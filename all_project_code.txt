================================================================================
PATH: .vercel\project.json
FILENAME: project.json
================================================================================

{"projectId":"prj_9fErKFo8cGUju6gQ3pToznG1HDRp","orgId":"team_cEEUn0WZZf4nEl8ZIdPhtiEQ","projectName":"sahakar-accounts"}

================================================================================
PATH: app\(auth)\layout.tsx
FILENAME: layout.tsx
================================================================================

export default function AuthLayout({
    children,
}: {
    children: React.ReactNode;
}) {
    return (
        <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100">
            <div className="w-full max-w-md">
                {children}
            </div>
        </div>
    );
}


================================================================================
PATH: app\(auth)\login\page.tsx
FILENAME: page.tsx
================================================================================

'use client';

import React, { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { useAuth } from '@/lib/auth-context';
import { Crown, Briefcase, BarChart3, User, Shield, Beaker } from 'lucide-react';

function LoginForm() {
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [error, setError] = useState('');
    const [loading, setLoading] = useState(false);
    const { signIn } = useAuth();

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        setError('');
        setLoading(true);

        try {
            console.log('[LoginForm] Attempting sign in for:', email);
            await signIn(email, password);
            console.log('[LoginForm] Sign in successful, auth state will trigger redirect');
            // Don't redirect here - let the auth state listener handle it
        } catch (err: any) {
            console.error('[LoginForm] Sign in error:', err);
            setError(err.message || 'Failed to sign in');
            setLoading(false);
        }
    };

    return (
        <div className="w-full max-w-md bg-white rounded-2xl shadow-2xl p-8">
            <div className="text-center mb-8">
                <h1 className="text-3xl font-bold text-gray-900 mb-2">
                    Sahakar Accounts
                </h1>
                <p className="text-gray-600">Sign in to your account</p>
            </div>

            {error && (
                <div className="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
                    <p className="text-red-800 text-sm">{error}</p>
                </div>
            )}

            <form onSubmit={handleSubmit} className="space-y-6">
                <div>
                    <label htmlFor="email" className="block text-sm font-medium text-gray-700 mb-2">
                        Email Address
                    </label>
                    <input
                        id="email"
                        type="email"
                        required
                        autoComplete="email"
                        value={email}
                        onChange={(e) => setEmail(e.target.value)}
                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="you@example.com"
                    />
                </div>

                <div>
                    <label htmlFor="password" className="block text-sm font-medium text-gray-700 mb-2">
                        Password
                    </label>
                    <input
                        id="password"
                        type="password"
                        required
                        autoComplete="current-password"
                        value={password}
                        onChange={(e) => setPassword(e.target.value)}
                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                    />
                </div>

                <button
                    type="submit"
                    disabled={loading}
                    className="w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-medium hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors"
                >
                    {loading ? 'Signing in...' : 'Sign In'}
                </button>

                {/* Fallback link for resilience */}
                {loading && (
                    <p className="text-center text-sm text-gray-600 mt-4">
                        If you are not redirected automatically,{' '}
                        <a href="/dashboard" className="text-blue-600 hover:text-blue-700 font-medium">
                            click here
                        </a>
                    </p>
                )}
            </form>

            {/* Demo Accounts */}
            <div className="mt-8 border-t border-gray-200 pt-6">
                <h3 className="text-sm font-semibold text-gray-700 mb-4 text-center flex items-center justify-center gap-2">
                    <Beaker className="w-4 h-4" /> Demo Accounts
                </h3>
                <div className="space-y-2">
                    {[
                        { email: 'frpboy12@gmail.com', role: 'Superadmin', Icon: Crown, color: 'bg-purple-50 border-purple-200 text-purple-900' },
                        { email: 'paymentstarlexpmna@gmail.com', role: 'HO Accountant', Icon: Briefcase, color: 'bg-green-50 border-green-200 text-green-900' },
                        { email: 'manager.test@sahakar.com', role: 'Manager', Icon: BarChart3, color: 'bg-blue-50 border-blue-200 text-blue-900' },
                        { email: 'staff.test@sahakar.com', role: 'Staff', Icon: User, color: 'bg-orange-50 border-orange-200 text-orange-900' },
                        { email: 'auditor.test@sahakar.com', role: 'Auditor', Icon: Shield, color: 'bg-gray-50 border-gray-200 text-gray-900' },
                    ].map((account) => (
                        <button
                            key={account.email}
                            onClick={() => {
                                setEmail(account.email);
                                setPassword('Zabnix@2025');
                            }}
                            className={`w-full text-left p-3 border rounded-lg hover:shadow-md transition-all ${account.color}`}
                        >
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-2">
                                    <account.Icon className="w-4 h-4" />
                                    <div>
                                        <p className="text-xs font-medium opacity-75">{account.role}</p>
                                        <p className="text-sm font-mono">{account.email}</p>
                                    </div>
                                </div>
                                <span className="text-xs opacity-50">Click to fill</span>
                            </div>
                        </button>
                    ))}
                </div>
                <p className="text-xs text-center text-gray-500 mt-4">
                    All accounts use password: <code className="bg-gray-100 px-2 py-1 rounded">Zabnix@2025</code>
                </p>
            </div>
        </div>
    );
}

export default function LoginPage() {
    const { user, loading } = useAuth();
    const router = useRouter();

    // Auth-state-based redirect (the correct pattern)
    useEffect(() => {
        if (!loading && user) {
            console.log('[LoginPage] User authenticated, redirecting to dashboard');
            router.replace('/dashboard');
        }
    }, [loading, user, router]);

    if (loading) {
        return (
            <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100">
                <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            </div>
        );
    }

    if (user) {
        return (
            <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100">
                <div className="text-center">
                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                    <p className="text-gray-700 font-medium">Redirecting to dashboard...</p>
                    <p className="text-xs text-gray-400 mt-2">Authenticated as {user.email}</p>
                    <p className="text-sm text-gray-600 mt-4">
                        If you are not redirected automatically,{' '}
                        <a href="/dashboard" className="text-blue-600 hover:text-blue-700 font-medium underline">
                            click here
                        </a>
                    </p>
                </div>
            </div>
        );
    }

    return (
        <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
            <LoginForm />
        </div>
    );
}


================================================================================
PATH: app\(dashboard)\dashboard\accountant\page.tsx
FILENAME: page.tsx
================================================================================

'use client';

import { useState } from 'react';
import { useAuth } from '@/lib/auth-context';
import { ProtectedRoute } from '@/components/protected-route';
import { MonthlyReport } from '@/components/monthly-report';
import { BalanceSummary } from '@/components/balance-summary';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { CheckCircle, Lock, Calendar, Building2, Filter, Clock, AlertCircle, X } from 'lucide-react';

interface DailyRecord {
    id: string;
    date: string;
    outlet_id: string;
    outlet?: { name: string; code: string };
    opening_cash: number;
    opening_upi: number;
    total_income: number;
    total_expense: number;
    status: string;
    submitted_at?: string;
}

export default function AccountantDashboard() {
    const { user } = useAuth();
    const queryClient = useQueryClient();
    const [filters, setFilters] = useState({
        outletId: 'all',
        startDate: '',
        endDate: ''
    });
    const [selectedRecord, setSelectedRecord] = useState<DailyRecord | null>(null);
    const [lockReason, setLockReason] = useState('');

    // Fetch all outlets
    const { data: outlets } = useQuery({
        queryKey: ['outlets'],
        queryFn: async () => {
            const res = await fetch('/api/outlets');
            if (!res.ok) return [];
            return res.json();
        }
    });

    // Fetch submitted records
    const { data: submittedRecords, isLoading } = useQuery<DailyRecord[]>({
        queryKey: ['submitted-records', filters],
        queryFn: async () => {
            const params = new URLSearchParams();
            params.append('status', 'submitted');
            if (filters.outletId !== 'all') params.append('outlet_id', filters.outletId);
            if (filters.startDate) params.append('start_date', filters.startDate);
            if (filters.endDate) params.append('end_date', filters.endDate);

            const res = await fetch(`/api/daily-records?${params}`);
            if (!res.ok) return [];
            return res.json();
        }
    });

    // Lock record mutation
    const lockMutation = useMutation({
        mutationFn: async ({ recordId, reason }: { recordId: string; reason: string }) => {
            const res = await fetch(`/api/daily-records/${recordId}/lock`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reason: reason || 'Reviewed and approved by HO Accountant' })
            });
            if (!res.ok) {
                const error = await res.json();
                throw new Error(error.error || 'Failed to lock record');
            }
            return res.json();
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['submitted-records'] });
            setSelectedRecord(null);
            setLockReason('');
        }
    });

    return (
        <ProtectedRoute allowedRoles={['ho_accountant', 'superadmin']}>
            <div className="p-6 max-w-7xl mx-auto">
                {/* Header */}
                <div className="mb-8">
                    <h1 className="text-3xl font-bold text-gray-900">HO Accountant Dashboard</h1>
                    <p className="text-gray-600 mt-2">Welcome, {user?.profile?.name}</p>
                </div>

                {/* Submitted Records Review Queue */}
                <div className="mb-8">
                    <div className="bg-white rounded-lg shadow">
                        <div className="p-6 border-b border-gray-200">
                            <div className="flex items-center justify-between mb-4">
                                <div>
                                    <h2 className="text-xl font-bold text-gray-900 flex items-center gap-2">
                                        <Clock className="w-5 h-5 text-yellow-600" />
                                        Pending Review Queue
                                    </h2>
                                    <p className="text-sm text-gray-600 mt-1">
                                        {submittedRecords?.length || 0} record(s) waiting for approval
                                    </p>
                                </div>
                            </div>

                            {/* Filters */}
                            <div className="flex flex-wrap items-center gap-4 pt-4">
                                <div className="flex-1 min-w-[200px]">
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        <Building2 className="w-4 h-4 inline mr-1" />
                                        Outlet
                                    </label>
                                    <select
                                        value={filters.outletId}
                                        onChange={(e) => setFilters({ ...filters, outletId: e.target.value })}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                    >
                                        <option value="all">All Outlets</option>
                                        {outlets?.map((outlet: any) => (
                                            <option key={outlet.id} value={outlet.id}>
                                                {outlet.name} ({outlet.code})
                                            </option>
                                        ))}
                                    </select>
                                </div>
                                <div className="flex-1 min-w-[150px]">
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        <Calendar className="w-4 h-4 inline mr-1" />
                                        From
                                    </label>
                                    <input
                                        type="date"
                                        value={filters.startDate}
                                        onChange={(e) => setFilters({ ...filters, startDate: e.target.value })}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                    />
                                </div>
                                <div className="flex-1 min-w-[150px]">
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                        <Calendar className="w-4 h-4 inline mr-1" />
                                        To
                                    </label>
                                    <input
                                        type="date"
                                        value={filters.endDate}
                                        onChange={(e) => setFilters({ ...filters, endDate: e.target.value })}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                    />
                                </div>
                            </div>
                        </div>

                        {/* Records Table */}
                        <div className="overflow-x-auto">
                            {isLoading ? (
                                <div className="p-8 text-center">
                                    <div className="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-green-600 border-r-transparent"></div>
                                    <p className="mt-2 text-gray-600">Loading records...</p>
                                </div>
                            ) : submittedRecords && submittedRecords.length > 0 ? (
                                <table className="w-full">
                                    <thead className="bg-gray-50 border-b border-gray-200">
                                        <tr>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Outlet</th>
                                            <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Income</th>
                                            <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Expense</th>
                                            <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Submitted</th>
                                            <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-gray-200">
                                        {submittedRecords.map((record) => (
                                            <tr key={record.id} className="hover:bg-gray-50">
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                    {new Date(record.date).toLocaleDateString('en-IN')}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap">
                                                    <div className="text-sm font-medium text-gray-900">{record.outlet?.name || 'Unknown'}</div>
                                                    <div className="text-xs text-gray-500">{record.outlet?.code || 'N/A'}</div>
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-right text-green-600 font-medium">
                                                    â‚¹{record.total_income?.toLocaleString('en-IN') || 0}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-right text-red-600 font-medium">
                                                    â‚¹{record.total_expense?.toLocaleString('en-IN') || 0}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-xs text-gray-500 text-center">
                                                    {record.submitted_at ? new Date(record.submitted_at).toLocaleString('en-IN') : 'N/A'}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-center">
                                                    <button
                                                        onClick={() => setSelectedRecord(record)}
                                                        className="px-3 py-1.5 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 flex items-center gap-1 mx-auto"
                                                    >
                                                        <Lock className="w-4 h-4" />
                                                        Lock
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            ) : (
                                <div className="p-8 text-center">
                                    <CheckCircle className="w-16 h-16 text-gray-300 mx-auto mb-4" />
                                    <h3 className="text-lg font-medium text-gray-900 mb-2">All Clear!</h3>
                                    <p className="text-gray-600">
                                        No pending records to review. All submitted records have been processed.
                                    </p>
                                </div>
                            )}
                        </div>
                    </div>
                </div>

                {/* Balance Summary */}
                <div className="mb-8">
                    <h2 className="text-2xl font-bold text-gray-900 mb-4">All Outlets Balance</h2>
                    <BalanceSummary />
                </div>

                {/* Monthly Report */}
                <div className="mb-8">
                    <MonthlyReport />
                </div>

                {/* Reports Section */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div className="bg-white rounded-lg shadow p-6">
                        <h2 className="text-xl font-bold text-gray-900 mb-4">ðŸ“„ Financial Reports</h2>
                        <div className="space-y-3">
                            <a href="/dashboard/monthly" className="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors block">
                                <h3 className="font-medium text-gray-900">Monthly P&L Statement</h3>
                                <p className="text-sm text-gray-600">Profit and Loss breakdown</p>
                            </a>
                            <a href="/dashboard/cash-flow" className="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors block">
                                <h3 className="font-medium text-gray-900">Cash Flow Report</h3>
                                <p className="text-sm text-gray-600">Cash movement analysis</p>
                            </a>
                            <a href="/dashboard/reports" className="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors block">
                                <h3 className="font-medium text-gray-900">Category Summary</h3>
                                <p className="text-sm text-gray-600">Income/Expense by category</p>
                            </a>
                        </div>
                    </div>

                    <div className="bg-white rounded-lg shadow p-6">
                        <h2 className="text-xl font-bold text-gray-900 mb-4">ðŸ“Š Google Sheets</h2>
                        <div className="space-y-3">
                            <div className="p-4 bg-green-50 border border-green-200 rounded-lg">
                                <h3 className="font-medium text-green-900 mb-2">âœ“ Auto-Sync Enabled</h3>
                                <p className="text-sm text-green-700">
                                    Daily records are automatically synced to Google Sheets when locked.
                                </p>
                            </div>
                            <a
                                href={process.env.NEXT_PUBLIC_GOOGLE_SHEET_URL || '#'}
                                target="_blank"
                                rel="noopener noreferrer"
                                className="w-full p-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-center block"
                            >
                                ðŸ“‚ Open Google Sheets
                            </a>
                            <button
                                onClick={async () => {
                                    try {
                                        const res = await fetch('/api/sync/google-sheets', { method: 'POST' });
                                        const data = await res.json();
                                        if (data.success) {
                                            alert(`âœ… Synced ${data.recordCount} records successfully!`);
                                        } else {
                                            alert(`âš ï¸ ${data.message || 'Sync failed'}`);
                                        }
                                    } catch (error) {
                                        alert('âŒ Sync error. Please check configuration.');
                                    }
                                }}
                                className="w-full p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors"
                            >
                                ðŸ”„ Manual Sync
                            </button>
                        </div>
                    </div>
                </div>

                {/* Lock Confirmation Modal */}
                {selectedRecord && (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div className="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                            <div className="flex items-center justify-between mb-4">
                                <h3 className="text-xl font-bold text-gray-900">Lock Daily Record</h3>
                                <button onClick={() => setSelectedRecord(null)} className="text-gray-400 hover:text-gray-600">
                                    <X className="w-6 h-6" />
                                </button>
                            </div>

                            <div className="bg-gray-50 rounded-lg p-4 mb-4">
                                <p className="text-sm text-gray-600">Date: <span className="font-medium text-gray-900">{new Date(selectedRecord.date).toLocaleDateString('en-IN')}</span></p>
                                <p className="text-sm text-gray-600">Outlet: <span className="font-medium text-gray-900">{selectedRecord.outlet?.name}</span></p>
                                <p className="text-sm text-gray-600">Income: <span className="font-medium text-green-600">â‚¹{selectedRecord.total_income?.toLocaleString('en-IN')}</span></p>
                                <p className="text-sm text-gray-600">Expense: <span className="font-medium text-red-600">â‚¹{selectedRecord.total_expense?.toLocaleString('en-IN')}</span></p>
                            </div>

                            <div className="mb-4">
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Reason (Optional)
                                </label>
                                <textarea
                                    value={lockReason}
                                    onChange={(e) => setLockReason(e.target.value)}
                                    placeholder="e.g., All transactions verified, balances correct"
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500"
                                    rows={3}
                                />
                            </div>

                            <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
                                <div className="flex gap-2">
                                    <AlertCircle className="w-5 h-5 text-yellow-600 flex-shrink-0" />
                                    <p className="text-sm text-yellow-800">
                                        Once locked, this record cannot be modified without superadmin intervention.
                                    </p>
                                </div>
                            </div>

                            {lockMutation.isError && (
                                <div className="bg-red-50 border border-red-200 rounded-lg p-3 mb-4">
                                    <p className="text-sm text-red-800">
                                        {lockMutation.error.message}
                                    </p>
                                </div>
                            )}

                            <div className="flex gap-3">
                                <button
                                    onClick={() => setSelectedRecord(null)}
                                    disabled={lockMutation.isPending}
                                    className="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 disabled:opacity-50"
                                >
                                    Cancel
                                </button>
                                <button
                                    onClick={() => lockMutation.mutate({ recordId: selectedRecord.id, reason: lockReason })}
                                    disabled={lockMutation.isPending}
                                    className="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400 flex items-center justify-center gap-2"
                                >
                                    {lockMutation.isPending ? (
                                        <>
                                            <div className="h-4 w-4 animate-spin rounded-full border-2 border-white border-t-transparent"></div>
                                            Locking...
                                        </>
                                    ) : (
                                        <>
                                            <Lock className="w-4 h-4" />
                                            Lock Record
                                        </>
                                    )}
                                </button>
                            </div>
                        </div>
                    </div>
                )}
            </div>
        </ProtectedRoute>
    );
}


================================================================================
PATH: app\(dashboard)\dashboard\admin\auditors\page.tsx
FILENAME: page.tsx
================================================================================

'use client';

import { useState } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { Shield, Clock, CheckCircle, XCircle, Calendar } from 'lucide-react';

interface Auditor {
    id: string;
    email: string;
    name: string;
    role: string;
    auditor_access_granted_at: string | null;
    auditor_access_expires_at: string | null;
    auditor_access_granted_by: string | null;
}

export default function AuditorManagementPage() {
    const queryClient = useQueryClient();
    const [selectedAuditor, setSelectedAuditor] = useState<string | null>(null);
    const [accessDays, setAccessDays] = useState<number>(30);

    // Fetch all auditors
    const { data: auditors, isLoading } = useQuery<Auditor[]>({
        queryKey: ['auditors'],
        queryFn: async () => {
            const res = await fetch('/api/users?role=auditor');
            if (!res.ok) throw new Error('Failed to fetch auditors');
            return res.json();
        }
    });

    // Grant access mutation
    const grantAccessMutation = useMutation({
        mutationFn: async ({ auditor_id, days }: { auditor_id: string; days: number }) => {
            const res = await fetch('/api/admin/auditors/grant-access', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ auditor_id, days })
            });
            if (!res.ok) {
                const error = await res.json();
                throw new Error(error.error || 'Failed to grant access');
            }
            return res.json();
        },
        onSuccess: (data) => {
            console.log('[DEBUG] Grant Access Success:', data);
            queryClient.invalidateQueries({ queryKey: ['auditors'] });
            setSelectedAuditor(null);
            setAccessDays(30);
        },
        onError: (error) => {
            console.error('[DEBUG] Grant Access Error:', error);
        }
    });

    // Revoke access mutation
    const revokeAccessMutation = useMutation({
        mutationFn: async (auditor_id: string) => {
            const res = await fetch('/api/admin/auditors/revoke-access', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ auditor_id })
            });
            if (!res.ok) {
                const error = await res.json();
                throw new Error(error.error || 'Failed to revoke access');
            }
            return res.json();
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['auditors'] });
        }
    });

    const handleGrantAccess = (auditorId: string) => {
        console.log('[DEBUG] handleGrantAccess initiated for auditor:', auditorId);
        if (confirm(`Grant ${accessDays} days of access to this auditor?`)) {
            console.log('[DEBUG] handleGrantAccess: Confirmed by user');
            grantAccessMutation.mutate({ auditor_id: auditorId, days: accessDays });
        } else {
            console.log('[DEBUG] handleGrantAccess: Cancelled by user');
        }
    };

    const handleRevokeAccess = (auditorId: string) => {
        if (confirm('Revoke access for this auditor? This will expire their access immediately.')) {
            revokeAccessMutation.mutate(auditorId);
        }
    };

    const getAccessStatus = (auditor: Auditor) => {
        if (!auditor.auditor_access_expires_at) {
            return { status: 'no_access', color: 'gray', label: 'No Access' };
        }

        const expiresAt = new Date(auditor.auditor_access_expires_at);
        const now = new Date();

        if (expiresAt < now) {
            return { status: 'expired', color: 'red', label: 'Expired' };
        }

        const daysRemaining = Math.ceil((expiresAt.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));
        return { status: 'active', color: 'green', label: `Active (${daysRemaining}d remaining)` };
    };

    if (isLoading) {
        return (
            <div className="p-6">
                <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
            </div>
        );
    }

    return (
        <div className="max-w-7xl mx-auto p-6">
            <div className="mb-6">
                <h1 className="text-3xl font-bold text-gray-900 flex items-center gap-3">
                    <Shield className="w-8 h-8 text-blue-600" />
                    Auditor Access Management
                </h1>
                <p className="text-gray-600 mt-2">
                    Grant or revoke time-bound access for auditors to view locked financial records
                </p>
            </div>

            {/* Grant Access Form */}
            <div className="bg-white rounded-lg shadow p-6 mb-6">
                <h2 className="text-lg font-semibold text-gray-900 mb-4">Grant Access</h2>
                <div className="flex items-end gap-4">
                    <div className="flex-1">
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                            Select Auditor
                        </label>
                        <select
                            value={selectedAuditor || ''}
                            onChange={(e) => setSelectedAuditor(e.target.value)}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        >
                            <option value="">Choose an auditor...</option>
                            {auditors?.map((auditor) => (
                                <option key={auditor.id} value={auditor.id}>
                                    {auditor.name} ({auditor.email})
                                </option>
                            ))}
                        </select>
                    </div>
                    <div className="w-48">
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                            Access Duration (days)
                        </label>
                        <input
                            type="number"
                            min="1"
                            max="365"
                            value={accessDays}
                            onChange={(e) => setAccessDays(Number(e.target.value))}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        />
                    </div>
                    <button
                        onClick={() => selectedAuditor && handleGrantAccess(selectedAuditor)}
                        disabled={!selectedAuditor || grantAccessMutation.isPending}
                        className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
                    >
                        {grantAccessMutation.isPending ? 'Granting...' : 'Grant Access'}
                    </button>
                </div>
                {grantAccessMutation.isError && (
                    <p className="mt-2 text-sm text-red-600">
                        Error: {grantAccessMutation.error.message}
                    </p>
                )}
                {grantAccessMutation.isSuccess && (
                    <p className="mt-2 text-sm text-green-600">
                        Access granted successfully!
                    </p>
                )}
            </div>

            {/* Auditors Table */}
            <div className="bg-white rounded-lg shadow overflow-hidden">
                <table className="min-w-full divide-y divide-gray-200">
                    <thead className="bg-gray-50">
                        <tr>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Auditor
                            </th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Access Status
                            </th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Granted At
                            </th>
                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Expires At
                            </th>
                            <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-gray-200">
                        {auditors && auditors.length > 0 ? (
                            auditors.map((auditor) => {
                                const accessStatus = getAccessStatus(auditor);
                                return (
                                    <tr key={auditor.id} className="hover:bg-gray-50">
                                        <td className="px-6 py-4 whitespace-nowrap">
                                            <div className="flex items-center">
                                                <Shield className="w-5 h-5 text-gray-400 mr-3" />
                                                <div>
                                                    <div className="text-sm font-medium text-gray-900">
                                                        {auditor.name}
                                                    </div>
                                                    <div className="text-sm text-gray-500">
                                                        {auditor.email}
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap">
                                            <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${accessStatus.status === 'active' ? 'bg-green-100 text-green-800' :
                                                accessStatus.status === 'expired' ? 'bg-red-100 text-red-800' :
                                                    'bg-gray-100 text-gray-800'
                                                }`}>
                                                {accessStatus.label}
                                            </span>
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            {auditor.auditor_access_granted_at ? (
                                                <div className="flex items-center gap-1">
                                                    <Calendar className="w-4 h-4" />
                                                    {new Date(auditor.auditor_access_granted_at).toLocaleDateString()}
                                                </div>
                                            ) : (
                                                'Never'
                                            )}
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            {auditor.auditor_access_expires_at ? (
                                                <div className="flex items-center gap-1">
                                                    <Clock className="w-4 h-4" />
                                                    {new Date(auditor.auditor_access_expires_at).toLocaleDateString()}
                                                </div>
                                            ) : (
                                                'N/A'
                                            )}
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                            {accessStatus.status === 'active' ? (
                                                <button
                                                    onClick={() => handleRevokeAccess(auditor.id)}
                                                    disabled={revokeAccessMutation.isPending}
                                                    className="text-red-600 hover:text-red-900 disabled:opacity-50"
                                                >
                                                    Revoke Access
                                                </button>
                                            ) : (
                                                <span className="text-gray-400">No active access</span>
                                            )}
                                        </td>
                                    </tr>
                                );
                            })
                        ) : (
                            <tr>
                                <td colSpan={5} className="px-6 py-8 text-center text-gray-500">
                                    No auditors found. Create auditor users first.
                                </td>
                            </tr>
                        )}
                    </tbody>
                </table>
            </div>
        </div>
    );
}


================================================================================
PATH: app\(dashboard)\dashboard\admin\page.tsx
FILENAME: page.tsx
================================================================================

'use client';

import { useState } from 'react';
import { useAuth } from '@/lib/auth-context';
import { ProtectedRoute } from '@/components/protected-route';
import { DashboardCard } from '@/components/dashboard-card';
import { MonthlyReport } from '@/components/monthly-report';
import { BalanceSummary } from '@/components/balance-summary';
import { CreateUserModal } from '@/components/create-user-modal';
import { CreateOutletModal } from '@/components/create-outlet-modal';
import { ManagePermissionsModal } from '@/components/manage-permissions-modal';
import { useQuery } from '@tanstack/react-query';
import { UserPlus, Building2, Settings } from 'lucide-react';

export default function AdminDashboard() {
    const { user } = useAuth();
    const [showCreateUser, setShowCreateUser] = useState(false);
    const [showCreateOutlet, setShowCreateOutlet] = useState(false);
    const [showManagePermissions, setShowManagePermissions] = useState(false);

    // Fetch users count
    const { data: users } = useQuery({
        queryKey: ['users'],
        queryFn: async () => {
            const res = await fetch('/api/users');
            if (!res.ok) return [];
            return res.json();
        },
    });

    // Fetch outlets count
    const { data: outlets } = useQuery({
        queryKey: ['outlets'],
        queryFn: async () => {
            const res = await fetch('/api/outlets');
            if (!res.ok) return [];
            return res.json();
        },
    });

    const handleUserCreated = () => {
        // Refetch users list
        window.location.reload();
    };

    const handleOutletCreated = () => {
        // Refetch outlets list
        window.location.reload();
    };

    return (
        <ProtectedRoute allowedRoles={['superadmin']}>
            <div className="p-6 max-w-7xl mx-auto">
                <div className="mb-8">
                    <h1 className="text-3xl font-bold text-gray-900">Admin Dashboard</h1>
                    <p className="text-gray-600 mt-2">Welcome, {user?.profile?.name}</p>
                </div>

                {/* System Overview */}
                <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <DashboardCard
                        title="Total Outlets"
                        value={outlets?.length?.toString() || '0'}
                        colorClass="text-blue-600"
                        subtitle="Active"
                    />
                    <DashboardCard
                        title="Total Users"
                        value={users?.length?.toString() || '0'}
                        colorClass="text-green-600"
                        subtitle="Active"
                    />
                    <DashboardCard
                        title="Monthly Revenue"
                        value="â‚¹2,45,000"
                        colorClass="text-purple-600"
                        subtitle="All outlets"
                    />
                    <DashboardCard
                        title="System Health"
                        value="98%"
                        colorClass="text-green-600"
                        subtitle="Uptime"
                    />
                </div>

                {/* Management Sections */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    {/* User Management */}
                    <div className="bg-white rounded-lg shadow p-6">
                        <h2 className="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                            <UserPlus className="w-5 h-5" /> User Management
                        </h2>
                        <div className="space-y-3">
                            <button
                                onClick={() => setShowCreateUser(true)}
                                className="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-blue-50 hover:border-blue-300 transition-colors"
                            >
                                <h3 className="font-medium text-gray-900">Create New User</h3>
                                <p className="text-sm text-gray-600">Add staff, manager, or accountant</p>
                            </button>
                            <button
                                onClick={() => setShowManagePermissions(true)}
                                className="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-purple-50 hover:border-purple-300 transition-colors"
                            >
                                <h3 className="font-medium text-gray-900">Manage Permissions</h3>
                                <p className="text-sm text-gray-600">Edit user roles and access</p>
                            </button>
                            <a
                                href="/dashboard/users"
                                className="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors block"
                            >
                                <h3 className="font-medium text-gray-900">View All Users</h3>
                                <p className="text-sm text-gray-600">{users?.length || 0} active users</p>
                            </a>
                        </div>
                    </div>

                    {/* Outlet Management */}
                    <div className="bg-white rounded-lg shadow p-6">
                        <h2 className="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                            <Building2 className="w-5 h-5" /> Outlet Management
                        </h2>
                        <div className="space-y-3">
                            <button
                                onClick={() => setShowCreateOutlet(true)}
                                className="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-green-50 hover:border-green-300 transition-colors"
                            >
                                <h3 className="font-medium text-gray-900">Add New Outlet</h3>
                                <p className="text-sm text-gray-600">Create outlet location</p>
                            </button>
                            <a
                                href="/dashboard/outlets"
                                className="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors block"
                            >
                                <h3 className="font-medium text-gray-900">View All Outlets</h3>
                                <p className="text-sm text-gray-600">{outlets?.length || 0} active outlets</p>
                            </a>
                            <button className="w-full text-left p-3 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors">
                                <h3 className="font-medium text-gray-900 flex items-center gap-2">
                                    <Settings className="w-4 h-4" /> Configure Settings
                                </h3>
                                <p className="text-sm text-gray-600">Update outlet details</p>
                            </button>
                        </div>
                    </div>
                </div>

                {/* Balance Summary */}
                <div className="mb-8">
                    <h2 className="text-2xl font-bold text-gray-900 mb-4">Outlet Balance Overview</h2>
                    <BalanceSummary />
                </div>

                {/* Monthly Report */}
                <div>
                    <MonthlyReport />
                </div>
            </div>

            {/* Modals */}
            <CreateUserModal
                isOpen={showCreateUser}
                onClose={() => setShowCreateUser(false)}
                onSuccess={handleUserCreated}
            />
            <CreateOutletModal
                isOpen={showCreateOutlet}
                onClose={() => setShowCreateOutlet(false)}
                onSuccess={handleOutletCreated}
            />
            <ManagePermissionsModal
                isOpen={showManagePermissions}
                onClose={() => setShowManagePermissions(false)}
                onSuccess={handleUserCreated}
            />
        </ProtectedRoute>
    );
}


================================================================================
PATH: app\(dashboard)\dashboard\audit-logs\page.tsx
FILENAME: page.tsx
================================================================================

'use client';

import { useState } from 'react';
import { useQuery } from '@tanstack/react-query';
import { ProtectedRoute } from '@/components/protected-route';
import { Shield, Filter, Calendar, AlertTriangle } from 'lucide-react';

interface AuditLog {
    id: string;
    user_id: string;
    action: string;
    entity: string;
    entity_id: string;
    old_data: any;
    new_data: any;
    reason: string;
    severity: string;
    ip_address: string;
    user_agent: string;
    created_at: string;
}

export default function AuditLogsViewer() {
    const [filters, setFilters] = useState({
        severity: 'all',
        action: 'all',
        startDate: '',
        endDate: ''
    });

    const { data: logs, isLoading } = useQuery<AuditLog[]>({
        queryKey: ['audit-logs', filters],
        queryFn: async () => {
            // TODO: Create API endpoint for audit logs
            const res = await fetch('/api/audit-logs');
            if (!res.ok) throw new Error('Failed to fetch audit logs');
            return res.json();
        }
    });

    const getSeverityColor = (severity: string) => {
        switch (severity) {
            case 'critical': return 'bg-red-100 text-red-800 border-red-200';
            case 'warning': return 'bg-yellow-100 text-yellow-800 border-yellow-200';
            default: return 'bg-gray-100 text-gray-800 border-gray-200';
        }
    };

    return (
        <ProtectedRoute allowedRoles={['superadmin']}>
            <div className="max-w-7xl mx-auto p-6">
                <div className="mb-6">
                    <h1 className="text-3xl font-bold text-gray-900 flex items-center gap-3">
                        <Shield className="w-8 h-8 text-purple-600" />
                        Audit Logs
                    </h1>
                    <p className="text-gray-600 mt-2">
                        Complete system activity and security audit trail
                    </p>
                </div>

                {/* Filters */}
                <div className="bg-white rounded-lg shadow p-6 mb-6">
                    <div className="flex flex-wrap items-center gap-4">
                        <div className="flex-1 min-w-[150px]">
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                <Filter className="w-4 h-4 inline mr-1" />
                                Severity
                            </label>
                            <select
                                value={filters.severity}
                                onChange={(e) => setFilters({ ...filters, severity: e.target.value })}
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                            >
                                <option value="all">All Severities</option>
                                <option value="critical">Critical</option>
                                <option value="warning">Warning</option>
                                <option value="normal">Normal</option>
                            </select>
                        </div>
                        <div className="flex-1 min-w-[150px]">
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                Action
                            </label>
                            <select
                                value={filters.action}
                                onChange={(e) => setFilters({ ...filters, action: e.target.value })}
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                            >
                                <option value="all">All Actions</option>
                                <option value="submit_day">Submit Day</option>
                                <option value="lock_day">Lock Day</option>
                                <option value="unlock_day">Unlock Day</option>
                            </select>
                        </div>
                        <div className="flex-1 min-w-[150px]">
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                <Calendar className="w-4 h-4 inline mr-1" />
                                Start Date
                            </label>
                            <input
                                type="date"
                                value={filters.startDate}
                                onChange={(e) => setFilters({ ...filters, startDate: e.target.value })}
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                            />
                        </div>
                        <div className="flex-1 min-w-[150px]">
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                <Calendar className="w-4 h-4 inline mr-1" />
                                End Date
                            </label>
                            <input
                                type="date"
                                value={filters.endDate}
                                onChange={(e) => setFilters({ ...filters, endDate: e.target.value })}
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                            />
                        </div>
                    </div>
                </div>

                {/* Logs Table */}
                <div className="bg-white rounded-lg shadow overflow-hidden">
                    {isLoading ? (
                        <div className="p-8 text-center">
                            <div className="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-purple-600 border-r-transparent"></div>
                            <p className="mt-2 text-gray-600">Loading audit logs...</p>
                        </div>
                    ) : logs && logs.length > 0 ? (
                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead className="bg-gray-50 border-b border-gray-200">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Timestamp</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Action</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Entity</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Severity</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Reason</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">IP Address</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-200">
                                    {logs.map((log) => (
                                        <tr key={log.id} className="hover:bg-gray-50">
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                {new Date(log.created_at).toLocaleString('en-IN')}
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap">
                                                <span className="px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800">
                                                    {log.action}
                                                </span>
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                                {log.entity}
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap">
                                                <span className={`px-2 py-1 text-xs font-medium rounded-full border ${getSeverityColor(log.severity || 'normal')}`}>
                                                    {log.severity || 'normal'}
                                                </span>
                                            </td>
                                            <td className="px-6 py-4 text-sm text-gray-600 max-w-xs truncate">
                                                {log.reason || '-'}
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-xs text-gray-500">
                                                {log.ip_address || '-'}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    ) : (
                        <div className="p-8 text-center">
                            <Shield className="w-16 h-16 text-gray-300 mx-auto mb-4" />
                            <h3 className="text-lg font-medium text-gray-900 mb-2">No Audit Logs Found</h3>
                            <p className="text-gray-600">
                                No logs match your current filters.
                            </p>
                        </div>
                    )}
                </div>

                {/* Info Banner */}
                <div className="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div className="flex gap-2">
                        <AlertTriangle className="w-5 h-5 text-blue-600 flex-shrink-0" />
                        <div>
                            <p className="text-sm font-medium text-blue-900 mb-1">Audit Log Retention</p>
                            <p className="text-sm text-blue-700">
                                All system actions are logged indefinitely for compliance. Critical actions (unlocks, deletions) are flagged for immediate review.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </ProtectedRoute>
    );
}


================================================================================
PATH: app\(dashboard)\dashboard\auditor\page.tsx
FILENAME: page.tsx
================================================================================

'use client';

import { useState, useEffect } from 'react';
import { useAuth } from '@/lib/auth-context';
import { ProtectedRoute } from '@/components/protected-route';
import { AuditorBanner } from '@/components/auditor-banner';
import { useQuery } from '@tanstack/react-query';
import {
    Shield,
    Calendar,
    Download,
    Filter,
    FileSpreadsheet,
    FileText,
    Building2,
    TrendingUp,
    TrendingDown,
    DollarSign
} from 'lucide-react';
import * as XLSX from 'xlsx';

interface DailyRecord {
    id: string;
    date: string;
    outlet_id: string;
    outlet?: { name: string; code: string };
    opening_cash: number;
    opening_upi: number;
    closing_cash: number;
    closing_upi: number;
    total_income: number;
    total_expense: number;
    status: string;
    submitted_by?: string;
    locked_by?: string;
    locked_at?: string;
}

export default function AuditorDashboard() {
    const { user } = useAuth();
    const [filters, setFilters] = useState({
        outletId: 'all',
        startDate: '',
        endDate: '',
        month: new Date().toISOString().slice(0, 7)
    });

    // Log dashboard access
    useEffect(() => {
        logAuditorAccess('view_dashboard');
    }, []);

    // Fetch all outlets for filter
    const { data: outlets } = useQuery({
        queryKey: ['outlets'],
        queryFn: async () => {
            const res = await fetch('/api/outlets');
            if (!res.ok) throw new Error('Failed to fetch outlets');
            return res.json();
        }
    });

    // Fetch locked records
    const { data: records, isLoading } = useQuery<DailyRecord[]>({
        queryKey: ['auditor-locked-records', filters],
        queryFn: async () => {
            const params = new URLSearchParams();
            params.append('status', 'locked');
            if (filters.outletId !== 'all') params.append('outlet_id', filters.outletId);
            if (filters.startDate) params.append('start_date', filters.startDate);
            if (filters.endDate) params.append('end_date', filters.endDate);

            const res = await fetch(`/api/daily-records?${params}`);
            if (!res.ok) throw new Error('Failed to fetch records');
            return res.json();
        }
    });

    // Log access action
    const logAuditorAccess = async (action: string, entity_id?: string) => {
        try {
            await fetch('/api/auditor/log-access', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action,
                    entity_type: 'daily_record',
                    entity_id,
                    outlet_id: filters.outletId !== 'all' ? filters.outletId : null
                })
            });
        } catch (error) {
            console.error('Failed to log access:', error);
        }
    };

    // Export to Excel with watermark
    const exportToExcel = () => {
        if (!records || records.length === 0) {
            alert('No data to export');
            return;
        }

        logAuditorAccess('export_excel');

        const exportData = records.map(record => ({
            'Date': new Date(record.date).toLocaleDateString('en-IN'),
            'Outlet': record.outlet?.name || 'Unknown',
            'Code': record.outlet?.code || 'N/A',
            'Opening Cash': record.opening_cash,
            'Opening UPI': record.opening_upi,
            'Total Income': record.total_income,
            'Total Expense': record.total_expense,
            'Closing Cash': record.closing_cash,
            'Closing UPI': record.closing_upi,
            'Locked At': record.locked_at ? new Date(record.locked_at).toLocaleString('en-IN') : 'N/A'
        }));

        // Add watermark rows
        exportData.push({
            'Date': '',
            'Outlet': '',
            'Code': '',
            'Opening Cash': '',
            'Opening UPI': '',
            'Total Income': '',
            'Total Expense': '',
            'Closing Cash': '',
            'Closing UPI': '',
            'Locked At': ''
        } as any);
        exportData.push({
            'Date': 'AUDIT EXPORT WATERMARK',
            'Outlet': `Exported by: ${user?.profile?.name || user?.email}`,
            'Code': `Date: ${new Date().toLocaleString('en-IN')}`,
            'Opening Cash': 'READ-ONLY AUDIT ACCESS',
            'Opening UPI': 'DO NOT MODIFY',
            'Total Income': '',
            'Total Expense': '',
            'Closing Cash': '',
            'Closing UPI': '',
            'Locked At': ''
        } as any);

        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Locked Records');

        XLSX.writeFile(wb, `Audit_Export_${new Date().toISOString().split('T')[0]}.xlsx`);
    };

    // Calculate totals
    const totals = records?.reduce((acc, record) => ({
        totalIncome: acc.totalIncome + (record.total_income || 0),
        totalExpense: acc.totalExpense + (record.total_expense || 0),
        recordCount: acc.recordCount + 1
    }), { totalIncome: 0, totalExpense: 0, recordCount: 0 }) || { totalIncome: 0, totalExpense: 0, recordCount: 0 };

    return (
        <ProtectedRoute allowedRoles={['auditor']}>
            <div className="max-w-7xl mx-auto p-6">
                {/* Auditor Banner */}
                <AuditorBanner
                    accessEndDate={user?.profile?.access_end_date || null}
                    userName={user?.profile?.name || user?.email || 'Auditor'}
                />

                {/* Header */}
                <div className="mb-6">
                    <h1 className="text-3xl font-bold text-gray-900 flex items-center gap-3">
                        <Shield className="w-8 h-8 text-red-600" />
                        Audit Dashboard
                    </h1>
                    <p className="text-gray-600 mt-2">
                        Review locked daily records across all outlets
                    </p>
                </div>

                {/* Summary Cards */}
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div className="bg-white rounded-lg shadow p-6">
                        <div className="flex items-center gap-3">
                            <FileText className="w-8 h-8 text-blue-600" />
                            <div>
                                <p className="text-sm text-gray-600">Total Locked Records</p>
                                <p className="text-2xl font-bold text-gray-900">{totals.recordCount}</p>
                            </div>
                        </div>
                    </div>
                    <div className="bg-white rounded-lg shadow p-6">
                        <div className="flex items-center gap-3">
                            <TrendingUp className="w-8 h-8 text-green-600" />
                            <div>
                                <p className="text-sm text-gray-600">Total Income</p>
                                <p className="text-2xl font-bold text-green-900">
                                    â‚¹{totals.totalIncome.toLocaleString('en-IN')}
                                </p>
                            </div>
                        </div>
                    </div>
                    <div className="bg-white rounded-lg shadow p-6">
                        <div className="flex items-center gap-3">
                            <TrendingDown className="w-8 h-8 text-red-600" />
                            <div>
                                <p className="text-sm text-gray-600">Total Expense</p>
                                <p className="text-2xl font-bold text-red-900">
                                    â‚¹{totals.totalExpense.toLocaleString('en-IN')}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                {/* Filters & Export */}
                <div className="bg-white rounded-lg shadow p-6 mb-6">
                    <div className="flex flex-wrap items-center gap-4">
                        <div className="flex-1 min-w-[200px]">
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                <Building2 className="w-4 h-4 inline mr-1" />
                                Outlet
                            </label>
                            <select
                                value={filters.outletId}
                                onChange={(e) => setFilters({ ...filters, outletId: e.target.value })}
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500"
                            >
                                <option value="all">All Outlets</option>
                                {outlets?.map((outlet: any) => (
                                    <option key={outlet.id} value={outlet.id}>
                                        {outlet.name} ({outlet.code})
                                    </option>
                                ))}
                            </select>
                        </div>
                        <div className="flex-1 min-w-[150px]">
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                <Calendar className="w-4 h-4 inline mr-1" />
                                Start Date
                            </label>
                            <input
                                type="date"
                                value={filters.startDate}
                                onChange={(e) => setFilters({ ...filters, startDate: e.target.value })}
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500"
                            />
                        </div>
                        <div className="flex-1 min-w-[150px]">
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                <Calendar className="w-4 h-4 inline mr-1" />
                                End Date
                            </label>
                            <input
                                type="date"
                                value={filters.endDate}
                                onChange={(e) => setFilters({ ...filters, endDate: e.target.value })}
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500"
                            />
                        </div>
                        <div className="flex-shrink-0 self-end">
                            <button
                                onClick={exportToExcel}
                                disabled={!records || records.length === 0}
                                className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center gap-2"
                            >
                                <FileSpreadsheet className="w-5 h-5" />
                                Export Excel
                            </button>
                        </div>
                    </div>
                </div>

                {/* Records Table */}
                <div className="bg-white rounded-lg shadow overflow-hidden">
                    {isLoading ? (
                        <div className="p-8 text-center">
                            <div className="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-red-600 border-r-transparent"></div>
                            <p className="mt-2 text-gray-600">Loading locked records...</p>
                        </div>
                    ) : records && records.length > 0 ? (
                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead className="bg-gray-50 border-b border-gray-200">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Outlet</th>
                                        <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Opening Cash</th>
                                        <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Opening UPI</th>
                                        <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Income</th>
                                        <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Expense</th>
                                        <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Closing Cash</th>
                                        <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Closing UPI</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Locked At</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-200">
                                    {records.map((record) => (
                                        <tr key={record.id} className="hover:bg-gray-50">
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                {new Date(record.date).toLocaleDateString('en-IN')}
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap">
                                                <div className="text-sm font-medium text-gray-900">{record.outlet?.name || 'Unknown'}</div>
                                                <div className="text-xs text-gray-500">{record.outlet?.code || 'N/A'}</div>
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-900">
                                                â‚¹{record.opening_cash.toLocaleString('en-IN')}
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-900">
                                                â‚¹{record.opening_upi.toLocaleString('en-IN')}
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-right text-green-600 font-medium">
                                                â‚¹{record.total_income.toLocaleString('en-IN')}
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-right text-red-600 font-medium">
                                                â‚¹{record.total_expense.toLocaleString('en-IN')}
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-900">
                                                â‚¹{record.closing_cash.toLocaleString('en-IN')}
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-900">
                                                â‚¹{record.closing_upi.toLocaleString('en-IN')}
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-xs text-gray-500">
                                                {record.locked_at ? new Date(record.locked_at).toLocaleString('en-IN') : 'N/A'}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    ) : (
                        <div className="p-8 text-center">
                            <Shield className="w-16 h-16 text-gray-300 mx-auto mb-4" />
                            <h3 className="text-lg font-medium text-gray-900 mb-2">No Locked Records Found</h3>
                            <p className="text-gray-600">
                                There are no locked records matching your filters.
                            </p>
                        </div>
                    )}
                </div>
            </div>
        </ProtectedRoute>
    );
}


================================================================================
PATH: app\(dashboard)\dashboard\cash-flow\page.tsx
FILENAME: page.tsx
================================================================================

'use client';

import { useAuth } from '@/lib/auth-context';
import { ProtectedRoute } from '@/components/protected-route';
import { useQuery } from '@tanstack/react-query';
import { useState } from 'react';

interface CashFlowData {
    date: string;
    cash_in: number;
    cash_out: number;
    upi_in: number;
    upi_out: number;
    net_cash: number;
    net_upi: number;
}

export default function CashFlowReportPage() {
    const { user } = useAuth();
    const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));

    // Mock data - replace with actual API call
    const { data: cashFlowData, isLoading } = useQuery<CashFlowData[]>({
        queryKey: ['cash-flow', selectedMonth],
        queryFn: async () => {
            // TODO: Replace with actual API endpoint
            return [];
        },
    });

    const totalCashIn = cashFlowData?.reduce((sum, d) => sum + d.cash_in, 0) || 0;
    const totalCashOut = cashFlowData?.reduce((sum, d) => sum + d.cash_out, 0) || 0;
    const totalUPIIn = cashFlowData?.reduce((sum, d) => sum + d.upi_in, 0) || 0;
    const totalUPIOut = cashFlowData?.reduce((sum, d) => sum + d.upi_out, 0) || 0;
    const netCashFlow = totalCashIn - totalCashOut + totalUPIIn - totalUPIOut;

    return (
        <ProtectedRoute allowedRoles={['master_admin', 'ho_accountant', 'outlet_manager']}>
            <div className="p-6 max-w-7xl mx-auto">
                <div className="mb-8">
                    <h1 className="text-3xl font-bold text-gray-900">Cash Flow Report</h1>
                    <p className="text-gray-600 mt-2">Track cash and UPI movements</p>
                </div>

                {/* Month Selector */}
                <div className="mb-6">
                    <label className="block text-sm font-medium text-gray-700 mb-2">Select Month</label>
                    <input
                        type="month"
                        value={selectedMonth}
                        onChange={(e) => setSelectedMonth(e.target.value)}
                        className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    />
                </div>

                {/* Summary Cards */}
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div className="bg-green-50 border border-green-200 rounded-lg p-6">
                        <p className="text-sm text-green-600 font-medium mb-2">ðŸ’µ Cash Inflow</p>
                        <p className="text-2xl font-bold text-green-900">
                            â‚¹{totalCashIn.toLocaleString('en-IN', { minimumFractionDigits: 2 })}
                        </p>
                    </div>
                    <div className="bg-red-50 border border-red-200 rounded-lg p-6">
                        <p className="text-sm text-red-600 font-medium mb-2">ðŸ’¸ Cash Outflow</p>
                        <p className="text-2xl font-bold text-red-900">
                            â‚¹{totalCashOut.toLocaleString('en-IN', { minimumFractionDigits: 2 })}
                        </p>
                    </div>
                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-6">
                        <p className="text-sm text-blue-600 font-medium mb-2">ðŸ“± UPI Inflow</p>
                        <p className="text-2xl font-bold text-blue-900">
                            â‚¹{totalUPIIn.toLocaleString('en-IN', { minimumFractionDigits: 2 })}
                        </p>
                    </div>
                    <div className={`border rounded-lg p-6 ${netCashFlow >= 0 ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`}>
                        <p className={`text-sm font-medium mb-2 ${netCashFlow >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                            {netCashFlow >= 0 ? 'ðŸ“ˆ' : 'ðŸ“‰'} Net Cash Flow
                        </p>
                        <p className={`text-2xl font-bold ${netCashFlow >= 0 ? 'text-green-900' : 'text-red-900'}`}>
                            â‚¹{Math.abs(netCashFlow).toLocaleString('en-IN', { minimumFractionDigits: 2 })}
                        </p>
                    </div>
                </div>

                {/* Cash Flow Table */}
                <div className="bg-white rounded-lg shadow">
                    <div className="p-6 border-b border-gray-200">
                        <h2 className="text-xl font-bold text-gray-900">Daily Cash Flow</h2>
                    </div>

                    {isLoading ? (
                        <div className="p-8 text-center">
                            <div className="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-blue-600 border-r-transparent"></div>
                            <p className="mt-2 text-gray-600">Loading cash flow data...</p>
                        </div>
                    ) : cashFlowData && cashFlowData.length > 0 ? (
                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead className="bg-gray-50 border-b border-gray-200">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                        <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Cash In</th>
                                        <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Cash Out</th>
                                        <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">UPI In</th>
                                        <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">UPI Out</th>
                                        <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Net</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-200">
                                    {cashFlowData.map((row, idx) => (
                                        <tr key={idx} className="hover:bg-gray-50">
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                {new Date(row.date).toLocaleDateString('en-IN')}
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-right text-green-600">
                                                â‚¹{row.cash_in.toLocaleString('en-IN')}
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-right text-red-600">
                                                â‚¹{row.cash_out.toLocaleString('en-IN')}
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-right text-blue-600">
                                                â‚¹{row.upi_in.toLocaleString('en-IN')}
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-right text-red-600">
                                                â‚¹{row.upi_out.toLocaleString('en-IN')}
                                            </td>
                                            <td className={`px-6 py-4 whitespace-nowrap text-sm text-right font-medium ${(row.net_cash + row.net_upi) >= 0 ? 'text-green-600' : 'text-red-600'
                                                }`}>
                                                â‚¹{(row.net_cash + row.net_upi).toLocaleString('en-IN')}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    ) : (
                        <div className="p-12 text-center">
                            <div className="text-6xl mb-4">ðŸ“Š</div>
                            <h3 className="text-lg font-medium text-gray-900 mb-2">No Data Available</h3>
                            <p className="text-gray-600">
                                Cash flow data will appear here once daily records are locked for the selected month.
                            </p>
                        </div>
                    )}
                </div>
            </div>
        </ProtectedRoute>
    );
}


================================================================================
PATH: app\(dashboard)\dashboard\layout.tsx
FILENAME: layout.tsx
================================================================================

import { createServerClient } from '@/lib/supabase-server';
import { DashboardNav } from '@/components/dashboard-nav';
import { UserMenu } from '@/components/user-menu';
import { AuthErrorState } from '@/components/auth-error-state';
import type { UserProfile } from '@/lib/auth-context';

export const dynamic = 'force-dynamic';

export default async function DashboardLayout({
    children,
}: {
    children: React.ReactNode;
}) {
    const supabase = createServerClient();

    const { data: { user }, error: authError } = await supabase.auth.getUser();

    if (authError) {
        console.error('[DashboardLayout] Auth error:', authError);
    }

    // Middleware guarantees user exists - if not, show error
    if (!user) {
        console.error('[DashboardLayout] No user found - middleware should have caught this');
        return <AuthErrorState message="Authentication required. Please log in again." />;
    }

    console.log('[DashboardLayout] User found:', user.email, 'Fetching profile...');

    const { data: userData, error: dbError } = await supabase
        .from('users')
        .select('*')
        .eq('id', user.id)
        .single();

    if (dbError) {
        console.error('[DashboardLayout] Database error fetching profile:', dbError);
    }

    if (!userData) {
        console.log('[DashboardLayout] No profile found for user');
        // Don't redirect - just show error state
        return (
            <div className="min-h-screen flex items-center justify-center bg-gray-50">
                <div className="text-center">
                    <h2 className="text-2xl font-bold text-gray-900">Profile Not Found</h2>
                    <p className="mt-2 text-gray-600">Please contact administrator to set up your profile.</p>
                </div>
            </div>
        );
    }

    console.log('[DashboardLayout] Profile loaded successfully for:', (userData as any)?.email);

    const typedUserData = userData as UserProfile & { id: string; email: string };

    return (
        <div className="min-h-screen bg-gray-50">
            {/* Header */}
            <header className="bg-white shadow-sm border-b sticky top-0 z-10">
                <div className="px-4 sm:px-6 lg:px-8">
                    <div className="flex justify-between items-center h-16">
                        <div className="flex items-center space-x-4">
                            <h1 className="text-xl font-bold text-gray-900">
                                Sahakar Accounts
                            </h1>
                        </div>
                        <UserMenu user={typedUserData} />
                    </div>
                </div>
            </header>

            <div className="flex">
                {/* Sidebar */}
                <aside className="w-64 bg-white border-r min-h-[calc(100vh-4rem)] hidden lg:block">
                    <DashboardNav role={typedUserData.role} />
                </aside>

                {/* Main content */}
                <main className="flex-1 p-6 lg:p-8">
                    {children}
                </main>
            </div>
        </div>
    );
}


================================================================================
PATH: app\(dashboard)\dashboard\loading.tsx
FILENAME: loading.tsx
================================================================================

import { DashboardSkeleton } from "@/components/skeleton";

export default function Loading() {
    return <DashboardSkeleton />;
}


================================================================================
PATH: app\(dashboard)\dashboard\manager\page.tsx
FILENAME: page.tsx
================================================================================

'use client';

import { useAuth } from '@/lib/auth-context';
import { ProtectedRoute } from '@/components/protected-route';
import { DailyRecordActions } from '@/components/daily-record-actions';
import { MonthlyReport } from '@/components/monthly-report';
import { BalanceSummary } from '@/components/balance-summary';
import { useQuery } from '@tanstack/react-query';

export default function ManagerDashboard() {
    const { user } = useAuth();

    // Get today's daily record
    const { data: dailyRecord } = useQuery({
        queryKey: ['daily-record-today'],
        queryFn: async () => {
            const res = await fetch('/api/daily-records/today');
            if (!res.ok) throw new Error('Failed to fetch daily record');
            return res.json();
        },
    });

    return (
        <ProtectedRoute allowedRoles={['outlet_manager']}>
            <div className="p-6 max-w-7xl mx-auto">
                <div className="mb-8">
                    <h1 className="text-3xl font-bold text-gray-900">Manager Dashboard</h1>
                    <p className="text-gray-600 mt-2">Welcome, {user?.profile?.name}</p>
                </div>

                {/* Balance Summary */}
                <div className="mb-8">
                    <BalanceSummary />
                </div>

                {/* Daily Record Actions */}
                {dailyRecord && (
                    <div className="mb-8">
                        <DailyRecordActions
                            recordId={dailyRecord.id}
                            status={dailyRecord.status}
                        />
                    </div>
                )}

                {/* Monthly Report */}
                <div className="mb-8">
                    <MonthlyReport />
                </div>

                {/* Quick Actions */}
                <div className="bg-white rounded-lg shadow p-6">
                    <h2 className="text-xl font-bold text-gray-900 mb-4">Quick Actions</h2>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <a
                            href="/dashboard/staff"
                            className="p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-center"
                        >
                            <div className="text-3xl mb-2">ðŸ“</div>
                            <h3 className="font-medium text-gray-900">Enter Transactions</h3>
                            <p className="text-sm text-gray-600 mt-1">Add today's entries</p>
                        </a>
                        <a href="/dashboard/reports" className="p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-center block">
                            <div className="text-3xl mb-2">ðŸ“Š</div>
                            <h3 className="font-medium text-gray-900">View Reports</h3>
                            <p className="text-sm text-gray-600 mt-1">Analyze performance</p>
                        </a>
                        <a href="/dashboard/monthly" className="p-4 border border-gray-200 rounded-lg hover:bg-gray-50 transition-colors text-center block">
                            <div className="text-3xl mb-2">ðŸ“¤</div>
                            <h3 className="font-medium text-gray-900">Monthly View</h3>
                            <p className="text-sm text-gray-600 mt-1">View monthly summaries</p>
                        </a>
                    </div>
                </div>
            </div>
        </ProtectedRoute>
    );
}


================================================================================
PATH: app\(dashboard)\dashboard\monthly\page.tsx
FILENAME: page.tsx
================================================================================

'use client';

import { MonthlyReport } from '@/components/monthly-report';

export default function MonthlyViewPage() {
    return (
        <div className="max-w-7xl mx-auto">
            <MonthlyReport />
        </div>
    );
}


================================================================================
PATH: app\(dashboard)\dashboard\outlets\page.tsx
FILENAME: page.tsx
================================================================================

'use client';

import { useState } from 'react';
import { useAuth } from '@/lib/auth-context';
import { ProtectedRoute } from '@/components/protected-route';
import { useQuery } from '@tanstack/react-query';
import { CreateOutletModal } from '@/components/create-outlet-modal';

interface Outlet {
    id: string;
    name: string;
    code: string;
    address: string | null;
    created_at: string;
}

export default function OutletsPage() {
    const { user } = useAuth();
    const [showCreateOutlet, setShowCreateOutlet] = useState(false);

    // Fetch all outlets
    const { data: outlets, isLoading, refetch } = useQuery<Outlet[]>({
        queryKey: ['outlets'],
        queryFn: async () => {
            const res = await fetch('/api/outlets');
            if (!res.ok) throw new Error('Failed to fetch outlets');
            return res.json();
        },
    });

    return (
        <ProtectedRoute allowedRoles={['master_admin', 'superadmin']}>
            <div className="p-6 max-w-7xl mx-auto">
                <div className="mb-8">
                    <h1 className="text-3xl font-bold text-gray-900">Outlet Management</h1>
                    <p className="text-gray-600 mt-2">Manage store locations and settings</p>
                </div>

                {/* Statistics */}
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-6">
                        <div className="flex items-center gap-3">
                            <div className="text-3xl">ðŸª</div>
                            <div>
                                <p className="text-sm text-blue-600 font-medium">Total Outlets</p>
                                <p className="text-2xl font-bold text-blue-900">{outlets?.length || 0}</p>
                            </div>
                        </div>
                    </div>
                    <div className="bg-green-50 border border-green-200 rounded-lg p-6">
                        <div className="flex items-center gap-3">
                            <div className="text-3xl">âœ…</div>
                            <div>
                                <p className="text-sm text-green-600 font-medium">Active</p>
                                <p className="text-2xl font-bold text-green-900">{outlets?.length || 0}</p>
                            </div>
                        </div>
                    </div>
                    <div className="bg-purple-50 border border-purple-200 rounded-lg p-6">
                        <div className="flex items-center gap-3">
                            <div className="text-3xl">ðŸ‘¥</div>
                            <div>
                                <p className="text-sm text-purple-600 font-medium">Staff Assigned</p>
                                <p className="text-2xl font-bold text-purple-900">--</p>
                            </div>
                        </div>
                    </div>
                </div>

                {/* Outlets List */}
                <div className="bg-white rounded-lg shadow">
                    <div className="p-6 border-b border-gray-200">
                        <div className="flex items-center justify-between">
                            <h2 className="text-xl font-bold text-gray-900">All Outlets</h2>
                            <button
                                onClick={() => setShowCreateOutlet(true)}
                                className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                            >
                                + Add New Outlet
                            </button>
                        </div>
                    </div>

                    <div className="overflow-x-auto">
                        {isLoading ? (
                            <div className="p-8 text-center">
                                <div className="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-blue-600 border-r-transparent"></div>
                                <p className="mt-2 text-gray-600">Loading outlets...</p>
                            </div>
                        ) : outlets && outlets.length > 0 ? (
                            <table className="w-full">
                                <thead className="bg-gray-50 border-b border-gray-200">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Code</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Address</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Created</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-200">
                                    {outlets.map((outlet) => (
                                        <tr key={outlet.id} className="hover:bg-gray-50">
                                            <td className="px-6 py-4 whitespace-nowrap">
                                                <span className="px-3 py-1 bg-blue-100 text-blue-800 text-sm font-medium rounded-full">
                                                    {outlet.code}
                                                </span>
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap">
                                                <div className="flex items-center gap-2">
                                                    <span className="text-2xl">ðŸª</span>
                                                    <span className="font-medium text-gray-900">{outlet.name}</span>
                                                </div>
                                            </td>
                                            <td className="px-6 py-4">
                                                <p className="text-sm text-gray-600">{outlet.address || 'Not specified'}</p>
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                                                {new Date(outlet.created_at).toLocaleDateString('en-IN')}
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap">
                                                <div className="flex items-center gap-2">
                                                    <button className="px-3 py-1 text-sm text-blue-600 hover:bg-blue-50 rounded">
                                                        Edit
                                                    </button>
                                                    <button className="px-3 py-1 text-sm text-gray-600 hover:bg-gray-50 rounded">
                                                        View Stats
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        ) : (
                            <div className="p-8 text-center">
                                <div className="text-6xl mb-4">ðŸª</div>
                                <h3 className="text-lg font-medium text-gray-900 mb-2">No outlets found</h3>
                                <p className="text-gray-600 mb-4">Get started by adding your first outlet</p>
                                <button className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    + Add First Outlet
                                </button>
                            </div>
                        )}
                    </div>
                </div>

                {/* Create Outlet Modal */}
                <CreateOutletModal
                    isOpen={showCreateOutlet}
                    onClose={() => setShowCreateOutlet(false)}
                    onSuccess={() => {
                        setShowCreateOutlet(false);
                        refetch();
                    }}
                />
            </div>
        </ProtectedRoute>
    );
}


================================================================================
PATH: app\(dashboard)\dashboard\page.tsx
FILENAME: page.tsx
================================================================================

import { createServerClient } from '@/lib/supabase-server';
import { AuthErrorState } from '@/components/auth-error-state';

export default async function DashboardPage() {
    const supabase = createServerClient();
    const { data: { user } } = await supabase.auth.getUser();

    // Middleware guarantees user exists - if not, show error
    if (!user) {
        console.error('[DashboardPage] No user found - middleware should have caught this');
        return <AuthErrorState message="Authentication required. Please log in again." />;
    }

    // Fetch user profile with outlet_id
    const { data: userProfile } = await supabase
        .from('users')
        .select('*')
        .eq('id', user.id)
        .single() as { data: any, error: any }; // Type cast for build fix

    let outlets: any[] = [];

    if (userProfile) {
        if (['master_admin', 'ho_accountant'].includes(userProfile.role)) {
            const { data } = await supabase
                .from('outlets')
                .select('*')
                // .eq('is_active', true) // Schema mismatch fix
                .order('name');
            outlets = data || [];
        } else if (userProfile.outlet_id) {
            const { data } = await supabase
                .from('outlets')
                .select('*')
                .eq('id', userProfile.outlet_id); // Fetch assigned outlet
            outlets = data || [];
        }
    }

    return (
        <div className="space-y-6">
            <div>
                <h2 className="text-2xl font-bold text-gray-900">
                    Welcome back, {userProfile?.full_name || userProfile?.name}
                </h2>
                <p className="mt-1 text-sm text-gray-500">
                    Role: {userProfile?.role?.replace('_', ' ').toUpperCase()}
                </p>
            </div>

            <div className="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
                {/* Total Outlets Card */}
                <div className="bg-white rounded-lg shadow p-6">
                    <div className="flex items-center justify-between">
                        <div>
                            <p className="text-sm font-medium text-gray-600">Total Outlets</p>
                            <p className="mt-2 text-3xl font-semibold text-gray-900">
                                {outlets.length}
                            </p>
                        </div>
                        <div className="p-3 bg-blue-100 rounded-full">
                            <svg
                                className="w-6 h-6 text-blue-600"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    strokeLinecap="round"
                                    strokeLinejoin="round"
                                    strokeWidth={2}
                                    d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"
                                />
                            </svg>
                        </div>
                    </div>
                </div>

                {/* Pending Entries Card */}
                <div className="bg-white rounded-lg shadow p-6">
                    <div className="flex items-center justify-between">
                        <div>
                            <p className="text-sm font-medium text-gray-600">Pending Entries</p>
                            <p className="mt-2 text-3xl font-semibold text-gray-900">0</p>
                        </div>
                        <div className="p-3 bg-yellow-100 rounded-full">
                            <svg
                                className="w-6 h-6 text-yellow-600"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    strokeLinecap="round"
                                    strokeLinejoin="round"
                                    strokeWidth={2}
                                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                                />
                            </svg>
                        </div>
                    </div>
                </div>

                {/* Submitted Today Card */}
                <div className="bg-white rounded-lg shadow p-6">
                    <div className="flex items-center justify-between">
                        <div>
                            <p className="text-sm font-medium text-gray-600">Submitted Today</p>
                            <p className="mt-2 text-3xl font-semibold text-gray-900">0</p>
                        </div>
                        <div className="p-3 bg-green-100 rounded-full">
                            <svg
                                className="w-6 h-6 text-green-600"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    strokeLinecap="round"
                                    strokeLinejoin="round"
                                    strokeWidth={2}
                                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                                />
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            {/* Recent Activity */}
            <div className="bg-white rounded-lg shadow">
                <div className="px-6 py-5 border-b border-gray-200">
                    <h3 className="text-lg font-medium text-gray-900">
                        Your Outlets
                    </h3>
                </div>
                <div className="p-6">
                    {outlets.length === 0 ? (
                        <p className="text-gray-500 text-center py-8">
                            No outlets assigned yet
                        </p>
                    ) : (
                        <div className="grid grid-cols-1 gap-4 sm:grid-cols-2">
                            {outlets.map((outlet) => (
                                <div
                                    key={outlet.id}
                                    className="border rounded-lg p-4 hover:bg-gray-50 transition-colors"
                                >
                                    <h4 className="font-medium text-gray-900">{outlet.name}</h4>
                                    <p className="text-sm text-gray-500 mt-1">{outlet.code}</p>
                                    {outlet.location && (
                                        <p className="text-xs text-gray-400 mt-1">{outlet.location}</p>
                                    )}
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
}


================================================================================
PATH: app\(dashboard)\dashboard\reports\page.tsx
FILENAME: page.tsx
================================================================================

'use client';

import { useState } from 'react';
import { useQuery } from '@tanstack/react-query';
import { PieChart, Pie, Cell, ResponsiveContainer, Legend, Tooltip, BarChart, Bar, XAxis, YAxis, CartesianGrid } from 'recharts';
import { Download, FileDown, Calendar, Shield } from 'lucide-react';
import * as XLSX from 'xlsx';
import jsPDF from 'jspdf';
import 'jspdf-autotable';
import { useAuth } from '@/lib/auth-context';
import { AuditorBanner } from '@/components/auditor-banner';

// Extend jsPDF type
declare module 'jspdf' {
    interface jsPDF {
        autoTable: (options: any) => void;
    }
}

const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884D8', '#82CA9D'];

export default function ReportsPage() {
    const { user } = useAuth();
    const [startDate, setStartDate] = useState('');
    const [endDate, setEndDate] = useState('');

    // Fetch report data
    const { data: reportData, isLoading } = useQuery({
        queryKey: ['category-report', startDate, endDate],
        queryFn: async () => {
            const params = new URLSearchParams();
            if (startDate) params.append('startDate', startDate);
            if (endDate) params.append('endDate', endDate);

            const res = await fetch(`/api/reports/category?${params}`);
            if (!res.ok) throw new Error('Failed to fetch report');
            return res.json();
        },
    });

    // Transform data for charts
    const incomeData = reportData?.filter((r: any) => r.type === 'income') || [];
    const expenseData = reportData?.filter((r: any) => r.type === 'expense') || [];


    // Export to Excel with optional watermark
    const exportToExcel = () => {
        if (!reportData) return;

        const isAuditor = user?.profile?.role === 'auditor';

        const data = reportData.map((r: any) => ({
            Category: r.category,
            Type: r.type,
            'Total Amount': `â‚¹${r.total.toLocaleString('en-IN')}`,
            Transactions: r.count,
        }));

        if (isAuditor) {
            data.push({
                Category: '',
                Type: '',
                'Total Amount': '',
                Transactions: ''
            } as any);
            data.push({
                Category: 'AUDIT EXPORT WATERMARK',
                Type: `Exported by: ${user?.profile?.name || user?.email}`,
                'Total Amount': `Date: ${new Date().toLocaleString('en-IN')}`,
                Transactions: 'DO NOT MODIFY'
            } as any);
        }

        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Category Report');

        const filename = `${isAuditor ? 'Audit_' : ''}category-report-${new Date().toISOString().split('T')[0]}.xlsx`;
        XLSX.writeFile(wb, filename);
    };

    // Export to PDF with optional watermark
    const exportToPDF = () => {
        if (!reportData) return;

        const isAuditor = user?.profile?.role === 'auditor';
        const doc = new jsPDF();

        doc.setFontSize(18);
        doc.text('Category-wise Financial Report', 14, 22);

        doc.setFontSize(11);
        doc.text(`Generated: ${new Date().toLocaleDateString()}`, 14, 30);
        if (startDate && endDate) {
            doc.text(`Period: ${startDate} to ${endDate}`, 14, 36);
        }

        if (isAuditor) {
            doc.setTextColor(200, 0, 0);
            doc.setFontSize(10);
            doc.text('READ-ONLY AUDIT EXPORT - FOR COMPLIANCE ONLY', 14, 42);
            doc.setTextColor(0, 0, 0);
        }

        const tableData = reportData.map((r: any) => [
            r.category,
            r.type,
            `â‚¹${r.total.toLocaleString('en-IN')}`,
            r.count,
        ]);

        doc.autoTable({
            startY: isAuditor ? 48 : 45,
            head: [['Category', 'Type', 'Total Amount', 'Transactions']],
            body: tableData,
        });

        if (isAuditor) {
            const pageHeight = doc.internal.pageSize.height;
            doc.setFontSize(8);
            doc.setTextColor(150);
            doc.text(`Audit Watermark: Exported by ${user?.profile?.name || user?.email} on ${new Date().toLocaleString('en-IN')}`, 14, pageHeight - 10);
        }

        const filename = `${isAuditor ? 'Audit_' : ''}category-report-${new Date().toISOString().split('T')[0]}.pdf`;
        doc.save(filename);
    };

    return (
        <div className="max-w-7xl mx-auto p-6">
            {user?.profile?.role === 'auditor' && (
                <AuditorBanner
                    accessEndDate={user?.profile?.access_end_date || null}
                    userName={user?.profile?.name || user?.email || 'Auditor'}
                />
            )}
            <div className="mb-6">
                <h1 className="text-3xl font-bold text-gray-900">Financial Reports</h1>
                <p className="text-gray-600 mt-2">Category-wise breakdown and analysis.</p>
            </div>

            {/* Date Range Filter */}
            <div className="bg-white rounded-lg shadow p-6 mb-6">
                <div className="flex items-center gap-4 flex-wrap">
                    <div className="flex items-center gap-2">
                        <Calendar className="w-5 h-5 text-gray-600" />
                        <span className="font-medium text-gray-700">Filter by Date:</span>
                    </div>
                    <div className="flex items-center gap-2">
                        <input
                            type="date"
                            value={startDate}
                            onChange={(e) => setStartDate(e.target.value)}
                            className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        />
                        <span className="text-gray-500">to</span>
                        <input
                            type="date"
                            value={endDate}
                            onChange={(e) => setEndDate(e.target.value)}
                            className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        />
                    </div>
                    {(startDate || endDate) && (
                        <button
                            onClick={() => { setStartDate(''); setEndDate(''); }}
                            className="text-sm text-blue-600 hover:text-blue-800"
                        >
                            Clear Filters
                        </button>
                    )}
                </div>
            </div>

            {/* Export Buttons */}
            <div className="flex gap-3 mb-6">
                <button
                    onClick={exportToExcel}
                    disabled={!reportData || reportData.length === 0}
                    className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed"
                >
                    <Download className="w-4 h-4" />
                    Export to Excel
                </button>
                <button
                    onClick={exportToPDF}
                    disabled={!reportData || reportData.length === 0}
                    className="flex items-center gap-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed"
                >
                    <FileDown className="w-4 h-4" />
                    Export to PDF
                </button>
            </div>

            {isLoading ? (
                <div className="bg-white rounded-lg shadow p-12 text-center">
                    <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
                    <p className="text-gray-600 mt-4">Loading report data...</p>
                </div>
            ) : !reportData || reportData.length === 0 ? (
                <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-8 text-center">
                    <p className="text-yellow-800">No data available for the selected period.</p>
                </div>
            ) : (
                <>
                    {/* Charts */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        {/* Income Pie Chart */}
                        <div className="bg-white rounded-lg shadow p-6">
                            <h2 className="text-lg font-bold text-gray-900 mb-4">Income Breakdown</h2>
                            <ResponsiveContainer width="100%" height={300}>
                                <PieChart>
                                    <Pie
                                        data={incomeData}
                                        dataKey="total"
                                        nameKey="category"
                                        cx="50%"
                                        cy="50%"
                                        outerRadius={80}
                                        label
                                    >
                                        {incomeData.map((entry: any, index: number) => (
                                            <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                                        ))}
                                    </Pie>
                                    <Tooltip />
                                    <Legend />
                                </PieChart>
                            </ResponsiveContainer>
                        </div>

                        {/* Expense Pie Chart */}
                        <div className="bg-white rounded-lg shadow p-6">
                            <h2 className="text-lg font-bold text-gray-900 mb-4">Expense Breakdown</h2>
                            <ResponsiveContainer width="100%" height={300}>
                                <PieChart>
                                    <Pie
                                        data={expenseData}
                                        dataKey="total"
                                        nameKey="category"
                                        cx="50%"
                                        cy="50%"
                                        outerRadius={80}
                                        label
                                    >
                                        {expenseData.map((entry: any, index: number) => (
                                            <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                                        ))}
                                    </Pie>
                                    <Tooltip />
                                    <Legend />
                                </PieChart>
                            </ResponsiveContainer>
                        </div>
                    </div>

                    {/* Bar Chart Comparison */}
                    <div className="bg-white rounded-lg shadow p-6 mb-6">
                        <h2 className="text-lg font-bold text-gray-900 mb-4">Category Comparison</h2>
                        <ResponsiveContainer width="100%" height={400}>
                            <BarChart data={reportData}>
                                <CartesianGrid strokeDasharray="3 3" />
                                <XAxis dataKey="category" angle={-45} textAnchor="end" height={100} />
                                <YAxis />
                                <Tooltip />
                                <Legend />
                                <Bar dataKey="total" fill="#8884d8" name="Amount" />
                            </BarChart>
                        </ResponsiveContainer>
                    </div>

                    {/* Data Table */}
                    <div className="bg-white rounded-lg shadow overflow-hidden">
                        <table className="min-w-full divide-y divide-gray-200">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Category
                                    </th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Type
                                    </th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Total Amount
                                    </th>
                                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        Transactions
                                    </th>
                                </tr>
                            </thead>
                            <tbody className="bg-white divide-y divide-gray-200">
                                {reportData.map((row: any, index: number) => (
                                    <tr key={index} className="hover:bg-gray-50">
                                        <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                            {row.category}
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            <span className={`px-2 py-1 rounded-full text-xs font-medium ${row.type === 'income'
                                                ? 'bg-green-100 text-green-800'
                                                : 'bg-red-100 text-red-800'
                                                }`}>
                                                {row.type}
                                            </span>
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                            â‚¹{row.total.toLocaleString('en-IN', {
                                                minimumFractionDigits: 2,
                                                maximumFractionDigits: 2,
                                            })}
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            {row.count}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </>
            )}
        </div>
    );
}


================================================================================
PATH: app\(dashboard)\dashboard\staff\page.tsx
FILENAME: page.tsx
================================================================================

'use client';

import { useState, useEffect } from 'react';
import { useAuth } from '@/lib/auth-context';
import { ProtectedRoute } from '@/components/protected-route';
import { DashboardCard } from '@/components/dashboard-card';
import { TransactionForm } from '@/components/transaction-form';
import { TransactionList } from '@/components/transaction-list';
import { LiveBalance } from '@/components/live-balance';
import { DailyRecordActions } from '@/components/daily-record-actions';
import { OpeningBalanceModal } from '@/components/opening-balance-modal';
import { TransactionSummary } from '@/components/transaction-summary';
import { useQuery } from '@tanstack/react-query';
import { Building2 } from 'lucide-react';

export default function StaffDashboard() {
    const { user } = useAuth();
    const [showOpeningModal, setShowOpeningModal] = useState(false);

    // Get today's daily record
    const { data: dailyRecord, isLoading: recordLoading } = useQuery({
        queryKey: ['daily-record-today'],
        queryFn: async () => {
            const res = await fetch('/api/daily-records/today');
            if (!res.ok) throw new Error('Failed to fetch daily record');
            return res.json();
        },
    });

    // Fetch outlet information
    const { data: outlet } = useQuery({
        queryKey: ['outlet', user?.profile?.outlet_id as string],
        queryFn: async () => {
            if (!user?.profile?.outlet_id) return null;
            const res = await fetch(`/api/outlets?id=${(user.profile as any).outlet_id}`);
            if (!res.ok) return null;
            const outlets = await res.json();
            return outlets[0] || null;
        },
        enabled: !!(user?.profile as any)?.outlet_id,
    });

    const cashBalance = dailyRecord?.closing_cash ?? dailyRecord?.opening_cash ?? 0;
    const upiBalance = dailyRecord?.closing_upi ?? dailyRecord?.opening_upi ?? 0;

    // Auto-show opening balance modal if needed
    useEffect(() => {
        if (dailyRecord && dailyRecord.status === 'draft') {
            const hasOpeningBalances = (dailyRecord.opening_cash || 0) > 0 || (dailyRecord.opening_upi || 0) > 0;
            if (!hasOpeningBalances) {
                setShowOpeningModal(true);
            }
        }
    }, [dailyRecord]);

    return (
        <ProtectedRoute allowedRoles={['outlet_staff', 'outlet_manager']}>
            <div className="p-6 max-w-7xl mx-auto">
                <div className="mb-6">
                    <h1 className="text-3xl font-bold text-gray-900">Staff Dashboard</h1>
                    <p className="text-gray-600 mt-2">Welcome, {user?.profile?.name}</p>
                    {outlet && (
                        <div className="mt-2 inline-flex items-center gap-2 px-3 py-1 bg-blue-50 border border-blue-200 rounded-lg">
                            <Building2 className="w-4 h-4 text-blue-600" />
                            <span className="text-sm font-medium text-blue-800">
                                {outlet.name} ({outlet.code})
                            </span>
                        </div>
                    )}
                </div>

                {/* Daily Record Status */}
                {dailyRecord && (
                    <div className="mb-6">
                        <DailyRecordActions
                            recordId={dailyRecord.id}
                            status={dailyRecord.status}
                        />
                    </div>
                )}

                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    {/* Live Balance - Takes 1 column */}
                    <div>
                        {recordLoading ? (
                            <div className="bg-gray-100 rounded-lg h-64 animate-pulse"></div>
                        ) : (
                            <LiveBalance
                                cashBalance={cashBalance}
                                upiBalance={upiBalance}
                                openingCash={dailyRecord?.opening_cash || 0}
                                openingUpi={dailyRecord?.opening_upi || 0}
                            />
                        )}
                    </div>

                    {/* Transaction Form - Takes 2 columns */}
                    <div className="lg:col-span-2">
                        {dailyRecord ? (
                            <TransactionForm dailyRecordId={dailyRecord.id} />
                        ) : (
                            <div className="bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                                <p className="text-gray-600">Loading daily record...</p>
                            </div>
                        )}
                    </div>
                </div>

                {/* Transaction List */}
                {dailyRecord && (
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-8">
                        <div>
                            <TransactionSummary dailyRecordId={dailyRecord.id} />
                        </div>
                        <div>
                            <TransactionList dailyRecordId={dailyRecord.id} />
                        </div>
                    </div>
                )}

                {/* Opening Balance Modal */}
                {dailyRecord && (
                    <OpeningBalanceModal
                        isOpen={showOpeningModal}
                        onClose={() => setShowOpeningModal(false)}
                        recordId={dailyRecord.id}
                        date={dailyRecord.date}
                        previousClosingCash={0}
                        previousClosingUpi={0}
                    />
                )}
            </div>
        </ProtectedRoute >
    );
}


================================================================================
PATH: app\(dashboard)\dashboard\users\page.tsx
FILENAME: page.tsx
================================================================================

'use client';

import { useState } from 'react';
import { useQuery } from '@tanstack/react-query';
import { createClientComponentClient } from '@supabase/auth-helpers-nextjs';
import { CreateUserModal } from '@/components/create-user-modal';
import { ManagePermissionsModal } from '@/components/manage-permissions-modal';
import { UserPlus, Settings } from 'lucide-react';

export default function UsersPage() {
    const supabase = createClientComponentClient();
    const [showCreateUser, setShowCreateUser] = useState(false);
    const [showManagePermissions, setShowManagePermissions] = useState(false);

    const { data: users, isLoading, refetch } = useQuery({
        queryKey: ['users-list'],
        queryFn: async () => {
            const { data, error } = await supabase
                .from('users')
                .select('*')
                .order('name');
            if (error) throw error;
            return data;
        },
    });

    return (
        <div className="max-w-7xl mx-auto">
            <div className="mb-6 flex justify-between items-center">
                <div>
                    <h1 className="text-3xl font-bold text-gray-900">Users</h1>
                    <p className="text-gray-600 mt-2">Manage system users and access.</p>
                </div>
                <div className="flex gap-3">
                    <button
                        onClick={() => setShowCreateUser(true)}
                        className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
                    >
                        <UserPlus size={20} />
                        Add User
                    </button>
                    <button
                        onClick={() => setShowManagePermissions(true)}
                        className="flex items-center gap-2 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors"
                    >
                        <Settings size={20} />
                        Manage Permissions
                    </button>
                </div>
            </div>

            {/* Modals */}
            <CreateUserModal
                isOpen={showCreateUser}
                onClose={() => setShowCreateUser(false)}
                onSuccess={() => {
                    setShowCreateUser(false);
                    refetch();
                }}
            />
            <ManagePermissionsModal
                isOpen={showManagePermissions}
                onClose={() => setShowManagePermissions(false)}
                onSuccess={() => setShowManagePermissions(false)}
            />

            <div className="bg-white rounded-lg shadow overflow-hidden">
                <div className="overflow-x-auto">
                    <table className="min-w-full divide-y divide-gray-200">
                        <thead className="bg-gray-50">
                            <tr>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Name
                                </th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Email
                                </th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Role
                                </th>
                                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Outlet ID
                                </th>
                            </tr>
                        </thead>
                        <tbody className="bg-white divide-y divide-gray-200">
                            {isLoading ? (
                                <tr>
                                    <td colSpan={4} className="px-6 py-4 text-center text-gray-500">
                                        Loading users...
                                    </td>
                                </tr>
                            ) : users?.length === 0 ? (
                                <tr>
                                    <td colSpan={4} className="px-6 py-4 text-center text-gray-500">
                                        No users found
                                    </td>
                                </tr>
                            ) : (
                                users?.map((user: any) => (
                                    <tr key={user.id} className="hover:bg-gray-50">
                                        <td className="px-6 py-4 whitespace-nowrap">
                                            <div className="text-sm font-medium text-gray-900">
                                                {user.name || user.full_name || 'N/A'}
                                            </div>
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap">
                                            <div className="text-sm text-gray-500">{user.email}</div>
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap">
                                            <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${user.role === 'master_admin' ? 'bg-purple-100 text-purple-800' :
                                                user.role === 'outlet_manager' ? 'bg-green-100 text-green-800' :
                                                    'bg-blue-100 text-blue-800'
                                                }`}>
                                                {user.role}
                                            </span>
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            {user.outlet_id ? (
                                                <span className="font-mono text-xs">{user.outlet_id}</span>
                                            ) : (
                                                <span className="text-red-500 text-xs">Unassigned</span>
                                            )}
                                        </td>
                                    </tr>
                                ))
                            )}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    );
}


================================================================================
PATH: app\api\admin\auditors\grant-access\route.ts
FILENAME: route.ts
================================================================================

import { NextResponse } from 'next/server';
import { createServerClient } from '@/lib/supabase-server';

export async function POST(request: Request) {
    try {
        const supabase = createServerClient();
        const { data: { user } } = await supabase.auth.getUser();

        if (!user) {
            return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
        }

        // Check if user is admin
        const { data: adminUser } = await supabase
            .from('users')
            .select('role')
            .eq('id', user.id)
            .single();

        if (!adminUser || !['master_admin', 'superadmin'].includes(adminUser.role)) {
            return NextResponse.json({ error: 'Forbidden: Admin access required' }, { status: 403 });
        }

        const { auditor_id, days } = await request.json();

        if (!auditor_id || !days) {
            return NextResponse.json({ error: 'Missing required fields: auditor_id, days' }, { status: 400 });
        }

        // Calculate expiry date
        const grantedAt = new Date();
        const expiresAt = new Date();
        expiresAt.setDate(expiresAt.getDate() + days);

        // Grant access
        const { error } = await supabase
            .from('users')
            .update({
                auditor_access_granted_at: grantedAt.toISOString(),
                auditor_access_expires_at: expiresAt.toISOString(),
                auditor_access_granted_by: user.id
            })
            .eq('id', auditor_id)
            .eq('role', 'auditor');

        if (error) {
            console.error('[GrantAccess] Error:', error);
            return NextResponse.json({ error: error.message }, { status: 500 });
        }

        return NextResponse.json({
            success: true,
            granted_at: grantedAt,
            expires_at: expiresAt,
            days: days
        });
    } catch (error: any) {
        console.error('[GrantAccess] Exception:', error);
        return NextResponse.json({ error: error.message || 'Internal server error' }, { status: 500 });
    }
}


================================================================================
PATH: app\api\admin\auditors\revoke-access\route.ts
FILENAME: route.ts
================================================================================

import { NextResponse } from 'next/server';
import { createServerClient } from '@/lib/supabase-server';

export async function POST(request: Request) {
    try {
        const supabase = createServerClient();
        const { data: { user } } = await supabase.auth.getUser();

        if (!user) {
            return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
        }

        // Check if user is admin
        const { data: adminUser } = await supabase
            .from('users')
            .select('role')
            .eq('id', user.id)
            .single();

        if (!adminUser || !['master_admin', 'superadmin'].includes(adminUser.role)) {
            return NextResponse.json({ error: 'Forbidden: Admin access required' }, { status: 403 });
        }

        const { auditor_id } = await request.json();

        if (!auditor_id) {
            return NextResponse.json({ error: 'Missing required field: auditor_id' }, { status: 400 });
        }

        // Revoke access by setting expiry to now
        const { error } = await supabase
            .from('users')
            .update({
                auditor_access_expires_at: new Date().toISOString()
            })
            .eq('id', auditor_id)
            .eq('role', 'auditor');

        if (error) {
            console.error('[RevokeAccess] Error:', error);
            return NextResponse.json({ error: error.message }, { status: 500 });
        }

        return NextResponse.json({
            success: true,
            revoked_at: new Date()
        });
    } catch (error: any) {
        console.error('[RevokeAccess] Exception:', error);
        return NextResponse.json({ error: error.message || 'Internal server error' }, { status: 500 });
    }
}


================================================================================
PATH: app\api\audit-logs\route.ts
FILENAME: route.ts
================================================================================

// @ts-nocheck
export const dynamic = 'force-dynamic';
import { NextRequest, NextResponse } from 'next/server';
import { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs';
import { cookies } from 'next/headers';

export async function GET(request: NextRequest) {
    try {
        const supabase = createRouteHandlerClient({ cookies });

        // Get current session
        const { data: { session } } = await supabase.auth.getSession();

        if (!session) {
            return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
        }

        // Verify user is superadmin
        const { data: user } = await supabase
            .from('users')
            .select('role')
            .eq('id', session.user.id)
            .single();

        if (user?.role !== 'master_admin') {
            return NextResponse.json({ error: 'Forbidden - Master Admin only' }, { status: 403 });
        }

        // Get query parameters
        const url = new URL(request.url);
        const severity = url.searchParams.get('severity');
        const action = url.searchParams.get('action');
        const startDate = url.searchParams.get('start_date');
        const endDate = url.searchParams.get('end_date');
        const limit = parseInt(url.searchParams.get('limit') || '100');

        let query = supabase
            .from('audit_logs')
            .select('*')
            .order('created_at', { ascending: false })
            .limit(limit);

        if (severity && severity !== 'all') {
            query = query.eq('severity', severity);
        }

        if (action && action !== 'all') {
            query = query.eq('action', action);
        }

        if (startDate) {
            query = query.gte('created_at', startDate);
        }

        if (endDate) {
            query = query.lte('created_at', endDate);
        }

        const { data, error } = await query;

        if (error) {
            return NextResponse.json({ error: error.message }, { status: 500 });
        }

        return NextResponse.json(data);
    } catch (error: any) {
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}


================================================================================
PATH: app\api\auditor\log-access\route.ts
FILENAME: route.ts
================================================================================

// @ts-nocheck
export const dynamic = 'force-dynamic';
import { NextRequest, NextResponse } from 'next/server';
import { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs';
import { cookies } from 'next/headers';

export async function POST(request: NextRequest) {
    try {
        const supabase = createRouteHandlerClient({ cookies });

        // Get current session
        const { data: { session } } = await supabase.auth.getSession();

        if (!session) {
            return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
        }

        // Verify user is an auditor
        const { data: user } = await supabase
            .from('users')
            .select('role')
            .eq('id', session.user.id)
            .single();

        if (user?.role !== 'auditor') {
            return NextResponse.json({ error: 'Forbidden - Auditor access only' }, { status: 403 });
        }

        const body = await request.json();
        const { action, entity_type, entity_id, outlet_id } = body;

        // Validate action
        const validActions = ['view_dashboard', 'view_record', 'view_transaction', 'export_excel', 'export_pdf', 'filter_data'];
        if (!validActions.includes(action)) {
            return NextResponse.json({ error: 'Invalid action' }, { status: 400 });
        }

        // Get IP address and user agent
        const ip_address = request.headers.get('x-forwarded-for') || request.headers.get('x-real-ip') || 'unknown';
        const user_agent = request.headers.get('user-agent') || 'unknown';

        // Insert audit log
        const { error } = await supabase
            .from('auditor_access_log')
            .insert({
                auditor_id: session.user.id,
                action,
                entity_type,
                entity_id,
                outlet_id,
                ip_address,
                user_agent
            });

        if (error) {
            console.error('Failed to log auditor access:', error);
            return NextResponse.json({ error: error.message }, { status: 500 });
        }

        return NextResponse.json({ success: true }, { status: 201 });
    } catch (error: any) {
        console.error('Error in auditor log-access:', error);
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}

// GET endpoint to retrieve audit logs (Superadmin only)
export async function GET(request: NextRequest) {
    try {
        const supabase = createRouteHandlerClient({ cookies });

        const { data: { session } } = await supabase.auth.getSession();

        if (!session) {
            return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
        }

        // Verify user is superadmin
        const { data: user } = await supabase
            .from('users')
            .select('role')
            .eq('id', session.user.id)
            .single();

        if (user?.role !== 'superadmin') {
            return NextResponse.json({ error: 'Forbidden - Superadmin only' }, { status: 403 });
        }

        // Get query parameters
        const url = new URL(request.url);
        const auditorId = url.searchParams.get('auditor_id');
        const limit = parseInt(url.searchParams.get('limit') || '100');

        let query = supabase
            .from('auditor_access_log')
            .select('*')
            .order('accessed_at', { ascending: false })
            .limit(limit);

        if (auditorId) {
            query = query.eq('auditor_id', auditorId);
        }

        const { data, error } = await query;

        if (error) {
            return NextResponse.json({ error: error.message }, { status: 500 });
        }

        return NextResponse.json(data);
    } catch (error: any) {
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}


================================================================================
PATH: app\api\categories\route.ts
FILENAME: route.ts
================================================================================

// @ts-nocheck
export const dynamic = 'force-dynamic';
import { NextRequest, NextResponse } from 'next/server';
import { createAdminClient } from '@/lib/supabase-server';

export async function GET(request: NextRequest) {
    try {
        const supabase = createAdminClient();

        const { data, error } = await supabase
            .from('categories')
            .select('*')
            .eq('is_active', true)
            .order('type, name');

        if (error) {
            console.error('Error fetching categories:', error);
            return NextResponse.json({ error: error.message }, { status: 500 });
        }

        return NextResponse.json(data);
    } catch (error: any) {
        console.error('Error in GET /api/categories:', error);
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}


================================================================================
PATH: app\api\cron\sync-sheets\route.ts
FILENAME: route.ts
================================================================================

// STEP 4: Cron endpoint for automated Google Sheets sync
// Runs hourly to sync all locked, unsynced records

import { NextRequest, NextResponse } from 'next/server';
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;

export async function POST(request: NextRequest) {
    try {
        // Verify cron secret for security
        const authHeader = request.headers.get('authorization');
        const cronSecret = process.env.CRON_SECRET || 'development-secret';

        if (authHeader !== `Bearer ${cronSecret}`) {
            console.error('Unauthorized cron request');
            return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
        }

        // Create service client (bypasses RLS)
        const supabase = createClient(supabaseUrl, supabaseServiceKey);

        // Fetch locked, unsynced records (limit 50 per run)
        const { data: records, error: fetchError } = await supabase
            .from('daily_records')
            .select('*, outlets(*)')
            .eq('status', 'locked')
            .eq('synced_to_sheets', false)
            .is('sheet_sync_error', null) // Skip records with errors (manual intervention needed)
            .order('date', { ascending: true })
            .limit(50);

        if (fetchError) {
            console.error('Error fetching records:', fetchError);
            return NextResponse.json({
                error: 'Failed to fetch records',
                details: fetchError.message
            }, { status: 500 });
        }

        if (!records || records.length === 0) {
            return NextResponse.json({
                success: true,
                message: 'No records to sync',
                synced: 0,
                failed: 0
            });
        }

        // Check if Google Sheets is configured
        const sheetsConfigured = !!(
            process.env.GOOGLE_SHEETS_CLIENT_EMAIL &&
            process.env.GOOGLE_SHEETS_PRIVATE_KEY
        );

        if (!sheetsConfigured) {
            console.warn('Google Sheets not configured, skipping sync');
            return NextResponse.json({
                success: false,
                error: 'Google Sheets not configured',
                synced: 0,
                failed: records.length
            }, { status: 503 });
        }

        // Initialize Google Sheets API
        const { google } = require('googleapis');
        const auth = new google.auth.GoogleAuth({
            credentials: {
                client_email: process.env.GOOGLE_SHEETS_CLIENT_EMAIL,
                private_key: process.env.GOOGLE_SHEETS_PRIVATE_KEY?.replace(/\\n/g, '\n'),
            },
            scopes: ['https://www.googleapis.com/auth/spreadsheets', 'https://www.googleapis.com/auth/drive'],
        });

        const sheets = google.sheets({ version: 'v4', auth });
        const drive = google.drive({ version: 'v3', auth });

        let synced = 0;
        let failed = 0;

        // Process each record
        for (const record of records) {
            try {
                // Get or create monthly sheet for this outlet
                const date = new Date(record.date);
                const monthYear = date.toLocaleDateString('en-IN', { month: 'long', year: 'numeric' });
                const sheetName = `${record.outlets.name} - ${monthYear}`;

                const folderID = process.env.GOOGLE_DRIVE_FOLDER_ID;
                let spreadsheetId: string | undefined;

                // Try to find existing sheet
                if (folderID) {
                    const listResponse = await drive.files.list({
                        q: `name='${sheetName}' and '${folderID}' in parents and mimeType='application/vnd.google-apps.spreadsheet'`,
                        fields: 'files(id, name)',
                    });

                    if (listResponse.data.files && listResponse.data.files.length > 0) {
                        spreadsheetId = listResponse.data.files[0].id || undefined;
                    }
                }

                // Create new sheet if not found
                if (!spreadsheetId) {
                    const createResponse = await sheets.spreadsheets.create({
                        requestBody: {
                            properties: {
                                title: sheetName,
                            },
                            sheets: [{
                                properties: {
                                    title: monthYear,
                                    gridProperties: {
                                        frozenRowCount: 1,
                                    }
                                }
                            }]
                        },
                    });

                    spreadsheetId = createResponse.data.spreadsheetId || undefined;

                    // Move to folder
                    if (spreadsheetId && folderID) {
                        await drive.files.update({
                            fileId: spreadsheetId,
                            addParents: folderID,
                            fields: 'id, parents',
                        });
                    }

                    // Add headers
                    if (spreadsheetId) {
                        await sheets.spreadsheets.values.update({
                            spreadsheetId,
                            range: `${monthYear}!A1:J1`,
                            valueInputOption: 'RAW',
                            requestBody: {
                                values: [[
                                    'Date', 'Opening Cash', 'Opening UPI',
                                    'Income Cash', 'Income UPI',
                                    'Expense Cash', 'Expense UPI',
                                    'Closing Cash', 'Closing UPI', 'Status'
                                ]],
                            },
                        });
                    }
                }

                // Append record data
                if (spreadsheetId) {
                    const rowData = [
                        date.toLocaleDateString('en-IN'),
                        record.opening_cash || 0,
                        record.opening_upi || 0,
                        record.income_cash || 0,
                        record.income_upi || 0,
                        record.expense_cash || 0,
                        record.expense_upi || 0,
                        record.closing_cash || 0,
                        record.closing_upi || 0,
                        record.status,
                    ];

                    await sheets.spreadsheets.values.append({
                        spreadsheetId,
                        range: `${monthYear}!A2`,
                        valueInputOption: 'RAW',
                        requestBody: {
                            values: [rowData],
                        },
                    });

                    // Mark as synced
                    await supabase
                        .from('daily_records')
                        .update({
                            synced_to_sheets: true,
                            last_synced_at: new Date().toISOString(),
                            sheet_sync_error: null
                        })
                        .eq('id', record.id);

                    // Log success
                    await supabase.from('sheet_sync_log').insert({
                        daily_record_id: record.id,
                        spreadsheet_id: spreadsheetId,
                        spreadsheet_url: `https://docs.google.com/spreadsheets/d/${spreadsheetId}/edit`,
                        sync_status: 'success',
                        sync_trigger: 'cron'
                    });

                    synced++;
                }

            } catch (error) {
                console.error(`Failed to sync record ${record.id}:`, error);
                failed++;

                // Log error
                const errorMessage = error instanceof Error ? error.message : 'Unknown error';

                await supabase
                    .from('daily_records')
                    .update({ sheet_sync_error: errorMessage })
                    .eq('id', record.id);

                await supabase.from('sheet_sync_log').insert({
                    daily_record_id: record.id,
                    sync_status: 'failed',
                    error_message: errorMessage,
                    sync_trigger: 'cron'
                });
            }
        }

        return NextResponse.json({
            success: true,
            message: `Sync complete: ${synced} succeeded, ${failed} failed`,
            synced,
            failed,
            total: records.length
        });

    } catch (error) {
        console.error('Cron sync error:', error);
        return NextResponse.json({
            error: 'Sync failed',
            details: error instanceof Error ? error.message : 'Unknown error',
        }, { status: 500 });
    }
}

// Optional GET endpoint to check cron status
export async function GET() {
    return NextResponse.json({
        service: 'Google Sheets Cron Sync',
        status: 'active',
        schedule: 'Every hour'
    });
}


================================================================================
PATH: app\api\daily-records\route.ts
FILENAME: route.ts
================================================================================

// @ts-nocheck
export const dynamic = 'force-dynamic';
import { NextRequest, NextResponse } from 'next/server';
import { createAdminClient } from '@/lib/supabase-server';

export async function GET(request: NextRequest) {
    try {
        const supabase = createAdminClient();
        const searchParams = request.nextUrl.searchParams;
        const outletId = searchParams.get('outletId') || '9e0c4614-53cf-40d3-abdd-a1d0183c3909';
        const month = searchParams.get('month'); // Format: YYYY-MM

        let query = supabase
            .from('daily_records')
            .select('*')
            .eq('outlet_id', outletId)
            .order('date', { ascending: false });

        if (month) {
            const startDate = `${month}-01`;
            const endDate = new Date(month + '-01');
            endDate.setMonth(endDate.getMonth() + 1);
            const endDateStr = endDate.toISOString().split('T')[0];

            query = query.gte('date', startDate).lt('date', endDateStr);
        }

        const { data, error } = await query;

        if (error) {
            console.error('Error fetching daily records:', error);
            return NextResponse.json({ error: error.message }, { status: 500 });
        }

        return NextResponse.json(data);
    } catch (error: any) {
        console.error('Error in GET /api/daily-records:', error);
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}


================================================================================
PATH: app\api\daily-records\today\route.ts
FILENAME: route.ts
================================================================================

// @ts-nocheck
export const dynamic = 'force-dynamic';
import { NextRequest, NextResponse } from 'next/server';
import { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs';
import { cookies } from 'next/headers';
import { createAdminClient } from '@/lib/supabase-server';

export async function GET(request: NextRequest) {
    try {
        const supabase = createRouteHandlerClient({ cookies });
        const { data: { session } } = await supabase.auth.getSession();

        const searchParams = request.nextUrl.searchParams;
        let outletId = searchParams.get('outletId');

        // If no outletId provided, try to get from logged-in user
        if (!outletId && session) {
            const adminDb = createAdminClient();
            const { data: user } = await adminDb
                .from('users')
                .select('outlet_id')
                .eq('id', session.user.id)
                .single();
            outletId = user?.outlet_id;
        }

        if (!outletId) {
            // Fallback for dev/testing only or error
            // outletId = '9e0c4614-53cf-40d3-abdd-a1d0183c3909'; 
            return NextResponse.json({ error: 'Outlet ID is required or not assigned to user' }, { status: 400 });
        }

        // Use admin client for reliable data fetching (bypassing potentially broken RLS for temporary fix)
        const adminSupabase = createAdminClient();


        // Get today's date in Asia/Kolkata timezone (IST = UTC+5:30)
        const now = new Date();
        const istOffset = 5.5 * 60 * 60 * 1000; // 5 hours 30 minutes in milliseconds
        const istTime = new Date(now.getTime() + istOffset);
        const today = istTime.toISOString().split('T')[0];

        // Try to get existing record for today
        const { data: existingRecord } = await adminSupabase
            .from('daily_records')
            .select('id,date,outlet_id,opening_cash,opening_upi,closing_cash,closing_upi,total_income,total_expense,status')
            .eq('outlet_id', outletId)
            .eq('date', today)
            .limit(1)
            .maybeSingle();

        if (existingRecord) {
            return NextResponse.json(existingRecord);
        }

        // Get previous day's closing balance (also in IST)
        const yesterday = new Date(istTime);
        yesterday.setDate(yesterday.getDate() - 1);
        const yesterdayStr = yesterday.toISOString().split('T')[0];

        const { data: previousRecord } = await adminSupabase
            .from('daily_records')
            .select('closing_cash, closing_upi')
            .eq('outlet_id', outletId)
            .eq('date', yesterdayStr)
            .maybeSingle();

        // Create new record - handles race conditions at database level
        const { data: newRecord, error: insertError } = await adminSupabase
            .from('daily_records')
            .insert({
                outlet_id: outletId,
                date: today,
                opening_cash: previousRecord?.closing_cash || 0,
                opening_upi: previousRecord?.closing_upi || 0,
                closing_cash: previousRecord?.closing_cash || 0,
                closing_upi: previousRecord?.closing_upi || 0,
                total_income: 0,
                total_expense: 0,
                status: 'draft',
            })
            .select()
            .single();

        if (insertError) {
            // Check if it's a duplicate key error (race condition)
            if (insertError.code === '23505') {
                // Another request created it, fetch and return
                console.log('[DailyRecords] Race condition detected, fetching existing record');
                const { data: raceRecord } = await adminSupabase
                    .from('daily_records')
                    .select('id,date,outlet_id,opening_cash,opening_upi,closing_cash,closing_upi,total_income,total_expense,status')
                    .eq('outlet_id', outletId)
                    .eq('date', today)
                    .limit(1)
                    .single();

                return NextResponse.json(raceRecord);
            }

            console.error('Error creating daily record:', insertError);
            return NextResponse.json(
                { error: 'Failed to create daily record', details: insertError.message },
                { status: 500 }
            );
        }

        return NextResponse.json(newRecord, { status: 201 });
    } catch (error: any) {
        console.error('Error in GET /api/daily-records/today:', {
            message: error.message,
            code: error.code,
        });
        return NextResponse.json(
            { error: 'An unexpected error occurred' },
            { status: 500 }
        );
    }
}


================================================================================
PATH: app\api\daily-records\[id]\lock\route.ts
FILENAME: route.ts
================================================================================

// @ts-nocheck
export const dynamic = 'force-dynamic';
import { NextRequest, NextResponse } from 'next/server';
import { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs';
import { cookies } from 'next/headers';

export async function POST(
    request: NextRequest,
    { params }: { params: { id: string } }
) {
    try {
        const supabase = createRouteHandlerClient({ cookies });

        // Get current session
        const { data: { session } } = await supabase.auth.getSession();

        if (!session) {
            return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
        }

        const { id } = params;

        // Get reason from request body (optional)
        const body = await request.json().catch(() => ({}));
        const reason = body.reason || null;

        // Call lock_day RPC (validates role and logs automatically)
        const { data, error } = await supabase.rpc('lock_day', {
            record_id: id,
            locked_by_user_id: session.user.id,
            lock_reason: reason
        });

        if (error) {
            console.error('Error calling lock_day RPC:', error);
            return NextResponse.json({ error: error.message }, { status: 500 });
        }

        // RPC returns JSON with success/error
        if (!data || !data.success) {
            return NextResponse.json({
                error: data?.error || 'Failed to lock record'
            }, { status: 400 });
        }

        // --- AUTOMATED SYNC START ---
        try {
            console.log(`[AutoSync] Starting sync for record ${id}...`);
            const adminSupabase = createRouteHandlerClient({ cookies }); // Need to fetch more data

            // Get daily record with outlet info
            const { data: record, error: recordError } = await adminSupabase
                .from('daily_records')
                .select('*, outlets(name, google_sheet_id)')
                .eq('id', id)
                .single();

            if (!recordError && record) {
                // Get transactions
                const { data: transactions } = await adminSupabase
                    .from('transactions')
                    .select('*')
                    .eq('daily_record_id', id);

                // Import sheetsService dynamically to avoid issues with SSR if any
                const { sheetsService } = require('@/lib/google-sheets');

                // Get or create sheet
                let sheetId = record.outlets?.google_sheet_id;
                if (!sheetId) {
                    const month = new Date(record.date).toISOString().slice(0, 7);
                    sheetId = await sheetsService.createMonthlySheet(
                        record.outlets?.name || 'Outlet',
                        month
                    );

                    // Update outlet with sheet ID
                    await adminSupabase
                        .from('outlets')
                        .update({ google_sheet_id: sheetId })
                        .eq('id', record.outlet_id);
                }

                // Sync to sheet
                await sheetsService.syncDailyRecord(sheetId, record.date, record);
                if (transactions && transactions.length > 0) {
                    await sheetsService.syncTransactions(sheetId, transactions);
                }

                // Update sync status in daily_records
                await adminSupabase
                    .from('daily_records')
                    .update({
                        synced_to_sheet: true,
                        last_synced_at: new Date().toISOString(),
                    })
                    .eq('id', id);

                console.log(`[AutoSync] âœ… Successfully synced record ${id} to sheet ${sheetId}`);
            }
        } catch (syncError) {
            console.error('[AutoSync] âŒ Failed to auto-sync:', syncError);
            // We don't fail the lock action if sync fails, but we should log it
            // The record is already locked in DB
        }
        // --- AUTOMATED SYNC END ---

        return NextResponse.json({
            success: true,
            message: data.message
        });
    } catch (error: any) {
        console.error('Error in POST /api/daily-records/[id]/lock:', error);
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}


================================================================================
PATH: app\api\daily-records\[id]\submit\route.ts
FILENAME: route.ts
================================================================================

// @ts-nocheck
export const dynamic = 'force-dynamic';
import { NextRequest, NextResponse } from 'next/server';
import { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs';
import { cookies } from 'next/headers';

export async function POST(
    request: NextRequest,
    { params }: { params: { id: string } }
) {
    try {
        const supabase = createRouteHandlerClient({ cookies });

        // Get current session
        const { data: { session } } = await supabase.auth.getSession();

        if (!session) {
            return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
        }

        const { id } = params;

        // Call submit_day RPC (validates and logs automatically)
        const { data, error } = await supabase.rpc('submit_day', {
            record_id: id,
            submitted_by_user_id: session.user.id
        });

        if (error) {
            console.error('Error calling submit_day RPC:', error);
            return NextResponse.json({ error: error.message }, { status: 500 });
        }

        // RPC returns JSON with success/error
        if (!data || !data.success) {
            return NextResponse.json({
                error: data?.error || 'Failed to submit record'
            }, { status: 400 });
        }

        return NextResponse.json({
            success: true,
            message: data.message
        });
    } catch (error: any) {
        console.error('Error in POST /api/daily-records/[id]/submit:', error);
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}


================================================================================
PATH: app\api\daily-records\[id]\sync\route.ts
FILENAME: route.ts
================================================================================

// @ts-nocheck
export const dynamic = 'force-dynamic';
import { NextRequest, NextResponse } from 'next/server';
import { createAdminClient } from '@/lib/supabase-server';
import { sheetsService } from '@/lib/google-sheets';

export async function POST(
    request: NextRequest,
    { params }: { params: { id: string } }
) {
    try {
        const supabase = createAdminClient();
        const { id } = params;

        // Get daily record
        const { data: record, error: recordError } = await supabase
            .from('daily_records')
            .select('*, outlets(name, google_sheet_id)')
            .eq('id', id)
            .single();

        if (recordError || !record) {
            return NextResponse.json({ error: 'Daily record not found' }, { status: 404 });
        }

        // Get transactions for this record
        const { data: transactions } = await supabase
            .from('transactions')
            .select('*')
            .eq('daily_record_id', id);

        // Get or create sheet
        let sheetId = record.outlets?.google_sheet_id;
        if (!sheetId) {
            const month = new Date(record.date).toISOString().slice(0, 7);
            sheetId = await sheetsService.createMonthlySheet(
                record.outlets?.name || 'Outlet',
                month
            );

            // Update outlet with sheet ID
            await supabase
                .from('outlets')
                .update({ google_sheet_id: sheetId })
                .eq('id', record.outlet_id);
        }

        // Sync to sheet
        await sheetsService.syncDailyRecord(sheetId, record.date, record);
        if (transactions && transactions.length > 0) {
            await sheetsService.syncTransactions(sheetId, transactions);
        }

        // Update sync status
        await supabase
            .from('daily_records')
            .update({
                synced_to_sheet: true,
                last_synced_at: new Date().toISOString(),
            })
            .eq('id', id);

        return NextResponse.json({ success: true, sheetId });
    } catch (error: any) {
        console.error('Error syncing to sheet:', error);
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}


================================================================================
PATH: app\api\daily-records\[id]\unlock\route.ts
FILENAME: route.ts
================================================================================

// @ts-nocheck
export const dynamic = 'force-dynamic';
import { NextRequest, NextResponse } from 'next/server';
import { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs';
import { cookies } from 'next/headers';

export async function POST(
    request: NextRequest,
    { params }: { params: { id: string } }
) {
    try {
        const supabase = createRouteHandlerClient({ cookies });

        // Get current session
        const { data: { session } } = await supabase.auth.getSession();

        const user = session?.user;
        if (user?.role !== 'master_admin') {
            return NextResponse.json({ error: 'Forbidden - Master Admin only' }, { status: 403 });
        }

        const { id } = params;

        // Get mandatory reason from request body
        const body = await request.json();
        const reason = body.reason;

        if (!reason || reason.trim() === '') {
            return NextResponse.json({
                error: 'Unlock reason is required for audit compliance'
            }, { status: 400 });
        }

        // Call unlock_day RPC (validates superadmin role and logs as critical)
        const { data, error } = await supabase.rpc('unlock_day', {
            record_id: id,
            admin_id: session.user.id,
            unlock_reason: reason
        });

        if (error) {
            console.error('Error calling unlock_day RPC:', error);
            return NextResponse.json({ error: error.message }, { status: 500 });
        }

        // RPC returns JSON with success/error
        if (!data || !data.success) {
            return NextResponse.json({
                error: data?.error || 'Failed to unlock record'
            }, { status: 400 });
        }

        return NextResponse.json({
            success: true,
            message: data.message,
            warning: data.warning,
            unlock_reason: data.unlock_reason
        });
    } catch (error: any) {
        console.error('Error in POST /api/daily-records/[id]/unlock:', error);
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}


================================================================================
PATH: app\api\dashboard\stats\route.ts
FILENAME: route.ts
================================================================================

// @ts-nocheck
export const dynamic = 'force-dynamic';
import { NextRequest, NextResponse } from 'next/server';
import { createAdminClient } from '@/lib/supabase-server';

export async function GET(request: NextRequest) {
    try {
        const supabase = createAdminClient();

        // Get the authenticated user
        const { data: { user }, error: authError } = await supabase.auth.getUser();

        if (authError || !user) {
            return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
        }

        // Get user profile with role
        const { data: profile, error: profileError } = await supabase
            .from('users')
            .select('role, outlet_id')
            .eq('id', user.id)
            .single();

        if (profileError || !profile) {
            return NextResponse.json({ error: 'Profile not found' }, { status: 404 });
        }

        let stats = {};

        // Role-specific statistics
        switch (profile.role) {
            case 'superadmin':
                stats = await getSuperAdminStats(supabase);
                break;
            case 'ho_accountant':
                stats = await getHOAccountantStats(supabase);
                break;
            case 'outlet_manager':
                stats = await getManagerStats(supabase, profile.outlet_id);
                break;
            case 'outlet_staff':
                stats = await getStaffStats(supabase, profile.outlet_id);
                break;
            default:
                return NextResponse.json({ error: 'Invalid role' }, { status: 400 });
        }

        return NextResponse.json(stats);
    } catch (error) {
        console.error('Dashboard stats error:', error);
        return NextResponse.json({ error: 'Internal server error' }, { status: 500 });
    }
}

async function getSuperAdminStats(supabase: any) {
    const [outletsResult, usersResult] = await Promise.all([
        supabase.from('outlets').select('id', { count: 'exact', head: true }),
        supabase.from('users').select('id', { count: 'exact', head: true }),
    ]);

    return {
        totalStores: outletsResult.count || 0,
        activeUsers: usersResult.count || 0,
        pendingSubmissions: 0, // Will implement with transactions
        lockedDays: 0, // Will implement with daily_records
    };
}

async function getHOAccountantStats(supabase: any) {
    return {
        pendingVerifications: 0, // Will implement with daily_records
        lockedToday: 0,
        flaggedEntries: 0,
        lateSubmissions: 0,
    };
}

async function getManagerStats(supabase: any, outletId: string | null) {
    if (!outletId) {
        return {
            todayStatus: 'No Outlet',
            todayIncome: 0,
            todayExpense: 0,
            transactionCount: 0,
        };
    }

    // Get today's date
    const today = new Date().toISOString().split('T')[0];

    return {
        todayStatus: 'Draft', // Will implement with daily_records
        todayIncome: 0,
        todayExpense: 0,
        transactionCount: 0,
    };
}

async function getStaffStats(supabase: any, outletId: string | null) {
    if (!outletId) {
        return {
            cashBalance: 0,
            upiBalance: 0,
            myTransactionsToday: 0,
        };
    }

    return {
        cashBalance: 0,
        upiBalance: 0,
        myTransactionsToday: 0,
    };
}


================================================================================
PATH: app\api\debug\manager\route.ts
FILENAME: route.ts
================================================================================

import { NextResponse } from 'next/server';
import { createAdminClient } from '@/lib/supabase-server';

export const dynamic = 'force-dynamic';

export async function GET() {
    try {
        const supabase = createAdminClient();

        const { data: user, error } = await supabase
            .from('users')
            .select('*')
            .eq('email', 'manager.test@sahakar.com')
            .single();

        if (error) {
            return NextResponse.json({ error: error.message }, { status: 500 });
        }

        return NextResponse.json({
            user,
            message: "Debug info for manager.test@sahakar.com"
        });
    } catch (error: any) {
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}


================================================================================
PATH: app\api\outlets\route.ts
FILENAME: route.ts
================================================================================

// @ts-nocheck
export const dynamic = 'force-dynamic';
import { NextRequest, NextResponse } from 'next/server';
import { createAdminClient } from '@/lib/supabase-server';

export async function GET(request: NextRequest) {
    try {
        const supabase = createAdminClient();
        const searchParams = request.nextUrl.searchParams;
        const id = searchParams.get('id');

        let query = supabase
            .from('outlets')
            .select('id,name,code,address,phone,email,created_at')
            .order('name');

        if (id) {
            query = query.eq('id', id).limit(1);
        }

        const { data, error } = await query;

        if (error) {
            return NextResponse.json({ error: error.message }, { status: 500 });
        }

        return NextResponse.json(data);
    } catch (error: any) {
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}

export async function POST(request: NextRequest) {
    try {
        const supabase = createAdminClient();
        const body = await request.json();

        const { name, code, location, phone, email } = body;

        if (!name || !code) {
            return NextResponse.json({ error: 'Name and code required' }, { status: 400 });
        }

        const { data, error } = await supabase
            .from('outlets')
            .insert({
                organization_id: '00000000-0000-0000-0000-000000000001',
                name,
                code,
                location,
                phone,
                email,
            })
            .select()
            .single();

        if (error) {
            return NextResponse.json({ error: error.message }, { status: 500 });
        }

        return NextResponse.json(data, { status: 201 });
    } catch (error: any) {
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}


================================================================================
PATH: app\api\reports\category\route.ts
FILENAME: route.ts
================================================================================

// @ts-nocheck
export const dynamic = 'force-dynamic';
import { NextRequest, NextResponse } from 'next/server';
import { createAdminClient } from '@/lib/supabase-server';

export async function GET(request: NextRequest) {
    try {
        const supabase = createAdminClient();
        const searchParams = request.nextUrl.searchParams;
        const startDate = searchParams.get('startDate');
        const endDate = searchParams.get('endDate');

        // Build query
        let query = supabase
            .from('transactions')
            .select('type,category,amount,date');

        // Apply date filters
        if (startDate) {
            query = query.gte('date', startDate);
        }
        if (endDate) {
            query = query.lte('date', endDate);
        }

        const { data: transactions, error } = await query;

        if (error) {
            console.error('Error fetching transactions:', error);
            return NextResponse.json({ error: error.message }, { status: 500 });
        }

        // Group by category and type
        const grouped = transactions?.reduce((acc: any, tx: any) => {
            const key = `${tx.category}-${tx.type}`;
            if (!acc[key]) {
                acc[key] = {
                    category: tx.category,
                    type: tx.type,
                    total: 0,
                    count: 0,
                };
            }
            acc[key].total += parseFloat(tx.amount);
            acc[key].count += 1;
            return acc;
        }, {});

        const result = Object.values(grouped || {});

        return NextResponse.json(result);
    } catch (error: any) {
        console.error('Error in GET /api/reports/category:', error);
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}


================================================================================
PATH: app\api\reports\monthly\route.ts
FILENAME: route.ts
================================================================================

// @ts-nocheck
export const dynamic = 'force-dynamic';
import { NextRequest, NextResponse } from 'next/server';
import { createAdminClient } from '@/lib/supabase-server';

export async function GET(request: NextRequest) {
    try {
        const supabase = createAdminClient();
        const searchParams = request.nextUrl.searchParams;
        const outletId = searchParams.get('outletId') || '9e0c4614-53cf-40d3-abdd-a1d0183c3909';
        const month = searchParams.get('month'); // Format: YYYY-MM

        if (!month) {
            return NextResponse.json({ error: 'Month parameter required' }, { status: 400 });
        }

        // Get all daily records for the month
        const startDate = `${month}-01`;
        const endDate = new Date(month + '-01');
        endDate.setMonth(endDate.getMonth() + 1);
        const endDateStr = endDate.toISOString().split('T')[0];

        const { data: records, error } = await supabase
            .from('daily_records')
            .select('*')
            .eq('outlet_id', outletId)
            .gte('date', startDate)
            .lt('date', endDateStr)
            .order('date', { ascending: true });

        if (error) {
            console.error('Error fetching monthly summary:', error);
            return NextResponse.json({ error: error.message }, { status: 500 });
        }

        // Calculate summary
        const summary = {
            month,
            outlet_id: outletId,
            days_count: records?.length || 0,
            total_income: 0,
            total_expense: 0,
            total_cash_in: 0,
            total_cash_out: 0,
            total_upi_in: 0,
            total_upi_out: 0,
            net_profit: 0,
            opening_balance: records?.[0]?.opening_cash + records?.[0]?.opening_upi || 0,
            closing_balance: records?.[records.length - 1]?.closing_cash + records?.[records.length - 1]?.closing_upi || 0,
        };

        if (records) {
            records.forEach(record => {
                summary.total_income += Number(record.total_income || 0);
                summary.total_expense += Number(record.total_expense || 0);
            });
            summary.net_profit = summary.total_income - summary.total_expense;
        }

        return NextResponse.json(summary);
    } catch (error: any) {
        console.error('Error in GET /api/reports/monthly:', error);
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}


================================================================================
PATH: app\api\sync\google-sheets\route.ts
FILENAME: route.ts
================================================================================

import { NextRequest, NextResponse } from 'next/server';
import { createRouteHandlerClient } from '@supabase/auth-helpers-nextjs';
import { cookies } from 'next/headers';

// This endpoint will sync locked daily records to Google Sheets
export async function POST(request: NextRequest) {
    try {
        const supabase = createRouteHandlerClient({ cookies });
        const { data: { session } } = await supabase.auth.getSession();

        if (!session) {
            return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
        }

        // Get user role to verify permissions
        const { data: user } = await supabase
            .from('users')
            .select('role')
            .eq('id', session.user.id)
            .single();

        if (user?.role !== 'ho_accountant' && user?.role !== 'master_admin' && user?.role !== 'superadmin') {
            return NextResponse.json({ error: 'Insufficient permissions' }, { status: 403 });
        }

        // Get locked daily records that need to be synced
        const { data: records, error: fetchError } = await supabase
            .from('daily_records')
            .select(`
                *,
                outlets ( name, code )
            `)
            .eq('status', 'locked')
            .order('date', { ascending: false })
            .limit(100);

        if (fetchError) {
            console.error('Error fetching records:', fetchError);
            return NextResponse.json({ error: 'Failed to fetch records' }, { status: 500 });
        }

        // Check if Google Sheets credentials are configured
        const sheetsConfigured = !!(
            process.env.GOOGLE_SHEETS_CLIENT_EMAIL &&
            process.env.GOOGLE_SHEETS_PRIVATE_KEY
        );

        if (!sheetsConfigured) {
            return NextResponse.json({
                success: false,
                error: 'Google Sheets not configured',
                message: 'Please add GOOGLE_SHEETS_CLIENT_EMAIL and GOOGLE_SHEETS_PRIVATE_KEY to environment variables',
                recordCount: records?.length || 0,
            }, { status: 503 });
        }

        // Initialize Google Sheets API
        const { google } = require('googleapis');
        const auth = new google.auth.GoogleAuth({
            credentials: {
                client_email: process.env.GOOGLE_SHEETS_CLIENT_EMAIL,
                private_key: process.env.GOOGLE_SHEETS_PRIVATE_KEY?.replace(/\\n/g, '\n'),
            },
            scopes: ['https://www.googleapis.com/auth/spreadsheets', 'https://www.googleapis.com/auth/drive'],
        });

        const sheets = google.sheets({ version: 'v4', auth });
        const drive = google.drive({ version: 'v3', auth });

        // Get or create the spreadsheet
        const folderID = process.env.GOOGLE_DRIVE_FOLDER_ID;
        const spreadsheetName = 'Sahakar Accounts - Daily Records';

        let spreadsheetId: string | undefined;

        // Try to find existing sheet in folder
        if (folderID) {
            const listResponse = await drive.files.list({
                q: `name='${spreadsheetName}' and '${folderID}' in parents and mimeType='application/vnd.google-apps.spreadsheet'`,
                fields: 'files(id, name)',
            });

            if (listResponse.data.files && listResponse.data.files.length > 0) {
                spreadsheetId = listResponse.data.files[0].id || undefined;
            }
        }

        // Create new spreadsheet if not found
        if (!spreadsheetId) {
            const createResponse = await sheets.spreadsheets.create({
                requestBody: {
                    properties: {
                        title: spreadsheetName,
                    },
                    sheets: [{
                        properties: {
                            title: 'Daily Records',
                        }
                    }]
                },
            });

            spreadsheetId = createResponse.data.spreadsheetId || undefined;

            // Move to folder if specified
            if (spreadsheetId && folderID) {
                await drive.files.update({
                    fileId: spreadsheetId,
                    addParents: folderID,
                    fields: 'id, parents',
                });
            }

            // Add headers
            await sheets.spreadsheets.values.update({
                spreadsheetId,
                range: 'Daily Records!A1:J1',
                valueInputOption: 'RAW',
                requestBody: {
                    values: [[
                        'Date', 'Outlet Code', 'Outlet Name', 'Opening Cash', 'Opening UPI',
                        'Total Income', 'Total Expense', 'Closing Cash', 'Closing UPI', 'Status'
                    ]],
                },
            });
        }

        // Prepare data rows
        const rows = records?.map(record => [
            record.date,
            record.outlets?.code || 'N/A',
            record.outlets?.name || 'N/A',
            record.opening_cash || 0,
            record.opening_upi || 0,
            record.total_income || 0,
            record.total_expense || 0,
            record.closing_cash || 0,
            record.closing_upi || 0,
            record.status,
        ]) || [];

        // Append data to sheet
        if (rows.length > 0 && spreadsheetId) {
            await sheets.spreadsheets.values.append({
                spreadsheetId,
                range: 'Daily Records!A2',
                valueInputOption: 'RAW',
                requestBody: {
                    values: rows,
                },
            });
        }

        return NextResponse.json({
            success: true,
            message: `Successfully synced ${records?.length || 0} records to Google Sheets`,
            recordCount: records?.length || 0,
            spreadsheetId,
            spreadsheetUrl: `https://docs.google.com/spreadsheets/d/${spreadsheetId}/edit`,
            synced_at: new Date().toISOString(),
        });

    } catch (error) {
        console.error('Sync error:', error);
        return NextResponse.json({
            error: 'Sync failed',
            details: error instanceof Error ? error.message : 'Unknown error',
        }, { status: 500 });
    }
}

// GET endpoint to check sync status
export async function GET(request: NextRequest) {
    try {
        const supabase = createRouteHandlerClient({ cookies });

        // Get count of locked records
        const { count, error } = await supabase
            .from('daily_records')
            .select('*', { count: 'exact', head: true })
            .eq('status', 'locked');

        if (error) {
            return NextResponse.json({ error: error.message }, { status: 500 });
        }

        const sheetsConfigured = !!(
            process.env.GOOGLE_SHEETS_CLIENT_EMAIL &&
            process.env.GOOGLE_SHEETS_PRIVATE_KEY
        );

        return NextResponse.json({
            configured: sheetsConfigured,
            locked_records_count: count || 0,
            folder_id: process.env.GOOGLE_DRIVE_FOLDER_ID || null,
        });

    } catch (error) {
        console.error('Status check error:', error);
        return NextResponse.json({ error: 'Failed to check status' }, { status: 500 });
    }
}


================================================================================
PATH: app\api\transactions\route.ts
FILENAME: route.ts
================================================================================

// @ts-nocheck
export const dynamic = 'force-dynamic';
import { NextRequest, NextResponse } from 'next/server';
import { createAdminClient } from '@/lib/supabase-server';
import { TransactionSchema } from '@/lib/validation';

export async function GET(request: NextRequest) {
    try {
        const supabase = createAdminClient();
        const searchParams = request.nextUrl.searchParams;
        const dailyRecordId = searchParams.get('dailyRecordId');

        let query = supabase
            .from('transactions')
            .select('id,daily_record_id,type,category,payment_mode,amount,description,date,created_at')
            .order('created_at', { ascending: false })
            .limit(50); // Limit to recent 50 transactions

        if (dailyRecordId) {
            query = query.eq('daily_record_id', dailyRecordId);
        }

        const { data, error } = await query;

        if (error) {
            console.error('Error fetching transactions:', error);
            return NextResponse.json({ error: error.message }, { status: 500 });
        }

        return NextResponse.json(data);
    } catch (error: any) {
        console.error('Error in GET /api/transactions:', error);
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}

export async function POST(request: NextRequest) {
    try {
        const supabase = createAdminClient();
        const body = await request.json();

        // Idempotency check - prevents duplicate transactions on retry
        const idempotencyKey = request.headers.get('x-idempotency-key');
        if (idempotencyKey) {
            const { data: existing } = await supabase
                .from('transactions')
                .select('id,daily_record_id,type,category,payment_mode,amount,description,date,created_at')
                .eq('idempotency_key', idempotencyKey)
                .limit(1)
                .maybeSingle();

            if (existing) {
                console.log('[Transactions] Duplicate request detected, returning existing');
                return NextResponse.json(existing);
            }
        }

        // Validate input with Zod schema - prevents injection & invalid data
        const validated = TransactionSchema.parse({
            dailyRecordId: body.dailyRecordId,
            type: body.type,
            category: body.category,
            paymentMode: body.paymentMode,
            amount: typeof body.amount === 'string' ? parseFloat(body.amount) : body.amount,
            description: body.description,
            createdBy: body.createdBy,
        });

        // Insert transaction
        const { data, error } = await supabase
            .from('transactions')
            .insert({
                daily_record_id: validated.dailyRecordId,
                type: validated.type,
                category: validated.category,
                payment_mode: validated.paymentMode,
                amount: validated.amount,
                description: validated.description || null,
                created_by: validated.createdBy || null,
                idempotency_key: idempotencyKey || null,
            })
            .select()
            .single();

        if (error) {
            console.error('Error creating transaction:', error);
            return NextResponse.json(
                { error: 'Failed to create transaction', details: error.message },
                { status: 500 }
            );
        }

        return NextResponse.json(data, { status: 201 });
    } catch (error: any) {
        // Zod validation error
        if (error.name === 'ZodError') {
            return NextResponse.json(
                {
                    error: 'Validation failed',
                    details: error.errors.map((e: any) => `${e.path.join('.')}: ${e.message}`).join(', ')
                },
                { status: 400 }
            );
        }

        // Sanitized error logging - never log sensitive data
        console.error('Error in POST /api/transactions:', {
            message: error.message,
            code: error.code,
        });

        return NextResponse.json(
            { error: 'An unexpected error occurred' },
            { status: 500 }
        );
    }
}


================================================================================
PATH: app\api\transactions\[id]\route.ts
FILENAME: route.ts
================================================================================

// @ts-nocheck
export const dynamic = 'force-dynamic';
import { NextRequest, NextResponse } from 'next/server';
import { createAdminClient } from '@/lib/supabase-server';

export async function PATCH(
    request: NextRequest,
    { params }: { params: { id: string } }
) {
    try {
        const supabase = createAdminClient();
        const body = await request.json();
        const { id } = params;

        const { type, category, paymentMode, amount, description } = body;

        const updateData: any = {};
        if (type) updateData.type = type;
        if (category) updateData.category = category;
        if (paymentMode) updateData.payment_mode = paymentMode;
        if (amount !== undefined) updateData.amount = amount;
        if (description !== undefined) updateData.description = description;

        const { data, error } = await supabase
            .from('transactions')
            .update(updateData)
            .eq('id', id)
            .select()
            .single();

        if (error) {
            console.error('Error updating transaction:', error);
            return NextResponse.json({ error: error.message }, { status: 500 });
        }

        return NextResponse.json(data);
    } catch (error: any) {
        console.error('Error in PATCH /api/transactions/[id]:', error);
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}

export async function DELETE(
    request: NextRequest,
    { params }: { params: { id: string } }
) {
    try {
        const supabase = createAdminClient();
        const { id } = params;

        const { error } = await supabase
            .from('transactions')
            .delete()
            .eq('id', id);

        if (error) {
            console.error('Error deleting transaction:', error);
            return NextResponse.json({ error: error.message }, { status: 500 });
        }

        return NextResponse.json({ success: true });
    } catch (error: any) {
        console.error('Error in DELETE /api/transactions/[id]:', error);
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}


================================================================================
PATH: app\api\users\route.ts
FILENAME: route.ts
================================================================================

// @ts-nocheck
export const dynamic = 'force-dynamic';
import { NextRequest, NextResponse } from 'next/server';
import { createAdminClient } from '@/lib/supabase-server';

export async function GET(request: NextRequest) {
    try {
        const supabase = createAdminClient();

        const { data, error } = await supabase
            .from('users')
            .select('id,email,name,role,outlet_id,phone,created_at')
            .order('created_at', { ascending: false })
            .limit(100); // Limit to 100 users

        if (error) {
            return NextResponse.json({ error: error.message }, { status: 500 });
        }

        return NextResponse.json(data);
    } catch (error: any) {
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}

export async function POST(request: NextRequest) {
    try {
        const supabase = createAdminClient();
        const body = await request.json();

        const { email, fullName, role, phone, outletId } = body;

        if (!email || !fullName || !role) {
            return NextResponse.json(
                { error: 'Email, name, and role required' },
                { status: 400 }
            );
        }

        // Create auth user first
        const { data: authData, error: authError } = await supabase.auth.admin.createUser({
            email,
            password: 'Zabnix@2025', // Default password
            email_confirm: true,
        });

        if (authError) {
            return NextResponse.json({ error: authError.message }, { status: 500 });
        }

        // Create user profile with outlet_id if provided
        const { data, error } = await supabase
            .from('users')
            .insert({
                id: authData.user.id,
                email,
                name: fullName,
                role,
                phone,
                outlet_id: outletId || null,
            })
            .select()
            .single();

        if (error) {
            // Rollback auth user if profile creation fails
            await supabase.auth.admin.deleteUser(authData.user.id);
            return NextResponse.json({ error: error.message }, { status: 500 });
        }

        // Outlet is already set in the insert above, no need for separate table

        return NextResponse.json(data, { status: 201 });
    } catch (error: any) {
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}


================================================================================
PATH: app\globals.css
FILENAME: globals.css
================================================================================

@tailwind base;
@tailwind components;
@tailwind utilities;

@layer base {
  :root {
    --background: 0 0% 100%;
    --foreground: 240 10% 3.9%;
    --card: 0 0% 100%;
    --card-foreground: 240 10% 3.9%;
    --popover: 0 0% 100%;
    --popover-foreground: 240 10% 3.9%;
    --primary: 240 5.9% 10%;
    --primary-foreground: 0 0% 98%;
    --secondary: 240 4.8% 95.9%;
    --secondary-foreground: 240 5.9% 10%;
    --muted: 240 4.8% 95.9%;
    --muted-foreground: 240 3.8% 46.1%;
    --accent: 240 4.8% 95.9%;
    --accent-foreground: 240 5.9% 10%;
    --destructive: 0 84.2% 60.2%;
    --destructive-foreground: 0 0% 98%;
    --border: 240 5.9% 90%;
    --input: 240 5.9% 90%;
    --ring: 240 5.9% 10%;
    --radius: 0.5rem;
  }

  .dark {
    --background: 240 10% 3.9%;
    --foreground: 0 0% 98%;
    --card: 240 10% 3.9%;
    --card-foreground: 0 0% 98%;
    --popover: 240 10% 3.9%;
    --popover-foreground: 0 0% 98%;
    --primary: 0 0% 98%;
    --primary-foreground: 240 5.9% 10%;
    --secondary: 240 3.7% 15.9%;
    --secondary-foreground: 0 0% 98%;
    --muted: 240 3.7% 15.9%;
    --muted-foreground: 240 5% 64.9%;
    --accent: 240 3.7% 15.9%;
    --accent-foreground: 0 0% 98%;
    --destructive: 0 62.8% 30.6%;
    --destructive-foreground: 0 0% 98%;
    --border: 240 3.7% 15.9%;
    --input: 240 3.7% 15.9%;
    --ring: 240 4.9% 83.9%;
  }
}

@layer base {
  * {
    @apply border-border;
  }
  body {
    @apply bg-background text-foreground;
  }
}


================================================================================
PATH: app\layout.tsx
FILENAME: layout.tsx
================================================================================

import './globals.css';
import type { Metadata } from 'next';
import { Inter } from 'next/font/google';
import { Providers } from '@/components/providers';

const inter = Inter({ subsets: ['latin'] });

export const metadata: Metadata = {
    title: 'Sahakar Accounts - Hyperpharmacy Accounting System',
    description: 'Multi-tenant accounting system for hyperpharmacies',
};

export default function RootLayout({
    children,
}: {
    children: React.ReactNode;
}) {
    return (
        <html lang="en" suppressHydrationWarning>
            <body className={inter.className}>
                <Providers>
                    {children}
                </Providers>
            </body>
        </html>
    );
}


================================================================================
PATH: app\page.tsx
FILENAME: page.tsx
================================================================================

import { redirect } from 'next/navigation';

export default function HomePage() {
    redirect('/dashboard');
}


================================================================================
PATH: components\auditor-banner.tsx
FILENAME: auditor-banner.tsx
================================================================================

'use client';

import { Shield, AlertCircle } from 'lucide-react';

interface AuditorBannerProps {
    accessEndDate: string | null;
    userName: string;
}

export function AuditorBanner({ accessEndDate, userName }: AuditorBannerProps) {
    if (!accessEndDate) {
        return (
            <div className="bg-red-50 border-l-4 border-red-500 p-4 mb-6">
                <div className="flex items-center gap-3">
                    <Shield className="w-6 h-6 text-red-600" />
                    <div className="flex-1">
                        <h3 className="font-bold text-red-900 flex items-center gap-2">
                            READ-ONLY AUDITOR MODE
                            <span className="text-xs px-2 py-1 bg-red-600 text-white rounded">ACTIVE</span>
                        </h3>
                        <p className="text-sm text-red-700 mt-1">
                            Logged in as: <strong>{userName}</strong> | Access: Indefinite
                        </p>
                        <p className="text-xs text-red-600 mt-2 flex items-center gap-1">
                            <AlertCircle className="w-4 h-4" />
                            âš ï¸ No modifications allowed. All actions are logged for audit compliance.
                        </p>
                    </div>
                </div>
            </div>
        );
    }

    const expiryDate = new Date(accessEndDate);
    const today = new Date();
    const daysRemaining = Math.ceil((expiryDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));
    const isExpiringSoon = daysRemaining <= 7;
    const isExpired = daysRemaining < 0;

    const bgColor = isExpired ? 'bg-gray-100' : isExpiringSoon ? 'bg-orange-50' : 'bg-red-50';
    const borderColor = isExpired ? 'border-gray-500' : isExpiringSoon ? 'border-orange-500' : 'border-red-500';
    const textColor = isExpired ? 'text-gray-900' : isExpiringSoon ? 'text-orange-900' : 'text-red-900';
    const subTextColor = isExpired ? 'text-gray-700' : isExpiringSoon ? 'text-orange-700' : 'text-red-700';

    return (
        <div className={`${bgColor} border-l-4 ${borderColor} p-4 mb-6`}>
            <div className="flex items-center gap-3">
                <Shield className={`w-6 h-6 ${isExpired ? 'text-gray-600' : isExpiringSoon ? 'text-orange-600' : 'text-red-600'}`} />
                <div className="flex-1">
                    <h3 className={`font-bold ${textColor} flex items-center gap-2`}>
                        READ-ONLY AUDITOR MODE
                        {isExpired && (
                            <span className="text-xs px-2 py-1 bg-gray-600 text-white rounded">EXPIRED</span>
                        )}
                        {isExpiringSoon && !isExpired && (
                            <span className="text-xs px-2 py-1 bg-orange-600 text-white rounded">EXPIRING SOON</span>
                        )}
                        {!isExpired && !isExpiringSoon && (
                            <span className="text-xs px-2 py-1 bg-red-600 text-white rounded">ACTIVE</span>
                        )}
                    </h3>
                    <p className={`text-sm ${subTextColor} mt-1`}>
                        Logged in as: <strong>{userName}</strong>
                    </p>
                    <p className={`text-sm ${subTextColor} mt-1`}>
                        Access expires on: <strong>{expiryDate.toLocaleDateString('en-IN', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        })}</strong>
                        {!isExpired && (
                            <span className="ml-2">
                                ({daysRemaining} {daysRemaining === 1 ? 'day' : 'days'} remaining)
                            </span>
                        )}
                        {isExpired && (
                            <span className="ml-2 text-red-600 font-semibold">
                                (Access Expired - Contact Administrator)
                            </span>
                        )}
                    </p>
                    <p className={`text-xs mt-2 flex items-center gap-1 ${isExpired ? 'text-gray-600' : subTextColor}`}>
                        <AlertCircle className="w-4 h-4" />
                        âš ï¸ No modifications allowed. All actions are logged for audit compliance.
                    </p>
                </div>
            </div>
        </div>
    );
}


================================================================================
PATH: components\auth-error-state.tsx
FILENAME: auth-error-state.tsx
================================================================================

export function AuthErrorState({ message }: { message: string }) {
    return (
        <div className="min-h-screen flex items-center justify-center bg-gray-50">
            <div className="text-center max-w-md px-4">
                <div className="mb-4">
                    <svg
                        className="mx-auto h-12 w-12 text-red-500"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            strokeLinecap="round"
                            strokeLinejoin="round"
                            strokeWidth={2}
                            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
                        />
                    </svg>
                </div>
                <h2 className="text-2xl font-bold text-gray-900 mb-2">
                    Authentication Error
                </h2>
                <p className="text-gray-600 mb-6">{message}</p>
                <button
                    onClick={() => window.location.href = '/login'}
                    className="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                >
                    Return to Login
                </button>
            </div>
        </div>
    );
}


================================================================================
PATH: components\balance-summary.tsx
FILENAME: balance-summary.tsx
================================================================================

'use client';

import React from 'react';
import { useQuery } from '@tanstack/react-query';
import { Flag, TrendingUp, TrendingDown, Target, ArrowUp, ArrowDown } from 'lucide-react';

interface BalanceSummaryProps {
    outletId?: string;
}

interface DailyRecord {
    id: string;
    date: string;
    opening_cash: number;
    opening_upi: number;
    closing_cash: number;
    closing_upi: number;
    total_income: number;
    total_expense: number;
    status: 'draft' | 'submitted' | 'locked';
}

export function BalanceSummary({ outletId }: BalanceSummaryProps) {
    // Fetch today's daily record
    const { data: dailyRecord, isLoading } = useQuery<DailyRecord>({
        queryKey: ['daily-record-today', outletId],
        queryFn: async () => {
            const url = outletId
                ? `/api/daily-records/today?outletId=${outletId}`
                : '/api/daily-records/today';
            const res = await fetch(url);
            if (!res.ok) throw new Error('Failed to fetch daily record');
            return res.json();
        },
    });

    if (isLoading) {
        return (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                {[1, 2, 3, 4].map((i) => (
                    <div key={i} className="bg-white rounded-lg shadow p-6 animate-pulse">
                        <div className="h-4 bg-gray-200 rounded w-3/4 mb-4"></div>
                        <div className="h-8 bg-gray-200 rounded w-1/2"></div>
                    </div>
                ))}
            </div>
        );
    }

    if (!dailyRecord) {
        return (
            <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center">
                <p className="text-yellow-800">No daily record found. Please create today's entry.</p>
            </div>
        );
    }

    const openingTotal = dailyRecord.opening_cash + dailyRecord.opening_upi;
    const closingTotal = dailyRecord.closing_cash + dailyRecord.closing_upi;
    const netChange = closingTotal - openingTotal;

    const balanceCards = [
        {
            label: 'Opening Balance',
            value: openingTotal,
            Icon: Flag,
            color: 'from-green-500 to-emerald-600',
            breakdown: `Cash: â‚¹${dailyRecord.opening_cash.toLocaleString('en-IN')} | UPI: â‚¹${dailyRecord.opening_upi.toLocaleString('en-IN')}`,
        },
        {
            label: 'Total Income',
            value: dailyRecord.total_income,
            Icon: TrendingUp,
            color: 'from-blue-500 to-cyan-600',
            breakdown: null,
        },
        {
            label: 'Total Expense',
            value: dailyRecord.total_expense,
            Icon: TrendingDown,
            color: 'from-red-500 to-pink-600',
            breakdown: null,
        },
        {
            label: 'Closing Balance',
            value: closingTotal,
            Icon: Target,
            color: 'from-purple-500 to-indigo-600',
            breakdown: `Cash: â‚¹${dailyRecord.closing_cash.toLocaleString('en-IN')} | UPI: â‚¹${dailyRecord.closing_upi.toLocaleString('en-IN')}`,
        },
    ];

    return (
        <div className="space-y-4">
            {/* Balance Cards Grid */}
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                {balanceCards.map((card, index) => (
                    <div
                        key={index}
                        className={`bg-gradient-to-br ${card.color} rounded-lg shadow-lg p-6 text-white`}
                    >
                        <div className="flex items-center justify-between mb-2">
                            <p className="text-sm opacity-90 font-medium">{card.label}</p>
                            <card.Icon className="w-6 h-6" />
                        </div>
                        <p className="text-3xl font-bold mb-1">
                            â‚¹{card.value.toLocaleString('en-IN', {
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2,
                            })}
                        </p>
                        {card.breakdown && (
                            <p className="text-xs opacity-75 mt-2">{card.breakdown}</p>
                        )}
                    </div>
                ))}
            </div>

            {/* Net Change Indicator */}
            <div className={`rounded-lg p-4 ${netChange >= 0 ? 'bg-green-50 border border-green-200' : 'bg-red-50 border border-red-200'}`}>
                <div className="flex items-center justify-between">
                    <div className="flex items-center gap-2">
                        {netChange >= 0 ? (
                            <ArrowUp className="w-6 h-6 text-green-600" />
                        ) : (
                            <ArrowDown className="w-6 h-6 text-red-600" />
                        )}
                        <span className={`font-medium ${netChange >= 0 ? 'text-green-800' : 'text-red-800'}`}>
                            Net Change Today
                        </span>
                    </div>
                    <span className={`text-2xl font-bold ${netChange >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                        {netChange >= 0 ? '+' : ''}â‚¹{netChange.toLocaleString('en-IN', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2,
                        })}
                    </span>
                </div>
                <p className={`text-sm mt-2 ${netChange >= 0 ? 'text-green-700' : 'text-red-700'}`}>
                    Formula: Closing Balance - Opening Balance = (Opening + Income - Expense)
                </p>
            </div>

            {/* Status Badge */}
            <div className="flex justify-end">
                <span className={`px-4 py-2 rounded-full text-sm font-medium ${dailyRecord.status === 'draft' ? 'bg-gray-100 text-gray-800' :
                    dailyRecord.status === 'submitted' ? 'bg-blue-100 text-blue-800' :
                        'bg-green-100 text-green-800'
                    }`}>
                    Status: {dailyRecord.status.toUpperCase()}
                </span>
            </div>
        </div>
    );
}


================================================================================
PATH: components\create-outlet-modal.tsx
FILENAME: create-outlet-modal.tsx
================================================================================

'use client';

import { useState } from 'react';
import { X, Building2, Loader2 } from 'lucide-react';

interface CreateOutletModalProps {
    isOpen: boolean;
    onClose: () => void;
    onSuccess: () => void;
}

export function CreateOutletModal({ isOpen, onClose, onSuccess }: CreateOutletModalProps) {
    const [formData, setFormData] = useState({
        name: '',
        code: '',
        location: '',
        phone: '',
        email: '',
    });
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState('');

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        setLoading(true);
        setError('');

        try {
            const res = await fetch('/api/outlets', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData),
            });

            if (!res.ok) {
                const data = await res.json();
                throw new Error(data.error || 'Failed to create outlet');
            }

            // Success
            onSuccess();
            onClose();

            // Reset form
            setFormData({
                name: '',
                code: '',
                location: '',
                phone: '',
                email: '',
            });
        } catch (err: any) {
            setError(err.message);
        } finally {
            setLoading(false);
        }
    };

    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-lg shadow-xl w-full max-w-md">
                {/* Header */}
                <div className="flex items-center justify-between p-6 border-b">
                    <div className="flex items-center gap-2">
                        <Building2 className="w-5 h-5 text-green-600" />
                        <h2 className="text-xl font-bold text-gray-900">Add New Outlet</h2>
                    </div>
                    <button
                        onClick={onClose}
                        className="text-gray-400 hover:text-gray-600 transition-colors"
                    >
                        <X className="w-5 h-5" />
                    </button>
                </div>

                {/* Form */}
                <form onSubmit={handleSubmit} className="p-6 space-y-4">
                    {error && (
                        <div className="bg-red-50 border border-red-200 rounded-lg p-3">
                            <p className="text-sm text-red-800">{error}</p>
                        </div>
                    )}

                    {/* Outlet Name */}
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                            Outlet Name *
                        </label>
                        <input
                            type="text"
                            required
                            value={formData.name}
                            onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                            placeholder="Main Branch"
                        />
                    </div>

                    {/* Outlet Code */}
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                            Outlet Code *
                        </label>
                        <input
                            type="text"
                            required
                            value={formData.code}
                            onChange={(e) => setFormData({ ...formData, code: e.target.value.toUpperCase() })}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent uppercase"
                            placeholder="MB001"
                            maxLength={10}
                        />
                        <p className="text-xs text-gray-500 mt-1">
                            Unique code (auto-converted to uppercase)
                        </p>
                    </div>

                    {/* Location/Address */}
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                            Location/Address
                        </label>
                        <textarea
                            value={formData.location}
                            onChange={(e) => setFormData({ ...formData, location: e.target.value })}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                            placeholder="Street, City, State, PIN"
                            rows={3}
                        />
                    </div>

                    {/* Phone */}
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                            Phone Number
                        </label>
                        <input
                            type="tel"
                            value={formData.phone}
                            onChange={(e) => setFormData({ ...formData, phone: e.target.value })}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                            placeholder="+91 98765 43210"
                        />
                    </div>

                    {/* Email */}
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                            Email Address
                        </label>
                        <input
                            type="email"
                            value={formData.email}
                            onChange={(e) => setFormData({ ...formData, email: e.target.value })}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                            placeholder="outlet@example.com"
                        />
                    </div>

                    {/* Buttons */}
                    <div className="flex gap-3 pt-4">
                        <button
                            type="button"
                            onClick={onClose}
                            className="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
                            disabled={loading}
                        >
                            Cancel
                        </button>
                        <button
                            type="submit"
                            disabled={loading}
                            className="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                        >
                            {loading ? (
                                <>
                                    <Loader2 className="w-4 h-4 animate-spin" />
                                    Creating...
                                </>
                            ) : (
                                <>
                                    <Building2 className="w-4 h-4" />
                                    Create Outlet
                                </>
                            )}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
}


================================================================================
PATH: components\create-user-modal.tsx
FILENAME: create-user-modal.tsx
================================================================================

'use client';

import { useState } from 'react';
import { X, UserPlus, Loader2 } from 'lucide-react';

interface CreateUserModalProps {
    isOpen: boolean;
    onClose: () => void;
    onSuccess: () => void;
}

export function CreateUserModal({ isOpen, onClose, onSuccess }: CreateUserModalProps) {
    const [formData, setFormData] = useState({
        email: '',
        fullName: '',
        role: 'outlet_staff',
        phone: '',
        outletId: '',
    });
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState('');

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        setLoading(true);
        setError('');

        try {
            const res = await fetch('/api/users', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData),
            });

            if (!res.ok) {
                const data = await res.json();
                throw new Error(data.error || 'Failed to create user');
            }

            // Success
            onSuccess();
            onClose();

            // Reset form
            setFormData({
                email: '',
                fullName: '',
                role: 'outlet_staff',
                phone: '',
                outletId: '',
            });
        } catch (err: any) {
            setError(err.message);
        } finally {
            setLoading(false);
        }
    };

    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-lg shadow-xl w-full max-w-md">
                {/* Header */}
                <div className="flex items-center justify-between p-6 border-b">
                    <div className="flex items-center gap-2">
                        <UserPlus className="w-5 h-5 text-blue-600" />
                        <h2 className="text-xl font-bold text-gray-900">Create New User</h2>
                    </div>
                    <button
                        onClick={onClose}
                        className="text-gray-400 hover:text-gray-600 transition-colors"
                    >
                        <X className="w-5 h-5" />
                    </button>
                </div>

                {/* Form */}
                <form onSubmit={handleSubmit} className="p-6 space-y-4">
                    {error && (
                        <div className="bg-red-50 border border-red-200 rounded-lg p-3">
                            <p className="text-sm text-red-800">{error}</p>
                        </div>
                    )}

                    {/* Email */}
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                            Email Address *
                        </label>
                        <input
                            type="email"
                            required
                            value={formData.email}
                            onChange={(e) => setFormData({ ...formData, email: e.target.value })}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="user@example.com"
                        />
                    </div>

                    {/* Full Name */}
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                            Full Name *
                        </label>
                        <input
                            type="text"
                            required
                            value={formData.fullName}
                            onChange={(e) => setFormData({ ...formData, fullName: e.target.value })}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="John Doe"
                        />
                    </div>

                    {/* Role */}
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                            Role *
                        </label>
                        <select
                            required
                            value={formData.role}
                            onChange={(e) => setFormData({ ...formData, role: e.target.value })}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        >
                            <option value="outlet_staff">Outlet Staff</option>
                            <option value="outlet_manager">Outlet Manager</option>
                            <option value="ho_accountant">HO Accountant</option>
                            <option value="master_admin">Master Admin</option>
                            <option value="auditor">Auditor</option>
                            <option value="superadmin">Superadmin</option>
                        </select>
                    </div>

                    {/* Phone */}
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1">
                            Phone Number
                        </label>
                        <input
                            type="tel"
                            value={formData.phone}
                            onChange={(e) => setFormData({ ...formData, phone: e.target.value })}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            placeholder="+91 98765 43210"
                        />
                    </div>

                    {/* Outlet ID (Optional - for staff/manager) */}
                    {(formData.role === 'outlet_staff' || formData.role === 'outlet_manager') && (
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                                Outlet ID (Optional)
                            </label>
                            <input
                                type="text"
                                value={formData.outletId}
                                onChange={(e) => setFormData({ ...formData, outletId: e.target.value })}
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="Enter outlet UUID"
                            />
                            <p className="text-xs text-gray-500 mt-1">
                                Leave blank to assign later
                            </p>
                        </div>
                    )}

                    {/* Info Box */}
                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                        <p className="text-sm text-blue-800">
                            <strong>Default Password:</strong> Zabnix@2025
                            <br />
                            <span className="text-xs">User can change password after first login</span>
                        </p>
                    </div>

                    {/* Buttons */}
                    <div className="flex gap-3 pt-4">
                        <button
                            type="button"
                            onClick={onClose}
                            className="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
                            disabled={loading}
                        >
                            Cancel
                        </button>
                        <button
                            type="submit"
                            disabled={loading}
                            className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                        >
                            {loading ? (
                                <>
                                    <Loader2 className="w-4 h-4 animate-spin" />
                                    Creating...
                                </>
                            ) : (
                                <>
                                    <UserPlus className="w-4 h-4" />
                                    Create User
                                </>
                            )}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
}


================================================================================
PATH: components\daily-record-actions.tsx
FILENAME: daily-record-actions.tsx
================================================================================

'use client';

import React, { useState } from 'react';
import { useMutation, useQueryClient } from '@tanstack/react-query';
import { SubmitReviewModal } from './submit-review-modal';

interface DailyRecordActionsProps {
    recordId: string;
    status: 'draft' | 'submitted' | 'locked';
}

export function DailyRecordActions({ recordId, status }: DailyRecordActionsProps) {
    const queryClient = useQueryClient();
    const [showSubmitModal, setShowSubmitModal] = useState(false);

    const submitRecord = useMutation({
        mutationFn: async () => {
            const res = await fetch(`/api/daily-records/${recordId}/submit`, {
                method: 'POST',
            });
            if (!res.ok) throw new Error('Failed to submit record');
            return res.json();
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['daily-record-today'] });
        },
    });

    const lockRecord = useMutation({
        mutationFn: async () => {
            const res = await fetch(`/api/daily-records/${recordId}/lock`, {
                method: 'POST',
            });
            if (!res.ok) throw new Error('Failed to lock record');
            return res.json();
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['daily-record-today'] });
        },
    });

    if (status === 'locked') {
        return (
            <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                <div className="flex items-center gap-2">
                    <svg className="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                    <span className="font-medium text-green-900">Record Locked</span>
                </div>
                <p className="text-sm text-green-700 mt-1">
                    This daily record has been finalized and cannot be modified.
                </p>
            </div>
        );
    }

    if (status === 'submitted') {
        return (
            <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <div className="flex items-center justify-between">
                    <div>
                        <div className="flex items-center gap-2">
                            <svg className="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <span className="font-medium text-yellow-900">Submitted for Review</span>
                        </div>
                        <p className="text-sm text-yellow-700 mt-1">
                            Waiting for manager approval to lock.
                        </p>
                    </div>
                    <button
                        onClick={() => lockRecord.mutate()}
                        disabled={lockRecord.isPending}
                        className="px-4 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 disabled:bg-gray-400"
                    >
                        {lockRecord.isPending ? 'Locking...' : 'ðŸ”’ Lock Record'}
                    </button>
                </div>
            </div>
        );
    }

    // Draft status
    return (
        <>
            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div className="flex items-center justify-between">
                    <div>
                        <div className="flex items-center gap-2">
                            <svg className="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                            <span className="font-medium text-blue-900">Draft</span>
                        </div>
                        <p className="text-sm text-blue-700 mt-1">
                            You can add or modify transactions.
                        </p>
                    </div>
                    <button
                        onClick={() => setShowSubmitModal(true)}
                        className="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700"
                    >
                        âœ“ Review & Submit
                    </button>
                </div>
            </div>

            {/* Submit Review Modal */}
            <SubmitReviewModal
                isOpen={showSubmitModal}
                onClose={() => setShowSubmitModal(false)}
                recordId={recordId}
                date={new Date().toISOString()}
            />
        </>
    );
}


================================================================================
PATH: components\dashboard-card.tsx
FILENAME: dashboard-card.tsx
================================================================================

import { ReactNode } from 'react';

interface DashboardCardProps {
    title: string;
    value: string | number;
    subtitle?: string;
    icon?: ReactNode;
    trend?: 'up' | 'down' | 'neutral';
    trendValue?: string;
    colorClass?: string;
}

export function DashboardCard({
    title,
    value,
    subtitle,
    icon,
    trend,
    trendValue,
    colorClass = 'text-gray-900',
}: DashboardCardProps) {
    const getTrendIcon = () => {
        if (!trend) return null;
        if (trend === 'up') return 'â†‘';
        if (trend === 'down') return 'â†“';
        return 'â†’';
    };

    const getTrendColor = () => {
        if (trend === 'up') return 'text-green-600';
        if (trend === 'down') return 'text-red-600';
        return 'text-gray-600';
    };

    return (
        <div className="bg-white p-6 rounded-lg shadow hover:shadow-md transition-shadow">
            <div className="flex items-start justify-between">
                <div className="flex-1">
                    <h3 className="text-sm font-medium text-gray-500">{title}</h3>
                    <p className={`text-3xl font-bold ${colorClass} mt-2`}>{value}</p>
                    {subtitle && <p className="text-sm text-gray-600 mt-1">{subtitle}</p>}
                    {trend && trendValue && (
                        <p className={`text-sm ${getTrendColor()} mt-2`}>
                            {getTrendIcon()} {trendValue}
                        </p>
                    )}
                </div>
                {icon && <div className="text-gray-400 ml-4">{icon}</div>}
            </div>
        </div>
    );
}


================================================================================
PATH: components\dashboard-nav.tsx
FILENAME: dashboard-nav.tsx
================================================================================

'use client';

import Link from 'next/link';
import { usePathname } from 'next/navigation';
import { cn } from '@/lib/utils';

interface NavItem {
    name: string;
    href: string;
    icon: React.ReactNode;
    roles: string[];
}

const navigation: NavItem[] = [
    {
        name: 'Dashboard',
        href: '/dashboard',
        roles: ['master_admin', 'ho_accountant', 'outlet_manager', 'outlet_staff'],
        icon: (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
            </svg>
        ),
    },
    {
        name: 'Daily Entry',
        href: '/dashboard/staff',
        roles: ['outlet_manager', 'outlet_staff'],
        icon: (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
        ),
    },
    {
        name: 'Monthly View',
        href: '/dashboard/monthly',
        roles: ['master_admin', 'ho_accountant', 'outlet_manager'],
        icon: (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
        ),
    },
    {
        name: 'Reports',
        href: '/dashboard/reports',
        roles: ['master_admin', 'ho_accountant', 'outlet_manager'],
        icon: (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
        ),
    },
    {
        name: 'Cash Flow',
        href: '/dashboard/cash-flow',
        roles: ['master_admin', 'ho_accountant', 'outlet_manager'],
        icon: (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        ),
    },
    {
        name: 'Outlets',
        href: '/dashboard/outlets',
        roles: ['master_admin'],
        icon: (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
            </svg>
        ),
    },
    {
        name: 'Users',
        href: '/dashboard/users',
        roles: ['master_admin', 'outlet_manager'],
        icon: (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
            </svg>
        ),
    },
    {
        name: 'Audit View',
        href: '/dashboard/auditor',
        roles: ['auditor'],
        icon: (
            <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
            </svg>
        ),
    },
];

export function DashboardNav({ role }: { role: string }) {
    const pathname = usePathname();

    const filteredNav = navigation.filter((item) =>
        item.roles.includes(role)
    );

    return (
        <nav className="px-3 py-6 space-y-1">
            {filteredNav.map((item) => {
                const isActive = pathname === item.href;
                return (
                    <Link
                        key={item.name}
                        href={item.href}
                        className={cn(
                            'flex items-center space-x-3 px-3 py-2 rounded-lg text-sm font-medium transition-colors',
                            isActive
                                ? 'bg-blue-50 text-blue-700'
                                : 'text-gray-700 hover:bg-gray-100 hover:text-gray-900'
                        )}
                    >
                        {item.icon}
                        <span>{item.name}</span>
                    </Link>
                );
            })}
        </nav>
    );
}


================================================================================
PATH: components\live-balance.tsx
FILENAME: live-balance.tsx
================================================================================

'use client';

import React from 'react';
import { TrendingUp, TrendingDown, Minus } from 'lucide-react';

interface LiveBalanceProps {
    cashBalance: number;
    upiBalance: number;
    openingCash?: number;
    openingUpi?: number;
}

export function LiveBalance({ cashBalance, upiBalance, openingCash = 0, openingUpi = 0 }: LiveBalanceProps) {
    const totalBalance = cashBalance + upiBalance;
    const totalOpening = openingCash + openingUpi;

    const cashChange = cashBalance - openingCash;
    const upiChange = upiBalance - openingUpi;
    const totalChange = totalBalance - totalOpening;

    const getCashProgress = () => {
        if (openingCash === 0) return 100;
        return Math.min((cashBalance / openingCash) * 100, 200);
    };

    const getUpiProgress = () => {
        if (openingUpi === 0) return 100;
        return Math.min((upiBalance / openingUpi) * 100, 200);
    };

    const getChangeIcon = (change: number) => {
        if (change > 0) return <TrendingUp className="w-4 h-4 text-green-300" />;
        if (change < 0) return <TrendingDown className="w-4 h-4 text-red-300" />;
        return <Minus className="w-4 h-4 text-gray-300" />;
    };

    const getChangeColor = (change: number) => {
        if (change > 0) return 'text-green-300';
        if (change < 0) return 'text-red-300';
        return 'text-gray-300';
    };

    return (
        <div className="bg-gradient-to-br from-blue-600 via-indigo-600 to-purple-600 rounded-lg shadow-lg p-6 text-white">
            <div className="flex items-center justify-between mb-6">
                <h2 className="text-lg font-semibold opacity-90">Live Balance</h2>
                <div className="flex items-center gap-2 text-xs opacity-75">
                    <span className="relative flex h-2 w-2">
                        <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-white opacity-75"></span>
                        <span className="relative inline-flex rounded-full h-2 w-2 bg-white"></span>
                    </span>
                    <span>Live</span>
                </div>
            </div>

            {/* Total Balance */}
            <div className="mb-6 pb-4 border-b border-white/20">
                <p className="text-sm opacity-80 mb-1">Total Balance</p>
                <div className="flex items-baseline justify-between">
                    <p className="text-4xl font-bold">
                        â‚¹{totalBalance.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                    </p>
                    <div className={`flex items-center gap-1 text-sm ${getChangeColor(totalChange)}`}>
                        {getChangeIcon(totalChange)}
                        <span>â‚¹{Math.abs(totalChange).toLocaleString('en-IN')}</span>
                    </div>
                </div>
            </div>

            <div className="space-y-5">
                {/* Cash Balance with Progress */}
                <div>
                    <div className="flex items-center justify-between mb-2">
                        <div className="flex items-center gap-2">
                            <span className="text-xl">ðŸ’µ</span>
                            <span className="text-sm opacity-90">Cash</span>
                        </div>
                        <div className="text-right">
                            <p className="text-lg font-semibold">
                                â‚¹{cashBalance.toLocaleString('en-IN', { minimumFractionDigits: 2 })}
                            </p>
                            <div className={`flex items-center gap-1 text-xs ${getChangeColor(cashChange)}`}>
                                {getChangeIcon(cashChange)}
                                <span>â‚¹{Math.abs(cashChange).toLocaleString('en-IN')}</span>
                            </div>
                        </div>
                    </div>
                    {openingCash > 0 && (
                        <div className="w-full bg-white/20 rounded-full h-2 overflow-hidden">
                            <div
                                className={`h-full rounded-full transition-all duration-500 ${cashChange >= 0 ? 'bg-green-400' : 'bg-red-400'
                                    }`}
                                style={{ width: `${Math.min(getCashProgress(), 100)}%` }}
                            ></div>
                        </div>
                    )}
                </div>

                {/* UPI Balance with Progress */}
                <div>
                    <div className="flex items-center justify-between mb-2">
                        <div className="flex items-center gap-2">
                            <span className="text-xl">ðŸ“±</span>
                            <span className="text-sm opacity-90">UPI</span>
                        </div>
                        <div className="text-right">
                            <p className="text-lg font-semibold">
                                â‚¹{upiBalance.toLocaleString('en-IN', { minimumFractionDigits: 2 })}
                            </p>
                            <div className={`flex items-center gap-1 text-xs ${getChangeColor(upiChange)}`}>
                                {getChangeIcon(upiChange)}
                                <span>â‚¹{Math.abs(upiChange).toLocaleString('en-IN')}</span>
                            </div>
                        </div>
                    </div>
                    {openingUpi > 0 && (
                        <div className="w-full bg-white/20 rounded-full h-2 overflow-hidden">
                            <div
                                className={`h-full rounded-full transition-all duration-500 ${upiChange >= 0 ? 'bg-blue-400' : 'bg-red-400'
                                    }`}
                                style={{ width: `${Math.min(getUpiProgress(), 100)}%` }}
                            ></div>
                        </div>
                    )}
                </div>
            </div>

            {/* Opening Balance Reference (if set) */}
            {totalOpening > 0 && (
                <div className="mt-4 pt-4 border-t border-white/20">
                    <div className="flex justify-between text-xs opacity-75">
                        <span>Opening:</span>
                        <span>â‚¹{totalOpening.toLocaleString('en-IN')}</span>
                    </div>
                </div>
            )}
        </div>
    );
}


================================================================================
PATH: components\manage-permissions-modal.tsx
FILENAME: manage-permissions-modal.tsx
================================================================================

'use client';

import { useState, useEffect } from 'react';
import { X, Shield, Loader2, User, Building2 } from 'lucide-react';
import { useQuery } from '@tanstack/react-query';

interface ManagePermissionsModalProps {
    isOpen: boolean;
    onClose: () => void;
    onSuccess: () => void;
}

export function ManagePermissionsModal({ isOpen, onClose, onSuccess }: ManagePermissionsModalProps) {
    const [selectedUser, setSelectedUser] = useState('');
    const [newRole, setNewRole] = useState('');
    const [newOutletId, setNewOutletId] = useState('');
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState('');

    // Fetch users
    const { data: users } = useQuery({
        queryKey: ['users'],
        queryFn: async () => {
            const res = await fetch('/api/users');
            if (!res.ok) return [];
            return res.json();
        },
        enabled: isOpen,
    });

    // Fetch outlets
    const { data: outlets } = useQuery({
        queryKey: ['outlets'],
        queryFn: async () => {
            const res = await fetch('/api/outlets');
            if (!res.ok) return [];
            return res.json();
        },
        enabled: isOpen,
    });

    const selectedUserData = users?.find((u: any) => u.id === selectedUser);

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        setLoading(true);
        setError('');

        try {
            // Note: This would require a new API endpoint to update user permissions
            // For now, we'll show a message that this needs to be done via SQL
            setError('Permission updates currently require SQL. Use: UPDATE users SET role = \'...\', outlet_id = \'...\' WHERE id = \'...\'');

            // TODO: Implement PATCH /api/users/[id] endpoint
            // const res = await fetch(`/api/users/${selectedUser}`, {
            //   method: 'PATCH',
            //   headers: { 'Content-Type': 'application/json' },
            //   body: JSON.stringify({ role: newRole, outlet_id: newOutletId }),
            // });

            setTimeout(() => {
                onSuccess();
                onClose();
            }, 3000);
        } catch (err: any) {
            setError(err.message);
        } finally {
            setLoading(false);
        }
    };

    useEffect(() => {
        if (selectedUserData) {
            setNewRole(selectedUserData.role || '');
            setNewOutletId(selectedUserData.outlet_id || '');
        }
    }, [selectedUserData]);

    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-lg shadow-xl w-full max-w-md">
                {/* Header */}
                <div className="flex items-center justify-between p-6 border-b">
                    <div className="flex items-center gap-2">
                        <Shield className="w-5 h-5 text-purple-600" />
                        <h2 className="text-xl font-bold text-gray-900">Manage Permissions</h2>
                    </div>
                    <button
                        onClick={onClose}
                        className="text-gray-400 hover:text-gray-600 transition-colors"
                    >
                        <X className="w-5 h-5" />
                    </button>
                </div>

                {/* Form */}
                <form onSubmit={handleSubmit} className="p-6 space-y-4">
                    {error && (
                        <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                            <p className="text-sm text-yellow-800 whitespace-pre-wrap">{error}</p>
                        </div>
                    )}

                    {/* Select User */}
                    <div>
                        <label className="block text-sm font-medium text-gray-700 mb-1 flex items-center gap-2">
                            <User className="w-4 h-4" />
                            Select User *
                        </label>
                        <select
                            required
                            value={selectedUser}
                            onChange={(e) => setSelectedUser(e.target.value)}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                        >
                            <option value="">Choose a user...</option>
                            {users?.map((user: any) => (
                                <option key={user.id} value={user.id}>
                                    {user.full_name || user.name || user.email} ({user.role})
                                </option>
                            ))}
                        </select>
                    </div>

                    {selectedUser && (
                        <>
                            {/* Current Info */}
                            <div className="bg-gray-50 rounded-lg p-3">
                                <p className="text-sm text-gray-600 mb-1">Current Settings:</p>
                                <p className="text-sm font-medium">Role: <span className="text-blue-600">{selectedUserData?.role}</span></p>
                                <p className="text-sm font-medium">Outlet: <span className="text-blue-600">{selectedUserData?.outlet_id || 'None'}</span></p>
                            </div>

                            {/* New Role */}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">
                                    New Role
                                </label>
                                <select
                                    value={newRole}
                                    onChange={(e) => setNewRole(e.target.value)}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                >
                                    <option value="">Keep current role</option>
                                    <option value="outlet_staff">Outlet Staff</option>
                                    <option value="outlet_manager">Outlet Manager</option>
                                    <option value="ho_accountant">HO Accountant</option>
                                    <option value="master_admin">Master Admin</option>
                                    <option value="auditor">Auditor</option>
                                    <option value="superadmin">Superadmin</option>
                                </select>
                            </div>

                            {/* Assign Outlet */}
                            {(newRole === 'outlet_staff' || newRole === 'outlet_manager' || selectedUserData?.role?.includes('outlet')) && (
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1 flex items-center gap-2">
                                        <Building2 className="w-4 h-4" />
                                        Assign Outlet
                                    </label>
                                    <select
                                        value={newOutletId}
                                        onChange={(e) => setNewOutletId(e.target.value)}
                                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    >
                                        <option value="">No outlet assigned</option>
                                        {outlets?.map((outlet: any) => (
                                            <option key={outlet.id} value={outlet.id}>
                                                {outlet.name} ({outlet.code})
                                            </option>
                                        ))}
                                    </select>
                                </div>
                            )}

                            {/* SQL Command Preview */}
                            {(newRole || newOutletId) && (
                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                    <p className="text-xs font-medium text-blue-800 mb-2">SQL Command to Run:</p>
                                    <code className="text-xs text-blue-900 block whitespace-pre-wrap">
                                        {`UPDATE users SET\n${newRole ? `  role = '${newRole}'` : ''}${newRole && newOutletId ? ',\n' : ''}${newOutletId ? `  outlet_id = '${newOutletId}'` : ''}\nWHERE id = '${selectedUser}';`}
                                    </code>
                                </div>
                            )}
                        </>
                    )}

                    {/* Buttons */}
                    <div className="flex gap-3 pt-4">
                        <button
                            type="button"
                            onClick={onClose}
                            className="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors"
                            disabled={loading}
                        >
                            Cancel
                        </button>
                        <button
                            type="submit"
                            disabled={loading || !selectedUser}
                            className="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                        >
                            {loading ? (
                                <>
                                    <Loader2 className="w-4 h-4 animate-spin" />
                                    Updating...
                                </>
                            ) : (
                                <>
                                    <Shield className="w-4 h-4" />
                                    Show SQL Command
                                </>
                            )}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
}


================================================================================
PATH: components\monthly-report.tsx
FILENAME: monthly-report.tsx
================================================================================

'use client';

import React, { useState } from 'react';
import { useQuery } from '@tanstack/react-query';
import { DashboardCard } from '@/components/dashboard-card';

export function MonthlyReport() {
    const [month, setMonth] = useState(() => {
        const now = new Date();
        return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
    });

    const { data: summary, isLoading } = useQuery({
        queryKey: ['monthly-report', month],
        queryFn: async () => {
            const res = await fetch(`/api/reports/monthly?month=${month}`);
            if (!res.ok) throw new Error('Failed to fetch report');
            return res.json();
        },
    });

    if (isLoading) {
        return <div className="text-center py-8">Loading report...</div>;
    }

    return (
        <div className="space-y-6">
            <div className="flex items-center justify-between">
                <h2 className="text-2xl font-bold text-gray-900">Monthly Report</h2>
                <input
                    type="month"
                    value={month}
                    onChange={(e) => setMonth(e.target.value)}
                    className="px-4 py-2 border border-gray-300 rounded-lg"
                />
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <DashboardCard
                    title="Total Income"
                    value={`â‚¹${summary?.total_income?.toLocaleString('en-IN', { minimumFractionDigits: 2 }) || '0.00'}`}
                    colorClass="text-green-600"
                    subtitle={`${summary?.days_count || 0} days`}
                />
                <DashboardCard
                    title="Total Expense"
                    value={`â‚¹${summary?.total_expense?.toLocaleString('en-IN', { minimumFractionDigits: 2 }) || '0.00'}`}
                    colorClass="text-red-600"
                    subtitle={`${summary?.days_count || 0} days`}
                />
                <DashboardCard
                    title="Net Profit"
                    value={`â‚¹${summary?.net_profit?.toLocaleString('en-IN', { minimumFractionDigits: 2 }) || '0.00'}`}
                    colorClass={summary?.net_profit >= 0 ? 'text-green-600' : 'text-red-600'}
                    subtitle="Income - Expense"
                />
                <DashboardCard
                    title="Closing Balance"
                    value={`â‚¹${summary?.closing_balance?.toLocaleString('en-IN', { minimumFractionDigits: 2 }) || '0.00'}`}
                    colorClass="text-blue-600"
                    subtitle="Cash + UPI"
                />
            </div>
        </div>
    );
}


================================================================================
PATH: components\opening-balance-modal.tsx
FILENAME: opening-balance-modal.tsx
================================================================================

'use client';

import { useState } from 'react';
import { useMutation, useQueryClient } from '@tanstack/react-query';
import { Calendar, DollarSign, CreditCard, TrendingUp, X } from 'lucide-react';

interface OpeningBalanceModalProps {
    isOpen: boolean;
    onClose: () => void;
    recordId: string;
    date: string;
    previousClosingCash?: number;
    previousClosingUpi?: number;
}

export function OpeningBalanceModal({
    isOpen,
    onClose,
    recordId,
    date,
    previousClosingCash = 0,
    previousClosingUpi = 0
}: OpeningBalanceModalProps) {
    const [openingCash, setOpeningCash] = useState(previousClosingCash.toString());
    const [openingUpi, setOpeningUpi] = useState(previousClosingUpi.toString());
    const queryClient = useQueryClient();

    const setOpeningBalances = useMutation({
        mutationFn: async () => {
            const res = await fetch(`/api/daily-records/${recordId}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    opening_cash: parseFloat(openingCash) || 0,
                    opening_upi: parseFloat(openingUpi) || 0
                })
            });
            if (!res.ok) throw new Error('Failed to set opening balances');
            return res.json();
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['daily-record-today'] });
            onClose();
        }
    });

    if (!isOpen) return null;

    const handleSubmit = (e: React.FormEvent) => {
        e.preventDefault();
        setOpeningBalances.mutate();
    };

    const totalOpening = (parseFloat(openingCash) || 0) + (parseFloat(openingUpi) || 0);

    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div className="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6">
                <div className="flex items-center justify-between mb-4">
                    <h3 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
                        <TrendingUp className="w-6 h-6 text-green-600" />
                        Start Your Day
                    </h3>
                    <button
                        onClick={onClose}
                        className="text-gray-400 hover:text-gray-600"
                        disabled={setOpeningBalances.isPending}
                    >
                        <X className="w-6 h-6" />
                    </button>
                </div>

                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <div className="flex items-center gap-2 mb-2">
                        <Calendar className="w-5 h-5 text-blue-600" />
                        <p className="font-medium text-blue-900">
                            {new Date(date).toLocaleDateString('en-IN', {
                                weekday: 'long',
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric'
                            })}
                        </p>
                    </div>
                    <p className="text-sm text-blue-700">
                        Set your opening balances to begin tracking today's transactions
                    </p>
                </div>

                <form onSubmit={handleSubmit}>
                    {/* Previous Day Summary */}
                    {(previousClosingCash > 0 || previousClosingUpi > 0) && (
                        <div className="bg-gray-50 rounded-lg p-4 mb-4">
                            <p className="text-sm font-medium text-gray-700 mb-2">Yesterday's Closing:</p>
                            <div className="flex justify-between text-sm text-gray-600">
                                <span>Cash: â‚¹{previousClosingCash.toLocaleString('en-IN')}</span>
                                <span>UPI: â‚¹{previousClosingUpi.toLocaleString('en-IN')}</span>
                            </div>
                        </div>
                    )}

                    {/* Opening Cash */}
                    <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                            <DollarSign className="w-4 h-4 inline mr-1 text-green-600" />
                            Opening Cash Balance
                        </label>
                        <input
                            type="number"
                            value={openingCash}
                            onChange={(e) => setOpeningCash(e.target.value)}
                            placeholder="0.00"
                            step="0.01"
                            min="0"
                            className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 text-lg"
                            required
                        />
                    </div>

                    {/* Opening UPI */}
                    <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                            <CreditCard className="w-4 h-4 inline mr-1 text-blue-600" />
                            Opening UPI Balance
                        </label>
                        <input
                            type="number"
                            value={openingUpi}
                            onChange={(e) => setOpeningUpi(e.target.value)}
                            placeholder="0.00"
                            step="0.01"
                            min="0"
                            className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-lg"
                            required
                        />
                    </div>

                    {/* Total */}
                    <div className="bg-gradient-to-r from-green-50 to-blue-50 rounded-lg p-4 mb-6">
                        <div className="flex justify-between items-center">
                            <span className="text-sm font-medium text-gray-700">Total Opening Balance:</span>
                            <span className="text-2xl font-bold text-gray-900">
                                â‚¹{totalOpening.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                            </span>
                        </div>
                    </div>

                    {setOpeningBalances.isError && (
                        <div className="bg-red-50 border border-red-200 rounded-lg p-3 mb-4">
                            <p className="text-sm text-red-800">
                                {setOpeningBalances.error.message}
                            </p>
                        </div>
                    )}

                    {/* Actions */}
                    <div className="flex gap-3">
                        <button
                            type="button"
                            onClick={onClose}
                            disabled={setOpeningBalances.isPending}
                            className="flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 disabled:opacity-50 font-medium"
                        >
                            Cancel
                        </button>
                        <button
                            type="submit"
                            disabled={setOpeningBalances.isPending}
                            className="flex-1 px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400 font-medium flex items-center justify-center gap-2"
                        >
                            {setOpeningBalances.isPending ? (
                                <>
                                    <div className="h-5 w-5 animate-spin rounded-full border-2 border-white border-t-transparent"></div>
                                    Starting...
                                </>
                            ) : (
                                <>
                                    <TrendingUp className="w-5 h-5" />
                                    Start Day
                                </>
                            )}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
}


================================================================================
PATH: components\protected-route.tsx
FILENAME: protected-route.tsx
================================================================================

'use client';

import { useEffect, useRef } from 'react';
import { useRouter } from 'next/navigation';
import { useAuth } from '@/lib/auth-context';
import { getRoleDashboard } from '@/lib/utils';
import type { UserRole } from '@/lib/types';

interface ProtectedRouteProps {
    children: React.ReactNode;
    allowedRoles?: UserRole[];
    requireAuth?: boolean;
}

export function ProtectedRoute({
    children,
    allowedRoles,
    requireAuth = true
}: ProtectedRouteProps) {
    const { user, loading } = useAuth();
    const router = useRouter();
    const hasRedirected = useRef(false);

    useEffect(() => {
        if (!loading && !hasRedirected.current) {
            console.log('[ProtectedRoute] Auth check:', {
                user: !!user,
                profile: user?.profile,
                role: user?.profile?.role,
                requireAuth,
                allowedRoles,
                hasUser: !!user,
                hasProfile: !!user?.profile,
                userRole: user?.profile?.role,
                allowedRolesList: allowedRoles,
                roleMatches: user?.profile?.role && allowedRoles?.includes(user.profile.role)
            });

            // Not authenticated but auth required
            if (requireAuth && !user) {
                console.log('[ProtectedRoute] âŒ Redirecting to login - no user');
                hasRedirected.current = true;
                router.push('/login');
                return;
            }

            // Check role authorization
            if (user && allowedRoles && user.profile) {
                const roleMatches = allowedRoles.includes(user.profile.role);
                console.log('[ProtectedRoute] Role check:', {
                    userRole: user.profile.role,
                    allowedRoles,
                    matches: roleMatches
                });

                if (!roleMatches) {
                    console.log('[ProtectedRoute] âŒ Redirecting - wrong role');
                    hasRedirected.current = true;
                    router.push(getRoleDashboard(user.profile.role));
                    return;
                }

                // Time-bound access check for auditors
                if (user.profile.role === 'auditor') {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    const startDate = user.profile.access_start_date ? new Date(user.profile.access_start_date) : null;
                    const endDate = user.profile.access_end_date ? new Date(user.profile.access_end_date) : null;

                    if (startDate) startDate.setHours(0, 0, 0, 0);
                    if (endDate) endDate.setHours(0, 0, 0, 0);

                    const isStarted = !startDate || today >= startDate;
                    const isNotExpired = !endDate || today <= endDate;

                    if (!isStarted || !isNotExpired) {
                        console.log('[ProtectedRoute] âŒ Auditor access invalid (time-bound)');
                        hasRedirected.current = true;
                        // For auditors with invalid access, we can redirect to a restricted page or just show the banner
                        // For now, let's allow them into the dashboard but the banner will show "EXPIRED"
                        // and RLS will prevent any data fetching anyway.
                    }
                }

                console.log('[ProtectedRoute] âœ… Access granted!');
            } else {
                console.log('[ProtectedRoute] âš ï¸ Access allowed (no role check required)');
            }
        }
    }, [loading, requireAuth, allowedRoles, user, router]);

    // Show loading state - CRITICAL: Don't redirect while loading!
    if (loading) {
        console.log('[ProtectedRoute] â³ Loading auth state...');
        return (
            <div className="min-h-screen flex items-center justify-center">
                <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            </div>
        );
    }

    // Show nothing while redirecting (auth is loaded at this point)
    if (requireAuth && !user) {
        console.log('[ProtectedRoute] â³ Redirecting to login...');
        return null;
    }

    if (user && allowedRoles && user.profile && !allowedRoles.includes(user.profile.role)) {
        console.log('[ProtectedRoute] â³ Redirecting to correct dashboard...');
        return null;
    }

    console.log('[ProtectedRoute] ðŸŽ‰ Rendering protected content');
    return <>{children}</>;
}


================================================================================
PATH: components\providers.tsx
FILENAME: providers.tsx
================================================================================

'use client';

import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { useState } from 'react';
import { AuthProvider } from '@/lib/auth-context';

export function Providers({ children }: { children: React.ReactNode }) {
    const [queryClient] = useState(
        () =>
            new QueryClient({
                defaultOptions: {
                    queries: {
                        staleTime: 60 * 1000, // 1 minute
                        refetchOnWindowFocus: false,
                    },
                },
            })
    );

    return (
        <QueryClientProvider client={queryClient}>
            <AuthProvider>
                {children}
            </AuthProvider>
        </QueryClientProvider>
    );
}


================================================================================
PATH: components\skeleton.tsx
FILENAME: skeleton.tsx
================================================================================

'use client';

interface SkeletonProps {
    variant?: 'card' | 'table' | 'list' | 'chart' | 'text';
    count?: number;
}

export function Skeleton({ variant = 'card', count = 1 }: SkeletonProps) {
    if (variant === 'card') {
        return (
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                {Array.from({ length: count }).map((_, i) => (
                    <div key={i} className="bg-white rounded-lg shadow p-6 animate-pulse">
                        <div className="flex items-center justify-between mb-4">
                            <div className="h-4 bg-gray-200 rounded w-24"></div>
                            <div className="h-6 w-6 bg-gray-200 rounded"></div>
                        </div>
                        <div className="h-8 bg-gray-200 rounded w-32 mb-2"></div>
                        <div className="h-3 bg-gray-200 rounded w-20"></div>
                    </div>
                ))}
            </div>
        );
    }

    if (variant === 'table') {
        return (
            <div className="bg-white rounded-lg shadow overflow-hidden">
                <table className="min-w-full">
                    <thead className="bg-gray-50">
                        <tr>
                            {Array.from({ length: 4 }).map((_, i) => (
                                <th key={i} className="px-6 py-3">
                                    <div className="h-4 bg-gray-200 rounded w-24 animate-pulse"></div>
                                </th>
                            ))}
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-200">
                        {Array.from({ length: count || 5 }).map((_, i) => (
                            <tr key={i}>
                                {Array.from({ length: 4 }).map((_, j) => (
                                    <td key={j} className="px-6 py-4">
                                        <div className="h-4 bg-gray-200 rounded w-full animate-pulse"></div>
                                    </td>
                                ))}
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        );
    }

    if (variant === 'list') {
        return (
            <div className="space-y-3">
                {Array.from({ length: count }).map((_, i) => (
                    <div key={i} className="bg-white rounded-lg shadow p-4 animate-pulse">
                        <div className="flex items-center gap-4">
                            <div className="h-12 w-12 bg-gray-200 rounded-full"></div>
                            <div className="flex-1 space-y-2">
                                <div className="h-4 bg-gray-200 rounded w-3/4"></div>
                                <div className="h-3 bg-gray-200 rounded w-1/2"></div>
                            </div>
                        </div>
                    </div>
                ))}
            </div>
        );
    }

    if (variant === 'chart') {
        return (
            <div className="bg-white rounded-lg shadow p-6">
                <div className="h-6 bg-gray-200 rounded w-48 mb-4 animate-pulse"></div>
                <div className="h-64 bg-gray-100 rounded animate-pulse"></div>
            </div>
        );
    }

    // Text variant
    return (
        <div className="space-y-2 animate-pulse">
            {Array.from({ length: count }).map((_, i) => (
                <div key={i} className="h-4 bg-gray-200 rounded w-full"></div>
            ))}
        </div>
    );
}

// Specific skeleton components for common use cases
export function DashboardSkeleton() {
    return (
        <div className="p-6 max-w-7xl mx-auto">
            {/* Header */}
            <div className="mb-8 animate-pulse">
                <div className="h-8 bg-gray-200 rounded w-64 mb-2"></div>
                <div className="h-4 bg-gray-200 rounded w-48"></div>
            </div>

            {/* Cards */}
            <Skeleton variant="card" count={4} />

            {/* Content */}
            <div className="mt-8 animate-pulse">
                <div className="h-64 bg-gray-100 rounded-lg"></div>
            </div>
        </div>
    );
}

export function TableSkeleton({ rows = 5 }: { rows?: number }) {
    return <Skeleton variant="table" count={rows} />;
}

export function ChartSkeleton() {
    return <Skeleton variant="chart" />;
}


================================================================================
PATH: components\submit-review-modal.tsx
FILENAME: submit-review-modal.tsx
================================================================================

'use client';

import { useState } from 'react';
import { useMutation, useQueryClient, useQuery } from '@tanstack/react-query';
import { CheckCircle, AlertCircle, X, Send, DollarSign, CreditCard } from 'lucide-react';

interface SubmitReviewModalProps {
    isOpen: boolean;
    onClose: () => void;
    recordId: string;
    date: string;
}

export function SubmitReviewModal({ isOpen, onClose, recordId, date }: SubmitReviewModalProps) {
    const queryClient = useQueryClient();

    // Fetch record details and transactions
    const { data: record } = useQuery({
        queryKey: ['daily-record', recordId],
        queryFn: async () => {
            const res = await fetch(`/api/daily-records?id=${recordId}`);
            if (!res.ok) throw new Error('Failed to fetch record');
            const records = await res.json();
            return records[0];
        },
        enabled: isOpen
    });

    const { data: transactions } = useQuery({
        queryKey: ['transactions', recordId],
        queryFn: async () => {
            const res = await fetch(`/api/transactions?daily_record_id=${recordId}`);
            if (!res.ok) throw new Error('Failed to fetch transactions');
            return res.json();
        },
        enabled: isOpen
    });

    const submitMutation = useMutation({
        mutationFn: async () => {
            const res = await fetch(`/api/daily-records/${recordId}/submit`, {
                method: 'POST'
            });
            if (!res.ok) {
                const error = await res.json();
                throw new Error(error.error || 'Failed to submit');
            }
            return res.json();
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['daily-record-today'] });
            queryClient.invalidateQueries({ queryKey: ['daily-record', recordId] });
            onClose();
        }
    });

    if (!isOpen || !record) return null;

    const openingCash = record.opening_cash || 0;
    const openingUpi = record.opening_upi || 0;
    const totalIncome = record.total_income || 0;
    const totalExpense = record.total_expense || 0;

    // Calculate expected closing
    const incomeTransactions = transactions?.filter((t: any) => t.type === 'income') || [];
    const expenseTransactions = transactions?.filter((t: any) => t.type === 'expense') || [];

    const cashIncome = incomeTransactions.filter((t: any) => t.payment_mode === 'cash')
        .reduce((sum: number, t: any) => sum + (t.amount || 0), 0);
    const upiIncome = incomeTransactions.filter((t: any) => t.payment_mode === 'upi')
        .reduce((sum: number, t: any) => sum + (t.amount || 0), 0);
    const cashExpense = expenseTransactions.filter((t: any) => t.payment_mode === 'cash')
        .reduce((sum: number, t: any) => sum + (t.amount || 0), 0);
    const upiExpense = expenseTransactions.filter((t: any) => t.payment_mode === 'upi')
        .reduce((sum: number, t: any) => sum + (t.amount || 0), 0);

    const expectedCashClosing = openingCash + cashIncome - cashExpense;
    const expectedUpiClosing = openingUpi + upiIncome - upiExpense;

    // Validations
    const hasOpeningBalances = openingCash > 0 || openingUpi > 0;
    const hasTransactions = (transactions?.length || 0) > 0;
    const hasIncome = totalIncome > 0;
    const hasExpense = totalExpense > 0;

    const canSubmit = hasOpeningBalances && hasTransactions;
    const warnings = [];
    if (!hasIncome) warnings.push('No income transactions recorded');
    if (!hasExpense) warnings.push('No expense transactions recorded');
    if (transactions?.length === 1) warnings.push('Only one transaction recorded');

    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div className="sticky top-0 bg-white border-b border-gray-200 p-6 flex items-center justify-between">
                    <h3 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
                        <CheckCircle className="w-6 h-6 text-blue-600" />
                        Review & Submit
                    </h3>
                    <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
                        <X className="w-6 h-6" />
                    </button>
                </div>

                <div className="p-6 space-y-6">
                    {/* Date */}
                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <p className="text-sm text-blue-700">Submitting for:</p>
                        <p className="text-lg font-bold text-blue-900">
                            {new Date(date).toLocaleDateString('en-IN', {
                                weekday: 'long',
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric'
                            })}
                        </p>
                    </div>

                    {/* Opening Balances */}
                    <div>
                        <h4 className="font-semibold text-gray-900 mb-3">1. Opening Balances</h4>
                        <div className="grid grid-cols-2 gap-4">
                            <div className="bg-gray-50 rounded-lg p-4">
                                <div className="flex items-center gap-2 mb-1">
                                    <DollarSign className="w-4 h-4 text-green-600" />
                                    <span className="text-sm text-gray-600">Cash</span>
                                </div>
                                <p className="text-xl font-bold text-gray-900">
                                    â‚¹{openingCash.toLocaleString('en-IN')}
                                </p>
                            </div>
                            <div className="bg-gray-50 rounded-lg p-4">
                                <div className="flex items-center gap-2 mb-1">
                                    <CreditCard className="w-4 h-4 text-blue-600" />
                                    <span className="text-sm text-gray-600">UPI</span>
                                </div>
                                <p className="text-xl font-bold text-gray-900">
                                    â‚¹{openingUpi.toLocaleString('en-IN')}
                                </p>
                            </div>
                        </div>
                    </div>

                    {/* Transaction Summary */}
                    <div>
                        <h4 className="font-semibold text-gray-900 mb-3">2. Transaction Summary</h4>
                        <div className="grid grid-cols-2 gap-4 mb-3">
                            <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                                <p className="text-sm text-green-700 mb-1">Total Income</p>
                                <p className="text-2xl font-bold text-green-900">
                                    â‚¹{totalIncome.toLocaleString('en-IN')}
                                </p>
                                <p className="text-xs text-green-600 mt-1">
                                    {incomeTransactions.length} transaction(s)
                                </p>
                            </div>
                            <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                                <p className="text-sm text-red-700 mb-1">Total Expense</p>
                                <p className="text-2xl font-bold text-red-900">
                                    â‚¹{totalExpense.toLocaleString('en-IN')}
                                </p>
                                <p className="text-xs text-red-600 mt-1">
                                    {expenseTransactions.length} transaction(s)
                                </p>
                            </div>
                        </div>
                        <p className="text-sm text-gray-600">
                            Total: <span className="font-medium">{transactions?.length || 0}</span> transactions recorded
                        </p>
                    </div>

                    {/* Expected Closing */}
                    <div>
                        <h4 className="font-semibold text-gray-900 mb-3">3. Expected Closing Balances</h4>
                        <div className="grid grid-cols-2 gap-4">
                            <div className="bg-gradient-to-br from-green-50 to-green-100 border border-green-200 rounded-lg p-4">
                                <p className="text-sm text-green-700 mb-1">Cash</p>
                                <p className="text-xl font-bold text-green-900">
                                    â‚¹{expectedCashClosing.toLocaleString('en-IN')}
                                </p>
                                <p className="text-xs text-green-600 mt-1">
                                    {openingCash.toLocaleString()} + {cashIncome.toLocaleString()} - {cashExpense.toLocaleString()}
                                </p>
                            </div>
                            <div className="bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200 rounded-lg p-4">
                                <p className="text-sm text-blue-700 mb-1">UPI</p>
                                <p className="text-xl font-bold text-blue-900">
                                    â‚¹{expectedUpiClosing.toLocaleString('en-IN')}
                                </p>
                                <p className="text-xs text-blue-600 mt-1">
                                    {openingUpi.toLocaleString()} + {upiIncome.toLocaleString()} - {upiExpense.toLocaleString()}
                                </p>
                            </div>
                        </div>
                    </div>

                    {/* Validations */}
                    <div>
                        <h4 className="font-semibold text-gray-900 mb-3">4. Validation Checks</h4>
                        <div className="space-y-2">
                            <div className={`flex items-center gap-2 ${hasOpeningBalances ? 'text-green-700' : 'text-red-700'}`}>
                                {hasOpeningBalances ? (
                                    <CheckCircle className="w-5 h-5" />
                                ) : (
                                    <AlertCircle className="w-5 h-5" />
                                )}
                                <span className="text-sm">Opening balances set</span>
                            </div>
                            <div className={`flex items-center gap-2 ${hasTransactions ? 'text-green-700' : 'text-red-700'}`}>
                                {hasTransactions ? (
                                    <CheckCircle className="w-5 h-5" />
                                ) : (
                                    <AlertCircle className="w-5 h-5" />
                                )}
                                <span className="text-sm">Transactions recorded</span>
                            </div>
                        </div>

                        {/* Warnings */}
                        {warnings.length > 0 && (
                            <div className="mt-3 bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                                <p className="text-sm font-medium text-yellow-900 mb-2">âš ï¸ Warnings:</p>
                                <ul className="text-sm text-yellow-700 space-y-1">
                                    {warnings.map((w, i) => (
                                        <li key={i}>â€¢ {w}</li>
                                    ))}
                                </ul>
                                <p className="text-xs text-yellow-600 mt-2">
                                    You can still submit, but please verify your data is correct.
                                </p>
                            </div>
                        )}
                    </div>

                    {submitMutation.isError && (
                        <div className="bg-red-50 border border-red-200 rounded-lg p-3">
                            <p className="text-sm text-red-800">
                                {submitMutation.error.message}
                            </p>
                        </div>
                    )}
                </div>

                <div className="sticky bottom-0 bg-gray-50 border-t border-gray-200 p-6 flex gap-3">
                    <button
                        onClick={onClose}
                        disabled={submitMutation.isPending}
                        className="flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-white disabled:opacity-50 font-medium"
                    >
                        Cancel
                    </button>
                    <button
                        onClick={() => submitMutation.mutate()}
                        disabled={!canSubmit || submitMutation.isPending}
                        className="flex-1 px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 font-medium flex items-center justify-center gap-2"
                    >
                        {submitMutation.isPending ? (
                            <>
                                <div className="h-5 w-5 animate-spin rounded-full border-2 border-white border-t-transparent"></div>
                                Submitting...
                            </>
                        ) : (
                            <>
                                <Send className="w-5 h-5" />
                                Submit for Review
                            </>
                        )}
                    </button>
                </div>
            </div>
        </div>
    );
}


================================================================================
PATH: components\transaction-form.tsx
FILENAME: transaction-form.tsx
================================================================================

'use client';

import React, { useState } from 'react';
import { useQueryClient, useMutation } from '@tanstack/react-query';

interface TransactionFormProps {
    dailyRecordId: string;
}

export function TransactionForm({ dailyRecordId }: TransactionFormProps) {
    const [type, setType] = useState<'income' | 'expense'>('income');
    const [category, setCategory] = useState('');
    const [paymentMode, setPaymentMode] = useState<'cash' | 'upi'>('cash');
    const [amount, setAmount] = useState('');
    const [description, setDescription] = useState('');
    const [isSubmitting, setIsSubmitting] = useState(false);

    const queryClient = useQueryClient();

    const createTransaction = useMutation({
        mutationFn: async (data: any) => {
            setIsSubmitting(true);
            try {
                // Generate unique idempotency key to prevent duplicates
                const idempotencyKey = `${dailyRecordId}-${Date.now()}-${Math.random().toString(36)}`;

                const res = await fetch('/api/transactions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Idempotency-Key': idempotencyKey,
                    },
                    body: JSON.stringify(data),
                });

                if (!res.ok) {
                    const error = await res.json();
                    throw new Error(error.details || error.error || 'Failed to create transaction');
                }

                return res.json();
            } finally {
                setIsSubmitting(false);
            }
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['transactions'] });
            queryClient.invalidateQueries({ queryKey: ['daily-record-today'] });
            // Reset form
            setCategory('');
            setAmount('');
            setDescription('');
        },
        onError: (error: Error) => {
            alert(`Error: ${error.message}`);
        },
    });

    const handleSubmit = (e: React.FormEvent) => {
        e.preventDefault();

        // Prevent double submission
        if (isSubmitting) {
            return;
        }

        // Client-side validation
        if (!amount || parseFloat(amount) <= 0) {
            alert('Please enter a valid amount');
            return;
        }

        if (!category) {
            alert('Please select a category');
            return;
        }

        createTransaction.mutate({
            dailyRecordId,
            type,
            category,
            paymentMode,
            amount: parseFloat(amount),
            description: description || undefined,
        });
    };

    const incomeCategories = [
        'consultation',
        'medicine_sale',
        'lab_test',
        'other_income',
    ];

    const expenseCategories = [
        'medicine_purchase',
        'staff_salary',
        'clinic_expenses',
        'transport',
        'rent',
        'utilities',
        'miscellaneous',
    ];

    const categories = type === 'income' ? incomeCategories : expenseCategories;

    return (
        <div className="bg-white rounded-lg shadow p-6">
            <h2 className="text-xl font-bold text-gray-900 mb-4">Quick Entry</h2>

            <form onSubmit={handleSubmit} className="space-y-4">
                {/* Type Selection */}
                <div className="flex gap-2">
                    <button
                        type="button"
                        onClick={() => setType('income')}
                        className={`flex-1 py-2 px-4 rounded-lg font-medium transition-colors ${type === 'income'
                            ? 'bg-green-600 text-white'
                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                            }`}
                    >
                        Income
                    </button>
                    <button
                        type="button"
                        onClick={() => setType('expense')}
                        className={`flex-1 py-2 px-4 rounded-lg font-medium transition-colors ${type === 'expense'
                            ? 'bg-red-600 text-white'
                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                            }`}
                    >
                        Expense
                    </button>
                </div>

                {/* Category */}
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                        Category *
                    </label>
                    <select
                        required
                        value={category}
                        onChange={(e) => setCategory(e.target.value)}
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                        <option value="">Select category</option>
                        {categories.map((cat) => (
                            <option key={cat} value={cat}>
                                {cat.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}
                            </option>
                        ))}
                    </select>
                </div>

                {/* Payment Mode */}
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                        Payment Mode *
                    </label>
                    <div className="flex gap-2">
                        <button
                            type="button"
                            onClick={() => setPaymentMode('cash')}
                            className={`flex-1 py-2 px-4 rounded-lg font-medium transition-colors ${paymentMode === 'cash'
                                ? 'bg-blue-600 text-white'
                                : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                }`}
                        >
                            ðŸ’µ Cash
                        </button>
                        <button
                            type="button"
                            onClick={() => setPaymentMode('upi')}
                            className={`flex-1 py-2 px-4 rounded-lg font-medium transition-colors ${paymentMode === 'upi'
                                ? 'bg-blue-600 text-white'
                                : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                }`}
                        >
                            ðŸ“± UPI
                        </button>
                    </div>
                </div>

                {/* Amount */}
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                        Amount *
                    </label>
                    <input
                        type="number"
                        required
                        min="0.01"
                        step="0.01"
                        value={amount}
                        onChange={(e) => setAmount(e.target.value)}
                        placeholder="0.00"
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                </div>

                {/* Description */}
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-1">
                        Description
                    </label>
                    <input
                        type="text"
                        value={description}
                        onChange={(e) => setDescription(e.target.value)}
                        placeholder="Optional notes"
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                </div>

                {/* Submit */}
                <button
                    type="submit"
                    disabled={isSubmitting || !amount || !category}
                    className="w-full bg-blue-600 text-white py-3 px-4 rounded-lg font-medium 
                             hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 
                             focus:ring-offset-2 disabled:bg-gray-400 disabled:cursor-not-allowed 
                             transition-colors shadow-sm"
                >
                    {isSubmitting ? 'Adding...' : 'âœ“ Add Transaction'}
                </button>

                {createTransaction.isError && (
                    <div className="p-3 bg-red-50 border border-red-200 rounded-lg text-red-800 text-sm">
                        Failed to add transaction. Please try again.
                    </div>
                )}
            </form>
        </div>
    );
}


================================================================================
PATH: components\transaction-list.tsx
FILENAME: transaction-list.tsx
================================================================================

'use client';

import React from 'react';
import { useQuery } from '@tanstack/react-query';

interface TransactionListProps {
    dailyRecordId: string;
}

interface Transaction {
    id: string;
    type: 'income' | 'expense';
    category: string;
    payment_mode: 'cash' | 'upi';
    amount: number;
    description: string | null;
    created_at: string;
}

export function TransactionList({ dailyRecordId }: TransactionListProps) {
    const { data: transactions, isLoading } = useQuery<Transaction[]>({
        queryKey: ['transactions', dailyRecordId],
        queryFn: async () => {
            const res = await fetch(`/api/transactions?dailyRecordId=${dailyRecordId}`);
            if (!res.ok) throw new Error('Failed to fetch transactions');
            return res.json();
        },
    });

    if (isLoading) {
        return (
            <div className="bg-white rounded-lg shadow p-6">
                <p className="text-gray-500 text-center">Loading transactions...</p>
            </div>
        );
    }

    if (!transactions || transactions.length === 0) {
        return (
            <div className="bg-white rounded-lg shadow p-6">
                <h2 className="text-xl font-bold text-gray-900 mb-4">Today's Transactions</h2>
                <p className="text-gray-500 text-center py-8">
                    No transactions yet. Add your first entry above!
                </p>
            </div>
        );
    }

    const formatTime = (timestamp: string) => {
        const date = new Date(timestamp);
        return date.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
    };

    const formatCategory = (category: string) => {
        return category.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    };

    return (
        <div className="bg-white rounded-lg shadow">
            <div className="p-6 border-b border-gray-200">
                <h2 className="text-xl font-bold text-gray-900">Today's Transactions</h2>
                <p className="text-sm text-gray-600 mt-1">{transactions.length} entries</p>
            </div>

            <div className="divide-y divide-gray-200">
                {transactions.map((transaction) => (
                    <div key={transaction.id} className="p-4 hover:bg-gray-50 transition-colors">
                        <div className="flex items-center justify-between">
                            <div className="flex-1">
                                <div className="flex items-center gap-2 mb-1">
                                    <span
                                        className={`px-2 py-0.5 rounded text-xs font-medium ${transaction.type === 'income'
                                                ? 'bg-green-100 text-green-800'
                                                : 'bg-red-100 text-red-800'
                                            }`}
                                    >
                                        {transaction.type.toUpperCase()}
                                    </span>
                                    <span
                                        className={`px-2 py-0.5 rounded text-xs font-medium ${transaction.payment_mode === 'cash'
                                                ? 'bg-blue-100 text-blue-800'
                                                : 'bg-purple-100 text-purple-800'
                                            }`}
                                    >
                                        {transaction.payment_mode === 'cash' ? 'ðŸ’µ Cash' : 'ðŸ“± UPI'}
                                    </span>
                                </div>
                                <p className="font-medium text-gray-900">
                                    {formatCategory(transaction.category)}
                                </p>
                                {transaction.description && (
                                    <p className="text-sm text-gray-600 mt-1">{transaction.description}</p>
                                )}
                                <p className="text-xs text-gray-500 mt-1">
                                    {formatTime(transaction.created_at)}
                                </p>
                            </div>
                            <div className="text-right">
                                <p
                                    className={`text-lg font-bold ${transaction.type === 'income' ? 'text-green-600' : 'text-red-600'
                                        }`}
                                >
                                    {transaction.type === 'income' ? '+' : '-'}â‚¹
                                    {transaction.amount.toLocaleString('en-IN', {
                                        minimumFractionDigits: 2,
                                        maximumFractionDigits: 2,
                                    })}
                                </p>
                            </div>
                        </div>
                    </div>
                ))}
            </div>
        </div>
    );
}


================================================================================
PATH: components\transaction-summary.tsx
FILENAME: transaction-summary.tsx
================================================================================

'use client';

import { useQuery } from '@tanstack/react-query';
import { DollarSign, CreditCard, TrendingUp, TrendingDown, List } from 'lucide-react';

interface TransactionSummaryProps {
    dailyRecordId: string;
}

export function TransactionSummary({ dailyRecordId }: TransactionSummaryProps) {
    const { data: transactions, isLoading } = useQuery({
        queryKey: ['transactions', dailyRecordId],
        queryFn: async () => {
            const res = await fetch(`/api/transactions?daily_record_id=${dailyRecordId}`);
            if (!res.ok) throw new Error('Failed to fetch transactions');
            return res.json();
        }
    });

    if (isLoading) {
        return (
            <div className="bg-white rounded-lg shadow p-6">
                <div className="animate-pulse space-y-4">
                    <div className="h-6 bg-gray-200 rounded w-1/3"></div>
                    <div className="space-y-3">
                        <div className="h-4 bg-gray-200 rounded"></div>
                        <div className="h-4 bg-gray-200 rounded"></div>
                    </div>
                </div>
            </div>
        );
    }

    if (!transactions || transactions.length === 0) {
        return (
            <div className="bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                <List className="w-12 h-12 text-gray-400 mx-auto mb-3" />
                <p className="text-gray-600">No transactions recorded yet</p>
                <p className="text-sm text-gray-500 mt-1">Add your first transaction above</p>
            </div>
        );
    }

    // Group by type and payment mode
    const incomeTransactions = transactions.filter((t: any) => t.type === 'income');
    const expenseTransactions = transactions.filter((t: any) => t.type === 'expense');

    const cashIncome = incomeTransactions.filter((t: any) => t.payment_mode === 'cash')
        .reduce((sum: number, t: any) => sum + (t.amount || 0), 0);
    const upiIncome = incomeTransactions.filter((t: any) => t.payment_mode === 'upi')
        .reduce((sum: number, t: any) => sum + (t.amount || 0), 0);
    const cashExpense = expenseTransactions.filter((t: any) => t.payment_mode === 'cash')
        .reduce((sum: number, t: any) => sum + (t.amount || 0), 0);
    const upiExpense = expenseTransactions.filter((t: any) => t.payment_mode === 'upi')
        .reduce((sum: number, t: any) => sum + (t.amount || 0), 0);

    const totalIncome = cashIncome + upiIncome;
    const totalExpense = cashExpense + upiExpense;

    // Group by category
    const categoryGroups: { [key: string]: { income: number; expense: number; count: number } } = {};
    transactions.forEach((t: any) => {
        if (!categoryGroups[t.category]) {
            categoryGroups[t.category] = { income: 0, expense: 0, count: 0 };
        }
        if (t.type === 'income') {
            categoryGroups[t.category].income += t.amount || 0;
        } else {
            categoryGroups[t.category].expense += t.amount || 0;
        }
        categoryGroups[t.category].count += 1;
    });

    return (
        <div className="bg-white rounded-lg shadow">
            <div className="p-6 border-b border-gray-200">
                <h3 className="text-lg font-bold text-gray-900 flex items-center gap-2">
                    <List className="w-5 h-5 text-blue-600" />
                    Transaction Summary
                </h3>
                <p className="text-sm text-gray-600 mt-1">
                    {transactions.length} transaction{transactions.length !== 1 ? 's' : ''} recorded
                </p>
            </div>

            <div className="p-6 space-y-6">
                {/* Overall Summary */}
                <div className="grid grid-cols-2 gap-4">
                    <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                        <div className="flex items-center gap-2 mb-2">
                            <TrendingUp className="w-5 h-5 text-green-600" />
                            <span className="text-sm font-medium text-green-700">Total Income</span>
                        </div>
                        <p className="text-2xl font-bold text-green-900">
                            â‚¹{totalIncome.toLocaleString('en-IN')}
                        </p>
                        <p className="text-xs text-green-600 mt-1">
                            {incomeTransactions.length} transaction{incomeTransactions.length !== 1 ? 's' : ''}
                        </p>
                    </div>
                    <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                        <div className="flex items-center gap-2 mb-2">
                            <TrendingDown className="w-5 h-5 text-red-600" />
                            <span className="text-sm font-medium text-red-700">Total Expense</span>
                        </div>
                        <p className="text-2xl font-bold text-red-900">
                            â‚¹{totalExpense.toLocaleString('en-IN')}
                        </p>
                        <p className="text-xs text-red-600 mt-1">
                            {expenseTransactions.length} transaction{expenseTransactions.length !== 1 ? 's' : ''}
                        </p>
                    </div>
                </div>

                {/* Payment Mode Split */}
                <div>
                    <h4 className="text-sm font-semibold text-gray-700 mb-3">Payment Mode Breakdown</h4>
                    <div className="grid grid-cols-2 gap-4">
                        <div className="bg-gray-50 rounded-lg p-4 border border-gray-200">
                            <div className="flex items-center gap-2 mb-3">
                                <DollarSign className="w-4 h-4 text-green-600" />
                                <span className="text-sm font-medium text-gray-700">Cash</span>
                            </div>
                            <div className="space-y-2">
                                <div className="flex justify-between text-sm">
                                    <span className="text-green-600">Income:</span>
                                    <span className="font-medium">â‚¹{cashIncome.toLocaleString('en-IN')}</span>
                                </div>
                                <div className="flex justify-between text-sm">
                                    <span className="text-red-600">Expense:</span>
                                    <span className="font-medium">â‚¹{cashExpense.toLocaleString('en-IN')}</span>
                                </div>
                                <div className="pt-2 border-t border-gray-300 flex justify-between text-sm font-bold">
                                    <span>Net:</span>
                                    <span className={cashIncome - cashExpense >= 0 ? 'text-green-700' : 'text-red-700'}>
                                        â‚¹{(cashIncome - cashExpense).toLocaleString('en-IN')}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div className="bg-gray-50 rounded-lg p-4 border border-gray-200">
                            <div className="flex items-center gap-2 mb-3">
                                <CreditCard className="w-4 h-4 text-blue-600" />
                                <span className="text-sm font-medium text-gray-700">UPI</span>
                            </div>
                            <div className="space-y-2">
                                <div className="flex justify-between text-sm">
                                    <span className="text-green-600">Income:</span>
                                    <span className="font-medium">â‚¹{upiIncome.toLocaleString('en-IN')}</span>
                                </div>
                                <div className="flex justify-between text-sm">
                                    <span className="text-red-600">Expense:</span>
                                    <span className="font-medium">â‚¹{upiExpense.toLocaleString('en-IN')}</span>
                                </div>
                                <div className="pt-2 border-t border-gray-300 flex justify-between text-sm font-bold">
                                    <span>Net:</span>
                                    <span className={upiIncome - upiExpense >= 0 ? 'text-green-700' : 'text-red-700'}>
                                        â‚¹{(upiIncome - upiExpense).toLocaleString('en-IN')}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                {/* Category Breakdown */}
                <div>
                    <h4 className="text-sm font-semibold text-gray-700 mb-3">By Category</h4>
                    <div className="space-y-2">
                        {Object.entries(categoryGroups)
                            .sort(([, a], [, b]) => (b.income + b.expense) - (a.income + a.expense))
                            .map(([category, data]) => (
                                <div key={category} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200">
                                    <div>
                                        <p className="font-medium text-gray-900">{category}</p>
                                        <p className="text-xs text-gray-500">{data.count} transaction{data.count !== 1 ? 's' : ''}</p>
                                    </div>
                                    <div className="text-right">
                                        {data.income > 0 && (
                                            <p className="text-sm text-green-600">+â‚¹{data.income.toLocaleString('en-IN')}</p>
                                        )}
                                        {data.expense > 0 && (
                                            <p className="text-sm text-red-600">-â‚¹{data.expense.toLocaleString('en-IN')}</p>
                                        )}
                                    </div>
                                </div>
                            ))}
                    </div>
                </div>
            </div>
        </div>
    );
}


================================================================================
PATH: components\unlock-record-modal.tsx
FILENAME: unlock-record-modal.tsx
================================================================================

'use client';

import { useState } from 'react';
import { useMutation, useQueryClient } from '@tanstack/react-query';
import { Lock, X, AlertCircle } from 'lucide-react';

interface UnlockModalProps {
    recordId: string;
    recordDate: string;
    outletName: string;
    onClose: () => void;
}

export function UnlockRecordModal({ recordId, recordDate, outletName, onClose }: UnlockModalProps) {
    const [reason, setReason] = useState('');
    const queryClient = useQueryClient();

    const unlockMutation = useMutation({
        mutationFn: async () => {
            const res = await fetch(`/api/daily-records/${recordId}/unlock`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ reason })
            });
            if (!res.ok) {
                const error = await res.json();
                throw new Error(error.error || 'Failed to unlock record');
            }
            return res.json();
        },
        onSuccess: () => {
            queryClient.invalidateQueries({ queryKey: ['daily-records'] });
            queryClient.invalidateQueries({ queryKey: ['locked-records'] });
            onClose();
        }
    });

    const handleSubmit = (e: React.FormEvent) => {
        e.preventDefault();
        if (!reason.trim()) {
            alert('Unlock reason is mandatory for audit compliance');
            return;
        }
        unlockMutation.mutate();
    };

    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div className="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6">
                <div className="flex items-center justify-between mb-4">
                    <h3 className="text-xl font-bold text-gray-900 flex items-center gap-2">
                        <Lock className="w-6 h-6 text-orange-600" />
                        Unlock Locked Record
                    </h3>
                    <button
                        onClick={onClose}
                        className="text-gray-400 hover:text-gray-600"
                    >
                        <X className="w-6 h-6" />
                    </button>
                </div>

                <div className="bg-gray-50 rounded-lg p-4 mb-4">
                    <p className="text-sm text-gray-600">Date: <span className="font-medium text-gray-900">{new Date(recordDate).toLocaleDateString('en-IN')}</span></p>
                    <p className="text-sm text-gray-600">Outlet: <span className="font-medium text-gray-900">{outletName}</span></p>
                </div>

                <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                    <div className="flex gap-2">
                        <AlertCircle className="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" />
                        <div>
                            <p className="text-sm font-medium text-red-900 mb-1">âš ï¸ CRITICAL ACTION</p>
                            <p className="text-sm text-red-700">
                                Unlocking will revert this record to "submitted" status and allow modifications.
                                HO Accountant will be notified of this action.
                            </p>
                        </div>
                    </div>
                </div>

                <form onSubmit={handleSubmit}>
                    <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                            Unlock Reason <span className="text-red-600">*</span>
                        </label>
                        <textarea
                            value={reason}
                            onChange={(e) => setReason(e.target.value)}
                            placeholder="e.g., Transaction correction needed, incorrect closing balance, data entry error"
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                            rows={4}
                            required
                        />
                        <p className="text-xs text-gray-500 mt-1">
                            This reason will be permanently logged in the audit trail
                        </p>
                    </div>

                    {unlockMutation.isError && (
                        <div className="bg-red-50 border border-red-200 rounded-lg p-3 mb-4">
                            <p className="text-sm text-red-800">
                                {unlockMutation.error.message}
                            </p>
                        </div>
                    )}

                    <div className="flex gap-3">
                        <button
                            type="button"
                            onClick={onClose}
                            disabled={unlockMutation.isPending}
                            className="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 disabled:opacity-50"
                        >
                            Cancel
                        </button>
                        <button
                            type="submit"
                            disabled={unlockMutation.isPending || !reason.trim()}
                            className="flex-1 px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 disabled:bg-gray-400 flex items-center justify-center gap-2"
                        >
                            {unlockMutation.isPending ? (
                                <>
                                    <div className="h-4 w-4 animate-spin rounded-full border-2 border-white border-t-transparent"></div>
                                    Unlocking...
                                </>
                            ) : (
                                <>
                                    <Lock className="w-4 h-4" />
                                    Unlock Record
                                </>
                            )}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
}


================================================================================
PATH: components\user-menu.tsx
FILENAME: user-menu.tsx
================================================================================

'use client';

import { useRouter } from 'next/navigation';
import { useAuth } from '@/lib/auth-context';
import { useState } from 'react';

interface UserMenuProps {
    user: {
        full_name?: string;
        name?: string;
        role: string;
    };
}

export function UserMenu({ user }: UserMenuProps) {
    const router = useRouter();
    const { signOut } = useAuth();
    const [isLoggingOut, setIsLoggingOut] = useState(false);

    const handleLogout = async () => {
        setIsLoggingOut(true);
        try {
            await signOut();
            // Redirect is handled in auth-context, but we can also force it here
            router.push('/login');
        } catch (error) {
            console.error('Logout error:', error);
            setIsLoggingOut(false);
        }
    };

    const displayName = user.full_name || user.name || 'User';

    return (
        <div className="flex items-center space-x-4">
            <div className="text-right hidden sm:block">
                <p className="text-sm font-medium text-gray-900">{displayName}</p>
                <p className="text-xs text-gray-500">
                    {user.role.replace('_', ' ').toUpperCase()}
                </p>
            </div>
            <button
                onClick={handleLogout}
                disabled={isLoggingOut}
                className="px-4 py-2 text-sm font-medium text-gray-700 hover:text-gray-900 hover:bg-gray-100 rounded-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
            >
                {isLoggingOut ? 'Logging out...' : 'Logout'}
            </button>
        </div>
    );
}


================================================================================
PATH: database\add-auditor-mode.sql
FILENAME: add-auditor-mode.sql
================================================================================

-- =====================================================
-- PHASE 1: Auditor Mode - Database Migration (Updated)
-- =====================================================
-- This migration adds missing auditor features to existing schema

-- 1. Add time-bound access tracking columns to users table
-- (access_start_date and access_end_date already exist)
ALTER TABLE users
ADD COLUMN IF NOT EXISTS auditor_access_granted_at TIMESTAMPTZ,
ADD COLUMN IF NOT EXISTS auditor_access_expires_at TIMESTAMPTZ,
ADD COLUMN IF NOT EXISTS auditor_access_granted_by UUID REFERENCES users(id);

-- Create index for expiry checks
CREATE INDEX IF NOT EXISTS idx_users_auditor_expiry 
ON users(auditor_access_expires_at)
WHERE role = 'auditor';

-- 2. Update auditor_access_log to match our needs
-- (Table already exists, just ensure it has what we need)

-- 3. Add RLS policies for auditor read-only access

-- Enable RLS on tables if not already enabled
ALTER TABLE daily_records ENABLE ROW LEVEL SECURITY;
ALTER TABLE transactions ENABLE ROW LEVEL SECURITY;
ALTER TABLE auditor_access_log ENABLE ROW LEVEL SECURITY;

-- Drop existing auditor policies if they exist (to recreate them)
DROP POLICY IF EXISTS "auditors_view_locked_records" ON daily_records;
DROP POLICY IF EXISTS "auditors_view_transactions" ON transactions;
DROP POLICY IF EXISTS "auditors_view_own_actions" ON auditor_access_log;
DROP POLICY IF EXISTS "admins_view_all_auditor_actions" ON auditor_access_log;

-- Auditors can only view LOCKED daily records with valid access
CREATE POLICY "auditors_view_locked_records"
ON daily_records FOR SELECT
TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM users
    WHERE id = auth.uid()
    AND role = 'auditor'
    AND (auditor_access_expires_at IS NULL OR auditor_access_expires_at > NOW())
  )
  AND status = 'locked'
);

-- Auditors can view transactions for locked records only
CREATE POLICY "auditors_view_transactions"
ON transactions FOR SELECT
TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM users
    WHERE id = auth.uid()
    AND role = 'auditor'
    AND (auditor_access_expires_at IS NULL OR auditor_access_expires_at > NOW())
  )
  AND daily_record_id IN (
    SELECT id FROM daily_records WHERE status = 'locked'
  )
);

-- Auditors can only view their own access logs
CREATE POLICY "auditors_view_own_actions"
ON auditor_access_log FOR SELECT
TO authenticated
USING (auditor_id = auth.uid());

-- Admins can view all auditor actions
CREATE POLICY "admins_view_all_auditor_actions"
ON auditor_access_log FOR SELECT
TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM users
    WHERE id = auth.uid()
    AND role IN ('master_admin', 'superadmin')
  )
);

-- System can insert auditor actions (for logging)
DROP POLICY IF EXISTS "system_insert_auditor_actions" ON auditor_access_log;
CREATE POLICY "system_insert_auditor_actions"
ON auditor_access_log FOR INSERT
TO authenticated
WITH CHECK (auditor_id = auth.uid());

-- 4. Ensure auditors CANNOT modify anything (defensive policies)

-- Prevent auditors from inserting daily records
DROP POLICY IF EXISTS "auditors_cannot_insert_daily_records" ON daily_records;
CREATE POLICY "auditors_cannot_insert_daily_records"
ON daily_records FOR INSERT
TO authenticated
WITH CHECK (
  NOT EXISTS (
    SELECT 1 FROM users
    WHERE id = auth.uid()
    AND role = 'auditor'
  )
);

-- Prevent auditors from updating daily records
DROP POLICY IF EXISTS "auditors_cannot_update_daily_records" ON daily_records;
CREATE POLICY "auditors_cannot_update_daily_records"
ON daily_records FOR UPDATE
TO authenticated
USING (
  NOT EXISTS (
    SELECT 1 FROM users
    WHERE id = auth.uid()
    AND role = 'auditor'
  )
);

-- Prevent auditors from deleting daily records
DROP POLICY IF EXISTS "auditors_cannot_delete_daily_records" ON daily_records;
CREATE POLICY "auditors_cannot_delete_daily_records"
ON daily_records FOR DELETE
TO authenticated
USING (
  NOT EXISTS (
    SELECT 1 FROM users
    WHERE id = auth.uid()
    AND role = 'auditor'
  )
);

-- Same for transactions
DROP POLICY IF EXISTS "auditors_cannot_insert_transactions" ON transactions;
CREATE POLICY "auditors_cannot_insert_transactions"
ON transactions FOR INSERT
TO authenticated
WITH CHECK (
  NOT EXISTS (
    SELECT 1 FROM users
    WHERE id = auth.uid()
    AND role = 'auditor'
  )
);

DROP POLICY IF EXISTS "auditors_cannot_update_transactions" ON transactions;
CREATE POLICY "auditors_cannot_update_transactions"
ON transactions FOR UPDATE
TO authenticated
USING (
  NOT EXISTS (
    SELECT 1 FROM users
    WHERE id = auth.uid()
    AND role = 'auditor'
  )
);

DROP POLICY IF EXISTS "auditors_cannot_delete_transactions" ON transactions;
CREATE POLICY "auditors_cannot_delete_transactions"
ON transactions FOR DELETE
TO authenticated
USING (
  NOT EXISTS (
    SELECT 1 FROM users
    WHERE id = auth.uid()
    AND role = 'auditor'
  )
);

-- 5. Create indexes for performance
CREATE INDEX IF NOT EXISTS idx_auditor_access_log_auditor 
ON auditor_access_log(auditor_id, accessed_at DESC);

CREATE INDEX IF NOT EXISTS idx_auditor_access_log_accessed 
ON auditor_access_log(accessed_at DESC);

-- 6. Add comments for documentation
COMMENT ON COLUMN users.auditor_access_granted_at IS 'Timestamp when auditor access was granted';
COMMENT ON COLUMN users.auditor_access_expires_at IS 'Timestamp when auditor access expires';
COMMENT ON COLUMN users.auditor_access_granted_by IS 'Admin user who granted the access';
COMMENT ON TABLE auditor_access_log IS 'Logs all actions performed by auditors for compliance tracking';

-- Migration complete
SELECT 'Auditor mode migration completed successfully' AS status;


================================================================================
PATH: database\add-auditor-role.sql
FILENAME: add-auditor-role.sql
================================================================================

-- 1. Update the Check Constraint on users table to allow 'auditor' role
ALTER TABLE users DROP CONSTRAINT IF EXISTS users_role_check;
ALTER TABLE users ADD CONSTRAINT users_role_check 
  CHECK (role IN ('master_admin', 'ho_accountant', 'outlet_manager', 'outlet_staff', 'auditor'));

-- 2. Create RLS Policies for Auditor Role

-- Outlets: View all outlets
CREATE POLICY "Auditors view all outlets" ON outlets
  FOR SELECT
  USING (
    auth.uid() IN (
      SELECT id FROM users WHERE role = 'auditor'
    )
  );

-- Users: View all users (to see who created records)
CREATE POLICY "Auditors view all users" ON users
  FOR SELECT
  USING (
    auth.uid() IN (
      SELECT id FROM users WHERE role = 'auditor'
    )
  );

-- Daily Records: View ONLY 'locked' records
CREATE POLICY "Auditors view locked records only" ON daily_records
  FOR SELECT
  USING (
    auth.uid() IN (
      SELECT id FROM users WHERE role = 'auditor'
    )
    AND status = 'locked'
  );

-- Transactions: View transactions belonging to 'locked' daily records
CREATE POLICY "Auditors view locked transactions" ON transactions
  FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM daily_records dr
      WHERE dr.id = transactions.daily_record_id
      AND dr.status = 'locked'
    )
    AND auth.uid() IN (
      SELECT id FROM users WHERE role = 'auditor'
    )
  );

-- Monthly Summaries: View all summaries (these are derived data)
CREATE POLICY "Auditors view monthly summaries" ON monthly_summaries
  FOR SELECT
  USING (
    auth.uid() IN (
      SELECT id FROM users WHERE role = 'auditor'
    )
  );


================================================================================
PATH: database\add-sheets-sync-tracking.sql
FILENAME: add-sheets-sync-tracking.sql
================================================================================

-- STEP 4: Google Sheets Sync - Database Schema Updates
-- Add sync tracking columns to daily_records table
-- Create sheet_sync_log table for audit trail

-- 1. Add sync tracking columns to daily_records
ALTER TABLE daily_records
ADD COLUMN IF NOT EXISTS synced_to_sheets BOOLEAN DEFAULT FALSE,
ADD COLUMN IF NOT EXISTS last_synced_at TIMESTAMPTZ,
ADD COLUMN IF NOT EXISTS sheet_sync_error TEXT;

-- Add index for filtering unsynced records
CREATE INDEX IF NOT EXISTS idx_daily_records_sync_status 
ON daily_records(synced_to_sheets, status) 
WHERE status = 'locked';

-- Add comment
COMMENT ON COLUMN daily_records.synced_to_sheets IS 'Flag indicating if record has been synced to Google Sheets';
COMMENT ON COLUMN daily_records.last_synced_at IS 'Timestamp of last successful sync to Google Sheets';
COMMENT ON COLUMN daily_records.sheet_sync_error IS 'Error message if sync failed, NULL on success';

-- 2. Create sheet_sync_log table for detailed audit trail
CREATE TABLE IF NOT EXISTS sheet_sync_log (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    daily_record_id UUID NOT NULL REFERENCES daily_records(id) ON DELETE CASCADE,
    spreadsheet_id TEXT,
    spreadsheet_url TEXT,
    sync_status TEXT NOT NULL CHECK (sync_status IN ('success', 'failed', 'pending')),
    error_message TEXT,
    synced_at TIMESTAMPTZ DEFAULT NOW(),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    
    -- Metadata
    synced_by UUID REFERENCES users(id),
    sync_trigger TEXT CHECK (sync_trigger IN ('auto', 'manual', 'cron', 'retry'))
);

-- Add indexes for common queries
CREATE INDEX IF NOT EXISTS idx_sheet_sync_log_record 
ON sheet_sync_log(daily_record_id, created_at DESC);

CREATE INDEX IF NOT EXISTS idx_sheet_sync_log_status 
ON sheet_sync_log(sync_status, synced_at DESC);

CREATE INDEX IF NOT EXISTS idx_sheet_sync_log_failures
ON sheet_sync_log(sync_status, daily_record_id)
WHERE sync_status = 'failed';

-- Add comments
COMMENT ON TABLE sheet_sync_log IS 'Audit trail for all Google Sheets synchronization attempts';
COMMENT ON COLUMN sheet_sync_log.sync_trigger IS 'How the sync was triggered: auto (on lock), manual (user button), cron (scheduled), retry (automatic retry)';

-- 3. Add RLS policies for sheet_sync_log
ALTER TABLE sheet_sync_log ENABLE ROW LEVEL SECURITY;

-- HO accountants and superadmins can view all sync logs
CREATE POLICY "HO and admins can view sync logs"
ON sheet_sync_log FOR SELECT
USING (
    EXISTS (
        SELECT 1 FROM users
        WHERE users.id = auth.uid()
        AND users.role IN ('ho_accountant', 'superadmin', 'master_admin')
    )
);

-- Only system can insert sync logs (via API)
CREATE POLICY "System can insert sync logs"
ON sheet_sync_log FOR INSERT
WITH CHECK (true);

-- Grant necessary permissions
GRANT SELECT ON sheet_sync_log TO authenticated;
GRANT INSERT ON sheet_sync_log TO authenticated;


================================================================================
PATH: database\add-time-bound-access.sql
FILENAME: add-time-bound-access.sql
================================================================================

-- =====================================================================
-- TIME-BOUND ACCESS CONTROL
-- =====================================================================
-- Purpose: Add time-bound access columns and validation function
-- Created: 2025-12-24
-- =====================================================================

-- Add time-bound access columns to users table
ALTER TABLE users 
ADD COLUMN IF NOT EXISTS access_start_date DATE,
ADD COLUMN IF NOT EXISTS access_end_date DATE;

-- Create function to check if user's access is currently valid
CREATE OR REPLACE FUNCTION is_access_valid(user_id UUID)
RETURNS BOOLEAN AS $$
DECLARE
    start_date DATE;
    end_date DATE;
    current_date DATE := CURRENT_DATE;
    user_role TEXT;
BEGIN
    -- Get user access dates and role
    SELECT access_start_date, access_end_date, role
    INTO start_date, end_date, user_role
    FROM users 
    WHERE id = user_id;
    
    -- If user doesn't exist, return false
    IF user_role IS NULL THEN
        RETURN FALSE;
    END IF;
    
    -- If user is not an auditor, time bounds don't apply
    IF user_role != 'auditor' THEN
        RETURN TRUE;
    END IF;
    
    -- If no dates set for auditor, access is valid (indefinite)
    IF start_date IS NULL AND end_date IS NULL THEN
        RETURN TRUE;
    END IF;
    
    -- Check if current date is within the valid range
    RETURN (
        (start_date IS NULL OR current_date >= start_date) AND
        (end_date IS NULL OR current_date <= end_date)
    );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Create function to get days until access expires
CREATE OR REPLACE FUNCTION days_until_expiry(user_id UUID)
RETURNS INTEGER AS $$
DECLARE
    end_date DATE;
    current_date DATE := CURRENT_DATE;
BEGIN
    SELECT access_end_date
    INTO end_date
    FROM users 
    WHERE id = user_id;
    
    -- If no expiry date, return NULL (indefinite access)
    IF end_date IS NULL THEN
        RETURN NULL;
    END IF;
    
    -- Calculate days remaining
    RETURN end_date - current_date;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Add index for efficient access validation queries
CREATE INDEX IF NOT EXISTS idx_users_access_dates 
ON users(access_end_date) 
WHERE role = 'auditor' AND access_end_date IS NOT NULL;

-- Comments for documentation
COMMENT ON COLUMN users.access_start_date IS 'Date when user access becomes active (primarily for auditors)';
COMMENT ON COLUMN users.access_end_date IS 'Date when user access expires (primarily for auditors)';
COMMENT ON FUNCTION is_access_valid(UUID) IS 'Checks if a user has valid time-bound access';
COMMENT ON FUNCTION days_until_expiry(UUID) IS 'Returns number of days until access expires, NULL if indefinite';

-- Verification queries
SELECT 
    column_name,
    data_type,
    is_nullable
FROM information_schema.columns
WHERE table_name = 'users'
AND column_name IN ('access_start_date', 'access_end_date');

-- Test the validation function
SELECT 
    id,
    email,
    role,
    access_start_date,
    access_end_date,
    is_access_valid(id) as has_valid_access,
    days_until_expiry(id) as days_remaining
FROM users
WHERE role = 'auditor';


================================================================================
PATH: database\assign-staff-outlet.sql
FILENAME: assign-staff-outlet.sql
================================================================================

-- Assign outlet to staff user to fix "Loading daily record..." issue
UPDATE users SET outlet_id = '9e0c4614-53cf-40d3-abdd-a1d0183c3909' 
WHERE email = 'staff.test@sahakar.com';

-- Verify the assignment
SELECT email, name, role, outlet_id FROM users WHERE email = 'staff.test@sahakar.com';


================================================================================
PATH: database\auditor-access-log.sql
FILENAME: auditor-access-log.sql
================================================================================

-- =====================================================================
-- AUDITOR ACCESS LOG TABLE
-- =====================================================================
-- Purpose: Track all auditor data access for compliance and audit trail
-- Created: 2025-12-24
-- =====================================================================

-- Create auditor access log table
CREATE TABLE IF NOT EXISTS auditor_access_log (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    auditor_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    outlet_id UUID REFERENCES outlets(id),
    action TEXT NOT NULL, -- 'view_dashboard', 'view_record', 'export_excel', 'export_pdf'
    entity_type TEXT, -- 'daily_record', 'transaction', etc.
    entity_id UUID,
    accessed_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    ip_address TEXT,
    user_agent TEXT,
    
    -- Constraints
    CONSTRAINT valid_action CHECK (
        action IN ('view_dashboard', 'view_record', 'view_transaction', 'export_excel', 'export_pdf', 'filter_data')
    )
);

-- Index for auditor activity queries
CREATE INDEX IF NOT EXISTS idx_auditor_access_log_auditor 
ON auditor_access_log(auditor_id, accessed_at DESC);

-- Index for outlet-wise access tracking
CREATE INDEX IF NOT EXISTS idx_auditor_access_log_outlet 
ON auditor_access_log(outlet_id, accessed_at DESC);

-- Index for action-based queries
CREATE INDEX IF NOT EXISTS idx_auditor_access_log_action 
ON auditor_access_log(action, accessed_at DESC);

-- Enable Row Level Security
ALTER TABLE auditor_access_log ENABLE ROW LEVEL SECURITY;

-- RLS Policy: Only superadmin can read audit logs
CREATE POLICY "superadmin_can_read_audit_logs"
ON auditor_access_log
FOR SELECT
USING (
    EXISTS (
        SELECT 1 FROM users
        WHERE users.id = auth.uid()
        AND users.role = 'superadmin'
    )
);

-- RLS Policy: Auditors can insert their own logs
CREATE POLICY "auditors_can_insert_own_logs"
ON auditor_access_log
FOR INSERT
WITH CHECK (
    auditor_id = auth.uid()
    AND EXISTS (
        SELECT 1 FROM users
        WHERE users.id = auth.uid()
        AND users.role = 'auditor'
    )
);

-- Comment for documentation
COMMENT ON TABLE auditor_access_log IS 'Tracks all data access by auditors for compliance and audit purposes';
COMMENT ON COLUMN auditor_access_log.action IS 'Type of action performed: view_dashboard, view_record, export_excel, export_pdf';
COMMENT ON COLUMN auditor_access_log.entity_type IS 'Type of entity accessed: daily_record, transaction';

-- Verification query
SELECT 
    table_name,
    column_name,
    data_type,
    is_nullable
FROM information_schema.columns
WHERE table_name = 'auditor_access_log'
ORDER BY ordinal_position;


================================================================================
PATH: database\auditor-rls-policies.sql
FILENAME: auditor-rls-policies.sql
================================================================================

-- =====================================================================
-- AUDITOR RLS POLICIES
-- =====================================================================
-- Purpose: Restrict auditors to read-only access of locked data only
-- Created: 2025-12-24
-- =====================================================================

-- =================================================================
-- AUDITOR READ-ONLY ACCESS (LOCKED DATA ONLY)
-- =================================================================

-- Daily Records: Auditors can ONLY read locked records
CREATE POLICY "auditors_read_locked_daily_records"
ON daily_records
FOR SELECT
USING (
    EXISTS (
        SELECT 1 FROM users
        WHERE users.id = auth.uid()
        AND users.role = 'auditor'
        AND is_access_valid(users.id) = TRUE
    )
    AND status = 'locked'
);

-- Transactions: Auditors can read transactions of locked daily records only
CREATE POLICY "auditors_read_locked_transactions"
ON transactions
FOR SELECT
USING (
    EXISTS (
        SELECT 1 FROM users
        WHERE users.id = auth.uid()
        AND users.role = 'auditor'
        AND is_access_valid(users.id) = TRUE
    )
    AND daily_record_id IN (
        SELECT id FROM daily_records WHERE status = 'locked'
    )
);

-- Outlets: Auditors can read outlet info for context
CREATE POLICY "auditors_read_outlets"
ON outlets
FOR SELECT
USING (
    EXISTS (
        SELECT 1 FROM users
        WHERE users.id = auth.uid()
        AND users.role = 'auditor'
        AND is_access_valid(users.id) = TRUE
    )
);

-- Categories: Auditors can read categories for transaction categorization
CREATE POLICY "auditors_read_categories"
ON categories
FOR SELECT
USING (
    EXISTS (
        SELECT 1 FROM users
        WHERE users.id = auth.uid()
        AND users.role = 'auditor'
        AND is_access_valid(users.id) = TRUE
    )
);

-- Users: Auditors can read basic user info (for audit trail context)
CREATE POLICY "auditors_read_users"
ON users
FOR SELECT
USING (
    EXISTS (
        SELECT 1 FROM users u
        WHERE u.id = auth.uid()
        AND u.role = 'auditor'
        AND is_access_valid(u.id) = TRUE
    )
);

-- =================================================================
-- PREVENT AUDITOR MODIFICATIONS (ALL TABLES)
-- =================================================================

-- Block auditors from INSERT/UPDATE/DELETE on daily_records
CREATE POLICY "auditors_cannot_modify_daily_records"
ON daily_records
AS RESTRICTIVE
FOR ALL
USING (
    NOT EXISTS (
        SELECT 1 FROM users
        WHERE users.id = auth.uid()
        AND users.role = 'auditor'
    )
);

-- Block auditors from INSERT/UPDATE/DELETE on transactions
CREATE POLICY "auditors_cannot_modify_transactions"
ON transactions
AS RESTRICTIVE
FOR ALL
USING (
    NOT EXISTS (
        SELECT 1 FROM users
        WHERE users.id = auth.uid()
        AND users.role = 'auditor'
    )
);

-- Block auditors from modifying outlets
CREATE POLICY "auditors_cannot_modify_outlets"
ON outlets
AS RESTRICTIVE
FOR ALL
USING (
    NOT EXISTS (
        SELECT 1 FROM users
        WHERE users.id = auth.uid()
        AND users.role = 'auditor'
    )
);

-- Block auditors from modifying categories
CREATE POLICY "auditors_cannot_modify_categories"
ON categories
AS RESTRICTIVE
FOR ALL
USING (
    NOT EXISTS (
        SELECT 1 FROM users
        WHERE users.id = auth.uid()
        AND users.role = 'auditor'
    )
);

-- Block auditors from modifying users
CREATE POLICY "auditors_cannot_modify_users"
ON users
AS RESTRICTIVE
FOR ALL
USING (
    NOT EXISTS (
        SELECT 1 FROM users u
        WHERE u.id = auth.uid()
        AND u.role = 'auditor'
    )
);

-- =================================================================
-- VERIFICATION & TESTING
-- =================================================================

-- List all policies for auditor role
SELECT 
    schemaname,
    tablename,
    policyname,
    permissive,
    roles,
    cmd,
    qual
FROM pg_policies
WHERE policyname LIKE '%auditor%'
ORDER BY tablename, policyname;

-- Test query (run as auditor user):
-- Should only return locked records
/*
SELECT COUNT(*) as locked_records
FROM daily_records
WHERE status = 'locked';

SELECT COUNT(*) as all_records
FROM daily_records; -- Should fail or return only locked ones for auditors
*/

COMMENT ON POLICY "auditors_read_locked_daily_records" ON daily_records IS 'Allows auditors to read only locked daily records with valid time-bound access';
COMMENT ON POLICY "auditors_cannot_modify_daily_records" ON daily_records IS 'Prevents auditors from INSERT/UPDATE/DELETE operations';


================================================================================
PATH: database\auto-sync-trigger.sql
FILENAME: auto-sync-trigger.sql
================================================================================

-- ============================================================================
-- AUTO-SYNC GOOGLE SHEETS ON RECORD LOCK
-- ============================================================================
-- This creates a database trigger that automatically syncs locked records
-- to Google Sheets when a daily record status changes to 'locked'
-- ============================================================================

-- Create function to call webhook
CREATE OR REPLACE FUNCTION trigger_google_sheets_sync()
RETURNS TRIGGER AS $$
DECLARE
    webhook_url TEXT;
BEGIN
    -- Only trigger if status changed to 'locked'
    IF NEW.status = 'locked' AND (OLD.status IS DISTINCT FROM 'locked') THEN
        
        -- Get the webhook URL from environment (set in Supabase dashboard)
        -- You'll need to set this in Supabase Settings â†’ Database â†’ Extensions â†’ pg_net
        webhook_url := current_setting('app.settings.sync_webhook_url', TRUE);
        
        -- Call the sync API endpoint (requires pg_net extension or use pg_cron)
        -- For now, we'll log the event and you can set up a cron job to check for new locked records
        
        RAISE NOTICE 'Record locked: % - Triggering Google Sheets sync', NEW.id;
        
        -- Option 1: Use pg_net (if available)
        -- PERFORM net.http_post(
        --     url := webhook_url || '/api/sync/google-sheets',
        --     headers := '{"Content-Type": "application/json"}'::jsonb,
        --     body := jsonb_build_object('record_id', NEW.id)
        -- );
        
        -- Option 2: Update a flag for cron job to process
        NEW.synced_to_sheet := FALSE;
        
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Create trigger on daily_records table
DROP TRIGGER IF EXISTS auto_sync_on_lock ON daily_records;

CREATE TRIGGER auto_sync_on_lock
    BEFORE UPDATE ON daily_records
    FOR EACH ROW
    EXECUTE FUNCTION trigger_google_sheets_sync();

-- ============================================================================
-- ALTERNATIVE: SCHEDULED SYNC JOB
-- ============================================================================
-- If you prefer a scheduled approach instead of real-time

-- Create function to sync pending records
CREATE OR REPLACE FUNCTION sync_pending_locked_records()
RETURNS void AS $$
DECLARE
    record_count INTEGER;
BEGIN
    -- Count records that need syncing
    SELECT COUNT(*) INTO record_count
    FROM daily_records
    WHERE status = 'locked' 
    AND (synced_to_sheet = FALSE OR synced_to_sheet IS NULL);
    
    IF record_count > 0 THEN
        RAISE NOTICE 'Found % locked records pending sync', record_count;
        
        -- You would call your API here
        -- For now, just mark them as needing attention
        -- The actual sync will happen via the API endpoint
    END IF;
END;
$$ LANGUAGE plpgsql;

-- Schedule this to run every hour using pg_cron (if available):
-- SELECT cron.schedule(
--     'sync-locked-records',
--     '0 * * * *',  -- Every hour
--     $$SELECT sync_pending_locked_records()$$
-- );

-- ============================================================================
-- MANUAL TRIGGER ALTERNATIVE
-- ============================================================================
-- If you don't have pg_net or pg_cron, use a simple flag system

-- The trigger above already sets synced_to_sheet = FALSE
-- Your sync API can query for these records:

-- SELECT * FROM daily_records 
-- WHERE status = 'locked' 
-- AND (synced_to_sheet = FALSE OR synced_to_sheet IS NULL);

-- Then mark them as synced after successful sync:
-- UPDATE daily_records SET synced_to_sheet = TRUE WHERE id = ...

-- ============================================================================
-- TESTING
-- ============================================================================
-- Test the trigger:
-- UPDATE daily_records SET status = 'locked' WHERE id = '...';
-- Check the logs for the NOTICE message

-- ============================================================================
-- NOTES
-- ============================================================================
-- 1. For real-time webhooks, you need pg_net extension enabled in Supabase
-- 2. For scheduled jobs, you need pg_cron extension
-- 3. The fallback is to query for unsynced locked records via API
-- 4. Current implementation: Trigger sets synced_to_sheet = FALSE,
--    and your sync API should check for these records
-- ============================================================================


================================================================================
PATH: database\current_schema.sql
FILENAME: current_schema.sql
================================================================================

-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.audit_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  action text,
  entity text,
  entity_id uuid,
  old_data jsonb,
  new_data jsonb,
  created_at timestamp without time zone DEFAULT now(),
  CONSTRAINT audit_logs_pkey PRIMARY KEY (id)
);
CREATE TABLE public.auditor_access_log (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  auditor_id uuid NOT NULL,
  outlet_id uuid,
  action text NOT NULL CHECK (action = ANY (ARRAY['view_dashboard'::text, 'view_record'::text, 'view_transaction'::text, 'export_excel'::text, 'export_pdf'::text, 'filter_data'::text])),
  entity_type text,
  entity_id uuid,
  accessed_at timestamp with time zone NOT NULL DEFAULT now(),
  ip_address text,
  user_agent text,
  CONSTRAINT auditor_access_log_pkey PRIMARY KEY (id),
  CONSTRAINT auditor_access_log_auditor_id_fkey FOREIGN KEY (auditor_id) REFERENCES public.users(id),
  CONSTRAINT auditor_access_log_outlet_id_fkey FOREIGN KEY (outlet_id) REFERENCES public.outlets(id)
);
CREATE TABLE public.auditor_outlets (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  outlet_id uuid,
  CONSTRAINT auditor_outlets_pkey PRIMARY KEY (id)
);
CREATE TABLE public.business_days (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  outlet_id uuid,
  date date NOT NULL,
  opening_cash numeric NOT NULL,
  opening_upi numeric NOT NULL,
  closing_cash numeric,
  closing_upi numeric,
  status USER-DEFINED DEFAULT 'DRAFT'::day_status,
  submitted_by uuid,
  submitted_at timestamp without time zone,
  locked_by uuid,
  locked_at timestamp without time zone,
  CONSTRAINT business_days_pkey PRIMARY KEY (id)
);
CREATE TABLE public.categories (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  code character varying NOT NULL UNIQUE,
  name character varying NOT NULL,
  type character varying NOT NULL CHECK (type::text = ANY (ARRAY['income'::character varying, 'expense'::character varying]::text[])),
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT categories_pkey PRIMARY KEY (id)
);
CREATE TABLE public.daily_records (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  outlet_id uuid NOT NULL,
  date date NOT NULL,
  particulars text NOT NULL,
  amount numeric NOT NULL,
  category text NOT NULL,
  payment_mode text,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  synced_to_sheets boolean DEFAULT false,
  opening_cash numeric DEFAULT 0,
  opening_upi numeric DEFAULT 0,
  closing_cash numeric,
  closing_upi numeric,
  total_income numeric,
  total_expense numeric,
  status character varying DEFAULT 'draft'::character varying,
  submitted_at timestamp with time zone,
  submitted_by uuid,
  locked_at timestamp with time zone,
  locked_by uuid,
  CONSTRAINT daily_records_pkey PRIMARY KEY (id),
  CONSTRAINT daily_entries_outlet_id_fkey FOREIGN KEY (outlet_id) REFERENCES public.outlets(id),
  CONSTRAINT daily_entries_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id),
  CONSTRAINT daily_records_submitted_by_fkey FOREIGN KEY (submitted_by) REFERENCES public.users(id),
  CONSTRAINT daily_records_locked_by_fkey FOREIGN KEY (locked_by) REFERENCES public.users(id)
);
CREATE TABLE public.daily_totals (
  business_day_id uuid NOT NULL,
  income_cash numeric,
  income_upi numeric,
  expense_cash numeric,
  expense_upi numeric,
  CONSTRAINT daily_totals_pkey PRIMARY KEY (business_day_id),
  CONSTRAINT daily_totals_business_day_id_fkey FOREIGN KEY (business_day_id) REFERENCES public.business_days(id)
);
CREATE TABLE public.monthly_summaries (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  outlet_id uuid NOT NULL,
  month date NOT NULL,
  total_income numeric DEFAULT 0,
  total_expense numeric DEFAULT 0,
  total_cash_in numeric DEFAULT 0,
  total_cash_out numeric DEFAULT 0,
  total_upi_in numeric DEFAULT 0,
  total_upi_out numeric DEFAULT 0,
  net_profit numeric DEFAULT 0,
  opening_balance numeric DEFAULT 0,
  closing_balance numeric DEFAULT 0,
  days_count integer DEFAULT 0,
  generated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT monthly_summaries_pkey PRIMARY KEY (id),
  CONSTRAINT monthly_summaries_outlet_id_fkey FOREIGN KEY (outlet_id) REFERENCES public.outlets(id)
);
CREATE TABLE public.outlets (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  name text NOT NULL,
  location text,
  created_at timestamp with time zone DEFAULT now(),
  code character varying NOT NULL,
  address text,
  phone character varying,
  email character varying,
  google_sheet_id character varying,
  is_active boolean DEFAULT true,
  updated_at timestamp with time zone DEFAULT now(),
  type character varying NOT NULL DEFAULT 'hyper_pharmacy'::character varying CHECK (type::text = ANY (ARRAY['hyper_pharmacy'::character varying, 'smart_clinic'::character varying]::text[])),
  CONSTRAINT outlets_pkey PRIMARY KEY (id)
);
CREATE TABLE public.roles (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL UNIQUE,
  CONSTRAINT roles_pkey PRIMARY KEY (id)
);
CREATE TABLE public.transactions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  daily_record_id uuid,
  type character varying NOT NULL CHECK (type::text = ANY (ARRAY['income'::character varying, 'expense'::character varying]::text[])),
  category character varying NOT NULL,
  payment_mode character varying NOT NULL CHECK (payment_mode::text = ANY (ARRAY['cash'::character varying, 'upi'::character varying]::text[])),
  amount numeric NOT NULL CHECK (amount > 0::numeric),
  description text,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  idempotency_key text,
  CONSTRAINT transactions_pkey PRIMARY KEY (id),
  CONSTRAINT transactions_daily_record_id_fkey FOREIGN KEY (daily_record_id) REFERENCES public.daily_records(id),
  CONSTRAINT transactions_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id)
);
CREATE TABLE public.user_outlets (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  outlet_id uuid,
  CONSTRAINT user_outlets_pkey PRIMARY KEY (id)
);
CREATE TABLE public.users (
  id uuid NOT NULL,
  email text NOT NULL UNIQUE,
  name text NOT NULL,
  role text NOT NULL CHECK (role = ANY (ARRAY['master_admin'::text, 'ho_accountant'::text, 'outlet_manager'::text, 'outlet_staff'::text, 'auditor'::text, 'superadmin'::text])),
  outlet_id uuid,
  created_at timestamp with time zone DEFAULT now(),
  access_start_date date,
  access_end_date date,
  CONSTRAINT users_pkey PRIMARY KEY (id),
  CONSTRAINT users_id_fkey FOREIGN KEY (id) REFERENCES auth.users(id),
  CONSTRAINT users_outlet_id_fkey FOREIGN KEY (outlet_id) REFERENCES public.outlets(id)
);

================================================================================
PATH: database\expand-audit-logs.sql
FILENAME: expand-audit-logs.sql
================================================================================

-- =====================================================================
-- EXPAND AUDIT LOGS TABLE
-- =====================================================================
-- Purpose: Add columns for enhanced audit trail (reason, IP, severity)
-- Created: 2025-12-24
-- Note: Working with existing schema (entity, old_data, new_data columns)
-- =====================================================================

-- Add new columns to audit_logs table if they don't exist
ALTER TABLE audit_logs 
ADD COLUMN IF NOT EXISTS reason TEXT,
ADD COLUMN IF NOT EXISTS ip_address TEXT,
ADD COLUMN IF NOT EXISTS user_agent TEXT,
ADD COLUMN IF NOT EXISTS severity TEXT DEFAULT 'normal' 
    CHECK (severity IN ('normal', 'warning', 'critical'));

-- Create index for querying by severity (critical actions first)
CREATE INDEX IF NOT EXISTS idx_audit_logs_severity 
ON audit_logs(severity, created_at DESC);

-- Create index for user activity tracking
CREATE INDEX IF NOT EXISTS idx_audit_logs_user_action 
ON audit_logs(user_id, action, created_at DESC);

-- Create index for entity tracking
CREATE INDEX IF NOT EXISTS idx_audit_logs_entity 
ON audit_logs(entity, entity_id, created_at DESC);

-- Add comments for documentation
COMMENT ON COLUMN audit_logs.reason IS 
'Mandatory for critical actions like unlock_day. Optional for normal actions.';

COMMENT ON COLUMN audit_logs.ip_address IS 
'IP address of the user performing the action (for security audit)';

COMMENT ON COLUMN audit_logs.user_agent IS 
'Browser/client user agent (for device tracking)';

COMMENT ON COLUMN audit_logs.severity IS 
'Severity level: normal (default), warning (important), critical (requires immediate attention)';

-- Verification query - check if new columns were added
SELECT 
    column_name,
    data_type,
    is_nullable,
    column_default
FROM information_schema.columns
WHERE table_name = 'audit_logs'
AND column_name IN ('reason', 'ip_address', 'user_agent', 'severity')
ORDER BY column_name;

SELECT 'audit_logs table expanded successfully' as status;



================================================================================
PATH: database\fix-auditor-migration.sql
FILENAME: fix-auditor-migration.sql
================================================================================

-- FIX: Add 'superadmin' to the allowed roles list to match existing data
-- The previous script failed because 'superadmin' was missing from the check list

-- 1. Update the Check Constraint (Safe Mode)
ALTER TABLE users DROP CONSTRAINT IF EXISTS users_role_check;

ALTER TABLE users ADD CONSTRAINT users_role_check 
  CHECK (role IN (
    'master_admin', 
    'ho_accountant', 
    'outlet_manager', 
    'outlet_staff', 
    'auditor',
    'superadmin'  -- Added this to fix the violation
  ));

-- 2. Re-apply RLS Policies (Idempotent)

-- Drop existing policies to avoid conflicts if they were partially created
DROP POLICY IF EXISTS "Auditors view all outlets" ON outlets;
DROP POLICY IF EXISTS "Auditors view all users" ON users;
DROP POLICY IF EXISTS "Auditors view locked records only" ON daily_records;
DROP POLICY IF EXISTS "Auditors view locked transactions" ON transactions;
DROP POLICY IF EXISTS "Auditors view monthly summaries" ON monthly_summaries;

-- Re-create Policies
CREATE POLICY "Auditors view all outlets" ON outlets FOR SELECT USING (auth.uid() IN (SELECT id FROM users WHERE role = 'auditor'));
CREATE POLICY "Auditors view all users" ON users FOR SELECT USING (auth.uid() IN (SELECT id FROM users WHERE role = 'auditor'));
CREATE POLICY "Auditors view locked records only" ON daily_records FOR SELECT USING (auth.uid() IN (SELECT id FROM users WHERE role = 'auditor') AND status = 'locked');
CREATE POLICY "Auditors view locked transactions" ON transactions FOR SELECT USING (EXISTS (SELECT 1 FROM daily_records dr WHERE dr.id = transactions.daily_record_id AND dr.status = 'locked') AND auth.uid() IN (SELECT id FROM users WHERE role = 'auditor'));
CREATE POLICY "Auditors view monthly summaries" ON monthly_summaries FOR SELECT USING (auth.uid() IN (SELECT id FROM users WHERE role = 'auditor'));


================================================================================
PATH: database\fix-auditor-migration_v2.sql
FILENAME: fix-auditor-migration_v2.sql
================================================================================

-- 1. FIX: Update User Check Constraint (Including 'superadmin')
ALTER TABLE users DROP CONSTRAINT IF EXISTS users_role_check;

ALTER TABLE users ADD CONSTRAINT users_role_check 
  CHECK (role IN (
    'master_admin', 
    'ho_accountant', 
    'outlet_manager', 
    'outlet_staff', 
    'auditor',
    'superadmin'
  ));

-- 2. FIX: Create monthly_summaries if missing (to prevent Policy error)
CREATE TABLE IF NOT EXISTS monthly_summaries (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  outlet_id UUID NOT NULL REFERENCES outlets(id) ON DELETE CASCADE,
  month DATE NOT NULL,
  total_income DECIMAL(12, 2) DEFAULT 0,
  total_expense DECIMAL(12, 2) DEFAULT 0,
  total_cash_in DECIMAL(12, 2) DEFAULT 0,
  total_cash_out DECIMAL(12, 2) DEFAULT 0,
  total_upi_in DECIMAL(12, 2) DEFAULT 0,
  total_upi_out DECIMAL(12, 2) DEFAULT 0,
  net_profit DECIMAL(12, 2) DEFAULT 0,
  opening_balance DECIMAL(12, 2) DEFAULT 0,
  closing_balance DECIMAL(12, 2) DEFAULT 0,
  days_count INTEGER DEFAULT 0,
  generated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(outlet_id, month)
);

-- Enable RLS on monthly_summaries if it was just created
ALTER TABLE monthly_summaries ENABLE ROW LEVEL SECURITY;

-- 3. Safely Re-apply RLS Policies
DROP POLICY IF EXISTS "Auditors view all outlets" ON outlets;
DROP POLICY IF EXISTS "Auditors view all users" ON users;
DROP POLICY IF EXISTS "Auditors view locked records only" ON daily_records;
DROP POLICY IF EXISTS "Auditors view locked transactions" ON transactions;
DROP POLICY IF EXISTS "Auditors view monthly summaries" ON monthly_summaries;

CREATE POLICY "Auditors view all outlets" ON outlets FOR SELECT USING (auth.uid() IN (SELECT id FROM users WHERE role = 'auditor'));
CREATE POLICY "Auditors view all users" ON users FOR SELECT USING (auth.uid() IN (SELECT id FROM users WHERE role = 'auditor'));
CREATE POLICY "Auditors view locked records only" ON daily_records FOR SELECT USING (auth.uid() IN (SELECT id FROM users WHERE role = 'auditor') AND status = 'locked');
CREATE POLICY "Auditors view locked transactions" ON transactions FOR SELECT USING (EXISTS (SELECT 1 FROM daily_records dr WHERE dr.id = transactions.daily_record_id AND dr.status = 'locked') AND auth.uid() IN (SELECT id FROM users WHERE role = 'auditor'));
CREATE POLICY "Auditors view monthly summaries" ON monthly_summaries FOR SELECT USING (auth.uid() IN (SELECT id FROM users WHERE role = 'auditor'));


================================================================================
PATH: database\fix-demo-profiles.sql
FILENAME: fix-demo-profiles.sql
================================================================================

-- =====================================================
-- Fix: Profile Not Found - Add Demo User Profiles
-- =====================================================
-- This script creates user profiles for all demo accounts

-- Insert demo user profiles (if they don't exist)
INSERT INTO users (id, email, name, role, created_at)
SELECT 
    auth.users.id,
    auth.users.email,
    CASE 
        WHEN auth.users.email = 'frpboy12@gmail.com' THEN 'Superadmin User'
        WHEN auth.users.email = 'paymentstarlexpmna@gmail.com' THEN 'HO Accountant'
        WHEN auth.users.email = 'manager.test@sahakar.com' THEN 'Manager User'
        WHEN auth.users.email = 'staff.test@sahakar.com' THEN 'Staff User'
        WHEN auth.users.email = 'auditor.test@sahakar.com' THEN 'Auditor User'
    END as name,
    CASE 
        WHEN auth.users.email = 'frpboy12@gmail.com' THEN 'superadmin'
        WHEN auth.users.email = 'paymentstarlexpmna@gmail.com' THEN 'ho_accountant'
        WHEN auth.users.email = 'manager.test@sahakar.com' THEN 'outlet_manager'
        WHEN auth.users.email = 'staff.test@sahakar.com' THEN 'outlet_staff'
        WHEN auth.users.email = 'auditor.test@sahakar.com' THEN 'auditor'
    END as role,
    NOW() as created_at
FROM auth.users
WHERE auth.users.email IN (
    'frpboy12@gmail.com',
    'paymentstarlexpmna@gmail.com',
    'manager.test@sahakar.com',
    'staff.test@sahakar.com',
    'auditor.test@sahakar.com'
)
ON CONFLICT (id) DO NOTHING;

-- Verify the insert
SELECT id, email, name, role 
FROM users 
WHERE email IN (
    'frpboy12@gmail.com',
    'paymentstarlexpmna@gmail.com',
    'manager.test@sahakar.com',
    'staff.test@sahakar.com',
    'auditor.test@sahakar.com'
);


================================================================================
PATH: database\fix-production-issues.sql
FILENAME: fix-production-issues.sql
================================================================================

-- Add idempotency_key column to transactions table
ALTER TABLE transactions 
ADD COLUMN IF NOT EXISTS idempotency_key TEXT;

-- Create unique index on idempotency_key (NULL values allowed, multiples NULL ok)
CREATE UNIQUE INDEX IF NOT EXISTS transactions_idempotency_key_idx 
ON transactions(idempotency_key) 
WHERE idempotency_key IS NOT NULL;

-- Add unique constraint on outlet_id + date for daily_records
-- This prevents race condition where two requests create duplicate records
ALTER TABLE daily_records 
ADD CONSTRAINT daily_records_outlet_date_unique 
UNIQUE (outlet_id, date);

-- Add check constraints for data integrity
ALTER TABLE transactions
ADD CONSTRAINT transactions_amount_positive 
CHECK (amount > 0);

ALTER TABLE transactions
ADD CONSTRAINT transactions_type_valid 
CHECK (type IN ('income', 'expense'));

ALTER TABLE transactions
ADD CONSTRAINT transactions_payment_mode_valid 
CHECK (payment_mode IN ('cash', 'upi'));

-- Add indexes for performance
CREATE INDEX IF NOT EXISTS transactions_daily_record_idx 
ON transactions(daily_record_id);

CREATE INDEX IF NOT EXISTS transactions_created_at_idx 
ON transactions(created_at DESC);

CREATE INDEX IF NOT EXISTS daily_records_outlet_date_idx 
ON daily_records(outlet_id, date DESC);

CREATE INDEX IF NOT EXISTS daily_records_status_idx 
ON daily_records(status);

-- Comments
COMMENT ON COLUMN transactions.idempotency_key IS 
'Client-generated key to prevent duplicate transactions on retry';

COMMENT ON CONSTRAINT daily_records_outlet_date_unique ON daily_records IS 
'Ensures only one daily record per outlet per date, prevents race conditions';


================================================================================
PATH: database\fix-rls-aggressive.sql
FILENAME: fix-rls-aggressive.sql
================================================================================

-- AGGRESSIVE FIX: Remove ALL recursive RLS policies on users table
-- The old policies are still there causing infinite recursion
-- This will drop EVERYTHING and start fresh

-- Run this in Supabase SQL Editor

-- Step 1: Drop EVERY policy on users table (including the recursive ones)
DROP POLICY IF EXISTS "HO can view all" ON users;
DROP POLICY IF EXISTS "Superadmin can manage all users" ON users;
DROP POLICY IF EXISTS "Superadmin can view all" ON users;
DROP POLICY IF EXISTS "Users can read own profile" ON users;
DROP POLICY IF EXISTS "Users can update own profile" ON users;
DROP POLICY IF EXISTS "Users can view own profile" ON users;
DROP POLICY IF EXISTS "Users can view same outlet" ON users;
DROP POLICY IF EXISTS "Enable read access for own profile" ON users;
DROP POLICY IF EXISTS "Enable all access for service role" ON users;
DROP POLICY IF EXISTS "Enable update for own profile" ON users;

-- Step 2: Disable RLS temporarily
ALTER TABLE users DISABLE ROW LEVEL SECURITY;

-- Step 3: Re-enable RLS
ALTER TABLE users ENABLE ROW LEVEL SECURITY;

-- Step 4: Create ONLY ONE simple policy - users can read their own profile
-- This is the ONLY policy we need for login to work
CREATE POLICY "allow_own_profile_read" ON users
  FOR SELECT 
  USING (auth.uid() = id);

-- Step 5: Allow service role full access (for server-side operations)
CREATE POLICY "allow_service_role" ON users
  FOR ALL 
  USING (auth.jwt()->>'role' = 'service_role');

-- Verify - should only see 2 policies now
SELECT policyname, cmd, qual
FROM pg_policies
WHERE tablename = 'users'
ORDER BY policyname;


================================================================================
PATH: database\fix-rls-final.sql
FILENAME: fix-rls-final.sql
================================================================================

-- FINAL FIX for infinite recursion in users table RLS policy
-- The previous fix still had recursion because policies were querying users table
-- This fix uses a simpler approach: allow users to read their own row directly

-- Run this in Supabase SQL Editor

-- Step 1: Drop ALL existing policies on users table
DROP POLICY IF EXISTS "Users can view own profile" ON users;
DROP POLICY IF EXISTS "Users can view same outlet" ON users;
DROP POLICY IF EXISTS "Superadmin can view all" ON users;
DROP POLICY IF EXISTS "HO can view all" ON users;
DROP POLICY IF EXISTS "Users can update own profile" ON users;
DROP POLICY IF EXISTS "Users can read own profile" ON users;
DROP POLICY IF EXISTS "Superadmin can manage all users" ON users;

-- Step 2: Temporarily DISABLE RLS on users table to break the cycle
ALTER TABLE users DISABLE ROW LEVEL SECURITY;

-- Step 3: Re-enable RLS
ALTER TABLE users ENABLE ROW LEVEL SECURITY;

-- Step 4: Create a SINGLE simple policy for reading your own profile
-- This doesn't query the users table, so no recursion!
CREATE POLICY "Enable read access for own profile" ON users
  FOR SELECT 
  USING (auth.uid() = id);

-- Step 5: Allow superadmin full access (but we'll manage this at app level for now)
CREATE POLICY "Enable all access for service role" ON users
  FOR ALL 
  USING (auth.jwt()->>'role' = 'service_role');

-- Step 6: Allow users to update their own profile
CREATE POLICY "Enable update for own profile" ON users
  FOR UPDATE 
  USING (auth.uid() = id);

-- Verify the new policies
SELECT schemaname, tablename, policyname, permissive, roles, cmd
FROM pg_policies
WHERE tablename = 'users'
ORDER BY policyname;

-- Test query (should work now without recursion)
-- SELECT * FROM users WHERE id = auth.uid();


================================================================================
PATH: database\fix-staff-outlet.sql
FILENAME: fix-staff-outlet.sql
================================================================================

-- Assign staff.test@sahakar.com to Main Outlet
UPDATE users 
SET outlet_id = (SELECT id FROM outlets WHERE name = 'Main Outlet' LIMIT 1)
WHERE email = 'staff.test@sahakar.com';

-- Also ensure staff@example.com (used in some logs) is assigned if it exists
UPDATE users 
SET outlet_id = (SELECT id FROM outlets WHERE name = 'Main Outlet' LIMIT 1)
WHERE email = 'staff@example.com';

-- Verify the update
SELECT u.email, o.name as outlet_name 
FROM users u 
JOIN outlets o ON u.outlet_id = o.id 
WHERE u.email IN ('staff.test@sahakar.com', 'staff@example.com');


================================================================================
PATH: database\fix-transactions-table.sql
FILENAME: fix-transactions-table.sql
================================================================================

-- Fix for existing transactions table
-- Run this in Supabase SQL Editor to fix the schema

-- Drop existing transactions table if it has wrong schema
DROP TABLE IF EXISTS transactions CASCADE;

-- Recreate transactions table with correct schema
CREATE TABLE transactions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  daily_record_id UUID REFERENCES daily_records(id) ON DELETE CASCADE,
  type VARCHAR(20) NOT NULL CHECK (type IN ('income', 'expense')),
  category VARCHAR(100) NOT NULL,
  payment_mode VARCHAR(10) NOT NULL CHECK (payment_mode IN ('cash', 'upi')),
  amount DECIMAL(12,2) NOT NULL CHECK (amount > 0),
  description TEXT,
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create indexes
CREATE INDEX idx_transactions_daily_record ON transactions(daily_record_id);
CREATE INDEX idx_transactions_created_by ON transactions(created_by);
CREATE INDEX idx_transactions_type ON transactions(type);
CREATE INDEX idx_transactions_date ON transactions(created_at);

-- Enable RLS
ALTER TABLE transactions ENABLE ROW LEVEL SECURITY;

-- Create RLS policies
CREATE POLICY "Users can view transactions from their outlet" ON transactions
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM daily_records dr
      JOIN users u ON u.id = auth.uid()
      WHERE dr.id = transactions.daily_record_id
      AND (u.role IN ('superadmin', 'ho_accountant') OR u.outlet_id = dr.outlet_id)
    )
  );

CREATE POLICY "Staff can create transactions for their outlet" ON transactions
  FOR INSERT WITH CHECK (
    EXISTS (
      SELECT 1 FROM daily_records dr
      JOIN users u ON u.id = auth.uid()
      WHERE dr.id = transactions.daily_record_id
      AND dr.status = 'draft'
      AND (u.role = 'superadmin' OR u.outlet_id = dr.outlet_id)
    )
  );

CREATE POLICY "Users can update their own transactions in draft" ON transactions
  FOR UPDATE USING (
    EXISTS (
      SELECT 1 FROM daily_records dr
      JOIN users u ON u.id = auth.uid()
      WHERE dr.id = transactions.daily_record_id
      AND dr.status = 'draft'
      AND (u.role = 'superadmin' OR (transactions.created_by = auth.uid() AND u.outlet_id = dr.outlet_id))
    )
  );

CREATE POLICY "Users can delete their own transactions in draft" ON transactions
  FOR DELETE USING (
    EXISTS (
      SELECT 1 FROM daily_records dr
      JOIN users u ON u.id = auth.uid()
      WHERE dr.id = transactions.daily_record_id
      AND dr.status = 'draft'
      AND (u.role = 'superadmin' OR (transactions.created_by = auth.uid() AND u.outlet_id = dr.outlet_id))
    )
  );

-- Verify
SELECT 'transactions table recreated' as status, count(*) as columns 
FROM information_schema.columns 
WHERE table_name = 'transactions';


================================================================================
PATH: database\fix-users-profile-rls.sql
FILENAME: fix-users-profile-rls.sql
================================================================================

-- FIX: RLS Policy for Users to Read Their Own Profile
-- This policy is CRITICAL for authentication to work properly

-- Drop existing policy if it exists (to avoid conflicts)
DROP POLICY IF EXISTS "Users can read own profile" ON users;
DROP POLICY IF EXISTS "allow_own_profile_read" ON users;

-- Create policy: Allow authenticated users to read ONLY their own profile row
CREATE POLICY "Users can read own profile" ON users
    FOR SELECT
    USING (auth.uid() = id);

-- Optional: Also allow service role full access (for admin operations)
DROP POLICY IF EXISTS "Service role full access" ON users;
CREATE POLICY "Service role full access" ON users
    FOR ALL
    USING (auth.role() = 'service_role');

-- Verify RLS is enabled
ALTER TABLE users ENABLE ROW LEVEL SECURITY;


================================================================================
PATH: database\fix-users-rls-recursion.sql
FILENAME: fix-users-rls-recursion.sql
================================================================================

-- Fix for infinite recursion in users table RLS policy
-- Run this in Supabase SQL Editor

-- Drop all existing policies on users table
DROP POLICY IF EXISTS "Users can view their own data" ON users;
DROP POLICY IF EXISTS "Users can view users in their outlet" ON users;
DROP POLICY IF EXISTS "Superadmin can view all users" ON users;
DROP POLICY IF EXISTS "Users can update their own data" ON users;

-- Create simple, non-recursive policies

-- Policy 1: Users can view their own profile
CREATE POLICY "Users can view own profile" ON users
  FOR SELECT USING (auth.uid() = id);

-- Policy 2: Superadmin can view all users
CREATE POLICY "Superadmin can view all" ON users
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM users u
      WHERE u.id = auth.uid() 
      AND u.role = 'superadmin'
    )
  );

-- Policy 3: Users can view other users in same outlet
CREATE POLICY "Users can view same outlet" ON users
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM users u
      WHERE u.id = auth.uid()
      AND u.outlet_id = users.outlet_id
    )
  );

-- Policy 4: HO Accountant can view all users
CREATE POLICY "HO can view all" ON users
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM users u
      WHERE u.id = auth.uid()
      AND u.role = 'ho_accountant'
    )
  );

-- Policy 5: Users can update their own profile
CREATE POLICY "Users can update own profile" ON users
  FOR UPDATE USING (auth.uid() = id);

-- Verify policies
SELECT schemaname, tablename, policyname, permissive, roles, cmd, qual
FROM pg_policies
WHERE tablename = 'users';


================================================================================
PATH: database\fix-users-rls-v2.sql
FILENAME: fix-users-rls-v2.sql
================================================================================

-- CRITICAL FIX: Drop ALL existing RLS policies on users table to prevent recursion
-- Then create a simple, non-recursive policy

-- Step 1: Drop ALL existing policies (this prevents conflicts)
DO $$ 
DECLARE
    r RECORD;
BEGIN
    FOR r IN (SELECT policyname FROM pg_policies WHERE tablename = 'users') 
    LOOP
        EXECUTE 'DROP POLICY IF EXISTS "' || r.policyname || '" ON users';
    END LOOP;
END $$;

-- Step 2: Ensure RLS is enabled
ALTER TABLE users ENABLE ROW LEVEL SECURITY;

-- Step 3: Create simple, non-recursive policy allowing users to read their own row
CREATE POLICY "allow_own_profile_read" ON users
    FOR SELECT
    USING (auth.uid() = id);

-- Step 4: Allow service role full access (for admin operations)
CREATE POLICY "allow_service_role_all" ON users
    FOR ALL
    USING (auth.role() = 'service_role');


================================================================================
PATH: database\large-transaction-alert.sql
FILENAME: large-transaction-alert.sql
================================================================================

-- =====================================================================
-- LARGE TRANSACTION ALERT TRIGGER
-- =====================================================================
-- Purpose: Automatically log an alert if a transaction exceeds â‚¹10,000
-- Created: 2025-12-25
-- =====================================================================

CREATE OR REPLACE FUNCTION log_large_transaction()
RETURNS TRIGGER AS $$
DECLARE
    v_outlet_id UUID;
    v_user_id UUID;
BEGIN
    -- Get the outlet_id from the daily record
    SELECT outlet_id INTO v_outlet_id 
    FROM daily_records 
    WHERE id = NEW.daily_record_id;

    -- Use NEW.created_by or the session user
    v_user_id := COALESCE(NEW.created_by, auth.uid());

    -- Check if transaction amount exceeds threshold (â‚¹10,000)
    IF NEW.amount > 10000 THEN
        INSERT INTO audit_logs (
            user_id,
            outlet_id,
            action,
            entity,
            entity_id,
            new_data,
            severity,
            reason
        ) VALUES (
            v_user_id,
            v_outlet_id,
            'large_transaction_alert',
            'transaction',
            NEW.id,
            json_build_object(
                'amount', NEW.amount,
                'payment_mode', NEW.payment_mode,
                'type', NEW.type,
                'category', NEW.category,
                'description', NEW.description
            ),
            'warning',
            'Transaction exceeds â‚¹10,000 threshold'
        );
    END IF;

    RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Drop trigger if exists to allow re-runs
DROP TRIGGER IF EXISTS tr_large_transaction_alert ON transactions;

-- Create the trigger
CREATE TRIGGER tr_large_transaction_alert
AFTER INSERT ON transactions
FOR EACH ROW
EXECUTE FUNCTION log_large_transaction();

-- Add comment for documentation
COMMENT ON FUNCTION log_large_transaction() IS 
'Automatically logs a warning in audit_logs when a single transaction amount exceeds â‚¹10,000.';

-- Verification
SELECT 'large_transaction_alert trigger created successfully' as status;


================================================================================
PATH: database\performance-indexes.sql
FILENAME: performance-indexes.sql
================================================================================

-- ============================================================================
-- SAHAKAR ACCOUNTS - PERFORMANCE INDEXES (CORRECTED)
-- ============================================================================
-- Critical indexes to improve query performance
-- Run this in Supabase SQL Editor
-- Expected impact: 10-100x faster queries on indexed columns
-- ============================================================================
-- Note: Some indexes may already exist from schema.sql
-- Using IF NOT EXISTS to prevent errors
-- ============================================================================

-- 1. DAILY RECORDS - Most queried table
-- Used by: Staff dashboard, Manager dashboard, Balance summary

-- Check if index exists before creating
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_indexes 
        WHERE indexname = 'idx_daily_records_outlet_date'
    ) THEN
        CREATE INDEX idx_daily_records_outlet_date 
        ON daily_records(outlet_id, date DESC);
    END IF;
END $$;

-- For finding today's record (most common query)
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_indexes 
        WHERE indexname = 'idx_daily_records_date'
    ) THEN
        CREATE INDEX idx_daily_records_date 
        ON daily_records(date DESC);
    END IF;
END $$;

-- Note: idx_daily_records_status already exists in schema.sql

-- 2. TRANSACTIONS - Heavy read/write table
-- Note: idx_transactions_daily_record already exists in schema.sql

-- For transaction history by date
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_indexes 
        WHERE indexname = 'idx_transactions_date'
    ) THEN
        CREATE INDEX idx_transactions_date 
        ON transactions(date DESC);
    END IF;
END $$;

-- For filtering by payment mode
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_indexes 
        WHERE indexname = 'idx_transactions_payment_mode'
    ) THEN
        CREATE INDEX idx_transactions_payment_mode 
        ON transactions(payment_mode);
    END IF;
END $$;

-- 3. AUDIT LOGS - For auditor view
-- Note: Some indexes already exist in schema.sql

-- For filtering by entity type and date
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_indexes 
        WHERE indexname = 'idx_audit_logs_entity_date'
    ) THEN
        CREATE INDEX idx_audit_logs_entity_date 
        ON audit_logs(entity_type, created_at DESC);
    END IF;
END $$;

-- For filtering by action
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_indexes 
        WHERE indexname = 'idx_audit_logs_action'
    ) THEN
        CREATE INDEX idx_audit_logs_action 
        ON audit_logs(action);
    END IF;
END $$;

-- 4. USERS - Authentication & lookup
-- For fast email-based login
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_indexes 
        WHERE indexname = 'idx_users_email'
    ) THEN
        CREATE INDEX idx_users_email 
        ON users(email);
    END IF;
END $$;

-- For outlet-based user filtering
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_indexes 
        WHERE indexname = 'idx_users_outlet'
    ) THEN
        CREATE INDEX idx_users_outlet 
        ON users(outlet_id) WHERE outlet_id IS NOT NULL;
    END IF;
END $$;

-- Note: idx_users_role already exists in schema.sql

-- 5. OUTLETS - Reference data
-- For fast outlet lookup by code
DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM pg_indexes 
        WHERE indexname = 'idx_outlets_code'
    ) THEN
        CREATE INDEX idx_outlets_code 
        ON outlets(code);
    END IF;
END $$;

-- ============================================================================
-- VERIFICATION QUERIES
-- ============================================================================
-- Run these to verify indexes are being used:

-- Check if indexes exist:
-- SELECT tablename, indexname FROM pg_indexes 
-- WHERE tablename IN ('daily_records', 'transactions', 'users', 'outlets', 'audit_logs')
-- ORDER BY tablename, indexname;

-- Check query plan (should show "Index Scan" not "Seq Scan"):
-- EXPLAIN ANALYZE SELECT * FROM daily_records 
-- WHERE outlet_id = '9e0c4614-53cf-40d3-abdd-a1d0183c3909' 
-- ORDER BY date DESC LIMIT 1;

-- ============================================================================
-- EXPECTED IMPROVEMENTS
-- ============================================================================
-- Before: Daily record query: ~500-2000ms (sequential scan)
-- After:  Daily record query: ~5-50ms (index scan)
--
-- Before: Transaction list: ~1000-3000ms
-- After:  Transaction list: ~10-100ms
--
-- Before: User lookup: ~200-500ms
-- After:  User lookup: ~5-20ms
-- ============================================================================


================================================================================
PATH: database\phase3-schema.sql
FILENAME: phase3-schema.sql
================================================================================

-- Phase 3: Transaction Management Database Schema
-- Run this in Supabase SQL Editor

-- IMPORTANT: Step 1 - Rename table FIRST before any foreign key references
ALTER TABLE IF EXISTS daily_entries RENAME TO daily_records;

-- Step 2: Add new columns to daily_records
ALTER TABLE daily_records 
  ADD COLUMN IF NOT EXISTS opening_cash DECIMAL(12,2) DEFAULT 0,
  ADD COLUMN IF NOT EXISTS opening_upi DECIMAL(12,2) DEFAULT 0,
  ADD COLUMN IF NOT EXISTS closing_cash DECIMAL(12,2),
  ADD COLUMN IF NOT EXISTS closing_upi DECIMAL(12,2),
  ADD COLUMN IF NOT EXISTS total_income DECIMAL(12,2),
  ADD COLUMN IF NOT EXISTS total_expense DECIMAL(12,2),
  ADD COLUMN IF NOT EXISTS status VARCHAR(20) DEFAULT 'draft',
  ADD COLUMN IF NOT EXISTS submitted_at TIMESTAMPTZ,
  ADD COLUMN IF NOT EXISTS submitted_by UUID REFERENCES users(id),
  ADD COLUMN IF NOT EXISTS locked_at TIMESTAMPTZ,
  ADD COLUMN IF NOT EXISTS locked_by UUID REFERENCES users(id);

-- Step 3: DROP existing transactions table if it exists (handles stale/wrong schema)
DROP TABLE IF EXISTS transactions CASCADE;

-- Step 4: Create transactions table (NOW daily_records exists)
CREATE TABLE transactions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  daily_record_id UUID REFERENCES daily_records(id) ON DELETE CASCADE,
  type VARCHAR(20) NOT NULL CHECK (type IN ('income', 'expense')),
  category VARCHAR(100) NOT NULL,
  payment_mode VARCHAR(10) NOT NULL CHECK (payment_mode IN ('cash', 'upi')),
  amount DECIMAL(12,2) NOT NULL CHECK (amount > 0),
  description TEXT,
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create indexes for transactions
CREATE INDEX IF NOT EXISTS idx_transactions_daily_record ON transactions(daily_record_id);
CREATE INDEX IF NOT EXISTS idx_transactions_created_by ON transactions(created_by);
CREATE INDEX IF NOT EXISTS idx_transactions_type ON transactions(type);
CREATE INDEX IF NOT EXISTS idx_transactions_date ON transactions(created_at);

-- Step 4: Create categories table
CREATE TABLE IF NOT EXISTS categories (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  code VARCHAR(50) UNIQUE NOT NULL,
  name VARCHAR(100) NOT NULL,
  type VARCHAR(20) NOT NULL CHECK (type IN ('income', 'expense')),
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Step 5: Seed initial categories
INSERT INTO categories (code, name, type) VALUES
  ('consultation', 'Consultation Fees', 'income'),
  ('medicine_sale', 'Medicine Sale', 'income'),
  ('lab_test', 'Lab Test Fees', 'income'),
  ('other_income', 'Other Income', 'income'),
  ('medicine_purchase', 'Medicine Purchase', 'expense'),
  ('staff_salary', 'Staff Salary', 'expense'),
  ('clinic_expenses', 'Clinic Expenses', 'expense'),
  ('transport', 'Transport', 'expense'),
  ('rent', 'Rent', 'expense'),
  ('utilities', 'Electricity/Water', 'expense'),
  ('miscellaneous', 'Miscellaneous', 'expense')
ON CONFLICT (code) DO NOTHING;

-- Step 6: Create trigger function to auto-calculate balances
CREATE OR REPLACE FUNCTION update_daily_record_balances()
RETURNS TRIGGER AS $$
DECLARE
  record_id UUID;
BEGIN
  -- Get the daily_record_id from the transaction
  record_id := COALESCE(NEW.daily_record_id, OLD.daily_record_id);
  
  -- Update the daily_record with calculated balances
  UPDATE daily_records dr
  SET 
    total_income = (
      SELECT COALESCE(SUM(amount), 0) 
      FROM transactions 
      WHERE daily_record_id = dr.id AND type = 'income'
    ),
    total_expense = (
      SELECT COALESCE(SUM(amount), 0) 
      FROM transactions 
      WHERE daily_record_id = dr.id AND type = 'expense'
    ),
    closing_cash = dr.opening_cash + 
      COALESCE((SELECT SUM(amount) FROM transactions WHERE daily_record_id = dr.id AND type = 'income' AND payment_mode = 'cash'), 0) -
      COALESCE((SELECT SUM(amount) FROM transactions WHERE daily_record_id = dr.id AND type = 'expense' AND payment_mode = 'cash'), 0),
    closing_upi = dr.opening_upi +
      COALESCE((SELECT SUM(amount) FROM transactions WHERE daily_record_id = dr.id AND type = 'income' AND payment_mode = 'upi'), 0) -
      COALESCE((SELECT SUM(amount) FROM transactions WHERE daily_record_id = dr.id AND type = 'expense' AND payment_mode = 'upi'), 0),
    updated_at = NOW()
  WHERE dr.id = record_id;
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Step 7: Create trigger on transactions table
DROP TRIGGER IF EXISTS transaction_balance_update ON transactions;
CREATE TRIGGER transaction_balance_update
AFTER INSERT OR UPDATE OR DELETE ON transactions
FOR EACH ROW
EXECUTE FUNCTION update_daily_record_balances();

-- Step 8: Enable RLS on new tables
ALTER TABLE transactions ENABLE ROW LEVEL SECURITY;
ALTER TABLE categories ENABLE ROW LEVEL SECURITY;

-- Step 9: Create RLS policies for transactions
CREATE POLICY "Users can view transactions from their outlet" ON transactions
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM daily_records dr
      JOIN users u ON u.id = auth.uid()
      WHERE dr.id = transactions.daily_record_id
      AND (u.role IN ('superadmin', 'ho_accountant') OR u.outlet_id = dr.outlet_id)
    )
  );

CREATE POLICY "Staff can create transactions for their outlet" ON transactions
  FOR INSERT WITH CHECK (
    EXISTS (
      SELECT 1 FROM daily_records dr
      JOIN users u ON u.id = auth.uid()
      WHERE dr.id = transactions.daily_record_id
      AND dr.status = 'draft'
      AND (u.role = 'superadmin' OR u.outlet_id = dr.outlet_id)
    )
  );

CREATE POLICY "Users can update their own transactions in draft" ON transactions
  FOR UPDATE USING (
    EXISTS (
      SELECT 1 FROM daily_records dr
      JOIN users u ON u.id = auth.uid()
      WHERE dr.id = transactions.daily_record_id
      AND dr.status = 'draft'
      AND (u.role = 'superadmin' OR (transactions.created_by = auth.uid() AND u.outlet_id = dr.outlet_id))
    )
  );

CREATE POLICY "Users can delete their own transactions in draft" ON transactions
  FOR DELETE USING (
    EXISTS (
      SELECT 1 FROM daily_records dr
      JOIN users u ON u.id = auth.uid()
      WHERE dr.id = transactions.daily_record_id
      AND dr.status = 'draft'
      AND (u.role = 'superadmin' OR (transactions.created_by = auth.uid() AND u.outlet_id = dr.outlet_id))
    )
  );

-- Step 10: Create RLS policies for categories
CREATE POLICY "Anyone can view active categories" ON categories
  FOR SELECT USING (is_active = true);

-- Verify everything was created
SELECT 'daily_records' as table_name, count(*) as columns FROM information_schema.columns WHERE table_name = 'daily_records'
UNION ALL
SELECT 'transactions', count(*) FROM information_schema.columns WHERE table_name = 'transactions'
UNION ALL
SELECT 'categories', count(*) FROM information_schema.columns WHERE table_name = 'categories';

SELECT 'Categories seeded' as status, count(*) as count FROM categories;


================================================================================
PATH: database\rpc-lock-day.sql
FILENAME: rpc-lock-day.sql
================================================================================

-- =====================================================================
-- LOCK DAY RPC
-- =====================================================================
-- Purpose: HO Accountant locks submitted daily record
-- Created: 2025-12-24
-- =====================================================================

CREATE OR REPLACE FUNCTION lock_day(
    record_id UUID,
    locked_by_user_id UUID,
    lock_reason TEXT DEFAULT NULL
)
RETURNS JSON
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    record daily_records%ROWTYPE;
    user_role TEXT;
BEGIN
    -- Get user role
    SELECT role INTO user_role FROM users WHERE id = locked_by_user_id;
    
    -- Check user has lock permission (HO accountant or superadmin)
    IF user_role NOT IN ('ho_accountant', 'superadmin') THEN
        RETURN json_build_object(
            'success', false,
            'error', 'Only HO Accountant or Superadmin can lock records. Your role: ' || user_role
        );
    END IF;
    
    -- Get the record
    SELECT * INTO record FROM daily_records WHERE id = record_id;
    
    IF NOT FOUND THEN
        RETURN json_build_object(
            'success', false,
            'error', 'Record not found'
        );
    END IF;
    
    -- Validate status is submitted
    IF record.status != 'submitted' THEN
        RETURN json_build_object(
            'success', false,
            'error', 'Can only lock submitted records. Current status: ' || record.status
        );
    END IF;
    
    -- Update status to locked and reset sync flags
    UPDATE daily_records
    SET 
        status = 'locked',
        locked_by = locked_by_user_id,
        locked_at = NOW(),
        synced_to_sheets = FALSE,  -- Mark for Google Sheets sync
        last_synced_at = NULL,     -- Reset sync timestamp
        sheet_sync_error = NULL,   -- Clear any previous errors
        updated_at = NOW()
    WHERE id = record_id;
    
    -- Log to audit_logs with reason
    INSERT INTO audit_logs (
        user_id,
        action,
        entity,
        entity_id,
        new_data,
        reason
    ) VALUES (
        locked_by_user_id,
        'lock_day',
        'daily_record',
        record_id,
        json_build_object(
            'old_status', 'submitted',
            'new_status', 'locked',
            'date', record.date,
            'outlet_id', record.outlet_id,
            'total_income', record.total_income,
            'total_expense', record.total_expense
        ),
        COALESCE(lock_reason, 'Locked by HO Accountant')
    );
    
    RETURN json_build_object(
        'success', true,
        'message', 'Record locked successfully. Ready for audit and Google Sheets sync.'
    );
END;
$$;

-- Grant execute permission to authenticated users (role check is inside function)
GRANT EXECUTE ON FUNCTION lock_day(UUID, UUID, TEXT) TO authenticated;

-- Add comment for documentation
COMMENT ON FUNCTION lock_day(UUID, UUID, TEXT) IS 
'HO Accountant locks submitted daily record after review. Sets synced_to_sheet flag for Google Sheets sync.';

-- Verification query
SELECT 'lock_day() function created successfully' as status;


================================================================================
PATH: database\rpc-submit-day.sql
FILENAME: rpc-submit-day.sql
================================================================================

-- =====================================================================
-- SUBMIT DAY RPC
-- =====================================================================
-- Purpose: Staff submits draft daily record for HO review
-- Created: 2025-12-24
-- =====================================================================

CREATE OR REPLACE FUNCTION submit_day(
    record_id UUID,
    submitted_by_user_id UUID
)
RETURNS JSON
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    record daily_records%ROWTYPE;
    result JSON;
BEGIN
    -- Get the record
    SELECT * INTO record FROM daily_records WHERE id = record_id;
    
    IF NOT FOUND THEN
        RETURN json_build_object(
            'success', false,
            'error', 'Record not found'
        );
    END IF;
    
    -- Validate status is draft
    IF record.status != 'draft' THEN
        RETURN json_build_object(
            'success', false,
            'error', 'Can only submit draft records. Current status: ' || record.status
        );
    END IF;
    
    -- Validate required fields (opening balances must be set)
    IF record.opening_cash IS NULL OR record.opening_upi IS NULL THEN
        RETURN json_build_object(
            'success', false,
            'error', 'Opening balances (cash and UPI) are required before submission'
        );
    END IF;
    
    -- Update status to submitted
    UPDATE daily_records
    SET 
        status = 'submitted',
        submitted_by = submitted_by_user_id,
        submitted_at = NOW(),
        updated_at = NOW()
    WHERE id = record_id;
    
    -- Log to audit_logs
    INSERT INTO audit_logs (
        user_id,
        action,
        entity,
        entity_id,
        new_data
    ) VALUES (
        submitted_by_user_id,
        'submit_day',
        'daily_record',
        record_id,
        json_build_object(
            'old_status', 'draft',
            'new_status', 'submitted',
            'date', record.date,
            'outlet_id', record.outlet_id
        )
    );
    
    RETURN json_build_object(
        'success', true,
        'message', 'Record submitted successfully for HO review'
    );
END;
$$;

-- Grant execute permission to authenticated users
GRANT EXECUTE ON FUNCTION submit_day(UUID, UUID) TO authenticated;

-- Add comment for documentation
COMMENT ON FUNCTION submit_day(UUID, UUID) IS 
'Staff submits draft daily record for HO accountant review. Validates draft status and required fields before submission.';

-- Verification query
SELECT 'submit_day() function created successfully' as status;


================================================================================
PATH: database\rpc-unlock-day.sql
FILENAME: rpc-unlock-day.sql
================================================================================

-- =====================================================================
-- UNLOCK DAY RPC
-- =====================================================================
-- Purpose: Superadmin unlocks locked record (emergency only)
-- Created: 2025-12-24
-- =====================================================================

CREATE OR REPLACE FUNCTION unlock_day(
    record_id UUID,
    admin_id UUID,
    unlock_reason TEXT
)
RETURNS JSON
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    record daily_records%ROWTYPE;
    user_role TEXT;
    previous_locker_email TEXT;
BEGIN
    -- Validate reason is provided (mandatory for audit trail)
    IF unlock_reason IS NULL OR trim(unlock_reason) = '' THEN
        RETURN json_build_object(
            'success', false,
            'error', 'Unlock reason is mandatory for audit compliance'
        );
    END IF;
    
    -- Get user role
    SELECT role INTO user_role FROM users WHERE id = admin_id;
    
    -- Only Master Admin can unlock
    IF user_role != 'master_admin' THEN
        RETURN json_build_object(
            'success', false,
            'error', 'Unauthorized: Only Master Admin can unlock records.'
        );
    END IF;
    
    -- Get the record
    SELECT * INTO record FROM daily_records WHERE id = record_id;
    
    IF NOT FOUND THEN
        RETURN json_build_object(
            'success', false,
            'error', 'Record not found'
        );
    END IF;

    -- Month-End Closure Enforcement: 
    -- Prevent unlocking records from previous months (Backdated edits prevention)
    IF date_trunc('month', record.date) < date_trunc('month', NOW()) THEN
        RETURN json_build_object(
            'success', false,
            'error', 'Month-End Closure: Records from previous months cannot be unlocked for security and audit integrity.'
        );
    END IF;
    
    -- Can only unlock locked records
    IF record.status != 'locked' THEN
        RETURN json_build_object(
            'success', false,
            'error', 'Can only unlock locked records. Current status: ' || record.status
        );
    END IF;
    
    -- Get the email of who locked it (for notification)
    SELECT email INTO previous_locker_email 
    FROM users 
    WHERE id = record.locked_by;
    
    -- Revert to submitted status
    UPDATE daily_records
    SET 
        status = 'submitted',
        locked_by = NULL,
        locked_at = NULL,
        updated_at = NOW()
    WHERE id = record_id;
    
    -- Log critical action with full context
    INSERT INTO audit_logs (
        user_id,
        action,
        entity,
        entity_id,
        old_data,
        new_data,
        reason,
        severity
    ) VALUES (
        admin_id,
        'unlock_day',
        'daily_record',
        record_id,
        json_build_object(
            'status', 'locked',
            'locked_by', record.locked_by,
            'locked_by_email', previous_locker_email,
            'locked_at', record.locked_at
        ),
        json_build_object(
            'status', 'submitted',
            'date', record.date,
            'outlet_id', record.outlet_id
        ),
        unlock_reason,
        'critical'
    );
    
    RETURN json_build_object(
        'success', true,
        'message', 'Record unlocked successfully',
        'warning', 'HO Accountant (' || previous_locker_email || ') should be notified about this unlock',
        'unlock_reason', unlock_reason
    );
END;
$$;

-- Grant execute permission to authenticated users (role check is inside function)
GRANT EXECUTE ON FUNCTION unlock_day(UUID, UUID, TEXT) TO authenticated;

-- Add comment for documentation
COMMENT ON FUNCTION unlock_day(UUID, UUID, TEXT) IS 
'Superadmin emergency unlock of locked records. Requires mandatory reason and logs as critical action.';

-- Verification query
SELECT 'unlock_day() function created successfully' as status;


================================================================================
PATH: database\schema.sql
FILENAME: schema.sql
================================================================================

-- Sahakar Accounts Database Schema
-- Run this in your Supabase SQL Editor

-- Enable UUID extension
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- ============================================================================
-- 1. ORGANIZATIONS TABLE
-- ============================================================================
CREATE TABLE organizations (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name VARCHAR(255) NOT NULL,
  code VARCHAR(50) UNIQUE NOT NULL,
  timezone VARCHAR(50) DEFAULT 'Asia/Kolkata',
  locale VARCHAR(10) DEFAULT 'en-IN',
  currency VARCHAR(3) DEFAULT 'INR',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ============================================================================
-- 2. OUTLETS TABLE
-- ============================================================================
CREATE TABLE outlets (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  name VARCHAR(255) NOT NULL,
  code VARCHAR(50) NOT NULL,
  location VARCHAR(255),
  phone VARCHAR(20),
  email VARCHAR(255),
  google_sheet_id VARCHAR(255),
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(organization_id, code)
);

CREATE INDEX idx_outlets_organization ON outlets(organization_id);
CREATE INDEX idx_outlets_active ON outlets(is_active);

-- ============================================================================
-- 3. USERS TABLE
-- ============================================================================
CREATE TABLE users (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  email VARCHAR(255) UNIQUE NOT NULL,
  full_name VARCHAR(255) NOT NULL,
  role VARCHAR(50) NOT NULL CHECK (role IN ('master_admin', 'ho_accountant', 'outlet_manager', 'outlet_staff')),
  phone VARCHAR(20),
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_users_organization ON users(organization_id);
CREATE INDEX idx_users_role ON users(role);

-- ============================================================================
-- 4. USER_OUTLET_ACCESS TABLE
-- ============================================================================
CREATE TABLE user_outlet_access (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  outlet_id UUID NOT NULL REFERENCES outlets(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(user_id, outlet_id)
);

CREATE INDEX idx_user_outlet_user ON user_outlet_access(user_id);
CREATE INDEX idx_user_outlet_outlet ON user_outlet_access(outlet_id);

-- ============================================================================
-- 5. DAILY_RECORDS TABLE
-- ============================================================================
CREATE TABLE daily_records (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  outlet_id UUID NOT NULL REFERENCES outlets(id) ON DELETE CASCADE,
  date DATE NOT NULL,
  opening_cash DECIMAL(12, 2) DEFAULT 0,
  opening_upi DECIMAL(12, 2) DEFAULT 0,
  closing_cash DECIMAL(12, 2) DEFAULT 0,
  closing_upi DECIMAL(12, 2) DEFAULT 0,
  total_income DECIMAL(12, 2) DEFAULT 0,
  total_expense DECIMAL(12, 2) DEFAULT 0,
  status VARCHAR(20) DEFAULT 'draft' CHECK (status IN ('draft', 'submitted', 'locked')),
  submitted_at TIMESTAMPTZ,
  submitted_by UUID REFERENCES users(id),
  locked_at TIMESTAMPTZ,
  locked_by UUID REFERENCES users(id),
  synced_to_sheet BOOLEAN DEFAULT false,
  last_synced_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(outlet_id, date)
);

CREATE INDEX idx_daily_records_outlet_date ON daily_records(outlet_id, date);
CREATE INDEX idx_daily_records_status ON daily_records(status);
CREATE INDEX idx_daily_records_sync ON daily_records(synced_to_sheet) WHERE synced_to_sheet = false;

-- ============================================================================
-- 6. TRANSACTIONS TABLE
-- ============================================================================
CREATE TABLE transactions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  daily_record_id UUID NOT NULL REFERENCES daily_records(id) ON DELETE CASCADE,
  type VARCHAR(20) NOT NULL CHECK (type IN ('income', 'expense')),
  category VARCHAR(100) NOT NULL,
  payment_mode VARCHAR(20) NOT NULL CHECK (payment_mode IN ('cash', 'upi')),
  amount DECIMAL(12, 2) NOT NULL CHECK (amount >= 0),
  description TEXT,
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_transactions_daily_record ON transactions(daily_record_id);
CREATE INDEX idx_transactions_type ON transactions(type);
CREATE INDEX idx_transactions_category ON transactions(category);

-- ============================================================================
-- 7. MONTHLY_SUMMARIES TABLE
-- ============================================================================
CREATE TABLE monthly_summaries (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  outlet_id UUID NOT NULL REFERENCES outlets(id) ON DELETE CASCADE,
  month DATE NOT NULL,
  total_income DECIMAL(12, 2) DEFAULT 0,
  total_expense DECIMAL(12, 2) DEFAULT 0,
  total_cash_in DECIMAL(12, 2) DEFAULT 0,
  total_cash_out DECIMAL(12, 2) DEFAULT 0,
  total_upi_in DECIMAL(12, 2) DEFAULT 0,
  total_upi_out DECIMAL(12, 2) DEFAULT 0,
  net_profit DECIMAL(12, 2) DEFAULT 0,
  opening_balance DECIMAL(12, 2) DEFAULT 0,
  closing_balance DECIMAL(12, 2) DEFAULT 0,
  days_count INTEGER DEFAULT 0,
  generated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(outlet_id, month)
);

CREATE INDEX idx_monthly_summaries_outlet_month ON monthly_summaries(outlet_id, month);

-- ============================================================================
-- 8. CATEGORIES TABLE
-- ============================================================================
CREATE TABLE categories (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
  name VARCHAR(100) NOT NULL,
  type VARCHAR(20) NOT NULL CHECK (type IN ('income', 'expense')),
  code VARCHAR(50) NOT NULL,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(organization_id, code)
);

CREATE INDEX idx_categories_organization ON categories(organization_id);
CREATE INDEX idx_categories_type ON categories(type);

-- ============================================================================
-- 9. AUDIT_LOGS TABLE
-- ============================================================================
CREATE TABLE audit_logs (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id),
  outlet_id UUID REFERENCES outlets(id),
  action VARCHAR(100) NOT NULL,
  entity_type VARCHAR(50),
  entity_id UUID,
  details JSONB,
  ip_address INET,
  user_agent TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_audit_logs_user ON audit_logs(user_id);
CREATE INDEX idx_audit_logs_outlet ON audit_logs(outlet_id);
CREATE INDEX idx_audit_logs_created_at ON audit_logs(created_at);

-- ============================================================================
-- ROW LEVEL SECURITY (RLS) POLICIES
-- ============================================================================

-- Enable RLS
ALTER TABLE organizations ENABLE ROW LEVEL SECURITY;
ALTER TABLE outlets ENABLE ROW LEVEL SECURITY;
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE user_outlet_access ENABLE ROW LEVEL SECURITY;
ALTER TABLE daily_records ENABLE ROW LEVEL SECURITY;
ALTER TABLE transactions ENABLE ROW LEVEL SECURITY;
ALTER TABLE monthly_summaries ENABLE ROW LEVEL SECURITY;
ALTER TABLE categories ENABLE ROW LEVEL SECURITY;
ALTER TABLE audit_logs ENABLE ROW LEVEL SECURITY;

-- Users can view their own profile
CREATE POLICY users_view_own ON users
  FOR SELECT
  USING (auth.uid() = id);

-- Outlets: Users can see outlets based on role and access
CREATE POLICY outlets_access ON outlets
  FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM users u
      WHERE u.id = auth.uid()
        AND (
          u.role IN ('master_admin', 'ho_accountant')
          OR
          EXISTS (
            SELECT 1 FROM user_outlet_access uoa
            WHERE uoa.user_id = u.id
              AND uoa.outlet_id = outlets.id
          )
        )
    )
  );

-- Daily Records: Based on outlet access
CREATE POLICY daily_records_access ON daily_records
  FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM users u
      WHERE u.id = auth.uid()
        AND (
          u.role IN ('master_admin', 'ho_accountant')
          OR
          EXISTS (
            SELECT 1 FROM user_outlet_access uoa
            WHERE uoa.user_id = u.id
              AND uoa.outlet_id = daily_records.outlet_id
          )
        )
    )
  );

-- Daily Records: Users can insert/update their outlet records
CREATE POLICY daily_records_modify ON daily_records
  FOR ALL
  USING (
    EXISTS (
      SELECT 1 FROM users u
      WHERE u.id = auth.uid()
        AND (
          u.role IN ('master_admin', 'outlet_manager')
          OR
          (
            u.role = 'outlet_staff'
            AND status = 'draft'
            AND EXISTS (
              SELECT 1 FROM user_outlet_access uoa
              WHERE uoa.user_id = u.id
                AND uoa.outlet_id = daily_records.outlet_id
            )
          )
        )
    )
  );

-- Transactions: Based on daily record access
CREATE POLICY transactions_access ON transactions
  FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM daily_records dr
      WHERE dr.id = transactions.daily_record_id
        AND EXISTS (
          SELECT 1 FROM users u
          WHERE u.id = auth.uid()
            AND (
              u.role IN ('master_admin', 'ho_accountant')
              OR
              EXISTS (
                SELECT 1 FROM user_outlet_access uoa
                WHERE uoa.user_id = u.id
                  AND uoa.outlet_id = dr.outlet_id
              )
            )
        )
    )
  );

-- Transactions: Users can add/modify transactions in draft daily records
CREATE POLICY transactions_modify ON transactions
  FOR ALL
  USING (
    EXISTS (
      SELECT 1 FROM daily_records dr
      JOIN users u ON u.id = auth.uid()
      WHERE dr.id = transactions.daily_record_id
        AND dr.status = 'draft'
        AND (
          u.role IN ('master_admin', 'outlet_manager', 'outlet_staff')
        )
        AND (
          u.role IN ('master_admin')
          OR
          EXISTS (
            SELECT 1 FROM user_outlet_access uoa
            WHERE uoa.user_id = u.id
              AND uoa.outlet_id = dr.outlet_id
          )
        )
    )
  );

-- Categories: Users can view categories from their organization
CREATE POLICY categories_access ON categories
  FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM users u
      WHERE u.id = auth.uid()
        AND u.organization_id = categories.organization_id
    )
  );

-- ============================================================================
-- SEED DATA
-- ============================================================================

-- Insert default organization
INSERT INTO organizations (id, name, code)
VALUES ('00000000-0000-0000-0000-000000000001', 'Sahakar Hyperpharmacies', 'SAHAKAR');

-- Insert default categories
INSERT INTO categories (organization_id, name, type, code) VALUES
  ('00000000-0000-0000-0000-000000000001', 'Consultation', 'income', 'consultation'),
  ('00000000-0000-0000-0000-000000000001', 'Medicine Sale', 'income', 'medicine_sale'),
  ('00000000-0000-0000-0000-000000000001', 'Other Income', 'income', 'other_income'),
  ('00000000-0000-0000-0000-000000000001', 'Medicine Purchase', 'expense', 'medicine_purchase'),
  ('00000000-0000-0000-0000-000000000001', 'Staff Salary', 'expense', 'staff_salary'),
  ('00000000-0000-0000-0000-000000000001', 'Clinic Expenses', 'expense', 'clinic_expenses'),
  ('00000000-0000-0000-0000-000000000001', 'Transport', 'expense', 'transport'),
  ('00000000-0000-0000-0000-000000000001', 'Rent', 'expense', 'rent'),
  ('00000000-0000-0000-0000-000000000001', 'Utilities', 'expense', 'utilities'),
  ('00000000-0000-0000-0000-000000000001', 'Miscellaneous', 'expense', 'miscellaneous');

-- ============================================================================
-- FUNCTIONS & TRIGGERS
-- ============================================================================

-- Function to update updated_at timestamp
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Triggers for updated_at
CREATE TRIGGER update_organizations_updated_at BEFORE UPDATE ON organizations
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_outlets_updated_at BEFORE UPDATE ON outlets
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON users
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_daily_records_updated_at BEFORE UPDATE ON daily_records
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_transactions_updated_at BEFORE UPDATE ON transactions
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();


================================================================================
PATH: database\verify-rls-policies.sql
FILENAME: verify-rls-policies.sql
================================================================================

-- =====================================================
-- Verify RLS Policies on Users Table
-- =====================================================
-- This script checks and fixes RLS policies to ensure
-- authenticated users can read their own profiles

-- 1. Check existing policies on users table
SELECT 
    schemaname,
    tablename,
    policyname,
    permissive,
    roles,
    cmd,
    qual,
    with_check
FROM pg_policies 
WHERE tablename = 'users';

-- 2. If no policy exists for reading own profile, create it
DO $$
BEGIN
    -- Drop existing policy if it exists
    DROP POLICY IF EXISTS "Users can read own profile" ON users;
    
    -- Create policy allowing users to read their own profile
    CREATE POLICY "Users can read own profile"
    ON users FOR SELECT
    USING (auth.uid() = id);
    
    RAISE NOTICE 'Policy created: Users can read own profile';
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'Error creating policy: %', SQLERRM;
END $$;

-- 3. Verify the policy was created
SELECT 
    policyname,
    cmd,
    qual
FROM pg_policies 
WHERE tablename = 'users' 
  AND policyname = 'Users can read own profile';

-- 4. Test the policy by selecting own profile
-- (Run this as an authenticated user in Supabase SQL Editor)
SELECT id, email, name, role 
FROM users 
WHERE id = auth.uid();
-- 5. Allow admins to update auditor access fields for any user
DO $$
BEGIN
    DROP POLICY IF EXISTS "Admins can update auditor access" ON users;
    
    CREATE POLICY "Admins can update auditor access"
    ON users FOR UPDATE
    TO authenticated
    USING (
      EXISTS (
        SELECT 1 FROM users
        WHERE id = auth.uid()
        AND role IN ('master_admin', 'superadmin')
      )
    );
    
    RAISE NOTICE 'Policy created: Admins can update auditor access';
EXCEPTION
    WHEN OTHERS THEN
        RAISE NOTICE 'Error creating policy: %', SQLERRM;
END $$;


================================================================================
PATH: lib\auditor-logger.ts
FILENAME: auditor-logger.ts
================================================================================

import { createServerClient } from '@/lib/supabase-server';

/**
 * Log auditor actions for compliance tracking
 */
export async function logAuditorAction(
    action: string,
    entity_type?: string,
    entity_id?: string,
    outlet_id?: string,
    metadata?: {
        ip_address?: string;
        user_agent?: string;
    }
) {
    try {
        const supabase = createServerClient();
        const { data: { user } } = await supabase.auth.getUser();

        if (!user) return;

        // Check if user is auditor
        const { data: userData } = await supabase
            .from('users')
            .select('role')
            .eq('id', user.id)
            .single();

        if (userData?.role !== 'auditor') return;

        // Log the action
        await supabase.from('auditor_access_log').insert({
            auditor_id: user.id,
            action,
            entity_type,
            entity_id,
            outlet_id,
            ip_address: metadata?.ip_address,
            user_agent: metadata?.user_agent
        });
    } catch (error) {
        console.error('[AuditorLogger] Error logging action:', error);
        // Don't throw - logging failure shouldn't break the app
    }
}


================================================================================
PATH: lib\auth-context.tsx
FILENAME: auth-context.tsx
================================================================================

// @ts-nocheck
'use client';

import React, {
    createContext,
    useContext,
    useMemo,
    useState,
    useEffect,
    ReactNode,
} from 'react';
import { User } from '@supabase/supabase-js';
// Replace explicit supabase import with client component client
import { createClientComponentClient } from '@supabase/auth-helpers-nextjs';
import { useRouter } from 'next/navigation';

/* ======================================================
   TYPES
====================================================== */

export type UserProfile = {
    role:
    | 'superadmin'
    | 'master_admin'
    | 'ho_accountant'
    | 'outlet_manager'
    | 'outlet_staff'
    | 'auditor';
    name?: string;
    outlet_id?: string;
    access_start_date?: string;
    access_end_date?: string;
};

export type AuthUser = {
    id: string;
    email: string;
    profile: UserProfile;
};

type AuthContextType = {
    user: AuthUser | null;
    loading: boolean;
    signIn: (email: string, password: string) => Promise<void>;
    signOut: () => Promise<void>;
};

/* ======================================================
   CONFIG
====================================================== */

const DEV_MODE = process.env.NEXT_PUBLIC_DEV_AUTH === 'true';

/* ======================================================
   CONTEXT
====================================================== */

const AuthContext = createContext<AuthContextType | undefined>(undefined);

/* ======================================================
   PROVIDER
====================================================== */

export function AuthProvider({ children }: { children: ReactNode }) {
    // initialize cookie-aware supabase client
    const supabase = createClientComponentClient();
    const router = useRouter();

    /* ======================================================
       ðŸ”§ DEV MODE â€” HARD EXIT (NO EFFECTS, NO STATE)
    ====================================================== */

    if (DEV_MODE) {
        const value = useMemo<AuthContextType>(() => ({
            user: {
                id: 'dev-staff',
                email: 'staff@test.local',
                profile: {
                    role: 'outlet_staff',
                    name: 'Dev Staff',
                },
            },
            loading: false,
            signIn: async (email: string, password: string) => {
                console.log('[DEV_MODE] Mock signIn called for:', email);
                router.push('/dashboard');
            },
            signOut: async () => {
                console.log('[DEV_MODE] Mock signOut called');
                router.push('/login');
            },
        }), [router]);

        return (
            <AuthContext.Provider value={value}>
                {children}
            </AuthContext.Provider>
        );
    }

    /* ======================================================
       ðŸ” PRODUCTION MODE (REAL SUPABASE AUTH)
    ====================================================== */

    const [user, setUser] = useState<AuthUser | null>(null);
    const [loading, setLoading] = useState<boolean>(true);

    // Fetch user profile from database with retry logic
    const fetchUserProfile = async (authUser: User, retryCount = 0): Promise<UserProfile> => {
        const maxRetries = 3;
        const retryDelay = Math.min(1000 * Math.pow(2, retryCount), 5000); // Exponential backoff, max 5s

        try {
            console.log(`[Auth] Fetching profile for user ${authUser.id} (attempt ${retryCount + 1}/${maxRetries + 1})`);

            const { data, error } = await supabase
                .from('users')
                .select('*')
                .eq('id', authUser.id)
                .single();

            if (error) {
                console.error('[Auth] Error fetching profile:', error);

                // Retry on network errors or timeouts
                if (retryCount < maxRetries && (error.message?.includes('timeout') || error.message?.includes('network'))) {
                    console.warn(`[Auth] Retrying profile fetch in ${retryDelay}ms...`);
                    await new Promise(resolve => setTimeout(resolve, retryDelay));
                    return fetchUserProfile(authUser, retryCount + 1);
                }

                // If no data after retries, throw error instead of returning default
                throw new Error(`Profile not found for user ${authUser.id}`);
            }

            if (!data) {
                throw new Error(`Profile not found for user ${authUser.id}`);
            }

            console.log('[Auth] Profile fetched successfully:', data.email, data.role);

            return {
                role: data.role,
                name: data.name || data.full_name,
                outlet_id: data.outlet_id,
                access_start_date: data.access_start_date,
                access_end_date: data.access_end_date,
            } as UserProfile;
        } catch (err) {
            console.error('[Auth] Exception fetching profile:', err);

            // Retry on exceptions
            if (retryCount < maxRetries) {
                console.warn(`[Auth] Retrying profile fetch in ${retryDelay}ms...`);
                await new Promise(resolve => setTimeout(resolve, retryDelay));
                return fetchUserProfile(authUser, retryCount + 1);
            }

            // After all retries failed, throw the error
            throw err;
        }
    };

    // Load user on mount
    useEffect(() => {
        let isMounted = true;

        const loadUser = async () => {
            try {
                console.log('[Auth] Starting session check...');
                // Get session from cookie-aware client
                const { data: { session } } = await supabase.auth.getSession();

                if (session?.user && isMounted) {
                    console.log('[Auth] Session found, fetching profile...');
                    const profile = await fetchUserProfile(session.user);

                    if (isMounted) {
                        setUser({
                            id: session.user.id,
                            email: session.user.email || '',
                            profile,
                        });
                        console.log('[Auth] User loaded successfully');
                    }
                } else {
                    console.log('[Auth] No session found');
                }
            } catch (err) {
                console.error('[Auth] Error loading user:', err);
                // Don't set user on error, let it remain null
            } finally {
                if (isMounted) {
                    console.log('[Auth] Initial load complete, setting loading=false');
                    setLoading(false);
                }
            }
        };

        // EMERGENCY FALLBACK: Force loading to false after 30 seconds if everything hangs
        const emergencyTimeoutId = setTimeout(() => {
            if (isMounted) {
                setLoading((prev) => {
                    if (prev) {
                        console.error('[Auth] EMERGENCY: Session check/Profile fetch timed out after 30s. Unblocking UI.');
                        return false;
                    }
                    return prev;
                });
            }
        }, 30000);

        loadUser().finally(() => {
            clearTimeout(emergencyTimeoutId);
        });

        // Subscribe to auth changes
        const { data: { subscription } } = supabase.auth.onAuthStateChange(
            async (event, session) => {
                console.log('[Auth] State changed:', event);

                if (session?.user && isMounted) {
                    const profile = await fetchUserProfile(session.user);
                    if (isMounted) {
                        setUser({
                            id: session.user.id,
                            email: session.user.email || '',
                            profile,
                        });
                    }
                    // Use router.refresh() on sign-in related events to update Server Components
                    if (event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED' || event === 'USER_UPDATED') {
                        router.refresh();
                    }
                } else if (isMounted) {
                    setUser(null);
                    // Force refresh on sign out to clear server state
                    if (event === 'SIGNED_OUT') {
                        router.refresh();
                    }
                }
            }
        );

        return () => {
            isMounted = false;
            subscription.unsubscribe();
        };
    }, [supabase, router]);

    // Sign in function
    const signIn = async (email: string, password: string) => {
        console.log('[Auth] Signing in:', email);

        const { data, error } = await supabase.auth.signInWithPassword({
            email,
            password,
        });

        if (error) {
            console.error('[Auth] Sign in error:', error.message);
            throw error;
        }

        console.log('[Auth] Sign in successful');
        // Login page will handle redirect explicitly
        // No need for router.refresh() here
    };

    // Sign out function
    const signOut = async () => {
        try {
            console.log('[Auth] Signing out...');

            // Clear user state immediately for instant feedback
            setUser(null);

            // Sign out from Supabase
            await supabase.auth.signOut();

            console.log('[Auth] Sign out successful');

            // Redirect to login
            router.push('/login');
            router.refresh();
        } catch (error) {
            console.error('[Auth] Error signing out:', error);

            // Even if signOut fails, clear local state and redirect
            setUser(null);
            router.push('/login');
            router.refresh();
        }
    };

    const value = useMemo<AuthContextType>(
        () => ({
            user,
            loading,
            signIn,
            signOut,
        }),
        [user, loading]
    );

    return (
        <AuthContext.Provider value={value}>
            {children}
        </AuthContext.Provider>
    );
}

/* ======================================================
   HOOK
====================================================== */

export function useAuth(): AuthContextType {
    const ctx = useContext(AuthContext);
    if (!ctx) {
        throw new Error('useAuth must be used within AuthProvider');
    }
    return ctx;
}


================================================================================
PATH: lib\database.types.ts
FILENAME: database.types.ts
================================================================================

export type Json =
    | string
    | number
    | boolean
    | null
    | { [key: string]: Json | undefined }
    | Json[]

export interface Database {
    public: {
        Tables: {
            organizations: {
                Row: {
                    id: string
                    name: string
                    code: string
                    timezone: string
                    locale: string
                    currency: string
                    created_at: string
                    updated_at: string
                }
                Insert: {
                    id?: string
                    name: string
                    code: string
                    timezone?: string
                    locale?: string
                    currency?: string
                    created_at?: string
                    updated_at?: string
                }
                Update: {
                    id?: string
                    name?: string
                    code?: string
                    timezone?: string
                    locale?: string
                    currency?: string
                    updated_at?: string
                }
            }
            outlets: {
                Row: {
                    id: string
                    organization_id: string
                    name: string
                    code: string
                    location: string | null
                    phone: string | null
                    email: string | null
                    google_sheet_id: string | null
                    is_active: boolean
                    created_at: string
                    updated_at: string
                }
                Insert: {
                    id?: string
                    organization_id: string
                    name: string
                    code: string
                    location?: string | null
                    phone?: string | null
                    email?: string | null
                    google_sheet_id?: string | null
                    is_active?: boolean
                    created_at?: string
                    updated_at?: string
                }
                Update: {
                    id?: string
                    organization_id?: string
                    name?: string
                    code?: string
                    location?: string | null
                    phone?: string | null
                    email?: string | null
                    google_sheet_id?: string | null
                    is_active?: boolean
                    updated_at?: string
                }
            }
            users: {
                Row: {
                    id: string
                    organization_id: string
                    email: string
                    full_name: string
                    role: 'master_admin' | 'ho_accountant' | 'outlet_manager' | 'outlet_staff' | 'auditor'
                    phone: string | null
                    is_active: boolean
                    created_at: string
                    updated_at: string
                }
                Insert: {
                    id: string
                    organization_id: string
                    email: string
                    full_name: string
                    role: 'master_admin' | 'ho_accountant' | 'outlet_manager' | 'outlet_staff' | 'auditor'
                    phone?: string | null
                    is_active?: boolean
                    created_at?: string
                    updated_at?: string
                }
                Update: {
                    organization_id?: string
                    email?: string
                    full_name?: string
                    role?: 'master_admin' | 'ho_accountant' | 'outlet_manager' | 'outlet_staff' | 'auditor'
                    phone?: string | null
                    is_active?: boolean
                    updated_at?: string
                }
            }
            user_outlet_access: {
                Row: {
                    id: string
                    user_id: string
                    outlet_id: string
                    created_at: string
                }
                Insert: {
                    id?: string
                    user_id: string
                    outlet_id: string
                    created_at?: string
                }
                Update: {
                    user_id?: string
                    outlet_id?: string
                }
            }
            daily_records: {
                Row: {
                    id: string
                    outlet_id: string
                    date: string
                    opening_cash: number
                    opening_upi: number
                    closing_cash: number
                    closing_upi: number
                    total_income: number
                    total_expense: number
                    status: 'draft' | 'submitted' | 'locked'
                    submitted_at: string | null
                    submitted_by: string | null
                    locked_at: string | null
                    locked_by: string | null
                    synced_to_sheet: boolean
                    last_synced_at: string | null
                    created_at: string
                    updated_at: string
                }
                Insert: {
                    id?: string
                    outlet_id: string
                    date: string
                    opening_cash?: number
                    opening_upi?: number
                    closing_cash?: number
                    closing_upi?: number
                    total_income?: number
                    total_expense?: number
                    status?: 'draft' | 'submitted' | 'locked'
                    submitted_at?: string | null
                    submitted_by?: string | null
                    locked_at?: string | null
                    locked_by?: string | null
                    synced_to_sheet?: boolean
                    last_synced_at?: string | null
                    created_at?: string
                    updated_at?: string
                }
                Update: {
                    outlet_id?: string
                    date?: string
                    opening_cash?: number
                    opening_upi?: number
                    closing_cash?: number
                    closing_upi?: number
                    total_income?: number
                    total_expense?: number
                    status?: 'draft' | 'submitted' | 'locked'
                    submitted_at?: string | null
                    submitted_by?: string | null
                    locked_at?: string | null
                    locked_by?: string | null
                    synced_to_sheet?: boolean
                    last_synced_at?: string | null
                    updated_at?: string
                }
            }
            transactions: {
                Row: {
                    id: string
                    daily_record_id: string
                    type: 'income' | 'expense'
                    category: string
                    payment_mode: 'cash' | 'upi'
                    amount: number
                    description: string | null
                    created_by: string | null
                    created_at: string
                    updated_at: string
                }
                Insert: {
                    id?: string
                    daily_record_id: string
                    type: 'income' | 'expense'
                    category: string
                    payment_mode: 'cash' | 'upi'
                    amount: number
                    description?: string | null
                    created_by?: string | null
                    created_at?: string
                    updated_at?: string
                }
                Update: {
                    daily_record_id?: string
                    type?: 'income' | 'expense'
                    category?: string
                    payment_mode?: 'cash' | 'upi'
                    amount?: number
                    description?: string | null
                    created_by?: string | null
                    updated_at?: string
                }
            }
            categories: {
                Row: {
                    id: string
                    organization_id: string
                    name: string
                    type: 'income' | 'expense'
                    code: string
                    is_active: boolean
                    created_at: string
                }
                Insert: {
                    id?: string
                    organization_id: string
                    name: string
                    type: 'income' | 'expense'
                    code: string
                    is_active?: boolean
                    created_at?: string
                }
                Update: {
                    organization_id?: string
                    name?: string
                    type?: 'income' | 'expense'
                    code?: string
                    is_active?: boolean
                }
            }
        }
        Views: {
            [_ in never]: never
        }
        Functions: {
            [_ in never]: never
        }
        Enums: {
            [_ in never]: never
        }
    }
}


================================================================================
PATH: lib\db.ts
FILENAME: db.ts
================================================================================

// IndexedDB Database Setup for Sahakar Accounts
// Provides offline-first caching and fast data access
import Dexie, { Table } from 'dexie';

// Define TypeScript interfaces for cached data
export interface CachedDailyRecord {
    id: string;
    outlet_id: string;
    date: string;
    opening_cash: number;
    opening_upi: number;
    closing_cash: number;
    closing_upi: number;
    total_income: number;
    total_expense: number;
    status: 'draft' | 'submitted' | 'locked';
    cached_at: number; // Timestamp
}

export interface CachedTransaction {
    id: string;
    daily_record_id: string;
    type: 'income' | 'expense';
    category: string;
    payment_mode: 'cash' | 'upi';
    amount: number;
    description?: string;
    date: string;
    cached_at: number;
}

export interface CachedOutlet {
    id: string;
    name: string;
    code: string;
    address?: string;
    phone?: string;
    cached_at: number;
}

export interface CachedUser {
    id: string;
    email: string;
    name?: string;
    full_name?: string;
    role: string;
    outlet_id?: string;
    cached_at: number;
}

// Dexie Database Class
class SahakarDB extends Dexie {
    daily_records!: Table<CachedDailyRecord>;
    transactions!: Table<CachedTransaction>;
    outlets!: Table<CachedOutlet>;
    users!: Table<CachedUser>;

    constructor() {
        super('SahakarAccountsDB');

        this.version(1).stores({
            daily_records: 'id, outlet_id, date, status, cached_at',
            transactions: 'id, daily_record_id, type, date, cached_at',
            outlets: 'id, code, cached_at',
            users: 'id, email, role, cached_at',
        });
    }
}

// Create database instance
export const db = new SahakarDB();

// Cache Management Functions

const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes

export const cacheHelpers = {
    // Check if cache is still fresh
    isFresh: (cachedAt: number): boolean => {
        return Date.now() - cachedAt < CACHE_DURATION;
    },

    // Daily Records
    getDailyRecord: async (id: string): Promise<CachedDailyRecord | undefined> => {
        const record = await db.daily_records.get(id);
        if (record && cacheHelpers.isFresh(record.cached_at)) {
            return record;
        }
        return undefined;
    },

    cacheDailyRecord: async (record: Omit<CachedDailyRecord, 'cached_at'>): Promise<void> => {
        await db.daily_records.put({
            ...record,
            cached_at: Date.now(),
        });
    },

    getDailyRecordsByOutlet: async (outletId: string): Promise<CachedDailyRecord[]> => {
        const records = await db.daily_records
            .where('outlet_id')
            .equals(outletId)
            .toArray();

        return records.filter(r => cacheHelpers.isFresh(r.cached_at));
    },

    // Transactions
    getTransaction: async (id: string): Promise<CachedTransaction | undefined> => {
        const transaction = await db.transactions.get(id);
        if (transaction && cacheHelpers.isFresh(transaction.cached_at)) {
            return transaction;
        }
        return undefined;
    },

    cacheTransaction: async (transaction: Omit<CachedTransaction, 'cached_at'>): Promise<void> => {
        await db.transactions.put({
            ...transaction,
            cached_at: Date.now(),
        });
    },

    getTransactionsByDailyRecord: async (dailyRecordId: string): Promise<CachedTransaction[]> => {
        const transactions = await db.transactions
            .where('daily_record_id')
            .equals(dailyRecordId)
            .toArray();

        return transactions.filter(t => cacheHelpers.isFresh(t.cached_at));
    },

    // Outlets
    getOutlet: async (id: string): Promise<CachedOutlet | undefined> => {
        const outlet = await db.outlets.get(id);
        if (outlet && cacheHelpers.isFresh(outlet.cached_at)) {
            return outlet;
        }
        return undefined;
    },

    cacheOutlet: async (outlet: Omit<CachedOutlet, 'cached_at'>): Promise<void> => {
        await db.outlets.put({
            ...outlet,
            cached_at: Date.now(),
        });
    },

    getAllOutlets: async (): Promise<CachedOutlet[]> => {
        const outlets = await db.outlets.toArray();
        return outlets.filter(o => cacheHelpers.isFresh(o.cached_at));
    },

    // Users
    getUser: async (id: string): Promise<CachedUser | undefined> => {
        const user = await db.users.get(id);
        if (user && cacheHelpers.isFresh(user.cached_at)) {
            return user;
        }
        return undefined;
    },

    cacheUser: async (user: Omit<CachedUser, 'cached_at'>): Promise<void> => {
        await db.users.put({
            ...user,
            cached_at: Date.now(),
        });
    },

    // Clear stale cache
    clearStaleCache: async (): Promise<void> => {
        const now = Date.now();

        await db.daily_records.where('cached_at').below(now - CACHE_DURATION).delete();
        await db.transactions.where('cached_at').below(now - CACHE_DURATION).delete();
        await db.outlets.where('cached_at').below(now - CACHE_DURATION).delete();
        await db.users.where('cached_at').below(now - CACHE_DURATION).delete();
    },

    // Clear all cache
    clearAllCache: async (): Promise<void> => {
        await db.daily_records.clear();
        await db.transactions.clear();
        await db.outlets.clear();
        await db.users.clear();
    },
};

// Auto-cleanup on page load
if (typeof window !== 'undefined') {
    cacheHelpers.clearStaleCache();
}


================================================================================
PATH: lib\google-sheets.ts
FILENAME: google-sheets.ts
================================================================================

import { google } from 'googleapis';

export class GoogleSheetsService {
    private sheets;
    private drive;

    constructor() {
        const auth = new google.auth.GoogleAuth({
            credentials: {
                client_email: process.env.GOOGLE_SHEETS_CLIENT_EMAIL!,
                private_key: process.env.GOOGLE_SHEETS_PRIVATE_KEY?.replace(/\\n/g, '\n'),
            },
            scopes: [
                'https://www.googleapis.com/auth/spreadsheets',
                'https://www.googleapis.com/auth/drive.file',
            ],
        });

        this.sheets = google.sheets({ version: 'v4', auth });
        this.drive = google.drive({ version: 'v3', auth });
    }

    async createMonthlySheet(outletName: string, month: string) {
        try {
            const title = `${outletName} - ${month}`;

            const response = await this.sheets.spreadsheets.create({
                requestBody: {
                    properties: { title },
                    sheets: [
                        {
                            properties: { title: 'Daily Records' },
                        },
                        {
                            properties: { title: 'Summary' },
                        },
                        {
                            properties: { title: 'Transactions' },
                        },
                    ],
                },
            });

            const spreadsheetId = response.data.spreadsheetId!;

            // Move to folder
            if (process.env.GOOGLE_DRIVE_FOLDER_ID) {
                await this.drive.files.update({
                    fileId: spreadsheetId,
                    addParents: process.env.GOOGLE_DRIVE_FOLDER_ID,
                    fields: 'id, parents',
                });
            }

            return spreadsheetId;
        } catch (error) {
            console.error('Error creating sheet:', error);
            throw error;
        }
    }

    async syncDailyRecord(spreadsheetId: string, date: string, data: any) {
        try {
            const values = [
                [
                    date,
                    data.opening_cash || 0,
                    data.opening_upi || 0,
                    data.total_income || 0,
                    data.total_expense || 0,
                    data.closing_cash || 0,
                    data.closing_upi || 0,
                    data.status,
                ],
            ];

            await this.sheets.spreadsheets.values.append({
                spreadsheetId,
                range: 'Daily Records!A:H',
                valueInputOption: 'RAW',
                requestBody: { values },
            });

            return true;
        } catch (error) {
            console.error('Error syncing daily record:', error);
            throw error;
        }
    }

    async syncTransactions(spreadsheetId: string, transactions: any[]) {
        try {
            const values = transactions.map(t => [
                new Date(t.created_at).toLocaleString('en-IN'),
                t.type,
                t.category,
                t.payment_mode,
                t.amount,
                t.description || '',
            ]);

            await this.sheets.spreadsheets.values.append({
                spreadsheetId,
                range: 'Transactions!A:F',
                valueInputOption: 'RAW',
                requestBody: { values },
            });

            return true;
        } catch (error) {
            console.error('Error syncing transactions:', error);
            throw error;
        }
    }
}

export const sheetsService = new GoogleSheetsService();


================================================================================
PATH: lib\supabase-server.ts
FILENAME: supabase-server.ts
================================================================================

import { createClient } from '@supabase/supabase-js';
import { createServerComponentClient } from '@supabase/auth-helpers-nextjs';
import { cookies } from 'next/headers';
import type { Database } from './database.types';

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;

// Server-side client with session capability (Server Components)
export function createServerClient() {
    return createServerComponentClient<Database>({ cookies });
}

// Admin client with service role (Bypass RLS)
export function createAdminClient() {
    const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

    if (!supabaseServiceKey) {
        console.error('SUPABASE_SERVICE_ROLE_KEY is not set in environment variables');
        throw new Error('Missing SUPABASE_SERVICE_ROLE_KEY environment variable');
    }

    return createClient<Database>(supabaseUrl, supabaseServiceKey, {
        auth: {
            persistSession: false,
            autoRefreshToken: false,
        },
    });
}


================================================================================
PATH: lib\supabase.ts
FILENAME: supabase.ts
================================================================================

import { createClient } from '@supabase/supabase-js';
import type { Database } from './database.types';

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;

// Development mode flag - set to true to bypass Supabase
const DEV_MODE = process.env.NEXT_PUBLIC_DEV_MODE === 'true';

export const supabase = createClient<Database>(supabaseUrl, supabaseAnonKey, {
    auth: {
        persistSession: true,
        autoRefreshToken: !DEV_MODE, // Don't auto-refresh in dev mode
    },
});



// Mock user for development
export const MOCK_USERS = {
    staff: {
        id: '4e734021-0118-4147-8880-cdfab90d45e4',
        email: 'staff.test@sahakar.com',
        profile: {
            id: '4e734021-0118-4147-8880-cdfab90d45e4',
            email: 'staff.test@sahakar.com',
            name: 'Test Staff',
            role: 'outlet_staff' as const,
            outlet_id: '9e0c4614-53cf-40d3-abdd-a1d0183c3909',
            created_at: '2025-12-22T13:20:08.734131+00:00',
        }
    },
    manager: {
        id: '5e734021-0118-4147-8880-cdfab90d45e5',
        email: 'manager.test@sahakar.com',
        profile: {
            id: '5e734021-0118-4147-8880-cdfab90d45e5',
            email: 'manager.test@sahakar.com',
            name: 'Test Manager',
            role: 'outlet_manager' as const,
            outlet_id: '9e0c4614-53cf-40d3-abdd-a1d0183c3909',
            created_at: '2025-12-22T13:20:08.734131+00:00',
        }
    },
    admin: {
        id: '6e734021-0118-4147-8880-cdfab90d45e6',
        email: 'admin@sahakar.com',
        profile: {
            id: '6e734021-0118-4147-8880-cdfab90d45e6',
            email: 'admin@sahakar.com',
            name: 'Super Admin',
            role: 'superadmin' as const,
            outlet_id: null,
            created_at: '2025-12-22T13:20:08.734131+00:00',
        }
    }
};


================================================================================
PATH: lib\temp-types.ts
FILENAME: temp-types.ts
================================================================================

// Temporary type definitions for build
// TODO: Replace with proper database.types.ts from Supabase

export type DailyRecord = {
    id: string;
    outlet_id: string;
    date: string;
    status: 'draft' | 'submitted' | 'locked';
    opening_cash: number;
    opening_upi: number;
    closing_cash: number;
    closing_upi: number;
    total_income: number;
    total_expense: number;
    locked_at?: string;
    locked_by?: string;
    created_at: string;
    updated_at: string;
};

export type Transaction = {
    id: string;
    daily_record_id: string;
    type: 'income' | 'expense';
    category: string;
    payment_mode: 'cash' | 'upi';
    amount: number;
    description?: string;
    created_at: string;
    updated_at: string;
};


================================================================================
PATH: lib\types.ts
FILENAME: types.ts
================================================================================

// @ts-nocheck
import type { Database } from './database.types';

export type UserRole = 'master_admin' | 'ho_accountant' | 'outlet_manager' | 'outlet_staff' | 'auditor' | 'superadmin';

export interface UserProfile {
    id: string;
    email: string;
    name: string;
    role: UserRole;
    outlet_id: string | null;
    created_at: string;
}

export interface AuthUser {
    id: string;
    email: string;
    profile: UserProfile | null;
}

export interface AuthContextType {
    user: AuthUser | null;
    loading: boolean;
    signIn: (email: string, password: string) => Promise<void>;
    signOut: () => Promise<void>;
    refreshProfile: () => Promise<void>;
}

export type { ClassValue } from 'clsx';


================================================================================
PATH: lib\use-realtime.ts
FILENAME: use-realtime.ts
================================================================================

'use client';

import { useEffect, useState } from 'react';
import { useQuery, useQueryClient } from '@tanstack/react-query';
import { createClientComponentClient } from '@supabase/auth-helpers-nextjs';
import { cacheHelpers } from './db';

// Real-time hook for daily records with caching
export function useRealtimeDailyRecords(outletId?: string) {
    const queryClient = useQueryClient();
    const supabase = createClientComponentClient();
    const [isRealtime, setIsRealtime] = useState(false);

    const { data, isLoading, error } = useQuery({
        queryKey: ['daily-records-realtime', outletId],
        queryFn: async () => {
            // Try cache first
            if (outletId) {
                const cached = await cacheHelpers.getDailyRecordsByOutlet(outletId);
                if (cached.length > 0) {
                    console.log('[Cache] Using cached daily records');
                    return cached;
                }
            }

            // Fetch from API
            const url = outletId ? `/api/daily-records?outletId=${outletId}` : '/api/daily-records';
            const res = await fetch(url);
            if (!res.ok) throw new Error('Failed to fetch daily records');

            const data = await res.json();

            // Cache each record
            if (Array.isArray(data)) {
                await Promise.all(data.map(record => cacheHelpers.cacheDailyRecord(record)));
            }

            return data;
        },
        staleTime: 30000, // 30 seconds
        refetchOnWindowFocus: false,
    });

    // Set up real-time subscription
    useEffect(() => {
        const channel = supabase
            .channel('daily-records-changes')
            .on(
                'postgres_changes',
                {
                    event: '*',
                    schema: 'public',
                    table: 'daily_records',
                    filter: outletId ? `outlet_id=eq.${outletId}` : undefined,
                },
                async (payload) => {
                    console.log('[Realtime] Daily record changed:', payload);

                    // Update cache
                    if (payload.new) {
                        await cacheHelpers.cacheDailyRecord(payload.new as any);
                    }

                    // Invalidate and refetch
                    queryClient.invalidateQueries({ queryKey: ['daily-records-realtime', outletId] });
                    setIsRealtime(true);
                }
            )
            .subscribe();

        return () => {
            supabase.removeChannel(channel);
        };
    }, [outletId, supabase, queryClient]);

    return { data, isLoading, error, isRealtime };
}

// Real-time hook for transactions with caching
export function useRealtimeTransactions(dailyRecordId?: string) {
    const queryClient = useQueryClient();
    const supabase = createClientComponentClient();
    const [isRealtime, setIsRealtime] = useState(false);

    const { data, isLoading, error } = useQuery({
        queryKey: ['transactions-realtime', dailyRecordId],
        queryFn: async () => {
            // Try cache first
            if (dailyRecordId) {
                const cached = await cacheHelpers.getTransactionsByDailyRecord(dailyRecordId);
                if (cached.length > 0) {
                    console.log('[Cache] Using cached transactions');
                    return cached;
                }
            }

            // Fetch from API
            const url = dailyRecordId
                ? `/api/transactions?dailyRecordId=${dailyRecordId}`
                : '/api/transactions';
            const res = await fetch(url);
            if (!res.ok) throw new Error('Failed to fetch transactions');

            const data = await res.json();

            // Cache each transaction
            if (Array.isArray(data)) {
                await Promise.all(data.map(tx => cacheHelpers.cacheTransaction(tx)));
            }

            return data;
        },
        enabled: !!dailyRecordId,
        staleTime: 10000, // 10 seconds
        refetchOnWindowFocus: false,
    });

    // Set up real-time subscription
    useEffect(() => {
        if (!dailyRecordId) return;

        const channel = supabase
            .channel('transactions-changes')
            .on(
                'postgres_changes',
                {
                    event: '*',
                    schema: 'public',
                    table: 'transactions',
                    filter: `daily_record_id=eq.${dailyRecordId}`,
                },
                async (payload) => {
                    console.log('[Realtime] Transaction changed:', payload);

                    // Update cache
                    if (payload.new) {
                        await cacheHelpers.cacheTransaction(payload.new as any);
                    }

                    // Invalidate and refetch
                    queryClient.invalidateQueries({ queryKey: ['transactions-realtime', dailyRecordId] });
                    queryClient.invalidateQueries({ queryKey: ['daily-record-today'] });
                    setIsRealtime(true);
                }
            )
            .subscribe();

        return () => {
            supabase.removeChannel(channel);
        };
    }, [dailyRecordId, supabase, queryClient]);

    return { data, isLoading, error, isRealtime };
}

// Real-time hook for outlets with caching
export function useRealtimeOutlets() {
    const queryClient = useQueryClient();
    const supabase = createClientComponentClient();

    const { data, isLoading, error } = useQuery({
        queryKey: ['outlets-realtime'],
        queryFn: async () => {
            // Try cache first
            const cached = await cacheHelpers.getAllOutlets();
            if (cached.length > 0) {
                console.log('[Cache] Using cached outlets');
                return cached;
            }

            // Fetch from API
            const res = await fetch('/api/outlets');
            if (!res.ok) throw new Error('Failed to fetch outlets');

            const data = await res.json();

            // Cache each outlet
            if (Array.isArray(data)) {
                await Promise.all(data.map(outlet => cacheHelpers.cacheOutlet(outlet)));
            }

            return data;
        },
        staleTime: 300000, // 5 minutes
        refetchOnWindowFocus: false,
    });

    // Set up real-time subscription
    useEffect(() => {
        const channel = supabase
            .channel('outlets-changes')
            .on(
                'postgres_changes',
                {
                    event: '*',
                    schema: 'public',
                    table: 'outlets',
                },
                async (payload) => {
                    console.log('[Realtime] Outlet changed:', payload);

                    // Update cache
                    if (payload.new) {
                        await cacheHelpers.cacheOutlet(payload.new as any);
                    }

                    // Invalidate and refetch
                    queryClient.invalidateQueries({ queryKey: ['outlets-realtime'] });
                }
            )
            .subscribe();

        return () => {
            supabase.removeChannel(channel);
        };
    }, [supabase, queryClient]);

    return { data, isLoading, error };
}


================================================================================
PATH: lib\utils.ts
FILENAME: utils.ts
================================================================================

import { type ClassValue, clsx } from 'clsx';
import { twMerge } from 'tailwind-merge';

export function cn(...inputs: ClassValue[]) {
    return twMerge(clsx(inputs));
}

export function formatCurrency(amount: number, currency: string = 'INR'): string {
    return new Intl.NumberFormat('en-IN', {
        style: 'currency',
        currency,
        minimumFractionDigits: 2,
    }).format(amount);
}

export function formatDate(date: Date | string): string {
    const dateObj = typeof date === 'string' ? new Date(date) : date;
    return new Intl.DateTimeFormat('en-IN', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
    }).format(dateObj);
}

export function getRoleDashboard(role: string): string {
    switch (role) {
        case 'superadmin':
        case 'master_admin':
            return '/dashboard/admin';
        case 'ho_accountant':
            return '/dashboard/accountant';
        case 'outlet_manager':
            return '/dashboard/manager';
        case 'outlet_staff':
            return '/dashboard/staff';
        default:
            return '/dashboard';
    }
}


================================================================================
PATH: lib\validation.ts
FILENAME: validation.ts
================================================================================

import { z } from 'zod';

// Transaction validation
export const TransactionSchema = z.object({
    dailyRecordId: z.string().uuid('Invalid daily record ID'),
    type: z.enum(['income', 'expense'], {
        errorMap: () => ({ message: 'Type must be income or expense' })
    }),
    category: z.string().min(1, 'Category is required'),
    paymentMode: z.enum(['cash', 'upi'], {
        errorMap: () => ({ message: 'Payment mode must be cash or upi' })
    }),
    amount: z.number()
        .positive('Amount must be positive')
        .max(10000000, 'Amount too large (max 10M)')
        .multipleOf(0.01, 'Amount can have max 2 decimal places'),
    description: z.string().optional(),
    createdBy: z.string().uuid().optional(),
});

export type TransactionInput = z.infer<typeof TransactionSchema>;

// Daily Record validation
export const DailyRecordSchema = z.object({
    outletId: z.string().uuid('Invalid outlet ID'),
    date: z.string().regex(/^\d{4}-\d{2}-\d{2}$/, 'Invalid date format (YYYY-MM-DD)'),
    openingCash: z.number().min(0, 'Opening cash cannot be negative').default(0),
    openingUpi: z.number().min(0, 'Opening UPI cannot be negative').default(0),
});

// User creation validation
export const UserCreateSchema = z.object({
    email: z.string().email('Invalid email address'),
    fullName: z.string().min(2, 'Name must be at least 2 characters'),
    role: z.enum(['master_admin', 'ho_accountant', 'outlet_manager', 'outlet_staff']),
    phone: z.string().regex(/^\+?[1-9]\d{9,14}$/, 'Invalid phone number').optional(),
    outletId: z.string().uuid().optional(),
});

// Outlet creation validation
export const OutletCreateSchema = z.object({
    name: z.string().min(2, 'Outlet name required'),
    code: z.string().min(2, 'Outlet code required').max(20, 'Code too long'),
    location: z.string().optional(),
    phone: z.string().optional(),
    email: z.string().email('Invalid email').optional(),
});

// Query params validation
export const PaginationSchema = z.object({
    limit: z.number().int().min(1).max(100).default(50),
    offset: z.number().int().min(0).default(0),
});

export const DateRangeSchema = z.object({
    startDate: z.string().regex(/^\d{4}-\d{2}-\d{2}$/),
    endDate: z.string().regex(/^\d{4}-\d{2}-\d{2}$/),
});


================================================================================
PATH: middleware.ts
FILENAME: middleware.ts
================================================================================

import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';
import { createMiddlewareClient } from '@supabase/auth-helpers-nextjs';

// Simple rate limiting using in-memory store (for development)
// In production, use Redis or similar
const rateLimit = new Map<string, { count: number; resetTime: number }>();

function getRateLimitKey(request: NextRequest): string {
    // Use IP + pathname for rate limit key
    const ip = request.headers.get('x-forwarded-for') ||
        request.headers.get('x-real-ip') ||
        'unknown';
    return `${ip}:${request.nextUrl.pathname}`;
}

function checkRateLimit(key: string, limit: number, windowMs: number): boolean {
    const now = Date.now();
    const record = rateLimit.get(key);

    if (!record || now > record.resetTime) {
        // First request or window expired
        rateLimit.set(key, { count: 1, resetTime: now + windowMs });
        return true;
    }

    if (record.count < limit) {
        record.count++;
        return true;
    }

    return false; // Rate limit exceeded
}

// Cleanup old entries every 5 minutes
setInterval(() => {
    const now = Date.now();
    const entries = Array.from(rateLimit.entries());
    for (const [key, record] of entries) {
        if (now > record.resetTime) {
            rateLimit.delete(key);
        }
    }
}, 5 * 60 * 1000);

export async function middleware(request: NextRequest) {
    // Skip rate limiting for static files
    if (
        request.nextUrl.pathname.startsWith('/_next') ||
        request.nextUrl.pathname.startsWith('/static') ||
        request.nextUrl.pathname.match(/\.(ico|png|jpg|jpeg|svg|css|js)$/)
    ) {
        return NextResponse.next();
    }

    // Apply rate limiting to API routes
    if (request.nextUrl.pathname.startsWith('/api')) {
        const key = getRateLimitKey(request);

        // Different limits for different endpoints
        let limit = 100; // requests
        let windowMs = 60 * 1000; // per minute

        // Stricter limits for write operations
        if (request.method === 'POST' || request.method === 'PUT' || request.method === 'PATCH') {
            limit = 20; // 20 writes per minute
        }

        // Very strict on login
        if (request.nextUrl.pathname === '/api/auth/login') {
            limit = 5;
            windowMs = 60 * 1000; // 5 attempts per minute
        }

        if (!checkRateLimit(key, limit, windowMs)) {
            return NextResponse.json(
                { error: 'Too many requests. Please try again later.' },
                {
                    status: 429,
                    headers: {
                        'Retry-After': '60',
                    }
                }
            );
        }
    }

    // Check DEV_AUTH in production
    const isDev = process.env.NODE_ENV === 'development';
    const devMode = process.env.NEXT_PUBLIC_DEV_AUTH === 'true';

    if (!isDev && devMode) {
        console.error('ðŸš¨ CRITICAL: DEV_AUTH enabled in production! Disabling immediately.');
        return NextResponse.json(
            { error: 'Configuration error. Please contact administrator.' },
            { status: 503 }
        );
    }

    // Supabase Session management
    let response = NextResponse.next({
        request: {
            headers: request.headers,
        },
    });

    const supabase = createMiddlewareClient({ req: request, res: response });

    // This will refresh the session if needed
    const { data: { session } } = await supabase.auth.getSession();

    const isLoginPage = request.nextUrl.pathname === '/login';
    const isDashboardPage = request.nextUrl.pathname.startsWith('/dashboard');

    // Redirect authenticated users away from login page
    if (isLoginPage && session) {
        const redirectUrl = new URL('/dashboard', request.url);
        // Create a new redirect response but make sure to include the updated cookies
        const redirectResponse = NextResponse.redirect(redirectUrl);

        // Copy the cookies from the Supabase response to the redirect response
        // This is crucial for keeping the session alive across the redirect
        supabase.auth.getSession().then(() => {
            // Re-sync cookies if needed, but createMiddlewareClient handles this via 'res' reference
        });

        return redirectResponse;
    }

    // Redirect unauthenticated users to login page
    if (isDashboardPage && !session) {
        return NextResponse.redirect(new URL('/login', request.url));
    }

    // Role-based Access Control
    if (session) {
        const userRole = session.user.user_metadata.role;

        // Auditor strict read-only enforcement
        if (userRole === 'auditor') {
            if (['POST', 'PUT', 'PATCH', 'DELETE'].includes(request.method)) {
                return NextResponse.json(
                    { error: 'Auditors have read-only access.' },
                    { status: 403 }
                );
            }
        }
    }

    return response;
}

export const config = {
    matcher: [
        /*
         * Match all request paths except:
         * - _next/static (static files)
         * - _next/image (image optimization files)
         * - favicon.ico (favicon file)
         */
        '/((?!_next/static|_next/image|favicon.ico).*)',
    ],
};


================================================================================
PATH: next-env.d.ts
FILENAME: next-env.d.ts
================================================================================

/// <reference types="next" />
/// <reference types="next/image-types/global" />

// NOTE: This file should not be edited
// see https://nextjs.org/docs/app/building-your-application/configuring/typescript for more information.


================================================================================
PATH: package.json
FILENAME: package.json
================================================================================

{
  "name": "sahakar-accounts",
  "version": "1.0.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  },
  "dependencies": {
    "@hookform/resolvers": "^3.3.0",
    "@supabase/auth-helpers-nextjs": "^0.8.0",
    "@supabase/supabase-js": "^2.38.0",
    "@tanstack/react-query": "^5.17.0",
    "class-variance-authority": "^0.7.0",
    "clsx": "^2.1.0",
    "date-fns": "^3.0.0",
    "dexie": "^4.2.1",
    "dotenv": "^17.2.3",
    "googleapis": "^128.0.0",
    "jspdf": "^3.0.4",
    "jspdf-autotable": "^5.0.2",
    "lucide-react": "^0.300.0",
    "next": "^14.2.0",
    "react": "^18.2.0",
    "react-datepicker": "^9.1.0",
    "react-dom": "^18.2.0",
    "react-hook-form": "^7.49.0",
    "recharts": "^3.6.0",
    "tailwind-merge": "^2.2.0",
    "tailwindcss-animate": "^1.0.7",
    "xlsx": "https://cdn.sheetjs.com/xlsx-0.20.3/xlsx-0.20.3.tgz",
    "zod": "^3.22.0",
    "zustand": "^4.4.0"
  },
  "devDependencies": {
    "@postgres-language-server/cli": "^0.18.0",
    "@types/node": "^20.0.0",
    "@types/react": "^18.2.0",
    "@types/react-dom": "^18.2.0",
    "autoprefixer": "^10.4.0",
    "eslint": "^8.56.0",
    "eslint-config-next": "^16.1.0",
    "postcss": "^8.4.0",
    "supabase": "^2.70.4",
    "tailwindcss": "^3.4.0",
    "typescript": "^5.3.0"
  }
}


================================================================================
PATH: postcss.config.js
FILENAME: postcss.config.js
================================================================================

module.exports = {
    plugins: {
        tailwindcss: {},
        autoprefixer: {},
    },
};


================================================================================
PATH: sahakar-accounts-production-216e1547b436.json
FILENAME: sahakar-accounts-production-216e1547b436.json
================================================================================

{
  "type": "service_account",
  "project_id": "sahakar-accounts-production",
  "private_key_id": "216e1547b436c14d7b1a7ea83052ea3c5242414c",
  "private_key": "-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQDvfxQjug0iwLr/\ntHAMsAlCgx4DQ8RUQZZ+oCdBZ/EsV/G0vATxLevdGqc/C+4D7E6U3JYalNkxTqx0\nMhN3iKWBi1ajJ8CDoyMcSnkihCeX63B8L+iDIvmqpOGVCQ0ST6ohndFE2SmOc2Gv\nhzZNMqR7Fh70CsDmY1BFaP2OdMhPoz4/gMKP39F2+lY6SQ2JtcYWvK1VL0myWbBJ\ntddGLrpzMy0v20H2kP61/WjeKrWuJBw1yvW8J16dcsx6DmFmwV0rfaCnq+9ALHE8\naYpRmvJwymuPaVyxBQ4IULWXUqE7dmI5vAjcPv56cGTBCtbjleyk3eh56N+cOydn\nScHBwFK3AgMBAAECggEAYtfnz/bxhO5WP0KRHCtrJvBGasKFPOD0473ldbEYcFy7\nfQQ8Ze218sMVU4fw692TcQy5Rq84FImL00j3j9XtuNFxKFU3txyVWQ/DfuNcE+8v\ntZFwPO8qa6sxDvl1U6FdbhJcVDXsWMZ2AqOjXakRCVvP2pi1lGBYuMzkGO9J3NOO\ncSAmNyHHB4cAtzGhPhL8M8cwoJBrcl4HGnngjvLFF2Xz9MTEtwYzsZIRiYiRhpxy\nuk8Q3XUc2AFxDM5MLKBMueAHdX2IminoEEqaDRWZ2OdlsaaxLJbPJ6DVao6XSR7K\nohvqQ4QTcfGvsvHOuznTKO4ujrC2YfUMCFRfaZIkwQKBgQD5H3uN9MdvvX4vXEYb\n3HxBHeD/G7lqnBh4jB/ljhnPwr3XXsNW9PysHjNv60SabvTN1XXYjnWoQ1aXKbX6\niVEeHRiLs4vtHHIWETWtaPNCH/eOk7igsZzedzn5HsXO9FEeNshrozldd9FqbbBv\n7T5GcvOwbKYiQKFV8GbEuF3b3QKBgQD2G5D8Ws+16OcP8SVQx8Lst2gExYcFcv6S\nmLO/gr7Ju1UzCWuSTi15Dzdavc0XPddPX1TH9CsQtb6JOaLl93FeiLV7HqGAvd1R\nAHkL20GhysrZt6efHky9oIkFgYXDIx9S/rmmKarHMMKMpKjA8UOZcsq5tZZIk5li\nCJAUmqvZowKBgQCuNTLMeSDB5ewIqGkqcIu/aWp+Wt/VSmTeX3aqqy0nmRHyOoU1\nGMpcfh4QJKBrsi2khqILFsv2J2i0+mkUUtQTz9rrTloKLHsnLU+w/RQm6H3QCULx\ntGJzO0KiD7/Z0gWrsDmE87ZYw0IBP8VC7889qoL4m3GtwC5SD3N+G0MfTQKBgEuh\ndRDYJ3TTug5gIQOOIAz23/R3b2LxT+JlIvf7if4cn7Yrcu9nLvpA/tXX9irqSjyO\nI1O/aWydLYymNbVOMXzHrl3DsAYMUvMNniVSn/zEgUoe8lgny5WKvBEBGMY7COlM\ndmjl7SGBjogCIgoJGqkRadNgRmrPURebYguy7JTZAoGAWJHHXAdm61mDlEJUYO2G\nrJtjOmUAvQj/8wm5ThxzTUTuKT4Z8sCJT0TCtxARbwG0LawpEGwICZqMxv52N94K\ndaY2DX7Fe4G+2JC2bl9vleIz1EWsYg8qvMVUO9/pu7cwrTq1HClXhatuOXnHvLR1\n9eFIX+UUASi2ZXEmCV08hW0=\n-----END PRIVATE KEY-----\n",
  "client_email": "sahakar-sheets-sync@sahakar-accounts-production.iam.gserviceaccount.com",
  "client_id": "113629729962423468662",
  "auth_uri": "https://accounts.google.com/o/oauth2/auth",
  "token_uri": "https://oauth2.googleapis.com/token",
  "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
  "client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/sahakar-sheets-sync%40sahakar-accounts-production.iam.gserviceaccount.com",
  "universe_domain": "googleapis.com"
}

================================================================================
PATH: scripts\bulk-onboard-outlets.js
FILENAME: bulk-onboard-outlets.js
================================================================================

const { createClient } = require('@supabase/supabase-js');
require('dotenv').config({ path: '.env.local' });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

if (!supabaseUrl || !supabaseKey) {
    console.error('Missing Supabase environment variables');
    process.exit(1);
}

const supabase = createClient(supabaseUrl, supabaseKey);

const TARGET_COUNT = 140;

async function bulkOnboard() {
    try {
        // 1. Count existing outlets
        const { count: currentCount } = await supabase
            .from('outlets')
            .select('id', { count: 'exact', head: true });

        console.log(`Current outlet count: ${currentCount}`);

        if (currentCount >= TARGET_COUNT) {
            console.log('Target count already reached or exceeded.');
            return;
        }

        const needed = TARGET_COUNT - currentCount;
        console.log(`Onboarding ${needed} more outlets...`);

        const newOutlets = [];
        for (let i = 1; i <= needed; i++) {
            const outletNum = currentCount + i;
            const type = Math.random() > 0.5 ? 'hyper_pharmacy' : 'smart_clinic';
            const typePrefix = type === 'hyper_pharmacy' ? 'HP' : 'SC';
            const code = `${typePrefix}-GEN-${outletNum.toString().padStart(3, '0')}`;

            newOutlets.push({
                name: `Sahakar ${type === 'hyper_pharmacy' ? 'Hyper Pharmacy' : 'Smart Clinic'} - Outlet ${outletNum}`,
                code: code,
                location: 'Generated Location',
                is_active: true,
                type: type
            });
        }

        // Insert in batches of 50
        for (let i = 0; i < newOutlets.length; i += 50) {
            const batch = newOutlets.slice(i, i + 50);
            const { error } = await supabase.from('outlets').insert(batch);
            if (error) {
                console.error(`Error inserting batch starting at ${i}:`, error.message);
            } else {
                console.log(`Inserted batch ${Math.floor(i / 50) + 1}`);
            }
        }

        console.log('âœ… Bulk onboarding complete!');

    } catch (error) {
        console.error('Unexpected error:', error);
    }
}

bulkOnboard();


================================================================================
PATH: scripts\create-superadmin-profile.js
FILENAME: create-superadmin-profile.js
================================================================================

// Create superadmin profile using raw SQL query
const { createClient } = require('@supabase/supabase-js');
const fs = require('fs');
const path = require('path');

// Read .env
const envPath = path.join(__dirname, '..', '.env');
const envContent = fs.readFileSync(envPath, 'utf-8');
const envVars = {};
envContent.split('\n').forEach(line => {
    line = line.trim().replace(/\r/g, '');
    const match = line.match(/^([^=]+)=(.*)$/);
    if (match) {
        const key = match[1].trim();
        const value = match[2].trim().replace(/^["']|["']$/g, '');
        envVars[key] = value;
    }
});

// Service role key
const SERVICE_ROLE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB2ZHFvdHVodXd6b295c3JtdHJkIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NjEzMTY1NCwiZXhwIjoyMDgxNzA3NjU0fQ.WBcfhvchDl37AU3IR8cYyErrSALk6QPyx02otPDOghM';

const supabase = createClient(
    envVars.NEXT_PUBLIC_SUPABASE_URL,
    SERVICE_ROLE_KEY
);

async function createSuperadminProfile() {
    console.log('Finding superadmin auth user via SQL...');

    // Query auth.users table directly
    const { data: authUsers, error: authError } = await supabase
        .from('auth.users')
        .select('id, email')
        .eq('email', 'frpboy12@gmail.com')
        .single();

    if (authError) {
        console.error('Error querying auth.users:', authError.message);
        console.log('\nTrying alternative method - creating profile with manual ID...');

        // Create a new auth user if it doesn't exist
        const { data: newUser, error: createError } = await supabase.auth.admin.createUser({
            email: 'frpboy12@gmail.com',
            password: 'Zabnix@2025',
            email_confirm: true,
        });

        if (createError) {
            // User might already exist, let's try to find it using RPC
            console.log('User creation failed (might already exist):', createError.message);
            console.log('\nPlease create the superadmin profile manually using the SQL Editor.');
            console.log('Run this SQL:');
            console.log(`
-- Create superadmin profile
INSERT INTO users (id, email, name, role, outlet_id)
SELECT id, 'frpboy12@gmail.com', 'K4NN4N', 'superadmin', NULL
FROM auth.users
WHERE email = 'frpboy12@gmail.com'
ON CONFLICT (id) DO UPDATE
SET name = EXCLUDED.name, role = EXCLUDED.role;
      `);
            return;
        }

        console.log('Created new auth user with ID:', newUser.user.id);

        // Create profile for the new user
        const { data: profile, error: profileError } = await supabase
            .from('users')
            .insert({
                id: newUser.user.id,
                email: 'frpboy12@gmail.com',
                name: 'K4NN4N',
                role: 'superadmin',
                outlet_id: null
            })
            .select()
            .single();

        if (profileError) {
            console.error('Error creating profile:', profileError);
            return;
        }

        console.log('Superadmin profile created successfully!');
        console.log(profile);
    } else {
        console.log('Found superadmin with ID:', authUsers.id);

        // Create or update profile
        const { data: profile, error: profileError } = await supabase
            .from('users')
            .upsert({
                id: authUsers.id,
                email: 'frpboy12@gmail.com',
                name: 'K4NN4N',
                role: 'superadmin',
                outlet_id: null
            })
            .select()
            .single();

        if (profileError) {
            console.error('Error creating profile:', profileError);
            return;
        }

        console.log('Superadmin profile created successfully!');
        console.log(profile);
    }

    // Verify all users
    console.log('\n=== ALL USERS IN DATABASE ===');
    const { data: allUsers } = await supabase
        .from('users')
        .select(`
      email,
      name,
      role,
      outlets (name)
    `)
        .order('role');

    if (allUsers) {
        console.table(allUsers.map(u => ({
            Email: u.email,
            Name: u.name,
            Role: u.role,
            Outlet: u.outlets?.name || 'All outlets'
        })));
    }
}

createSuperadminProfile().catch(console.error);


================================================================================
PATH: scripts\create-superadmin-profile.sql
FILENAME: create-superadmin-profile.sql
================================================================================

-- Find the superadmin auth user and create their profile
-- Run this in Supabase SQL Editor

-- First, find the superadmin user ID
SELECT id, email, created_at 
FROM auth.users 
WHERE email = 'frpboy12@gmail.com';

-- Then insert the superadmin profile (replace [UUID] with the id from above)
INSERT INTO users (id, email, name, role, outlet_id) VALUES
  ('[UUID_FROM_ABOVE]', 'frpboy12@gmail.com', 'K4NN4N', 'superadmin', NULL)
ON CONFLICT (id) DO UPDATE
SET 
  name = EXCLUDED.name,
  role = EXCLUDED.role,
  outlet_id =EXCLUDED.outlet_id;

-- Verify all users
SELECT 
  u.id,
  u.email,
  u.name,
  u.role,
  o.name as outlet_name
FROM users u
LEFT JOIN outlets o ON u.outlet_id = o.id
ORDER BY u.role, u.name;


================================================================================
PATH: scripts\create-users.js
FILENAME: create-users.js
================================================================================

// Script to create Supabase Auth users programmatically
// Run this script using: node scripts/create-users.js

const { createClient } = require('@supabase/supabase-js');
const fs = require('fs');
const path = require('path');

// Read .env manually
const envPath = path.join(__dirname, '..', '.env');
const envContent = fs.readFileSync(envPath, 'utf-8');
const envVars = {};
envContent.split('\n').forEach(line => {
    line = line.trim().replace(/\r/g, ''); // Remove carriage returns
    const match = line.match(/^([^=]+)=(.*)$/);
    if (match) {
        const key = match[1].trim();
        const value = match[2].trim().replace(/^["']|["']$/g, '');
        envVars[key] = value;
    }
});

// Service role key from Vercel (we configured this earlier)
const SERVICE_ROLE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB2ZHFvdHVodXd6b295c3JtdHJkIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NjEzMTY1NCwiZXhwIjoyMDgxNzA3NjU0fQ.WBcfhvchDl37AU3IR8cYyErrSALk6QPyx02otPDOghM';

// Debug: print environment variables
console.log('Environment variables loaded:');
console.log('  NEXT_PUBLIC_SUPABASE_URL:', envVars.NEXT_PUBLIC_SUPABASE_URL);
console.log('  Has service role key:', !!SERVICE_ROLE_KEY);
console.log('');

const supabase = createClient(
    envVars.NEXT_PUBLIC_SUPABASE_URL,
    SERVICE_ROLE_KEY
);

const users = [
    {
        email: 'frpboy12@gmail.com',
        password: 'Zabnix@2025',
        name: 'K4NN4N',
        role: 'superadmin',
        outlet_id: null
    },
    {
        email: 'paymentstarlexpmna@gmail.com',
        password: 'Zabnix@2025',
        name: 'HO Accountant',
        role: 'ho_accountant',
        outlet_id: null
    },
    {
        email: 'manager.test@sahakar.com',
        password: 'Zabnix@2025',
        name: 'Test Manager',
        role: 'outlet_manager',
        outlet_id: 'NEEDS_MAIN_OUTLET_ID'
    },
    {
        email: 'staff.test@sahakar.com',
        password: 'Zabnix@2025',
        name: 'Test Staff',
        role: 'outlet_staff',
        outlet_id: 'NEEDS_MAIN_OUTLET_ID'
    }
];

async function createUsers() {
    console.log('Starting user creation...\n');

    // First, get the Main Outlet ID
    const { data: outlets, error: outletError } = await supabase
        .from('outlets')
        .select('id, name')
        .eq('name', 'Main Outlet')
        .single();

    if (outletError || !outlets) {
        console.error('Error fetching Main Outlet:', outletError);
        return;
    }

    console.log('Found Main Outlet:', outlets.id);
    const mainOutletId = outlets.id;

    // Update outlet IDs for manager and staff
    users[2].outlet_id = mainOutletId;
    users[3].outlet_id = mainOutletId;

    // Create each user
    for (const user of users) {
        console.log(`\nCreating user: ${user.email}`);

        // Create auth user
        const { data: authData, error: authError } = await supabase.auth.admin.createUser({
            email: user.email,
            password: user.password,
            email_confirm: true,
        });

        if (authError) {
            console.error(`Error creating auth user ${user.email}:`, authError.message);
            continue;
        }

        console.log(`Auth user created with ID: ${authData.user.id}`);

        // Insert user profile
        const { data: profileData, error: profileError } = await supabase
            .from('users')
            .insert({
                id: authData.user.id,
                email: user.email,
                name: user.name,
                role: user.role,
                outlet_id: user.outlet_id
            })
            .select()
            .single();

        if (profileError) {
            console.error(`Error creating user profile ${user.email}:`, profileError.message);
            continue;
        }

        console.log(`User profile created:`, {
            email: profileData.email,
            name: profileData.name,
            role: profileData.role,
            outlet: user.outlet_id ? 'Main Outlet' : 'All outlets'
        });
    }

    console.log('\nUser creation complete!\n');

    // Verify all users
    console.log('Verifying created users...\n');
    const { data: allUsers, error: verifyError } = await supabase
        .from('users')
        .select(`
      id,
      email,
      name,
      role,
      outlets (name)
    `)
        .order('role', { ascending: true });

    if (verifyError) {
        console.error('Error verifying users:', verifyError);
        return;
    }

    console.table(allUsers.map(u => ({
        Email: u.email,
        Name: u.name,
        Role: u.role,
        Outlet: u.outlets?.name || 'All outlets'
    })));
}

createUsers().catch(console.error);


================================================================================
PATH: scripts\execute-fix.js
FILENAME: execute-fix.js
================================================================================

const { createClient } = require('@supabase/supabase-js');
require('dotenv').config({ path: '.env.local' });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

if (!supabaseUrl || !supabaseKey) {
    console.error('Missing Supabase environment variables');
    process.exit(1);
}

const supabase = createClient(supabaseUrl, supabaseKey);

async function fixStaffOutlet() {
    try {
        // 1. Find Main Outlet
        const { data: outlets, error: outletError } = await supabase
            .from('outlets')
            .select('id, name')
            .ilike('name', '%Main Outlet%')
            .limit(1);

        if (outletError || !outlets.length) {
            console.error('Could not find Main Outlet:', outletError || 'Not found');
            // Let's list all outlets to see what we have
            const { data: allOutlets } = await supabase.from('outlets').select('id, name');
            console.log('Available outlets:', allOutlets);
            return;
        }

        const mainOutletId = outlets[0].id;
        console.log(`Found Main Outlet: ${outlets[0].name} (ID: ${mainOutletId})`);

        // 2. Find Staff User
        const { data: users, error: userError } = await supabase
            .from('users')
            .select('id, email, name')
            .eq('email', 'staff.test@sahakar.com')
            .single();

        if (userError || !users) {
            console.error('Could not find staff user:', userError || 'Not found');
            return;
        }

        console.log(`Found Staff User: ${users.name} (ID: ${users.id})`);

        // 3. Update outlet_id
        const { data: updateData, error: updateError } = await supabase
            .from('users')
            .update({ outlet_id: mainOutletId })
            .eq('id', users.id);

        if (updateError) {
            console.error('Error updating user:', updateError);
            return;
        }

        console.log('âœ… Successfully updated staff user outlet association!');

        // 4. Verify update
        const { data: verifiedUser } = await supabase
            .from('users')
            .select('id, email, outlet_id')
            .eq('id', users.id)
            .single();

        console.log('Verification:', verifiedUser);

    } catch (error) {
        console.error('Unexpected error:', error);
    }
}

fixStaffOutlet();


================================================================================
PATH: scripts\import-demo-data.ts
FILENAME: import-demo-data.ts
================================================================================

import { config } from 'dotenv';
import { createClient } from '@supabase/supabase-js';
import * as XLSX from 'xlsx';
import * as fs from 'fs';
import * as path from 'path';

// Load environment variables from .env.local
config({ path: '.env.local' });

// Initialize Supabase client
const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

if (!supabaseUrl || !supabaseKey) {
    console.error('âŒ Missing Supabase credentials in .env.local');
    console.error('   NEXT_PUBLIC_SUPABASE_URL:', supabaseUrl ? 'âœ“' : 'âœ—');
    console.error('   SUPABASE_SERVICE_ROLE_KEY:', supabaseKey ? 'âœ“' : 'âœ—');
    process.exit(1);
}

const supabase = createClient(supabaseUrl, supabaseKey);

// Base directory containing demo data
const DEMO_DATA_DIR = './ACCOUNTS Demo Data';

// Mapping of outlet types to folder names
const OUTLET_TYPES = {
    'HYPER PHARMACY': 'hyper_pharmacy',
    'SMART CLINIC': 'smart_clinic'
} as const;

// Cell mapping for daily sheet data (based on the Excel template)
// Data starts around Row 2-3
// Column B has labels, Column C has the actual values
const CELL_MAP = {
    DATE: 'C2',  // Date is in C2
    OUTLET_NAME: 'B3',
    OPENING_CASH: 'C5',
    OPENING_UPI: 'C6',
    OPENING_CREDIT: 'C7',
    CASH_FROM_HO: 'C8',
    TOTAL_SALE: 'C9',
    CASH_SALE: 'C10',
    UPI_SALE: 'C11',
    CREDIT_SALE: 'C12',
    CASH_FROM_CREDIT: 'C13',
    UPI_FROM_CREDIT: 'C14',
    SALES_RETURN: 'C15',
    TOTAL_EXPENSES: 'C16',
    CASH_EXPENSES: 'C17',
    UPI_EXPENSES: 'C18',
    CREDIT_EXPENSES: 'C19',
    CLOSING_CREDIT: 'C20',
    CLOSING_UPI: 'C21',
    CLOSING_CASH: 'C22',
    PHYSICAL_CASH: 'C23',
    DIFFERENCE: 'C24',
};

// Helper to parse Excel date serial number
function parseExcelDate(serial: any): string | null {
    if (!serial) return null;

    try {
        if (typeof serial === 'number') {
            const date = XLSX.SSF.parse_date_code(serial);
            if (!date) return null;
            const jsDate = new Date(date.y, date.m - 1, date.d);
            if (isNaN(jsDate.getTime())) return null;
            return jsDate.toISOString().split('T')[0];
        }

        if (serial instanceof Date) {
            if (isNaN(serial.getTime())) return null;
            return serial.toISOString().split('T')[0];
        }

        if (typeof serial === 'string') {
            const parsed = new Date(serial);
            if (isNaN(parsed.getTime())) return null;
            return parsed.toISOString().split('T')[0];
        }

        return null;
    } catch (error) {
        return null;
    }
}

// Helper to safely parse number from cell
function parseNumber(value: any): number {
    if (value === null || value === undefined || value === '') return 0;
    const num = parseFloat(value);
    return isNaN(num) ? 0 : num;
}

// Get or create outlet
async function getOrCreateOutlet(
    name: string,
    code: string,
    location: string,
    type: 'hyper_pharmacy' | 'smart_clinic'
): Promise<string | null> {
    try {
        // Check if outlet exists
        const { data: existing, error: fetchError } = await supabase
            .from('outlets')
            .select('id')
            .eq('code', code)
            .single();

        if (existing) {
            console.log(`  âœ“ Outlet ${code} already exists`);
            return existing.id;
        }

        // Create new outlet
        const { data: newOutlet, error: insertError } = await supabase
            .from('outlets')
            .insert({
                name,
                code,
                location,
                type,
                is_active: true
            })
            .select('id')
            .single();

        if (insertError) {
            console.error(`  âŒ Failed to create outlet ${code}:`, insertError.message);
            return null;
        }

        console.log(`  âœ… Created outlet ${code}`);
        return newOutlet.id;
    } catch (error) {
        console.error(`  âŒ Error with outlet ${code}:`, error);
        return null;
    }
}

// Parse a single daily sheet and import data
async function parseDailySheet(
    workbook: XLSX.WorkBook,
    sheetName: string,
    outletId: string
): Promise<boolean> {
    try {
        const sheet = workbook.Sheets[sheetName];
        if (!sheet) return false;

        // Extract date from C2 (Row 1 is empty, data starts at Row 2)
        const dateSerial = sheet['C2']?.v;
        const date = parseExcelDate(dateSerial);

        if (!date) {
            console.log(`    â­ï¸  Skipping sheet ${sheetName} - invalid date`);
            return false;
        }

        // Check if this date already exists for this outlet
        const { data: existing } = await supabase
            .from('daily_records')
            .select('id')
            .eq('outlet_id', outletId)
            .eq('date', date)
            .limit(1);

        if (existing && existing.length > 0) {
            console.log(`    â­ï¸  ${date} already exists`);
            return false;
        }

        // Extract all values from the sheet (Column C)
        const openingCash = parseNumber(sheet['C4']?.v);
        const openingUPI = parseNumber(sheet['C5']?.v);
        const totalSale = parseNumber(sheet['C8']?.v);
        const cashSale = parseNumber(sheet['C9']?.v);
        const upiSale = parseNumber(sheet['C10']?.v);
        const creditSale = parseNumber(sheet['C11']?.v);
        const salesReturn = parseNumber(sheet['C14']?.v);
        const totalExpenses = parseNumber(sheet['C15']?.v);
        const closingCash = parseNumber(sheet['C21']?.v);
        const closingUPI = parseNumber(sheet['C20']?.v);

        // Create daily_records entries (one per transaction type)
        const records = [];

        // 1. Sales - Cash
        if (cashSale > 0) {
            records.push({
                outlet_id: outletId,
                date,
                particulars: 'Cash Sales',
                amount: cashSale,
                category: 'sales',
                payment_mode: 'cash',
                opening_cash: openingCash,
                opening_upi: openingUPI,
                total_income: totalSale,
                total_expense: totalExpenses,
                closing_cash: closingCash,
                closing_upi: closingUPI,
                status: 'locked'
            });
        }

        // 2. Sales - UPI
        if (upiSale > 0) {
            records.push({
                outlet_id: outletId,
                date,
                particulars: 'UPI Sales',
                amount: upiSale,
                category: 'sales',
                payment_mode: 'upi',
                opening_cash: openingCash,
                opening_upi: openingUPI,
                total_income: totalSale,
                total_expense: totalExpenses,
                closing_cash: closingCash,
                closing_upi: closingUPI,
                status: 'locked'
            });
        }

        // 3. Sales - Credit
        if (creditSale > 0) {
            records.push({
                outlet_id: outletId,
                date,
                particulars: 'Credit Sales',
                amount: creditSale,
                category: 'sales',
                payment_mode: 'credit',
                opening_cash: openingCash,
                opening_upi: openingUPI,
                total_income: totalSale,
                total_expense: totalExpenses,
                closing_cash: closingCash,
                closing_upi: closingUPI,
                status: 'locked'
            });
        }

        // 4. Sales Return
        if (salesReturn > 0) {
            records.push({
                outlet_id: outletId,
                date,
                particulars: 'Sales Return',
                amount: salesReturn,
                category: 'sales_return',
                payment_mode: 'cash',
                opening_cash: openingCash,
                opening_upi: openingUPI,
                total_income: totalSale,
                total_expense: totalExpenses,
                closing_cash: closingCash,
                closing_upi: closingUPI,
                status: 'locked'
            });
        }

        // 5. Expenses
        if (totalExpenses > 0) {
            records.push({
                outlet_id: outletId,
                date,
                particulars: 'Total Expenses',
                amount: totalExpenses,
                category: 'expenses',
                payment_mode: 'cash',
                opening_cash: openingCash,
                opening_upi: openingUPI,
                total_income: totalSale,
                total_expense: totalExpenses,
                closing_cash: closingCash,
                closing_upi: closingUPI,
                status: 'locked'
            });
        }

        // Insert all records
        if (records.length > 0) {
            const { error } = await supabase
                .from('daily_records')
                .insert(records);

            if (error) {
                console.error(`    âŒ Error importing ${date}:`, error.message);
                return false;
            }

            console.log(`    âœ… Imported ${date} (${records.length} records)`);
            return true;
        }

        return false;
    } catch (error) {
        console.error(`    âŒ Error parsing sheet ${sheetName}:`, error);
        return false;
    }
}

// Process a single Excel workbook
async function processWorkbook(filePath: string, outletId: string): Promise<void> {
    try {
        if (!fs.existsSync(filePath)) {
            console.error(`  âŒ File not found: ${filePath}`);
            return;
        }
        const data = fs.readFileSync(filePath);
        const workbook = XLSX.read(data, { type: 'buffer' });
        console.log(`  ðŸ“Š Processing: ${path.basename(filePath)}`);
        console.log(`  ðŸ“‹ Found ${workbook.SheetNames.length} sheets`);

        let imported = 0;

        // Process each sheet (skip non-date sheets like TEMPLATE, Meta, Summary)
        for (const sheetName of workbook.SheetNames) {
            // Only process sheets that look like dates (6 digits: DDMMYY or similar)
            if (/^\d{6}$/.test(sheetName)) {
                const success = await parseDailySheet(workbook, sheetName, outletId);
                if (success) imported++;
            }
        }

        console.log(`  âœ… Imported ${imported} days from ${path.basename(filePath)}\n`);
    } catch (error) {
        console.error(`  âŒ Error processing workbook:`, error);
    }
}

// Recursively scan and process folders
async function scanAndImport(dir: string, outletType?: string, location?: string): Promise<void> {
    const items = fs.readdirSync(dir);

    for (const item of items) {
        const fullPath = path.join(dir, item);
        const stat = fs.statSync(fullPath);

        if (stat.isDirectory()) {
            // Determine context from folder name
            const folderName = item.toUpperCase();

            // Check if this is an outlet type folder
            if (folderName === 'HYPER PHARMACY' || folderName === 'SMART CLINIC') {
                console.log(`\nðŸ“ Processing ${item}...`);
                await scanAndImport(fullPath, OUTLET_TYPES[folderName as keyof typeof OUTLET_TYPES]);
            }
            // Check if this is a location folder (within an outlet type)
            else if (outletType && !location && folderName !== 'OUTLETS.XLSX') {
                console.log(`\n  ðŸ“ Location: ${item}`);
                await scanAndImport(fullPath, outletType, item);
            }
            // Otherwise, recurse into subdirectories (year/month folders)
            else {
                await scanAndImport(fullPath, outletType, location);
            }
        } else if (item.endsWith('.xlsx') && !item.startsWith('~') && !item.includes('TEMPLATE') && !item.includes('OUTLETS')) {
            // Process Excel file
            if (outletType && location) {
                // Generate outlet code
                const typePrefix = outletType === 'hyper_pharmacy' ? 'HP' : 'SC';
                const locationCode = location.substring(0, 3).toUpperCase();
                const code = `${typePrefix}-${locationCode}`;

                // Get or create outlet
                const outletId = await getOrCreateOutlet(
                    `${location} ${outletType === 'hyper_pharmacy' ? 'Hyper Pharmacy' : 'Smart Clinic'}`,
                    code,
                    location,
                    outletType as 'hyper_pharmacy' | 'smart_clinic'
                );

                if (outletId) {
                    await processWorkbook(fullPath, outletId);
                }
            }
        }
    }
}

// Main execution
async function main() {
    console.log('ðŸš€ Starting Excel Import...\n');
    console.log(`ðŸ“‚ Scanning: ${DEMO_DATA_DIR}\n`);

    try {
        await scanAndImport(DEMO_DATA_DIR);
        console.log('\nâœ… Import complete!');
    } catch (error) {
        console.error('\nâŒ Import failed:', error);
        process.exit(1);
    }
}

main();


================================================================================
PATH: scripts\inspect-excel.js
FILENAME: inspect-excel.js
================================================================================

const XLSX = require('xlsx');

const filePath = './ACCOUNTS Demo Data/HYPER PHARMACY/TIRUR/2025/DECEMBER/DECEMBER 2025 TIRUR SAHAKAR HYPER PHARMACY ACCOUNTS REPORT.xlsx';
const wb = XLSX.readFile(filePath);

console.log('ðŸ“‹ Sheet Names:', wb.SheetNames);
console.log('\n');

const firstSheet = wb.Sheets[wb.SheetNames[0]];
const data = XLSX.utils.sheet_to_json(firstSheet, { header: 1, defval: '' });

console.log('ðŸ” First 10 rows of data:');
data.slice(0, 10).forEach((row, i) => {
    console.log(`Row ${i}:`, row);
});

console.log('\n\nðŸ“Š Data as JSON (with headers):');
const jsonData = XLSX.utils.sheet_to_json(firstSheet);
console.log('First record:', jsonData[0]);
console.log('Columns:', jsonData.length > 0 ? Object.keys(jsonData[0]) : 'No data');


================================================================================
PATH: scripts\inspect-outlets.js
FILENAME: inspect-outlets.js
================================================================================

const XLSX = require('xlsx');
const path = require('path');

const files = [
    'ACCOUNTS Demo Data/HYPER PHARMACY/OUTLETS.xlsx',
    'ACCOUNTS Demo Data/SMART CLINIC/OUTLETS.xlsx'
];

files.forEach(file => {
    const fullPath = path.join(process.cwd(), file);
    try {
        const workbook = XLSX.readFile(fullPath);
        console.log(`\n--- ${file} ---`);
        workbook.SheetNames.forEach(name => {
            const sheet = workbook.Sheets[name];
            const data = XLSX.utils.sheet_to_json(sheet);
            console.log(`Sheet: ${name}, Rows: ${data.length}`);
            if (data.length > 0) {
                console.log('Sample row:', data[0]);
            }
        });
    } catch (err) {
        console.error(`Error reading ${file}:`, err.message);
    }
});


================================================================================
PATH: scripts\run-migrations.ts
FILENAME: run-migrations.ts
================================================================================

// Run SQL migrations via Supabase API
import { createClient } from '@supabase/supabase-js';
import * as fs from 'fs';
import * as path from 'path';
import * as dotenv from 'dotenv';

// Load environment variables
dotenv.config({ path: '.env.local' });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY!;

if (!supabaseUrl || !supabaseServiceKey) {
    console.error('âŒ Missing Supabase credentials in .env.local');
    process.exit(1);
}

const supabase = createClient(supabaseUrl, supabaseServiceKey);

async function executeSQLFile(filePath: string): Promise<void> {
    console.log(`\nðŸ“‚ Reading: ${filePath}`);
    const sql = fs.readFileSync(filePath, 'utf-8');

    console.log(`ðŸ”§ Executing SQL (${sql.length} characters)...`);

    // Execute via RPC or direct SQL execution
    // Note: Supabase doesn't have a direct SQL execution endpoint in JS client
    // We need to use the REST API directly
    const response = await fetch(`${supabaseUrl}/rest/v1/rpc/exec_sql`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'apikey': supabaseServiceKey,
            'Authorization': `Bearer ${supabaseServiceKey}`
        },
        body: JSON.stringify({ query: sql })
    });

    if (!response.ok) {
        const error = await response.text();
        console.error(`âŒ Failed to execute ${filePath}:`, error);
        throw new Error(error);
    }

    console.log(`âœ… Successfully executed: ${filePath}`);
}

async function main() {
    console.log('ðŸš€ Starting database migrations...\n');
    console.log(`ðŸ“ Supabase URL: ${supabaseUrl}`);

    const migrations = [
        'database/add-time-bound-access.sql',
        'database/auditor-access-log.sql'
    ];

    for (const migration of migrations) {
        try {
            await executeSQLFile(migration);
        } catch (error) {
            console.error(`\nðŸ’¥ Migration failed: ${migration}`);
            console.error(error);
            process.exit(1);
        }
    }

    console.log('\nâœ… All migrations completed successfully!');

    // Verification
    console.log('\nðŸ” Verifying migrations...');

    const { data: functions, error: funcError } = await supabase
        .rpc('is_access_valid', { user_id: '6a622bde-bde5-4eef-947b-19d4197c124d' });

    if (funcError) {
        console.error('âš ï¸  Function verification failed:', funcError.message);
    } else {
        console.log('âœ… is_access_valid() function works!');
    }

    const { count, error: tableError } = await supabase
        .from('auditor_access_log')
        .select('*', { count: 'exact', head: true });

    if (tableError) {
        console.error('âš ï¸  Table verification failed:', tableError.message);
    } else {
        console.log(`âœ… auditor_access_log table exists (${count} rows)`);
    }

    console.log('\nðŸŽ‰ Migration verification complete!');
}

main().catch(console.error);


================================================================================
PATH: supabase\migrations\20251222140415_complete_phase3_schema.sql
FILENAME: 20251222140415_complete_phase3_schema.sql
================================================================================

-- Phase 3: Transaction Management Database Schema
-- Run this in Supabase SQL Editor

-- IMPORTANT: Step 1 - Rename table FIRST before any foreign key references
ALTER TABLE IF EXISTS daily_entries RENAME TO daily_records;

-- Step 2: Add new columns to daily_records
ALTER TABLE daily_records 
  ADD COLUMN IF NOT EXISTS opening_cash DECIMAL(12,2) DEFAULT 0,
  ADD COLUMN IF NOT EXISTS opening_upi DECIMAL(12,2) DEFAULT 0,
  ADD COLUMN IF NOT EXISTS closing_cash DECIMAL(12,2),
  ADD COLUMN IF NOT EXISTS closing_upi DECIMAL(12,2),
  ADD COLUMN IF NOT EXISTS total_income DECIMAL(12,2),
  ADD COLUMN IF NOT EXISTS total_expense DECIMAL(12,2),
  ADD COLUMN IF NOT EXISTS status VARCHAR(20) DEFAULT 'draft',
  ADD COLUMN IF NOT EXISTS submitted_at TIMESTAMPTZ,
  ADD COLUMN IF NOT EXISTS submitted_by UUID REFERENCES users(id),
  ADD COLUMN IF NOT EXISTS locked_at TIMESTAMPTZ,
  ADD COLUMN IF NOT EXISTS locked_by UUID REFERENCES users(id);

-- Step 3: Create transactions table (NOW daily_records exists)
CREATE TABLE IF NOT EXISTS transactions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  daily_record_id UUID REFERENCES daily_records(id) ON DELETE CASCADE,
  type VARCHAR(20) NOT NULL CHECK (type IN ('income', 'expense')),
  category VARCHAR(100) NOT NULL,
  payment_mode VARCHAR(10) NOT NULL CHECK (payment_mode IN ('cash', 'upi')),
  amount DECIMAL(12,2) NOT NULL CHECK (amount > 0),
  description TEXT,
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create indexes for transactions
CREATE INDEX IF NOT EXISTS idx_transactions_daily_record ON transactions(daily_record_id);
CREATE INDEX IF NOT EXISTS idx_transactions_created_by ON transactions(created_by);
CREATE INDEX IF NOT EXISTS idx_transactions_type ON transactions(type);
CREATE INDEX IF NOT EXISTS idx_transactions_date ON transactions(created_at);

-- Step 4: Create categories table
CREATE TABLE IF NOT EXISTS categories (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  code VARCHAR(50) UNIQUE NOT NULL,
  name VARCHAR(100) NOT NULL,
  type VARCHAR(20) NOT NULL CHECK (type IN ('income', 'expense')),
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- Step 5: Seed initial categories
INSERT INTO categories (code, name, type) VALUES
  ('consultation', 'Consultation Fees', 'income'),
  ('medicine_sale', 'Medicine Sale', 'income'),
  ('lab_test', 'Lab Test Fees', 'income'),
  ('other_income', 'Other Income', 'income'),
  ('medicine_purchase', 'Medicine Purchase', 'expense'),
  ('staff_salary', 'Staff Salary', 'expense'),
  ('clinic_expenses', 'Clinic Expenses', 'expense'),
  ('transport', 'Transport', 'expense'),
  ('rent', 'Rent', 'expense'),
  ('utilities', 'Electricity/Water', 'expense'),
  ('miscellaneous', 'Miscellaneous', 'expense')
ON CONFLICT (code) DO NOTHING;

-- Step 6: Create trigger function to auto-calculate balances
CREATE OR REPLACE FUNCTION update_daily_record_balances()
RETURNS TRIGGER AS $$
DECLARE
  record_id UUID;
BEGIN
  -- Get the daily_record_id from the transaction
  record_id := COALESCE(NEW.daily_record_id, OLD.daily_record_id);
  
  -- Update the daily_record with calculated balances
  UPDATE daily_records dr
  SET 
    total_income = (
      SELECT COALESCE(SUM(amount), 0) 
      FROM transactions 
      WHERE daily_record_id = dr.id AND type = 'income'
    ),
    total_expense = (
      SELECT COALESCE(SUM(amount), 0) 
      FROM transactions 
      WHERE daily_record_id = dr.id AND type = 'expense'
    ),
    closing_cash = dr.opening_cash + 
      COALESCE((SELECT SUM(amount) FROM transactions WHERE daily_record_id = dr.id AND type = 'income' AND payment_mode = 'cash'), 0) -
      COALESCE((SELECT SUM(amount) FROM transactions WHERE daily_record_id = dr.id AND type = 'expense' AND payment_mode = 'cash'), 0),
    closing_upi = dr.opening_upi +
      COALESCE((SELECT SUM(amount) FROM transactions WHERE daily_record_id = dr.id AND type = 'income' AND payment_mode = 'upi'), 0) -
      COALESCE((SELECT SUM(amount) FROM transactions WHERE daily_record_id = dr.id AND type = 'expense' AND payment_mode = 'upi'), 0),
    updated_at = NOW()
  WHERE dr.id = record_id;
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Step 7: Create trigger on transactions table
DROP TRIGGER IF EXISTS transaction_balance_update ON transactions;
CREATE TRIGGER transaction_balance_update
AFTER INSERT OR UPDATE OR DELETE ON transactions
FOR EACH ROW
EXECUTE FUNCTION update_daily_record_balances();

-- Step 8: Enable RLS on new tables
ALTER TABLE transactions ENABLE ROW LEVEL SECURITY;
ALTER TABLE categories ENABLE ROW LEVEL SECURITY;

-- Step 9: Create RLS policies for transactions
CREATE POLICY "Users can view transactions from their outlet" ON transactions
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM daily_records dr
      JOIN users u ON u.id = auth.uid()
      WHERE dr.id = transactions.daily_record_id
      AND (u.role IN ('superadmin', 'ho_accountant') OR u.outlet_id = dr.outlet_id)
    )
  );

CREATE POLICY "Staff can create transactions for their outlet" ON transactions
  FOR INSERT WITH CHECK (
    EXISTS (
      SELECT 1 FROM daily_records dr
      JOIN users u ON u.id = auth.uid()
      WHERE dr.id = transactions.daily_record_id
      AND dr.status = 'draft'
      AND (u.role = 'superadmin' OR u.outlet_id = dr.outlet_id)
    )
  );

CREATE POLICY "Users can update their own transactions in draft" ON transactions
  FOR UPDATE USING (
    EXISTS (
      SELECT 1 FROM daily_records dr
      JOIN users u ON u.id = auth.uid()
      WHERE dr.id = transactions.daily_record_id
      AND dr.status = 'draft'
      AND (u.role = 'superadmin' OR (transactions.created_by = auth.uid() AND u.outlet_id = dr.outlet_id))
    )
  );

CREATE POLICY "Users can delete their own transactions in draft" ON transactions
  FOR DELETE USING (
    EXISTS (
      SELECT 1 FROM daily_records dr
      JOIN users u ON u.id = auth.uid()
      WHERE dr.id = transactions.daily_record_id
      AND dr.status = 'draft'
      AND (u.role = 'superadmin' OR (transactions.created_by = auth.uid() AND u.outlet_id = dr.outlet_id))
    )
  );

-- Step 10: Create RLS policies for categories
CREATE POLICY "Anyone can view active categories" ON categories
  FOR SELECT USING (is_active = true);

-- Verify everything was created
SELECT 'daily_records' as table_name, count(*) as columns FROM information_schema.columns WHERE table_name = 'daily_records'
UNION ALL
SELECT 'transactions', count(*) FROM information_schema.columns WHERE table_name = 'transactions'
UNION ALL
SELECT 'categories', count(*) FROM information_schema.columns WHERE table_name = 'categories';

SELECT 'Categories seeded' as status, count(*) as count FROM categories;


================================================================================
PATH: tailwind.config.ts
FILENAME: tailwind.config.ts
================================================================================

import type { Config } from 'tailwindcss';

const config: Config = {
    darkMode: ['class'],
    content: [
        './pages/**/*.{ts,tsx}',
        './components/**/*.{ts,tsx}',
        './app/**/*.{ts,tsx}',
        './src/**/*.{ts,tsx}',
    ],
    theme: {
        container: {
            center: true,
            padding: '2rem',
            screens: {
                '2xl': '1400px',
            },
        },
        extend: {
            colors: {
                border: 'hsl(var(--border))',
                input: 'hsl(var(--input))',
                ring: 'hsl(var(--ring))',
                background: 'hsl(var(--background))',
                foreground: 'hsl(var(--foreground))',
                primary: {
                    DEFAULT: 'hsl(var(--primary))',
                    foreground: 'hsl(var(--primary-foreground))',
                },
                secondary: {
                    DEFAULT: 'hsl(var(--secondary))',
                    foreground: 'hsl(var(--secondary-foreground))',
                },
                destructive: {
                    DEFAULT: 'hsl(var(--destructive))',
                    foreground: 'hsl(var(--destructive-foreground))',
                },
                muted: {
                    DEFAULT: 'hsl(var(--muted))',
                    foreground: 'hsl(var(--muted-foreground))',
                },
                accent: {
                    DEFAULT: 'hsl(var(--accent))',
                    foreground: 'hsl(var(--accent-foreground))',
                },
                popover: {
                    DEFAULT: 'hsl(var(--popover))',
                    foreground: 'hsl(var(--popover-foreground))',
                },
                card: {
                    DEFAULT: 'hsl(var(--card))',
                    foreground: 'hsl(var(--card-foreground))',
                },
            },
            borderRadius: {
                lg: 'var(--radius)',
                md: 'calc(var(--radius) - 2px)',
                sm: 'calc(var(--radius) - 4px)',
            },
            keyframes: {
                'accordion-down': {
                    from: { height: '0' },
                    to: { height: 'var(--radix-accordion-content-height)' },
                },
                'accordion-up': {
                    from: { height: 'var(--radix-accordion-content-height)' },
                    to: { height: '0' },
                },
            },
            animation: {
                'accordion-down': 'accordion-down 0.2s ease-out',
                'accordion-up': 'accordion-up 0.2s ease-out',
            },
        },
    },
    plugins: [require('tailwindcss-animate')],
};

export default config;


================================================================================
PATH: tsconfig.json
FILENAME: tsconfig.json
================================================================================

{
    "compilerOptions": {
        "lib": [
            "dom",
            "dom.iterable",
            "esnext"
        ],
        "allowJs": true,
        "skipLibCheck": true,
        "strict": true,
        "noEmit": true,
        "esModuleInterop": true,
        "module": "esnext",
        "moduleResolution": "bundler",
        "resolveJsonModule": true,
        "isolatedModules": true,
        "jsx": "preserve",
        "incremental": true,
        "plugins": [
            {
                "name": "next"
            }
        ],
        "paths": {
            "@/*": [
                "./*"
            ]
        }
    },
    "include": [
        "next-env.d.ts",
        "**/*.ts",
        "**/*.tsx",
        ".next/types/**/*.ts"
    ],
    "exclude": [
        "node_modules"
    ]
}

================================================================================
PATH: vercel.json
FILENAME: vercel.json
================================================================================

{
    "crons": [
        {
            "path": "/api/cron/sync-sheets",
            "schedule": "0 0 * * *"
        }
    ]
}

