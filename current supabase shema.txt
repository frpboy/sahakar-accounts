-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.anomalies (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  outlet_id uuid,
  title character varying NOT NULL,
  description text,
  severity character varying NOT NULL CHECK (severity::text = ANY (ARRAY['critical'::character varying, 'warning'::character varying, 'info'::character varying]::text[])),
  category character varying NOT NULL,
  metadata jsonb DEFAULT '{}'::jsonb,
  detected_at timestamp with time zone DEFAULT now(),
  resolved_at timestamp with time zone,
  resolved_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  business_day_id uuid,
  assigned_to uuid,
  status character varying NOT NULL DEFAULT 'open'::character varying CHECK (status::text = ANY (ARRAY['open'::character varying, 'acknowledged'::character varying, 'resolved'::character varying, 'waived'::character varying]::text[])),
  resolution_attachment_url text,
  fingerprint text,
  occurrences_count integer NOT NULL DEFAULT 1,
  first_detected_at timestamp with time zone DEFAULT now(),
  last_detected_at timestamp with time zone DEFAULT now(),
  CONSTRAINT anomalies_pkey PRIMARY KEY (id),
  CONSTRAINT anomalies_outlet_id_fkey FOREIGN KEY (outlet_id) REFERENCES public.outlets(id),
  CONSTRAINT anomalies_resolved_by_fkey FOREIGN KEY (resolved_by) REFERENCES auth.users(id),
  CONSTRAINT anomalies_business_day_id_fkey FOREIGN KEY (business_day_id) REFERENCES public.business_days(id),
  CONSTRAINT anomalies_assigned_to_fkey FOREIGN KEY (assigned_to) REFERENCES public.users(id)
);
CREATE TABLE public.anomaly_history (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  anomaly_id uuid,
  status character varying NOT NULL,
  data_snapshot jsonb DEFAULT '{}'::jsonb,
  recorded_at timestamp with time zone DEFAULT now(),
  attachment_url text,
  CONSTRAINT anomaly_history_pkey PRIMARY KEY (id),
  CONSTRAINT anomaly_history_anomaly_id_fkey FOREIGN KEY (anomaly_id) REFERENCES public.anomalies(id)
);
CREATE TABLE public.audit_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  action text,
  entity text,
  entity_id uuid,
  old_data jsonb,
  new_data jsonb,
  created_at timestamp without time zone DEFAULT now(),
  reason text,
  ip_address text,
  user_agent text,
  severity text DEFAULT 'normal'::text CHECK (severity = ANY (ARRAY['normal'::text, 'warning'::text, 'critical'::text])),
  CONSTRAINT audit_logs_pkey PRIMARY KEY (id)
);
CREATE TABLE public.auditor_access_log (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  auditor_id uuid NOT NULL,
  outlet_id uuid,
  action text NOT NULL CHECK (action = ANY (ARRAY['view_dashboard'::text, 'view_record'::text, 'view_transaction'::text, 'export_excel'::text, 'export_pdf'::text, 'filter_data'::text])),
  entity_type text,
  entity_id uuid,
  accessed_at timestamp with time zone NOT NULL DEFAULT now(),
  ip_address text,
  user_agent text,
  CONSTRAINT auditor_access_log_pkey PRIMARY KEY (id),
  CONSTRAINT auditor_access_log_outlet_id_fkey FOREIGN KEY (outlet_id) REFERENCES public.outlets(id),
  CONSTRAINT auditor_access_log_auditor_id_fkey FOREIGN KEY (auditor_id) REFERENCES public.users(id)
);
CREATE TABLE public.auditor_outlets (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  outlet_id uuid,
  CONSTRAINT auditor_outlets_pkey PRIMARY KEY (id),
  CONSTRAINT auditor_outlets_outlet_id_fkey FOREIGN KEY (outlet_id) REFERENCES public.outlets(id)
);
CREATE TABLE public.business_days (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  outlet_id uuid,
  date date NOT NULL,
  opening_cash numeric NOT NULL,
  opening_upi numeric NOT NULL,
  closing_cash numeric,
  closing_upi numeric,
  status USER-DEFINED DEFAULT 'DRAFT'::day_status,
  submitted_by uuid,
  submitted_at timestamp without time zone,
  locked_by uuid,
  locked_at timestamp without time zone,
  CONSTRAINT business_days_pkey PRIMARY KEY (id)
);
CREATE TABLE public.categories (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  code character varying NOT NULL UNIQUE,
  name character varying NOT NULL,
  type character varying NOT NULL CHECK (type::text = ANY (ARRAY['income'::character varying, 'expense'::character varying]::text[])),
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT categories_pkey PRIMARY KEY (id)
);
CREATE TABLE public.customers (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  outlet_id uuid NOT NULL,
  name text NOT NULL,
  phone character varying,
  email character varying,
  address text,
  notes text,
  credit_limit numeric DEFAULT 0,
  outstanding_balance numeric DEFAULT 0,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  created_by uuid,
  referred_by text,
  internal_customer_id text UNIQUE,
  customer_code text UNIQUE,
  CONSTRAINT customers_pkey PRIMARY KEY (id),
  CONSTRAINT customers_outlet_id_fkey FOREIGN KEY (outlet_id) REFERENCES public.outlets(id),
  CONSTRAINT customers_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id)
);
CREATE TABLE public.daily_records (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  outlet_id uuid NOT NULL,
  date date NOT NULL,
  particulars text NOT NULL,
  amount numeric NOT NULL,
  category text NOT NULL,
  payment_mode text,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  synced_to_sheets boolean DEFAULT false,
  opening_cash numeric DEFAULT 0,
  opening_upi numeric DEFAULT 0,
  closing_cash numeric,
  closing_upi numeric,
  total_income numeric,
  total_expense numeric,
  status character varying DEFAULT 'draft'::character varying,
  submitted_at timestamp with time zone,
  submitted_by uuid,
  locked_at timestamp with time zone,
  locked_by uuid,
  last_synced_at timestamp with time zone,
  sheet_sync_error text,
  CONSTRAINT daily_records_pkey PRIMARY KEY (id),
  CONSTRAINT daily_entries_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id),
  CONSTRAINT daily_records_submitted_by_fkey FOREIGN KEY (submitted_by) REFERENCES public.users(id),
  CONSTRAINT daily_records_locked_by_fkey FOREIGN KEY (locked_by) REFERENCES public.users(id)
);
CREATE TABLE public.daily_totals (
  business_day_id uuid NOT NULL,
  income_cash numeric,
  income_upi numeric,
  expense_cash numeric,
  expense_upi numeric,
  CONSTRAINT daily_totals_pkey PRIMARY KEY (business_day_id),
  CONSTRAINT daily_totals_business_day_id_fkey FOREIGN KEY (business_day_id) REFERENCES public.business_days(id)
);
CREATE TABLE public.dashboard_annotations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  outlet_id uuid NOT NULL,
  user_id uuid NOT NULL,
  page_key text NOT NULL,
  text text NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT dashboard_annotations_pkey PRIMARY KEY (id)
);
CREATE TABLE public.duty_logs (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid NOT NULL,
  outlet_id uuid,
  duty_start timestamp with time zone,
  duty_end timestamp with time zone,
  date date NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT duty_logs_pkey PRIMARY KEY (id),
  CONSTRAINT duty_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT duty_logs_outlet_id_fkey FOREIGN KEY (outlet_id) REFERENCES public.outlets(id)
);
CREATE TABLE public.export_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  user_role character varying,
  export_type character varying CHECK (export_type::text = ANY (ARRAY['csv'::character varying, 'json'::character varying, 'pdf'::character varying]::text[])),
  report_type character varying,
  file_hash character varying,
  record_count integer,
  filters jsonb DEFAULT '{}'::jsonb,
  status character varying CHECK (status::text = ANY (ARRAY['processing'::character varying, 'completed'::character varying, 'failed'::character varying]::text[])),
  file_path text,
  created_at timestamp with time zone DEFAULT now(),
  completed_at timestamp with time zone,
  error_message text,
  CONSTRAINT export_logs_pkey PRIMARY KEY (id),
  CONSTRAINT export_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.monthly_closure_snapshots (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  outlet_id uuid NOT NULL,
  month_date date NOT NULL,
  version integer NOT NULL DEFAULT 1,
  snapshot jsonb NOT NULL,
  snapshot_hash text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  created_by uuid NOT NULL,
  CONSTRAINT monthly_closure_snapshots_pkey PRIMARY KEY (id),
  CONSTRAINT monthly_closure_snapshots_outlet_id_fkey FOREIGN KEY (outlet_id) REFERENCES public.outlets(id),
  CONSTRAINT monthly_closure_snapshots_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id)
);
CREATE TABLE public.monthly_closures (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  outlet_id uuid NOT NULL,
  month_date date NOT NULL,
  status character varying NOT NULL CHECK (status::text = ANY (ARRAY['open'::character varying, 'closed'::character varying]::text[])),
  closed_at timestamp with time zone,
  closed_by uuid,
  opening_cash numeric NOT NULL DEFAULT 0,
  closing_cash numeric NOT NULL DEFAULT 0,
  total_income numeric NOT NULL DEFAULT 0,
  total_expense numeric NOT NULL DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  opening_upi numeric NOT NULL DEFAULT 0,
  closing_upi numeric NOT NULL DEFAULT 0,
  days_count integer NOT NULL DEFAULT 0,
  reopened_at timestamp with time zone,
  reopened_by uuid,
  reopen_reason text,
  CONSTRAINT monthly_closures_pkey PRIMARY KEY (id),
  CONSTRAINT monthly_closures_outlet_id_fkey FOREIGN KEY (outlet_id) REFERENCES public.outlets(id),
  CONSTRAINT monthly_closures_closed_by_fkey FOREIGN KEY (closed_by) REFERENCES public.users(id),
  CONSTRAINT monthly_closures_reopened_by_fkey FOREIGN KEY (reopened_by) REFERENCES public.users(id)
);
CREATE TABLE public.monthly_summaries (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  outlet_id uuid NOT NULL,
  month date NOT NULL,
  total_income numeric DEFAULT 0,
  total_expense numeric DEFAULT 0,
  total_cash_in numeric DEFAULT 0,
  total_cash_out numeric DEFAULT 0,
  total_upi_in numeric DEFAULT 0,
  total_upi_out numeric DEFAULT 0,
  net_profit numeric DEFAULT 0,
  opening_balance numeric DEFAULT 0,
  closing_balance numeric DEFAULT 0,
  days_count integer DEFAULT 0,
  generated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT monthly_summaries_pkey PRIMARY KEY (id),
  CONSTRAINT monthly_summaries_outlet_id_fkey FOREIGN KEY (outlet_id) REFERENCES public.outlets(id)
);
CREATE TABLE public.outlet_chats (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  outlet_id uuid NOT NULL,
  user_id uuid NOT NULL,
  role text,
  content text NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT outlet_chats_pkey PRIMARY KEY (id)
);
CREATE TABLE public.outlet_counters (
  outlet_id uuid NOT NULL,
  next_entry_seq bigint NOT NULL DEFAULT 1,
  next_customer_seq bigint NOT NULL DEFAULT 1,
  CONSTRAINT outlet_counters_pkey PRIMARY KEY (outlet_id),
  CONSTRAINT outlet_counters_outlet_id_fkey FOREIGN KEY (outlet_id) REFERENCES public.outlets(id)
);
CREATE TABLE public.outlets (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  name text NOT NULL,
  location text,
  created_at timestamp with time zone DEFAULT now(),
  code character varying NOT NULL,
  address text,
  phone character varying,
  email character varying,
  google_sheet_id character varying,
  is_active boolean DEFAULT true,
  updated_at timestamp with time zone DEFAULT now(),
  type character varying NOT NULL DEFAULT 'hyper_pharmacy'::character varying CHECK (type::text = ANY (ARRAY['hyper_pharmacy'::character varying, 'smart_clinic'::character varying]::text[])),
  drive_folder_url text,
  outlet_type text NOT NULL CHECK (outlet_type = ANY (ARRAY['HP'::text, 'SC'::text])),
  location_code text NOT NULL,
  CONSTRAINT outlets_pkey PRIMARY KEY (id)
);
CREATE TABLE public.role_approvals (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  target_user_id uuid NOT NULL,
  requested_by uuid NOT NULL,
  requested_role text NOT NULL CHECK (requested_role = ANY (ARRAY['superadmin'::text])),
  old_role text,
  status text NOT NULL DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'approved'::text, 'rejected'::text])),
  reason text,
  requested_at timestamp with time zone NOT NULL DEFAULT now(),
  approved_by uuid,
  approved_at timestamp with time zone,
  CONSTRAINT role_approvals_pkey PRIMARY KEY (id),
  CONSTRAINT role_approvals_target_user_id_fkey FOREIGN KEY (target_user_id) REFERENCES public.users(id),
  CONSTRAINT role_approvals_requested_by_fkey FOREIGN KEY (requested_by) REFERENCES public.users(id),
  CONSTRAINT role_approvals_approved_by_fkey FOREIGN KEY (approved_by) REFERENCES public.users(id)
);
CREATE TABLE public.roles (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name text NOT NULL UNIQUE,
  CONSTRAINT roles_pkey PRIMARY KEY (id)
);
CREATE TABLE public.sheet_sync_log (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  daily_record_id uuid NOT NULL,
  spreadsheet_id text,
  spreadsheet_url text,
  sync_status text NOT NULL CHECK (sync_status = ANY (ARRAY['success'::text, 'failed'::text, 'pending'::text])),
  error_message text,
  synced_at timestamp with time zone DEFAULT now(),
  created_at timestamp with time zone DEFAULT now(),
  synced_by uuid,
  sync_trigger text CHECK (sync_trigger = ANY (ARRAY['auto'::text, 'manual'::text, 'cron'::text, 'retry'::text])),
  CONSTRAINT sheet_sync_log_pkey PRIMARY KEY (id),
  CONSTRAINT sheet_sync_log_daily_record_id_fkey FOREIGN KEY (daily_record_id) REFERENCES public.daily_records(id),
  CONSTRAINT sheet_sync_log_synced_by_fkey FOREIGN KEY (synced_by) REFERENCES public.users(id)
);
CREATE TABLE public.transactions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  daily_record_id uuid,
  type character varying NOT NULL CHECK (type::text = ANY (ARRAY['income'::character varying, 'expense'::character varying]::text[])),
  category character varying NOT NULL,
  payment_modes text NOT NULL CHECK (payment_modes = ANY (ARRAY['cash'::character varying::text, 'upi'::character varying::text])),
  amount numeric NOT NULL CHECK (amount > 0::numeric),
  description text,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  idempotency_key text,
  internal_entry_id text UNIQUE,
  outlet_id uuid,
  entry_number text,
  customer_phone text,
  CONSTRAINT transactions_pkey PRIMARY KEY (id),
  CONSTRAINT transactions_daily_record_id_fkey FOREIGN KEY (daily_record_id) REFERENCES public.daily_records(id),
  CONSTRAINT transactions_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id),
  CONSTRAINT transactions_outlet_id_fkey FOREIGN KEY (outlet_id) REFERENCES public.outlets(id)
);
CREATE TABLE public.user_outlet_access (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid NOT NULL,
  outlet_id uuid NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT user_outlet_access_pkey PRIMARY KEY (id),
  CONSTRAINT user_outlet_access_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT user_outlet_access_outlet_id_fkey FOREIGN KEY (outlet_id) REFERENCES public.outlets(id)
);
CREATE TABLE public.user_outlets (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  outlet_id uuid,
  CONSTRAINT user_outlets_pkey PRIMARY KEY (id)
);
CREATE TABLE public.users (
  id uuid NOT NULL,
  email text NOT NULL UNIQUE,
  name text NOT NULL,
  role text NOT NULL CHECK (role = ANY (ARRAY['master_admin'::text, 'ho_accountant'::text, 'outlet_manager'::text, 'outlet_staff'::text, 'auditor'::text, 'superadmin'::text])),
  outlet_id uuid,
  created_at timestamp with time zone DEFAULT now(),
  access_start_date date,
  access_end_date date,
  auditor_access_granted_at timestamp with time zone,
  auditor_access_expires_at timestamp with time zone,
  auditor_access_granted_by uuid,
  full_name text,
  CONSTRAINT users_pkey PRIMARY KEY (id),
  CONSTRAINT users_id_fkey FOREIGN KEY (id) REFERENCES auth.users(id),
  CONSTRAINT users_auditor_access_granted_by_fkey FOREIGN KEY (auditor_access_granted_by) REFERENCES public.users(id),
  CONSTRAINT users_outlet_id_fkey FOREIGN KEY (outlet_id) REFERENCES public.outlets(id)
);