# Phase 4 Roadmap - Production Enhancement

**Status:** Post-Launch Improvements  
**Priority:** Medium (Not blocking launch)  
**Estimated Effort:** 2-3 weeks

---

## üéØ Honest Gap Analysis

### What's Working ‚úÖ
- Core transactions (sales, credit, purchase)
- Role-based access control
- Offline drafts
- Basic dashboards
- User/Outlet management
- CSV exports
- Time-based staff controls
- Auto-payment calculation

### What's Missing (Reality Check) üöß

#### 1. **Reporting Pages Are Shells**
**Current State:**
- Reports landing page exists
- Links to 6 report categories

**Missing:**
- No individual report pages
- No date range filters
- No saved views
- No drill-down capabilities

**Impact:** Medium - Users can export CSVs manually
**When:** Phase 4A

#### 2. **Exports Are CSV-Only**
**Current State:**
- CSV download works (3 options)

**Missing:**
- Excel (.xlsx) formatted exports
- PDF reports with headers/footers
- Formatted summaries for HO

**Impact:** Medium - Managers will ask for Excel eventually
**When:** Phase 4B

#### 3. **Anomaly System Is Conceptual**
**Current State:**
- Mentioned in UI (placeholder count = 0)

**Missing:**
- No detection logic
- No flagging system
- No alerts for unusual patterns

**Impact:** Low initially, High for audit compliance
**When:** Phase 4C

#### 4. **Offline Conflict Resolution**
**Current State:**
- Offline drafts save locally
- Auto-sync on reconnect

**Missing:**
- Conflict resolution UI (if same entry synced twice)
- Duplicate prevention on delayed sync

**Impact:** Low - Edge case, but worth planning
**When:** Phase 4D

---

## üìã Phase 4A ‚Äî Reporting Maturity (Must-Have)

**Goal:** Make reports usable, not just navigable

### Individual Report Pages

#### 1. Sales Report
```
Features:
- Date range selector (today, week, month, custom)
- Outlet filter (if multi-outlet user)
- Customer filter/search
- Payment mode breakdown
- Product category breakdown (if available)
- Daily/Weekly/Monthly view toggle

Columns:
- Date, Bill #, Customer, Amount, Payment Mode, Staff

Actions:
- Export this report (CSV)
- Print preview
```

#### 2. Financial Report
```
Features:
- Income vs Expense chart
- Category breakdown (sales, purchase, etc.)
- Payment mode distribution
- Net cash flow
- MTD, YTD comparisons

Sections:
- Revenue Summary
- Expense Summary
- Net Position
- Cash vs Credit breakdown
```

#### 3. Credit Aging Report
```
Features:
- Customers with outstanding credit
- Aging buckets: 0-30, 31-60, 60+ days
- Total outstanding per customer
- Click customer ‚Üí see all credits

Columns:
- Customer, Phone, Total Credit, Oldest Date, Days Outstanding
```

#### 4. Staff Performance Report
```
Features:
- Staff-wise transaction counts
- Revenue by staff member
- Average transaction size
- Date range filter

Metrics:
- Total transactions
- Total revenue
- Avg per transaction
- Top performer badge
```

**Effort:** 4-5 days  
**Dependencies:** None (uses existing data)

---

## üìã Phase 4B ‚Äî Export Engine Upgrade

**Goal:** Stop CSV-only complaints

### Implementation

#### Excel Export (SheetJS)
```bash
npm install xlsx
```

**Features:**
- Multiple sheets per workbook
- Formatted headers
- Auto-column width
- Formula support (totals, averages)
- Outlet metadata sheet

**Code Location:**
```typescript
// utils/export-engine.ts
export async function exportToExcel(data, reportType, metadata) {
  // Create workbook
  // Add data sheet
  // Add summary sheet
  // Add metadata sheet
  // Download
}
```

#### PDF Export (Server-Side)
**Options:**
1. **jsPDF** (client-side, simple)
2. **Puppeteer** (server-side, full HTML‚ÜíPDF)
3. **PDFKit** (server-side, custom layout)

**Recommended:** jsPDF for simplicity

**Features:**
- Company header
- Report title & date range
- Table with auto-pagination
- Footer: "Generated by {user} on {date}"

#### Consistent Export Metadata
```typescript
type ExportMetadata = {
  reportType: string;
  generatedAt: Date;
  generatedBy: string;
  outlet: string;
  dateRange: { from: Date; to: Date };
  recordCount: number;
};
```

**Effort:** 3-4 days  
**Dependencies:** Report pages (Phase 4A)

---

## üìã Phase 4C ‚Äî Soft Anomaly Flags (Lightweight)

**Goal:** Visibility, not AI. Simple rule-based detection.

### Anomaly Types

#### 1. **Post-Lock Edits**
```sql
-- Any transaction created after day was locked
SELECT * FROM transactions 
WHERE outlet_id = ? 
AND DATE(created_at) < CURRENT_DATE
AND created_at > (
  SELECT updated_at FROM daily_records 
  WHERE outlet_id = ? AND status = 'locked'
);
```

**Flag:** üî¥ High Priority

#### 2. **High Credit Days**
```sql
-- Days where>50% of sales are credit
SELECT 
  DATE(created_at) as date,
  SUM(CASE WHEN payment_mode = 'Credit' THEN amount ELSE 0 END) / SUM(amount) * 100 as credit_pct
FROM transactions
WHERE type = 'income' AND category = 'sales'
GROUP BY DATE(created_at)
HAVING credit_pct > 50;
```

**Flag:** üü° Medium Priority

#### 3. **Zero-Cash Days**
```sql
-- Days with no cash transactions (unusual)
SELECT DATE(created_at) as date
FROM transactions
WHERE outlet_id = ?
GROUP BY DATE(created_at)
HAVING SUM(CASE WHEN payment_mode = 'Cash' THEN 1 ELSE 0 END) = 0;
```

**Flag:** üü° Medium Priority

#### 4. **Sudden Drops**
```sql
-- Revenue <50% of 7-day average
WITH avg_revenue AS (
  SELECT AVG(daily_total) as avg_amt
  FROM (
    SELECT DATE(created_at), SUM(amount) as daily_total
    FROM transactions
    WHERE created_at >= CURRENT_DATE - INTERVAL '7 days'
    GROUP BY DATE(created_at)
  ) t
)
SELECT DATE(created_at) as date, SUM(amount) as total
FROM transactions
WHERE DATE(created_at) = CURRENT_DATE
GROUP BY DATE(created_at)
HAVING SUM(amount) < (SELECT avg_amt * 0.5 FROM avg_revenue);
```

**Flag:** üü† Low Priority

### UI Implementation
```typescript
// Dashboard widget
<AnomalyCard
  title="Detected Issues"
  count={anomaliesCount}
  items={[
    { type: 'post_lock_edit', count: 2, severity: 'high' },
    { type: 'high_credit_day', count: 1, severity: 'medium' }
  ]}
  onClick={() => router.push('/dashboard/anomalies')}
/>
```

**Effort:** 5-6 days (includes anomalies table + detection logic)  
**Dependencies:** None

---

## üìã Phase 4D ‚Äî Final Polish (Optional but Valuable)

### 1. Dark Mode
```bash
npm install next-themes
```
**Effort:** 2 days

### 2. Saved Filters
```sql
CREATE TABLE saved_filters (
  id UUID PRIMARY KEY,
  user_id UUID NOT NULL,
  filter_name VARCHAR(100),
  filter_config JSONB,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```
**Effort:** 1 day

### 3. Dashboard Personalization
- Drag-and-drop widgets
- Show/hide metrics
- Custom date ranges
**Effort:** 3-4 days

### 4. Auto Sign-Out at 2 AM
```typescript
// middleware or auth-context
useEffect(() => {
  const checkTime = setInterval(() => {
    const hour = new Date().getHours();
    if (hour === 2 && user?.profile?.role === 'outlet_staff') {
      signOut();
    }
  }, 60000); // Check every minute
  
  return () => clearInterval(checkTime);
}, [user]);
```
**Effort:** 1 hour (already have time checks in place)

---

## üóìÔ∏è Realistic Timeline

| Phase | Priority | Effort | Status |
|-------|----------|--------|--------|
| **4A - Reports** | High | 4-5 days | Not Started |
| **4B - Exports** | High | 3-4 days | Not Started |
| **4C - Anomalies** | Medium | 5-6 days | Not Started |
| **4D - Polish** | Low | 3-4 days | Not Started |

**Total:** 15-19 days (3-4 weeks part-time)

---

## üöÄ Recommendation

### Release v1.0 NOW with:
‚úÖ Core transactions  
‚úÖ Dashboards (simplified manager view)  
‚úÖ User/Outlet management  
‚úÖ CSV exports  
‚úÖ Time-based controls  

### Post-Launch (Phase 4):
Week 1-2: Phase 4A (Reports)  
Week 2-3: Phase 4B (Exports)  
Week 3-4: Phase 4C (Anomalies)  
Week 4+: Phase 4D (Polish)

---

**Last Updated:** January 2, 2026  
**Next Review:** Post v1.0 launch
